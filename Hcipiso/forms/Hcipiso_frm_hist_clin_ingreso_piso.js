/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6617D7A2-838F-4433-A415-DFE0AD4F52F1"}
 */
var f_eges_condiva = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B37145CC-44AB-4D0A-B61F-FE402808D642"}
 */
var f_eges_afiliado = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"30721A9B-FF89-42B2-92B9-16D929B5EF6E"}
 */
var f_eges_nompres = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4FB5A809-E72F-4481-AB41-845E72C3A75E",variableType:4}
 */
var f_eges_seqpres = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"791315A3-9F48-4564-BB23-36AE3D2C3138",variableType:4}
 */
var f_eges_codpres = 0;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"11E5D63B-79E9-4806-99CC-F64DF27800AF",variableType:93}
 */
var f_eges_fechamensaje = new Date();

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"366C49E8-CE79-450B-B228-4F2965EAAF22",variableType:4}
 */
var f_eges_canti_codpres = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5E2D9419-FB59-4CAD-96C4-F89FC265CA20"}
 */
var f_eges_estadomensaje = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"855200B6-B6C3-49BB-A47C-34B4A8F38369",variableType:4}
 */
var f_eges_autori = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CDD99E0E-58E2-4D44-9D2B-56B4CF50680A"}
 */
var f_eges_email = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CE61133C-B02B-44EC-8E9F-265D5CE5EC7A"}
 */
var f_eges_plan = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"97C64C13-463A-4D3B-A908-6B1E60F4ACE5",variableType:4}
 */
var f_eges_cober = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"23E5DFC3-AA59-4AC2-9F91-4CDF0577A601"}
 */
var f_eges_sexo = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E94B8A8F-FB49-40B6-A79E-500DE1B652A1",variableType:4}
 */
var f_eges_fecnac = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AE34033E-BBA2-453A-BB1A-E650B33CE5B3"}
 */
var f_eges_modal = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B20AB670-F4D1-4F12-8E2F-C00164A725D2"}
 */
var f_eges_nrointer = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4DD9FED0-FAD8-4EC8-8588-07B4C547788E",variableType:4}
 */
var f_eges_numdoc = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"793716CE-AEAA-48AE-9191-848CAE2B6FB6",variableType:4}
 */
var f_eges_tipdoc = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"762CC280-1BC5-48ED-B445-E78C3D3C6634"}
 */
var f_eges_apellido = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9EFCEFBC-ECFB-498E-8B10-B95D67E3ACBE"}
 */
var f_eges_nombre = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F378AD98-8A9A-4D04-9364-B764F4D96040",variableType:8}
 */
var f_eges_histcli = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"94BE7ACC-7793-49F8-9464-A4B54D90F26A",variableType:4}
 */
var f_eges_servi = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2BBDC376-D921-4F8A-A07A-B6519E7E24DD"}
 */
var f_eges_hortur = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4E0DF2C2-77AA-4425-941E-0E3A6B36DC4A"}
 */
var f_eges_fectur = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"116A9F01-C833-46F7-A927-3BFFC4F4DFEC"}
 */
var f_eges_motfun = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"903E866A-82CF-44C2-A8CC-02D05D7DEBFC"}
 */
var f_eges_diagno = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7BB41BDD-8B30-4CAD-B5AC-E97EDF81086F"}
 */
var f_eges_matmedsol = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8E09208C-4B38-4DAA-A5A7-FB00C9111F67"}
 */
var f_eges_aynmedsol = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A57310CC-8603-4B63-8BB6-F745B92F65FD"}
 */
var f_eges_habcam = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"60484020-A6C9-46E8-A851-875D8A368D23"}
 */
var f_eges_sector = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"44533430-B02F-422B-82E5-A56E1F43B0DA"}
 */
var f_eges_fehocre = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"50509F19-0321-4F8B-BAE8-72BC9A6811BA"}
 */
var f_eges_esthor = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"99688E73-AF58-4B9F-9A65-DF5BF497EBA5"}
 */
var f_eges_estfec = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B0A057E8-E832-4BB9-B189-853E29F4732A",variableType:4}
 */
var f_eges_ipednroi = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2A2A412B-88F9-411A-9225-E33CA68D708E",variableType:4}
 */
var f_eges_idmsj = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"16B7D42B-06D9-46A9-9E50-B26C845475E5"}
 */
var f_eges_tipomsj = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B63BA51E-A4F1-4808-A016-7176FC92749A"}
 */
var f_eges_fechor = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3A7EF06C-095E-4332-98D3-D5F18824DF7E"}
 */
var $_msgSMS = '';

/**
 * @properties={typeid:35,uuid:"5AAF9FF5-1FBF-4F8F-9C99-A6147F4E858B",variableType:-4}
 */
var $_listNumberSMS = new Array();

/**
 * @properties={typeid:35,uuid:"D843762E-BB66-4AD0-9BBB-E67B7F965EC7",variableType:-4}
 */
var $_wtrau = false;

/**
 * @properties={typeid:35,uuid:"DB150300-F55E-416A-9AC2-3646DA9ADB00",variableType:-4}
 */
var $_wsele = false;

/**
 * @properties={typeid:35,uuid:"86924098-7889-43A5-AE3A-5452508984E7",variableType:-4}
 */
var $_isUserOSTEE = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"39630DE8-2259-413C-BBE9-145F1CDC38E1",variableType:4}
 */
var $_countChange = 1;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3A4555B1-0376-4154-A410-4703A3789EC1"}
 */
var f_habita = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"20AC0486-2D3F-4738-8120-2522AFC3EE56"}
 */
var f_cama = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"94083C73-3682-4D5D-B367-71D3E551A4E0",variableType:4}
 */
var f_sexo = null;

/**
 * @properties={typeid:35,uuid:"929AAC1D-9C7D-4D68-85A0-6E3B6C17C1FD",variableType:-4}
 */
var f_cerrarForm = false;

/**
 * @properties={typeid:35,uuid:"9F8164A7-22B7-4C2A-817A-13B056B663F1",variableType:-4}
 */
var $isDirty = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0A4CD76C-0D70-4848-AC72-B23EED1501ED",variableType:4}
 */
var f_protocolo = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1AB3E040-4187-4437-AD6F-717CD6AAF142"}
 */
var $messageErrorInter = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"DC36D2C7-960D-4C3C-A963-EDCA0F12A74C"}
 */
var f_medico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BB01ED6B-31B7-4985-87C0-B0493A932947"}
 */
var f_edad = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BA0D5A02-9B2E-41BB-BD72-7E5A0C063518"}
 */
var f_cobertura = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B4478212-514C-4A97-A33E-67F1447AD2E0"}
 */
var f_histClinUnica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"753E4BDD-223E-4B6F-A1BC-7403215D6B69"}
 */
var f_paciente = null;

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4B1E1418-A1FE-4733-A2DC-107A5EFD1F78"}
 */
function onShow_inicializarForm(firstShow, event) {

	//initFormFirstShow();
	elements.txt_paciente.requestFocus(); 
}

/**
 * @properties={typeid:24,uuid:"753FC5B8-7DEB-42CA-A619-CD1617303120"}
 */
function mostrarRecordatorio() {

	var texto = "Resulta Indispensable, con el fin de evitar inconvenientes" + "\n legales, NO utilizar Abreviaturas, EVITAR faltas de ortografia" + "\n y señalar puntualmente localizaciones, utilizando superior," + "\n inferior, derecho, izquierdo, distal, proximal, etc." + "\n y llenar todos los espacios de la historia clinica de ingreso" + "\n a guardia." + "\n Recuerde que debe firmar y sellar la impresión de la H.Clin."
	globals.DIALOGS.showInfoDialog("Recordatorio", texto, "Aceptar");
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"A038B895-72A5-49C2-A09E-EA640B34FFE2"}
 */
function onAction_btnBuscarPaciente(event) {

	globals.Hcipiso_eventSourceButton = 1;
	openSearch();
}

/**
 * @properties={typeid:24,uuid:"78873DE9-D736-4CB7-BEB2-2AE5AA0D5073"}
 */
function openSearch() {

	var win2 = application.createWindow("seleccion_internado", JSWindow.MODAL_DIALOG);
	win2.title = 'Búsqueda de Pacientes Internados';
	win2.resizable = false;
	win2.show(forms.Hcipiso_dlg_buscar_internado);

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EEF30012-5BFF-47FA-87C6-31F83CD715EE"}
 */
function onAction_txtBusquedaRapida(event) {

	if(elements.txt_paciente.editable){
		
		globals.Hcipiso_hisclistrynro = f_paciente;
		if (globals.Hcipiso_hisclistrynro != '' && globals.Hcipiso_hisclistrynro != null) {
			globals.Hcipiso_eventSourceButton = 0;
			openSearch();
			//$isDirty = true;
		} else {
			globals.DIALOGS.showWarningDialog("Atención", 'Debe ingresar Nro. de paciente o apellido.', "Aceptar")
		}
	}
}

/**
 * @properties={typeid:24,uuid:"168B410C-6483-4407-A933-6CF053474536"}
 */
function pacienteSeleccionadoInter() {

	if(isValidDatosPacienteInter()){
		
		editablePaciente(false);
		$isDirty = true;
		f_paciente = hcipiso_numero_to_tbc_admision.hiscli2_hcipiso + ' ' + utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_apelnom);
		f_histClinUnica = hcipiso_numero_to_tbc_admision.adm_histclinuni;
		f_sexo = hcipiso_numero_to_tbc_admision.adm_sexo;
		f_edad = globals.CalculoEdad(hcipiso_numero_to_tbc_admision.adm_fecnac) + ' ' + globals.vTipoEdad;
		f_habita = hcipiso_numero_to_tbc_admision.adm_habita;
		f_cama = hcipiso_numero_to_tbc_admision.adm_cama;
		globals.Hcipiso_obrCodigo = hcipiso_numero_to_tbc_admision.adm_obrsoc;
		f_cobertura = utils.stringTrim(hcipiso_rel_buscar_obrasocial.obr_razonsoc);
		//forms.Anatpa_frm_anatpaca.f_plan = utils.stringTrim(foundset.adm_planobr);
		
		var espeMed = globals.Hcipiso_vEspeMed;
		if(hcipiso_rel_buscar_obrasocial.obr_codigo == 1132 && (espeMed == 224 || espeMed == 88 || espeMed == 18 || espeMed == 250 || espeMed == 279 || espeMed == 301)){
			$_wsele = true;
			$_wtrau = true;
		}
		
		// espami [1:pami 2:osecac 3:otro]	obr_codigo:1132 ostee
		if(hcipiso_rel_buscar_obrasocial.obr_espami != 2 &&  hcipiso_rel_buscar_obrasocial.obr_codigo != 1132){
			$_wsele = true;
			if(espeMed == 224 || espeMed == 88 || espeMed == 18 || espeMed == 250 || espeMed == 279 || espeMed == 301){
				$_wtrau = true;
			}
		}
		
		globals.Hcipiso_hiiHisCli = hcipiso_numero_to_tbc_admision.adm_histclin;
		
		globals.Hcipiso_histClinAsist = hcipiso_numero_to_tbc_admision.adm_histclin;
		var fechaIngreso = hcipiso_numero_to_tbc_admision.adm_fecing.toString().substr(6, 2) + "/" + hcipiso_numero_to_tbc_admision.adm_fecing.toString().substr(4, 2) + "/" + hcipiso_numero_to_tbc_admision.adm_fecing.toString().substr(0, 4);
		var hora = convertNumberToHour_HHMM(hcipiso_numero_to_tbc_admision.adm_horing);
		var horaAux = hora.split(':')
		var fechaDesde = globals.IntegerToDate(hcipiso_numero_to_tbc_admision.adm_fecing);
		fechaDesde.setHours(Number(horaAux[0]), Number(horaAux[1]));
		//var fechaActual = utils.timestampToDate(application.getServerTimeStamp());
		var fechaActual = application.getServerTimeStamp();
		var dias = contar_dias(fechaDesde, fechaActual);
		var info = "Ingresó al Sanatorio : " + fechaIngreso + "  " + globals.Hcipiso_convertNumberToHour_HHMM(String(hcipiso_numero_to_tbc_admision.adm_horing)) + " Hrs.   " + dias + " días de Internado" + "\nDomicilio : " + utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_domicilio) + "\nT.E. : " + utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_telefefono);
		if (hcipiso_rel_buscar_hciint.getSize() == 0)
			info += "\n\nHistoria Clinica de Ingreso, aún no ha sido Confeccionada.";
		info += "\n¿Confirma paciente?";
		var res = globals.DIALOGS.showQuestionDialog('¡Atención!', info, 'Si', 'No');
		
		if (res == 'Si') {
			
			var bloqueado = globals.AsistFunciones_isRegisterTableLocked(application.getSolutionName(),controller.getName(),hcipiso_numero_to_tbc_admision.adm_histclin.toString(),globals.Hcipiso_vLega.toString(),"Historia Clinica");
			if(!bloqueado){
				
				if(hcipiso_rel_buscar_hciint.getSize() > 1){
					
					var win2 = application.createWindow("seleccion_hciint", JSWindow.MODAL_DIALOG);
					win2.title = 'Historias clínicas de Ingreso';
					win2.resizable = false;
					win2.show(forms.Hcipiso_dlg_buscar_hciint);
				}
				else{
					
					if(hcipiso_rel_buscar_hciint.getSize() == 1){
						
						globals.Hcipiso_fechaHciint = hcipiso_rel_buscar_hciint.hiifecha;
						globals.Hcipiso_horaHciint = hcipiso_rel_buscar_hciint.hiihora;
						
					}
					
					loadHciint();
				}
			}
			else{
				limpiarForm();
			}
		} 
		else{
			
			limpiarForm();
		}	
	}
	else{
		
		elements.txt_paciente.requestFocus();
	}
}

/**
 * @properties={typeid:24,uuid:"DDD61BF0-E450-4D44-A983-B065C0BC94F5"}
 * @AllowToRunInFind
 */
function loadHciint() {
	
	// Existe historia clinica de ingreso a piso para el paciente seleccionado
	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.getSize() > 0) {
		
		hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 = 0;
		hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 = 0;
		hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 = 0;
		hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 = 0;
		
		globals.Hcipiso_fechaTxt = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha;
		globals.Hcipiso_horaTxt = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora;
		globals.Hcipiso_grupoTxt = 1;
		
		if (hcipiso_rel_hciinttxt.getSize() > 0) {

			// cargar informes de Postgres
			globals.Hcipiso_itemTxt = 1;
			forms.Hcipiso_txt_motivo_ingreso.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 2;
			forms.Hcipiso_txt_antec_familiar.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 4;
			forms.Hcipiso_txt_antec_enfermedad.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 5;
			forms.Hcipiso_txt_medicacion_toma.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 6;
			forms.Hcipiso_txt_examen_fisico.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 7;
			forms.Hcipiso_txt_cabeza_cuello.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 8;
			forms.Hcipiso_txt_respiratorio.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 9;
			forms.Hcipiso_txt_cardiovascular.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 10;
			forms.Hcipiso_txt_abdominal.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 11;
			forms.Hcipiso_txt_neurológico.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 12;
			forms.Hcipiso_txt_urogenital.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 13;
			forms.Hcipiso_txt_osteo_articular.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 14;
			forms.Hcipiso_txt_laboratorio.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 15;
			forms.Hcipiso_txt_imagenes.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 16;
			forms.Hcipiso_txt_tratamiento_ingreso.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 17;
			forms.Hcipiso_txt_interconsulta.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

			globals.Hcipiso_itemTxt = 18;
			forms.Hcipiso_txt_observacion.f_informe = hcipiso_rel_buscar_hciinttxt.linea;

		} else {
			//cargar informes de Relativity
			var sqlInfo = "select HiinxItem,HiinxSec,HiinxLinea from tbc_hciinttxt" 
						+ " where HiinxHiscli = " + hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihiscli 
						+ " and HiinxFecha = " + hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha
						+ " and HiinxHora = " + hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora
						+ " and HiinxGrupo = 1" 
						+ " order by HiinxItem, HiinxSec";
			var ds_info = databaseManager.getDataSetByQuery("asistencial", sqlInfo, null, -1);

			var i;

			for (i = 1; i <= ds_info.getMaxRowIndex(); i++) {

				if (ds_info.getValue(i, 1) == 1){
					
					if(utils.stringTrim(forms.Hcipiso_txt_motivo_ingreso.f_informe).length == 0)
						forms.Hcipiso_txt_motivo_ingreso.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_motivo_ingreso.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 2){
					
					if(utils.stringTrim(forms.Hcipiso_txt_antec_familiar.f_informe).length == 0)
						forms.Hcipiso_txt_antec_familiar.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_antec_familiar.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}
					
				if (ds_info.getValue(i, 1) == 4){
					
					if(utils.stringTrim(forms.Hcipiso_txt_antec_enfermedad.f_informe).length == 0)
						forms.Hcipiso_txt_antec_enfermedad.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_antec_enfermedad.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 5){
					
					if(utils.stringTrim(forms.Hcipiso_txt_medicacion_toma.f_informe).length == 0)
						forms.Hcipiso_txt_medicacion_toma.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_medicacion_toma.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 6){
					
					if(utils.stringTrim(forms.Hcipiso_txt_examen_fisico.f_informe).length == 0)
						forms.Hcipiso_txt_examen_fisico.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_examen_fisico.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 7){
					
					if(utils.stringTrim(forms.Hcipiso_txt_cabeza_cuello.f_informe).length == 0)
						forms.Hcipiso_txt_cabeza_cuello.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_cabeza_cuello.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 8){
					
					if(utils.stringTrim(forms.Hcipiso_txt_respiratorio.f_informe).length == 0)
						forms.Hcipiso_txt_respiratorio.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_respiratorio.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 9){
					
					if(utils.stringTrim(forms.Hcipiso_txt_cardiovascular.f_informe).length == 0)
						forms.Hcipiso_txt_cardiovascular.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_cardiovascular.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 10){
					
					if(utils.stringTrim(forms.Hcipiso_txt_abdominal.f_informe).length == 0)
						forms.Hcipiso_txt_abdominal.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_abdominal.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 11){
					
					if(utils.stringTrim(forms.Hcipiso_txt_neurológico.f_informe).length == 0)
						forms.Hcipiso_txt_neurológico.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_neurológico.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 12){
					
					if(utils.stringTrim(forms.Hcipiso_txt_urogenital.f_informe).length == 0)
						forms.Hcipiso_txt_urogenital.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_urogenital.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 13){
					
					if(utils.stringTrim(forms.Hcipiso_txt_osteo_articular.f_informe).length == 0)
						forms.Hcipiso_txt_osteo_articular.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_osteo_articular.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 14){
					
					if(utils.stringTrim(forms.Hcipiso_txt_laboratorio.f_informe).length == 0)
						forms.Hcipiso_txt_laboratorio.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_laboratorio.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 15){
					
					if(utils.stringTrim(forms.Hcipiso_txt_imagenes.f_informe).length == 0)
						forms.Hcipiso_txt_imagenes.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_imagenes.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 16){
					
					if(utils.stringTrim(forms.Hcipiso_txt_tratamiento_ingreso.f_informe).length == 0)
						forms.Hcipiso_txt_tratamiento_ingreso.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_tratamiento_ingreso.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 17){
					
					if(utils.stringTrim(forms.Hcipiso_txt_interconsulta.f_informe).length == 0)
						forms.Hcipiso_txt_interconsulta.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_interconsulta.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}

				if (ds_info.getValue(i, 1) == 18){
					
					if(utils.stringTrim(forms.Hcipiso_txt_observacion.f_informe).length == 0)
						forms.Hcipiso_txt_observacion.f_informe += utils.stringTrim(ds_info.getValue(i, 3));
					else
						forms.Hcipiso_txt_observacion.f_informe += '\n' + utils.stringTrim(ds_info.getValue(i, 3));
				}
			}
		}

		// las Alertas se cargan automaticamente al estar definida como relacion
		if (hcipiso_rel_alerta.getSize() == 0) {

			hcipiso_rel_alerta.newRecord();
			inicializarRelacionAlert();
		}
		//plugins.dialogs.showInfoDialog("editableSolicitudAutomatica(false) 1","false")
		editableSolicitudAutomatica(false);
		$isDirty = false;
		//hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicama = hcipiso_numero_to_tbc_admision.adm_cama;
		//hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihabi = hcipiso_numero_to_tbc_admision.adm_habita;

	} 
	else {
		globals.Hcipiso_hiiHisCli = 0;
		globals.Hcipiso_fechaHciint = 0;
		globals.Hcipiso_horaHciint = 0;
		hcipiso_rel_tbc_hciint_to_tbc_hciint.newRecord();
		inicializarRelacionHcint();

		hcipiso_rel_alerta.newRecord();
		inicializarRelacionAlert();
		//plugins.dialogs.showInfoDialog("$_wsele",$_wsele)
		editableSolicitudAutomatica($_wsele);
		if($_wsele){
			hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 = 1;
		}
	}

	visibleBody(true);
	elements.txt_frecuencia.requestFocus();
	
}

/**
 * @properties={typeid:24,uuid:"D7E088F5-B129-4B51-85CE-AA4FB76A38C1"}
 */
function isValidDatosPacienteInter() {

	var isValid = true;
	$messageErrorInter = '';

	if($_isUserOSTEE){
		 if(hcipiso_numero_to_tbc_admision.adm_obrsoc != 1132){
			 $messageErrorInter += "\nEl paciente NO corresponde a OSTEE.";
			 isValid = false;
		 }
	 }
	 
	 if(!isValid){
		 globals.DIALOGS.showWarningDialog("Atención!", $messageErrorInter, "Aceptar")
	 }
	
	return isValid;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param value
 *
 * @properties={typeid:24,uuid:"EF32DD00-6D0B-4553-B4E0-61C70B579B7B"}
 */
function editablePaciente(value) {
	elements.txt_paciente.editable = value;
	elements.btn_buscarPaciente.enabled = value;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"00C0851D-346C-4348-8E3A-F8B1A8DD2577"}
 * @AllowToRunInFind
 */
function onAction_btnNuevo(event) {
	
	//application.output( globals.ControlCodobra(0,2,1,1,170101,1920,'B SOCIAL'));
	//enviarEmail("MANZOLINO PEDRO","00185-00","E.C.G",0,4,0);
	//generarInterconsultaTraumato(20180118,1700);
	//enviarEmailInterconsulta(380436,20180124,843);
	//enviarSMSinterconsulta();
	//generarLaboratorio();
	//generarCoagulograma();
	//globals.AsistFunciones_isRegisterTableLocked(application.getSolutionName(),controller.getName(),"25","91576","Historia Clinica");
	//globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),"2523670","9157","Historia Clinica");
	
	var limpiar = false;
	if ($isDirty) {
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!', 'Existen datos que no han sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No');
		if (respuesta == 'Si')
			limpiar = true;
	} else {
		limpiar = true;
	}

	if (limpiar) {
		
		globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),hcipiso_numero_to_tbc_admision.adm_histclin.toString(),globals.Hcipiso_vLega.toString(),"Historia Clinica");
		limpiarForm();
	}
}

/**
 * @properties={typeid:24,uuid:"6E4CFFF9-A4A1-48BC-94B1-8E335DBC993F"}
 */
function limpiarForm() {

	databaseManager.revertEditedRecords();

	inicializarForm();

	elements.txt_paciente.requestFocus();
	//elements.txt_paciente.requestFocus();
	$isDirty = false;

}

/**
 * @properties={typeid:24,uuid:"00D09F43-C73B-48DF-A514-64FDE37AF6D4"}
 */
function inicializarForm() {

	f_histClinUnica = null;
	f_paciente = null;
	f_cobertura = null;
	f_protocolo = null;
	f_edad = null;
	f_sexo = null;
	f_cerrarForm = false;
	//f_medico = null;
	f_habita = null;
	f_cama = null;
	$_countChange = 1;
	$_wsele = false;
	$_wtrau = false;
	$_msgSMS = "";
	$_listNumberSMS = new Array();
	
	elements.lbl_procesando.visible = false;
	application.updateUI();

	// SEGUIR ADEMAS LIMPIAR LAS VARIABLES GLOBALES ANALIZAR CUALES.

	forms.Hcipiso_txt_abdominal.f_informe = null;
	forms.Hcipiso_txt_antec_enfermedad.f_informe = null;
	forms.Hcipiso_txt_antec_familiar.f_informe = null;
	forms.Hcipiso_txt_cabeza_cuello.f_informe = null;
	forms.Hcipiso_txt_cardiovascular.f_informe = null;
	forms.Hcipiso_txt_examen_fisico.f_informe = null;
	forms.Hcipiso_txt_imagenes.f_informe = null;
	forms.Hcipiso_txt_interconsulta.f_informe = null;
	forms.Hcipiso_txt_laboratorio.f_informe = null;
	forms.Hcipiso_txt_medicacion_toma.f_informe = null;
	forms.Hcipiso_txt_motivo_ingreso.f_informe = null;
	forms.Hcipiso_txt_neurológico.f_informe = null;
	forms.Hcipiso_txt_observacion.f_informe = null;
	forms.Hcipiso_txt_osteo_articular.f_informe = null;
	forms.Hcipiso_txt_respiratorio.f_informe = null;
	forms.Hcipiso_txt_tratamiento_ingreso.f_informe = null;
	forms.Hcipiso_txt_urogenital.f_informe = null;

	globals.Hcipiso_hisclin = 0;
	globals.Hcipiso_hisclistrynro = '';
	globals.Hcipiso_hiiHisCli = 0;
	globals.Hcipiso_itemTxt = 0;
	globals.Hcipiso_obrCodigo = 0;
	globals.Hcipiso_patDataProvider = '';
	globals.Hcipiso_histClinAsist = 0;
	globals.Hcipiso_fechaHciint = 0;
	globals.Hcipiso_horaHciint = 0;
	globals.Hcipiso_servCodigo = 0;
	globals.Hcipiso_ipedPedido = 0;
	globals.Hcipiso_ipedServicio = 0;
	globals.Hcipiso_camCama = '';
	globals.Hcipiso_camHabita = 0;
	
	visibleBody(false);
	editablePaciente(true);
}

/**
 * TODO generated, please specify type and doc for the params
 * @param value
 *
 * @properties={typeid:24,uuid:"F9E25099-287B-44F6-A884-273A82D205F2"}
 */
function visibleBody(value) {

	elements.tab_informe_1.visible = value;
	elements.tab_informe_2.visible = value;
	elements.shs_informe.visible = value;

	if (value) {
		elements.tab_informe_1.tabIndex = 1;
		elements.tab_informe_2.tabIndex = 1;
	}
	elements.grp_diagnostico.visible = value;
	elements.grp_signovitale.visible = value;
	elements.grp_solicitud.visible = value;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Boolean} value
 *
 * @properties={typeid:24,uuid:"381DD4E5-0211-4037-9B9C-4118717255F7"}
 */
function editableSolicitudAutomatica(value){
	
	elements.grp_solicitud.enabled = value;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"2B80396D-D7B3-456E-823E-BFD9CB470E40"}
 * @AllowToRunInFind
 */
function onAction_btnGuardar(event) {

	var res = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿ Esta seguro que desea guardar la historia clínica de ingreso a piso ?', 'Si', 'No');
	if (res == 'Si') {

		if ($isDirty) {

			if (isValidDataForm()) {

				if (isValidData()) {
					
					var fecha = 0;
					var hora = 0;
					var nuevoHciint = false;
					
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha == 0) {
						
						nuevoHciint = true;
						fecha = utils.stringToNumber(globals.CapturaFechaSistema());
						hora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));

						// Completando cabecera
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihiscli = hcipiso_numero_to_tbc_admision.adm_histclin;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha = fecha;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora = hora;

						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitipomed = globals.Hcipiso_vTipoOperador;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiilegajomed = globals.Hcipiso_vLega;

						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha2 = fecha;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora2 = hora;

						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiapyno = utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_apelnom);
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihabi = hcipiso_numero_to_tbc_admision.adm_habita;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicama = hcipiso_numero_to_tbc_admision.adm_cama;

						hcipiso_rel_alerta.aler_histclin = hcipiso_numero_to_tbc_admision.adm_histclin;
						hcipiso_rel_alerta.aler_tipadmi = 0;
						hcipiso_rel_alerta.aler_tipoper = globals.Hcipiso_vTipoOperador;
						hcipiso_rel_alerta.aler_codoper = globals.Hcipiso_vLega;
						
						// Pedidos especiales
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiseleccion = $_wsele == true ? 'S' : 'N';
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitraumato = $_wtrau == true ? 'S' : 'N';
						
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 == 1 ? 2 : 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 == 1 ? 2 : 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 == 1 ? 2 : 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 == 1 ? 2 : 0;

					}
					else{
						fecha = utils.stringToNumber(globals.CapturaFechaSistema());
						hora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
					}
					
					// completando referencia a informes
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimotivo = utils.stringTrim(forms.Hcipiso_txt_motivo_ingreso.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesgrales = utils.stringTrim(forms.Hcipiso_txt_antec_familiar.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesactual = utils.stringTrim(forms.Hcipiso_txt_antec_enfermedad.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimedicacionactual = utils.stringTrim(forms.Hcipiso_txt_medicacion_toma.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiexamenfisico = utils.stringTrim(forms.Hcipiso_txt_examen_fisico.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicabezaycuello = utils.stringTrim(forms.Hcipiso_txt_cabeza_cuello.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiirespiratorio = utils.stringTrim(forms.Hcipiso_txt_respiratorio.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicardiovascular = utils.stringTrim(forms.Hcipiso_txt_cardiovascular.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiabdominal = utils.stringTrim(forms.Hcipiso_txt_abdominal.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiineurologico = utils.stringTrim(forms.Hcipiso_txt_neurológico.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiurogenital = utils.stringTrim(forms.Hcipiso_txt_urogenital.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiosteoarticular = utils.stringTrim(forms.Hcipiso_txt_osteo_articular.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiilaboratorio = utils.stringTrim(forms.Hcipiso_txt_laboratorio.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiimagenes = utils.stringTrim(forms.Hcipiso_txt_imagenes.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitratamiento = utils.stringTrim(forms.Hcipiso_txt_tratamiento_ingreso.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiinterconsultas = utils.stringTrim(forms.Hcipiso_txt_interconsulta.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiobservaciones = utils.stringTrim(forms.Hcipiso_txt_observacion.f_informe).length > 0 ? 1 : 0;
					hcipiso_rel_tbc_hciint_to_tbc_hciint.hiialertas = tieneAlertas() == true ? 1 : 0;

					// Actualizando base de datos
					var resultSave = databaseManager.saveData(hcipiso_rel_tbc_hciint_to_tbc_hciint.getRecord(1));
					if(resultSave && nuevoHciint){
						
						globals.Hcipiso_hiiHisCli = hcipiso_numero_to_tbc_admision.adm_histclin;
						globals.Hcipiso_fechaHciint = fecha;
						globals.Hcipiso_horaHciint = hora;
					}
					
					// Guardando informes
					var itemHistClin = hcipiso_numero_to_tbc_admision.adm_histclin;
					var itemFecha = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha;
					var itemHora = hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora;
					var itemGrupo = 1;

					// Informe Motivo de ingreso
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimotivo == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 1, forms.Hcipiso_txt_motivo_ingreso.f_informe);

					// Antec.Fam.y Pers.Grales.
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesgrales == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 2, forms.Hcipiso_txt_antec_familiar.f_informe);

					// Antec.de Enfermedad Actual
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesactual == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 4, forms.Hcipiso_txt_antec_enfermedad.f_informe);

					// Medicacion que toma actualm.
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimedicacionactual == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 5, forms.Hcipiso_txt_medicacion_toma.f_informe);

					// Examen Fisico
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiexamenfisico == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 6, forms.Hcipiso_txt_examen_fisico.f_informe);

					// Cabeza y Cuello
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicabezaycuello == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 7, forms.Hcipiso_txt_cabeza_cuello.f_informe);

					// Respiratorio
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiirespiratorio == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 8, forms.Hcipiso_txt_respiratorio.f_informe);

					// Cardiovascular
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicardiovascular == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 9, forms.Hcipiso_txt_cardiovascular.f_informe);

					// Abdominal
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiabdominal == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 10, forms.Hcipiso_txt_abdominal.f_informe);

					// Neurologico
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiineurologico == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 11, forms.Hcipiso_txt_neurológico.f_informe);

					// Urogenital
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiurogenital == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 12, forms.Hcipiso_txt_urogenital.f_informe);

					// Osteo Articular
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiosteoarticular == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 13, forms.Hcipiso_txt_osteo_articular.f_informe);

					// Laboratorio
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiilaboratorio == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 14, forms.Hcipiso_txt_laboratorio.f_informe);

					// Imagenes
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiimagenes == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 15, forms.Hcipiso_txt_imagenes.f_informe);

					// Tratamiento de Ingreso
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitratamiento == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 16, forms.Hcipiso_txt_tratamiento_ingreso.f_informe);

					// Interconsultas
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiinterconsultas == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 17, forms.Hcipiso_txt_interconsulta.f_informe);

					// Observaciones
					if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiobservaciones == 1 && resultSave)
						resultSave = guardarTexto(itemHistClin, itemFecha, itemHora, itemGrupo, 18, forms.Hcipiso_txt_observacion.f_informe);

					// Guardando alertas
					if (hcipiso_rel_alerta.aler_histclin == 0) {
						hcipiso_rel_alerta.aler_histclin = hcipiso_numero_to_tbc_admision.adm_histclin;
						hcipiso_rel_alerta.aler_tipadmi = 0;
						hcipiso_rel_alerta.aler_tipoper = globals.Hcipiso_vTipoOperador;
						hcipiso_rel_alerta.aler_codoper = globals.Hcipiso_vLega;
						
					}
					
					resultSave = databaseManager.saveData(hcipiso_rel_alerta.getRecord(1));
					
					// Pedidos Especiales
					
					// (Paciente ostee y determinada especialidad medica) o (paciene distinto a osecac y  paciente distinto a ostee)
					if($_wsele && resultSave){
						
						//Electrocardiograma
						if(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 == 2)
							generarImagen(12,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora);
						
						//Rx
						if(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 == 2)
							generarImagen(1,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora);
						
						//Laboratorio
						if(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 == 2)
							generarLaboratorio();
						else{
							
							//Pac. Quirug.
							if(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 == 2)
								generarCoagulograma();
						}
					}
					//plugins.dialogs.showInfoDialog("genera Interconsultas",fecha + " "+ $_wtrau +" "+resultSave)
					// (paciente ostee y determinada especialidad) o (pacientes distinto a osecac y paciente distinto a ostee y determinada espeialidad medica)
					if($_wtrau && resultSave){
						
						generarInterconsultaCardio(fecha,hora);
						generarInterconsultaTraumato(fecha,hora);
						
					}
					
					if (resultSave == true) {

						//databaseManager.commitTransaction();
						globals.DIALOGS.showInfoDialog("Resultado", "La historia clínica de ingreso a piso se guardó correctamente.", "Aceptar");
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 = 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 = 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 = 0;
						hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 = 0;

						editablePaciente(false);
						editableSolicitudAutomatica(false);

						var print = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿Desea imprimir la historia clínica de ingreso a piso?', 'Si', 'No');
						if (print == 'Si') {
							imprimir(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihiscli, hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha, hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora);
						}

						$isDirty = false;
					} else {
						var error1 = ''
						var error2 = ''
						var array = databaseManager.getFailedRecords()
						for (var i = 0; i < array.length; i++) {
							var record = array[i];
							var jstable = databaseManager.getTable(record);
							var tableSQLName = jstable.getSQLName();
							error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
							error2 = 'Error en grabación ' + record.exception;
							if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
								// exception thrown in pre-insert/update/delete event method
								var thrown = record.exception.getValue()
								//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
							}
						}

						//databaseManager.rollbackTransaction()

						if (error1 != '') {
							globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
							globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error1, "Aceptar")
							globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error2, "Aceptar")
						}
						globals.DIALOGS.showErrorDialog("Error en grabación", "Se ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
					}
				}
			}
		} else {
			globals.DIALOGS.showWarningDialog("Atención!", "No hay datos para guardar.", "Aceptar")
			elements.txt_paciente.requestFocus();
		}
	} else
		elements.txt_paciente.requestFocus();
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} histClin
 * @param {Number} fecha
 * @param {Number} hora
 * @param {Number} grupo
 * @param {Number} item
 * @param {String} texto
 *
 * @properties={typeid:24,uuid:"B614F93F-BB4E-4F7D-AEAB-62772C1D509D"}
 */
function guardarTexto(histClin, fecha, hora, grupo, item, texto) {

	globals.Hcipiso_itemTxt = item;
	if (hcipiso_rel_buscar_hciinttxt.getSize() == 0) {

		hcipiso_rel_buscar_hciinttxt.newRecord();
		hcipiso_rel_buscar_hciinttxt.histclinica = histClin;
		hcipiso_rel_buscar_hciinttxt.fecha = fecha;
		hcipiso_rel_buscar_hciinttxt.hora = hora;
		hcipiso_rel_buscar_hciinttxt.grupo = grupo;
		hcipiso_rel_buscar_hciinttxt.item = item;

	}

	hcipiso_rel_buscar_hciinttxt.linea = utils.stringTrim(texto);

	return databaseManager.saveData(hcipiso_rel_buscar_hciinttxt.getRecord(1));

}

/**
 * @properties={typeid:24,uuid:"665FBD03-74BD-4A60-B236-1F4E55B19BB5"}
 */
function isValidDataForm() {

	var isValid = true;
	var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
		//var borderError = 'LineBorder,1,#ff0000';
		//setDefaultBorderElements();

	if (f_histClinUnica == null) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar paciente.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiipulsocardiaco < 1) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar la Frecuencia del Pulso.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmax < 1) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar Tensión Arterial Máxima.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmin < 1) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar Tensión Arterial Mínima.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmin > hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmax) {
		//elements.txt_paciente.border = borderError;
		messageError += "\n La Tensión Arterial Mínima debe ser menor o igual a la Máxima.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitipotemperatura < 1) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe seleccionar Tipo Temperatura.";
		isValid = false;
	}

	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitemperatura < 1) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar valor de Temperatura.";
		isValid = false;
	}
	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1 > 0 &&  hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1 != null){
		globals.Hcipiso_diagno1=hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1
	}
	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1 < 1 || (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1 > 0 && hcipiso_gbl_diagno1_to_tbc_patologia.getSize() < 1)) {
		//elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar Diagnóstico.";
		isValid = false;
	}
	
	// validando longitud de texto
	var isValidText = true;
	var titulo = "";
	var tabIndex = 0;

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_motivo_ingreso.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(1);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_antec_familiar.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(2);
		isValidText = false;
	}
	/*
	if (isValidText && !tieneAlertas()) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(3);
		tabIndex = 3;
		isValidText = false;
	}
	*/
	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_antec_enfermedad.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(4);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_medicacion_toma.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(5);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_examen_fisico.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(6);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_cabeza_cuello.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(7);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_respiratorio.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(8);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_cardiovascular.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_1.getTabTextAt(9);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_abdominal.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(1);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_neurológico.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(2);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_urogenital.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(3);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_osteo_articular.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(4);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_laboratorio.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(5);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_imagenes.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(6);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_tratamiento_ingreso.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(7);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_interconsulta.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(8);
		isValidText = false;
	}

	if (isValidText && utils.stringTrim(forms.Hcipiso_txt_observacion.f_informe).length < 18) {
		//elements.txt_paciente.border = borderError;
		titulo += elements.tab_informe_2.getTabTextAt(9);
		isValidText = false;
	}

	if (!isValidText) {
		if (tabIndex == 3)
			messageError += "\nInforme : " + titulo + ". Debe seleccionar al menos un alerta.";
		else
			messageError += "\nInforme : " + titulo + ". Debe ingresar 17 caracteres como mínimo.";
		isValid = false;
	}

	if (!isValid) {
		globals.DIALOGS.showWarningDialog("¡Atención!", messageError, "Aceptar")
	}

	return isValid;
}

/**
 * @properties={typeid:24,uuid:"0832F0B8-8641-4D99-A418-43854F564758"}
 */
function isValidData() {

	var isValid = true;
	var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
		//var borderError = 'LineBorder,1,#ff0000';
		//setDefaultBorderElements();
		/*
	 if(isValid){

	 if(f_protocolo == null){

	 var res = globals.DIALOGS.showQuestionDialog('¡Atención!','¿ Desea Guardar Ingreso de Historia Clinica de Cirugia sin Protocolo ?', 'Si', 'No');
	 if( res == 'Si'){
	 }
	 else{

	 messageError += "\nHistoria Clinica de Cirugia sin Protocolo."
	 isValid = false;
	 }
	 }
	 }
	 else{
	 globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
	 elements.txt_paciente.requestFocus();
	 }
	 */
	return isValid;

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"28A80CA6-3E4B-40A3-BD6B-76C4D9DCDD9E"}
 */
function onAction_btnCerrar(event) {

	if ($isDirty) {
		if (globals.DIALOGS.showQuestionDialog('¡Atención!', 'Existen datos que no han sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			f_cerrarForm = true;
	} else {
		f_cerrarForm = true;
	}

	if (f_cerrarForm) {
		
		globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),hcipiso_numero_to_tbc_admision.adm_histclin.toString(),globals.Hcipiso_vLega.toString(),"Historia Clinica");
		var $win = application.getWindow(application.getActiveWindow().getName());
		if ($win != null) {
			$win.hide();
			$win.destroy();
		}
	}
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"D5E7CD1F-EA1B-4728-A846-6C6A491BA3D7"}
 */
function onHide_cerrarForm(event) {
	
	if(!f_cerrarForm)
		globals.DIALOGS.showInfoDialog("Atención","Para cerrar el programa debe presionar el botón Salir.","Aceptar")
	return f_cerrarForm;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"112367B8-AA9F-416A-9A7C-3F0C13613AC4"}
 */
function onAction_buscarPatologia_1(event) {

	globals.Hcipiso_patDataProvider = 'hiidiag1';
	openBuscarPatologia();

}

/**
 * @properties={typeid:24,uuid:"BAEA42DE-6F51-4396-9685-BC35216D740F"}
 */
function openBuscarPatologia() {

	var win2 = application.createWindow("seleccion_patologia", JSWindow.MODAL_DIALOG);
	win2.title = 'Búsqueda de Diagnóstico';
	win2.resizable = false;
	win2.show(forms.Hcipiso_dlg_buscar_patologia);

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"87FC2798-B0D8-4768-8EAD-EEB69D9E6AD0"}
 */
function onAction_buscarPatologia_2(event) {

	globals.Hcipiso_patDataProvider = 'hiidiag2';
	openBuscarPatologia();
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4E1480C7-911C-4A4C-AB01-DA9FFFDE88AB"}
 */
function onAction_buscarPatologia_3(event) {

	globals.Hcipiso_patDataProvider = 'hiidiag3';
	openBuscarPatologia();
}

/**
 * @properties={typeid:24,uuid:"793F37BC-1175-4FCD-90A7-29BFDA5DDE7A"}
 */
function inicializarRelacionHcint() {

	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihiscli = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiabdominal = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiialertas = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesactual = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiantecedentesgrales = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiapyno = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicabezaycuello = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicama = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiicardiovascular = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag1 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiidiag3 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiexamenfisico = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihabi = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_1 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_10 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_2 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_3 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_4 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_5 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_6 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_7 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_8 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyima_9 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_1 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_10 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_3 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_4 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_5 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_6 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_7 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_8 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyinter_9 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_1 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_10 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_3 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_4 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_5 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_6 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_7 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_8 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeylab_9 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_1 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_10 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_2 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_3 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_4 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_5 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_6 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_7 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_8 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihtkeyseg_9 = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiimagenes = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiinterconsultas = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiilaboratorio = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiilegajomed = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimedicacionactual = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiimotivo = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiineurologico = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiobservaciones = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiosteoarticular = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiipulsocardiaco = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiirespiratorio = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiseleccion = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitemperatura = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmax = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitensionmin = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitipomed = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitipotemperatura = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitratamiento = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitraumato = ' ';
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiiurogenital = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_1 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_2 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_3 = 0;
	hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 = 0;
}

/**
 * @properties={typeid:24,uuid:"5C6BA9EA-44BB-4AE4-A488-2BE0B380E708"}
 */
function inicializarRelacionAlert() {

	hcipiso_rel_alerta.aler_histclin = 0;
	hcipiso_rel_alerta.aler_tipadmi = 0;
	hcipiso_rel_alerta.aler_alergico = ' ';
	hcipiso_rel_alerta.aler_codoper = 0;
	hcipiso_rel_alerta.aler_filler = ' ';
	hcipiso_rel_alerta.aler_tipaler_1 = 0;
	hcipiso_rel_alerta.aler_tipaler_10 = 0;
	hcipiso_rel_alerta.aler_tipaler_11 = 0;
	hcipiso_rel_alerta.aler_tipaler_12 = 0;
	hcipiso_rel_alerta.aler_tipaler_13 = 0;
	hcipiso_rel_alerta.aler_tipaler_14 = 0;
	hcipiso_rel_alerta.aler_tipaler_15 = 0;
	hcipiso_rel_alerta.aler_tipaler_16 = 0;
	hcipiso_rel_alerta.aler_tipaler_17 = 0;
	hcipiso_rel_alerta.aler_tipaler_18 = 0;
	hcipiso_rel_alerta.aler_tipaler_19 = 0;
	hcipiso_rel_alerta.aler_tipaler_2 = 0;
	hcipiso_rel_alerta.aler_tipaler_20 = 0;
	hcipiso_rel_alerta.aler_tipaler_21 = 0;
	hcipiso_rel_alerta.aler_tipaler_22 = 0;
	hcipiso_rel_alerta.aler_tipaler_23 = 0;
	hcipiso_rel_alerta.aler_tipaler_24 = 0;
	hcipiso_rel_alerta.aler_tipaler_25 = 0;
	hcipiso_rel_alerta.aler_tipaler_3 = 0;
	hcipiso_rel_alerta.aler_tipaler_4 = 0;
	hcipiso_rel_alerta.aler_tipaler_5 = 0;
	hcipiso_rel_alerta.aler_tipaler_6 = 0;
	hcipiso_rel_alerta.aler_tipaler_7 = 0;
	hcipiso_rel_alerta.aler_tipaler_8 = 0;
	hcipiso_rel_alerta.aler_tipaler_9 = 0;
	hcipiso_rel_alerta.aler_tipoper = 0;

}

/**
 * @properties={typeid:24,uuid:"D19DEFE2-606A-4F7E-BF2E-268DEF2215B8"}
 */
function tieneAlertas() {

	var value = false;

	var dataprovidersNames = hcipiso_rel_alerta.alldataproviders;
	for (var i = 0; i < dataprovidersNames.length; i++) {
		if (hcipiso_rel_alerta[dataprovidersNames[i]] == 1) {
			value = true;
			break;
		}
	}

	return value;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Date} Fecha_Desde
 * @param {Date} Fecha_Hasta
 *
 * @properties={typeid:24,uuid:"77E05889-0C83-4B95-B809-F51FCDC379DA"}
 */
function contar_dias(Fecha_Desde, Fecha_Hasta) {
	// El hasta dede ser mayor al desde
	var $contar = 0;

	var $x = Fecha_Hasta - Fecha_Desde//diferencias entre dos dias y lo muestra en milisegundos
	var $un_dia = 1000 * 60 * 60 * 24 //ms * sec * min * hrs de un día
	var $dif_dias = $x / $un_dia //calcula la diferencia en días
		//$contar = Math.ceil($dif_dias )   //redondea
	//$contar = Math.round($dif_dias)
	$contar = Math.floor($dif_dias) //redondea

	return $contar
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} realValue
 *
 * @properties={typeid:24,uuid:"710D2FBF-940E-4F27-8C4D-B5EC2AAAB3C6"}
 */
function convertNumberToHour_HHMM(realValue) {

	var hora = "";
	if (realValue != null) {
		var value = realValue;
		if (value < 1) {
			hora = "00:00";
		} else {
			if (value < 10) {
				hora = "00:0" + value.toString().substr(0, 1);
			} else {
				if (value < 100) {
					hora = "00:" + value.toString().substr(0, 2);
				} else {
					if (value < 1000) {
						hora = "0" + value.toString().substr(0, 1) + ":" + value.toString().substr(1, 2);
					} else {
						if (value <= 2359) {
							hora = value.toString().substr(0, 2) + ":" + value.toString().substr(2, 2);
						}
					}
				}
			}
		}
	}

	return hora;
}

/**
 * Callback method when the user changes tab in a tab panel or divider position in split pane.
 *
 * @param {Number} previousIndex index of tab shown before the change
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"098B36FB-F569-43F8-A873-DE84102A6A14"}
 */
function onTabChange_informe_1(previousIndex, event) {

	//if($_countChange == 1)
	//validarInforme(previousIndex,elements.tab_informe_1.getName(),elements.tab_informe_1.getTabFormNameAt(previousIndex),elements.tab_informe_1.getTabTextAt(previousIndex));
	elements.tab_informe_1.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_1.setTabFGColorAt(elements.tab_informe_1.tabIndex, '#3336ff');
	
	if(elements.tab_informe_1.tabIndex == 1)
		forms.Hcipiso_txt_motivo_ingreso.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 2)
		forms.Hcipiso_txt_antec_familiar.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 3)
		forms.Hcipiso_txt_alerta.elements.chk_alergia.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 4)
		forms.Hcipiso_txt_antec_enfermedad.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 5)
		forms.Hcipiso_txt_medicacion_toma.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 6)
		forms.Hcipiso_txt_examen_fisico.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 7)
		forms.Hcipiso_txt_cabeza_cuello.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 8)
		forms.Hcipiso_txt_respiratorio.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 9)
		forms.Hcipiso_txt_cardiovascular.elements.hcicirtxt1.requestFocus();

}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} previousIndex
 * @param {String} tabName
 * @param {String} formName
 * @param {String} title
 *
 * @properties={typeid:24,uuid:"987E77E1-99DD-4E57-B047-9723132940C4"}
 */
function validarInforme(previousIndex, tabName, formName, title) {

	if (previousIndex != 3) {

		var isValid = true;
		if (utils.stringTrim(forms[formName].f_informe).length < 18)
			isValid = false;

		if (!isValid) {

			// Para evitar la recursividad
			$_countChange = 0;
			elements[tabName].tabIndex = previousIndex;

			var messageError = "";
			messageError += "Informe : " + title;
			messageError += "\n\n Dr.";
			messageError += "\nPor favor expláyese algo más."
			messageError += "\nResulta Indispensable, con el fin de evitar inconvenientes";
			messageError += "\nlegales, NO utilizar Abreviaturas."

			globals.DIALOGS.showWarningDialog("¡Atención!", messageError, "Aceptar");
			//forms[formName].controller.focusFirstField()
			$_countChange = 1;

		} else {
			//forms[formName].controller.focusFirstField();
			elements[tabName].setTabFGColorAt(previousIndex, '#000000');
			elements[tabName].setTabFGColorAt(elements[tabName].tabIndex, '#3336ff');

			$_countChange = 1;
		}
	} else {
		elements[tabName].setTabFGColorAt(previousIndex, '#000000');
		elements[tabName].setTabFGColorAt(elements[tabName].tabIndex, '#3336ff');
	}
}

/**
 * Callback method when the user changes tab in a tab panel or divider position in split pane.
 *
 * @param {Number} previousIndex index of tab shown before the change
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"8125FADC-300C-4596-A518-14AA20FB7360"}
 */
function onTabChange_informe_2(previousIndex, event) {

	//if($_countChange == 1)
	//validarInforme(previousIndex,elements.tab_informe_2.getName(),elements.tab_informe_2.getTabFormNameAt(previousIndex),elements.tab_informe_2.getTabTextAt(previousIndex));

	elements.tab_informe_2.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_2.setTabFGColorAt(elements.tab_informe_2.tabIndex, '#3336ff');
	
	if(elements.tab_informe_2.tabIndex == 1)
		forms.Hcipiso_txt_abdominal.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 2)
		forms.Hcipiso_txt_neurológico.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 3)
		forms.Hcipiso_txt_urogenital.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 4)
		forms.Hcipiso_txt_osteo_articular.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 5)
		forms.Hcipiso_txt_laboratorio.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 6)
		forms.Hcipiso_txt_imagenes.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 7)
		forms.Hcipiso_txt_tratamiento_ingreso.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 8)
		forms.Hcipiso_txt_interconsulta.elements.hcicirtxt1.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 9)
		forms.Hcipiso_txt_observacion.elements.hcicirtxt1.requestFocus();
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} histClin
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"FA163D90-B3F1-4F99-8894-7D678A57FD77"}
 */
function imprimir(histClin, fecha, hora) {

	forms.Hcipiso_print.imprimirHcipiso(histClin, fecha, hora)
	//forms.Hcipiso_print.controller.setPageFormat(210,297,10,10,10,10,1,0);
	//forms.Hcipiso_print.controller.print(false,false);
	/*
	 var win = application.createWindow("impri_paciente",JSWindow.MODAL_DIALOG);
	 win.title = "Impresion de Hitória Clínica";
	 win.resizable = false;
	 win.show(forms.Hcipiso_print)
	 */
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"A660CD38-C57C-4B03-9DA5-92C29DB081B9"}
 */
function onDataChange_txtField(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	return true
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"C30C4943-FD30-47AD-87C8-50BA6ED83C07"}
 */
function onDataChange_cboSelect(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	elements.txt_temperatura.requestFocus();
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"9F59D938-F548-4FF7-A41C-E741399569BD"}
 */
function onAction_imprimir(event) {
	
	if (hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha > 0) {
		
		if(!$isDirty){
			
			var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿Esta seguro que desea imprimir?', 'Si', 'No');
			if (respuesta == 'Si') {
				imprimir(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihiscli,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiifecha,hcipiso_rel_tbc_hciint_to_tbc_hciint.hiihora);
			}
		}
		else
			globals.DIALOGS.showInfoDialog("Atención", "No ha sido posible imprimir. Existen modificaciones pendientes para guardar.", "Aceptar")
	} else
		globals.DIALOGS.showWarningDialog("Atención!", "No existe una historia clínica de ingreso para imprimir.", "Aceptar");
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} servicio
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"73546DCE-D55F-4811-98FC-05FEC3BEDAF2"}
 * @AllowToRunInFind
 */
function generarImagen(servicio,fecha,hora) {
	
	var nroPedido = 0;
	var nroPedUnico = 0;
	var isValidSave = false;
	
	globals.Hcipiso_servCodigo = servicio;
	var modalidad = hcipiso_rel_buscar_servicio.servmodalidadvisual;
	var servCodAuto = hcipiso_rel_buscar_servicio.servcodauto;
	var completarNroPedidoUnico = false;
	if(utils.stringTrim(modalidad).length > 0){

		if((hcipiso_rel_buscar_obrasocial.obr_espami == 2 && hcipiso_rel_buscar_servicio.servcodigo != 6)  || (hcipiso_rel_buscar_obrasocial.obr_espami != 2 && servicio != 6)){
			
			completarNroPedidoUnico = true;
		}
	}
	
	if(servicio == 12)
		nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",21);
	
	if(servicio == 1)
		nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",20);
	
	if (nroPedido > 0) {
		
		hcipiso_rel_imapedi_new.newRecord();
		inicializarRelacionImapediNew();
		
		if(completarNroPedidoUnico)
			nroPedUnico = obtenerNumerador("parametros","param2","prm2_54","key_param2",1);
		
		// Completando imapedi
		hcipiso_rel_imapedi_new.ipedpedido = nroPedido;
		hcipiso_rel_imapedi_new.ipedservicio = servicio;
		hcipiso_rel_imapedi_new.ipedservicio1 = servicio;
		hcipiso_rel_imapedi_new.ipedservicio2 = servicio;
		hcipiso_rel_imapedi_new.ipedservicio3 = servicio;
		hcipiso_rel_imapedi_new.ipedservicio4 = servicio;
		
		var sector = obtenerSector();
		hcipiso_rel_imapedi_new.ipedsector = sector; 
		hcipiso_rel_imapedi_new.ipedhistclinica = hcipiso_numero_to_tbc_admision.adm_histclin;
		hcipiso_rel_imapedi_new.ipedhistcldesc = utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_apelnom);
		hcipiso_rel_imapedi_new.ipedfechapedido = fecha;
		hcipiso_rel_imapedi_new.ipedfechapedido4 = fecha;
		hcipiso_rel_imapedi_new.ipedhorapedido = hora; 
		hcipiso_rel_imapedi_new.ipedhorapedido4 = hora;
		
		hcipiso_rel_imapedi_new.ipedobra = hcipiso_numero_to_tbc_admision.adm_obrsoc;
		hcipiso_rel_imapedi_new.ipedplan = utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_planobr).length > 0 ? utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_planobr) : ' ';
		hcipiso_rel_imapedi_new.ipedmedsolic = globals.Hcipiso_vLega;
		hcipiso_rel_imapedi_new.ipediesolic = globals.Hcipiso_vTipoOperador;
		hcipiso_rel_imapedi_new.ipedhabi = hcipiso_numero_to_tbc_admision.adm_habita;
		hcipiso_rel_imapedi_new.ipedcama = hcipiso_numero_to_tbc_admision.adm_cama;
		hcipiso_rel_imapedi_new.ipedurgen = 2;
		hcipiso_rel_imapedi_new.ipednropedunico = nroPedUnico;
	
		isValidSave = databaseManager.saveData(hcipiso_rel_imapedi_new.getRecord(1));
		if(isValidSave){
			
			//Completando imapedet
			hcipiso_rel_imapedet_new.newRecord();
			inicializarImapedetNew();
			
			hcipiso_rel_imapedet_new.idetservicio = servicio;
			hcipiso_rel_imapedet_new.idetservicio3 = servicio;
			hcipiso_rel_imapedet_new.idetservicio4 = servicio;
			hcipiso_rel_imapedet_new.idetservicio5 = servicio;
			hcipiso_rel_imapedet_new.idetpedido = nroPedido;
			hcipiso_rel_imapedet_new.idetpedido3 = nroPedido;
			hcipiso_rel_imapedet_new.idetpedido4 = nroPedido;
			
			var tipoNom = 1;
			var codiNom = 0;
			if(servicio == 12)
				codiNom = 170101;
			else
				codiNom = 340301;
			
			hcipiso_rel_imapedet_new.idettiponom = tipoNom;
			hcipiso_rel_imapedet_new.idettiponom1 = tipoNom;
			hcipiso_rel_imapedet_new.idetcodinom = codiNom;	
			hcipiso_rel_imapedet_new.idetcodinom1 = codiNom;
			hcipiso_rel_imapedet_new.idethistclinica = hcipiso_numero_to_tbc_admision.adm_histclin;
			
			isValidSave = databaseManager.saveData(hcipiso_rel_imapedet_new.getRecord(1));
			
			if(isValidSave){
				if(servicio==1){
					globals.Hcipiso_histclinUnica=hcipiso_numero_to_tbc_admision.adm_histclinuni
					globals.Hcipiso_histClinAsist=hcipiso_numero_to_tbc_admision.adm_histclin
					var $fecha_actual=new Date()
					$fecha_actual=application.getServerTimeStamp()
					var $anio=$fecha_actual.getFullYear()
					var $mes=$fecha_actual.getMonth()+1
					var $dia=$fecha_actual.getDate()
					var $mes_ed=' '
					var $dia_ed=' '
					var $hora=$fecha_actual.getHours()
					var $minutos=$fecha_actual.getMinutes()
					var $segundos=$fecha_actual.getSeconds()
					var $hora_ed=' '
					var $minutos_ed=' '
					var $segundos_ed=' '
					if ($mes<10){
						$mes_ed='0'+$mes
					}else{
						$mes_ed=$mes
					}
					if($dia<10){
						$dia_ed='0'+$dia
					}else{
						$dia_ed=$dia
					}
					if($hora<10){
						$hora_ed='0'+$hora
					}else{
						$hora_ed=$hora
					}
					if($minutos<10){
						$minutos_ed='0'+$minutos
					}else{
						$minutos_ed=$minutos
					}
					if($segundos<10){
						$segundos_ed='0'+$segundos
					}else{
						$segundos_ed=$segundos
					}
					f_eges_fechamensaje=$fecha_actual
					f_eges_tipomsj="ORM_O01"
					f_eges_idmsj = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",38);
					f_eges_histcli=hcipiso_numero_to_tbc_admision.adm_histclinuni;
					f_eges_ipednroi=nroPedido;
					f_eges_estfec=$dia_ed+"/"+$mes_ed+"/"+$anio;
					f_eges_esthor=$hora_ed+''+$minutos_ed;
					f_eges_habcam=hcipiso_numero_to_tbc_admision.adm_habita+"-"+hcipiso_numero_to_tbc_admision.adm_cama
					f_eges_nrointer=hcipiso_numero_to_tbc_admision.adm_histclin;
					f_eges_nombre=hcipiso_numero_to_tbc_admision.adm_nombre;
					f_eges_apellido=hcipiso_numero_to_tbc_admision.adm_apellido;
					f_eges_tipdoc=hcipiso_numero_to_asistencial_admision.adm_tipdocu;
					f_eges_numdoc=hcipiso_numero_to_asistencial_admision.adm_nrodocu;
					f_eges_fecnac=hcipiso_numero_to_asistencial_admision.adm_fecnac;
					if(hcipiso_unica_to_tbc_hist_cab.histcab_email!=null){
						if(hcipiso_unica_to_tbc_hist_cab.histcab_email.toString().substr(0,16)!='Refiere no tener'&&hcipiso_unica_to_tbc_hist_cab.histcab_email!=''&&hcipiso_unica_to_tbc_hist_cab.histcab_email!=null){
							f_eges_email=hcipiso_unica_to_tbc_hist_cab.histcab_email;
							f_eges_autori=utils.stringToNumber(hcipiso_unica_to_tbc_hist_cab.histcabenvioxmail);
						}else{
							f_eges_email=' ';
							f_eges_autori=0;
						}
					}else{
						f_eges_email=' ';
						f_eges_autori=0;
					}
					if(servicio==11){
						f_eges_servi=3;
					}else{
						f_eges_servi=servicio;
					}
					f_eges_fectur=fecha.toString().substr(6,2)+"/"+fecha.toString().substr(4,2)+"/"+fecha.toString().substr(0,4);
					f_eges_hortur=hora;
					f_eges_cober=hcipiso_numero_to_tbc_admision.adm_obrsoc;
					var fs_planobra = databaseManager.getFoundSet("asistencial","tbc_plan_obra")
					fs_planobra.find()
					fs_planobra['ploobra1']=hcipiso_numero_to_tbc_admision.adm_obrsoc;
					fs_planobra['ploplanx10']=hcipiso_numero_to_tbc_admision.adm_planobr
					fs_planobra.search()
					if(fs_planobra.getSize()>0){
						f_eges_plan=hcipiso_numero_to_tbc_admision.adm_obrsoc+"-"+fs_planobra['ploplanx']
					}else{
						f_eges_plan=hcipiso_numero_to_tbc_admision.adm_obrsoc+"-"+"General"
					}
					f_eges_fechor=$anio+$mes_ed+$dia_ed+$hora_ed+$minutos_ed+$segundos_ed
					f_eges_fehocre=f_eges_fechor
					switch (hcipiso_numero_to_tbc_admision.adm_utiliza){
						case 1:f_eges_sector='Internac. ';break;
						case 2:f_eges_sector='T.I.      ';break;
						case 3:f_eges_sector='Int.Guardi';break;
						case 4:f_eges_sector='U.C.      ';break;
						case 5:f_eges_sector='R.C.V.    ';break;
						case 6:f_eges_sector='T.I.N.    ';break;
						case 7:f_eges_sector='Morgue    ';break;
						case 8:f_eges_sector='T.I.P.    ';break;
						case 9:f_eges_sector='Nursery   ';break;
						case 10:f_eges_sector='Terapia 2 ';break;
						case 11:f_eges_sector='Int.Coron.';break;
						case 12:f_eges_sector='T.Interme.';break;
					}
					f_eges_modal='I'
					if(hcipiso_numero_to_asistencial_admision.adm_sexo==1){
						f_eges_sexo="F"
					}else{
						f_eges_sexo="M"
					}
					if(globals.Hcipiso_vTipoOperador==0){
						f_eges_aynmedsol=hcipiso_vlegajo_menu_cirugia_to_tbc_personal.per_apelnom;
						f_eges_matmedsol=utils.stringToNumber(hcipiso_vlegajo_menu_cirugia_to_tbc_personal.per_codmatri);
					}else{
						f_eges_aynmedsol=hcipiso_vlegajo_to_tbc_medicos.med_apenom;
						f_eges_matmedsol=hcipiso_vlegajo_to_tbc_medicos.med_matricula;
					}
					f_eges_diagno="Historia Clinica de Ingreso a Piso"
					f_eges_motfun=" "
					f_eges_seqpres=1
					f_eges_codpres=codiNom
					
					var fs_nomen=databaseManager.getFoundSet("maestros","tbc_nomencla")
					fs_nomen.find()
					fs_nomen['nome_tipo']=1
					fs_nomen['nome_codigo']=f_eges_codpres
					fs_nomen.search()
					var $descri = " ";
					if(fs_nomen.getSize()>0){
						fs_nomen.setSelectedIndex(1)
						$descri=fs_nomen['nome_descr'];
						
						//f_eges_nompres=$descri.toString().substr(0,60);
						f_eges_nompres=$descri;
					}else{
						f_eges_nompres=" ";
					}
					f_eges_canti_codpres=1;
					if(hcipiso_numero_to_tbc_admision.adm_obrsoc==400){
						f_eges_condiva="P"
					}else{
						if(hcipiso_numero_to_asistencial_admision.adm_iva==1){
							f_eges_condiva="O"
						}else{
							f_eges_condiva="P"
						}
					}
					f_eges_afiliado=hcipiso_numero_to_asistencial_admision.adm_nrobenef
					
					insertar_xml_requestsc()
				}
				// Cod Auto
				var empresa = 1;
				var obra = hcipiso_numero_to_tbc_admision.adm_obrsoc;
				var nomeDesc = '';
				var planx10 = utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_planobr).length > 0 ? utils.stringTrim(hcipiso_numero_to_tbc_admision.adm_planobr) : '';
				
				globals.Call_2142_InicializarVariables();
				globals.Call_2142_empresa = empresa;
				globals.Call_2142_obra = obra;
				globals.Call_2142_planX10 = planx10;
				globals.Call_2142_sector = sector;
				globals.Call_2142_tipoNome = tipoNom;
				globals.Call_2142_codiNome = codiNom;
				
				// AUTORIZACION-CODAUTO
				globals.Call_2142_ControlCodobra();
				
				if(globals.Call_2142_ok == true && globals.Call_2142_autori == 1){
					
					hcipiso_rel_codauto.newRecord();
					inicializarRelacionCodAuto();
					
					hcipiso_rel_codauto.codautoempr = empresa;
					hcipiso_rel_codauto.codautoempr5 = empresa;
					hcipiso_rel_codauto.codautoadmi = 0;
					hcipiso_rel_codauto.codautoobra = obra;
					hcipiso_rel_codauto.codautoobra3 = obra;
					hcipiso_rel_codauto.codautoobra4 = obra;
					hcipiso_rel_codauto.codautoobra6 = obra;
				
					hcipiso_rel_codauto.codautohist = hcipiso_numero_to_tbc_admision.adm_histclin;
					hcipiso_rel_codauto.codautohist3 = hcipiso_numero_to_tbc_admision.adm_histclin;
					hcipiso_rel_codauto.codautohist4 = hcipiso_numero_to_tbc_admision.adm_histclin;
					hcipiso_rel_codauto.codautohist5 = hcipiso_numero_to_tbc_admision.adm_histclin;
					hcipiso_rel_codauto.codautohist6 = hcipiso_numero_to_tbc_admision.adm_histclin;
					
					hcipiso_rel_codauto.codautoserv = servCodAuto;
					hcipiso_rel_codauto.codautoserv3 = servCodAuto;
					hcipiso_rel_codauto.codautoserv4 = servCodAuto;
					hcipiso_rel_codauto.codautoserv6 = servCodAuto;
					hcipiso_rel_codauto.codautofsol = fecha;
					hcipiso_rel_codauto.codautohsol = globals.CapturaHoraSistema('HHMMSSDD');
					hcipiso_rel_codauto.codautotipo = tipoNom;
					hcipiso_rel_codauto.codautocdar = codiNom;
					hcipiso_rel_codauto.codautosect = sector;
					hcipiso_rel_codauto.codautopedi = nroPedido;
					hcipiso_rel_codauto.codautotmed = globals.Hcipiso_vTipoOperador;
					hcipiso_rel_codauto.codautomedi = globals.Hcipiso_vLega;
					hcipiso_rel_codauto.codautoutiliza = hcipiso_numero_to_tbc_admision.adm_utiliza;
					hcipiso_rel_codauto.codautohabita = 0;
					
					if(hcipiso_rel_buscar_obrasocial.obrmodautpre == 1 || hcipiso_rel_buscar_obrasocial.obrmodautpre == 3){
						var codAutoEsta = 2;
						hcipiso_rel_codauto.codautoesta3 = codAutoEsta;
						hcipiso_rel_codauto.codautoesta3 = codAutoEsta;
						hcipiso_rel_codauto.codautoesta3 = codAutoEsta;
					}
					
					var sql_query = "select nome_pantalla,nome_descr from tbc_nomencla where nome_tipo = " + tipoNom + " and nome_codigo = " + codiNom;
					var ds_nomencla = databaseManager.getDataSetByQuery('maestros',sql_query,null,-1);
					if(ds_nomencla.getMaxRowIndex() > 0){
						hcipiso_rel_codauto.codautopant = ds_nomencla.getValue(1,1);
						nomeDesc = utils.stringTrim(ds_nomencla.getValue(1,2));
					}
					else
						hcipiso_rel_codauto.codautopant = 4;
					
					var sqlplan = "select PloPlanX from tbc_plan_obra where PloObra = " + hcipiso_numero_to_tbc_admision.adm_obrsoc + " and PloPlanX10 = '" + planx10 + "'";
					var ds_planObra = databaseManager.getDataSetByQuery('asistencial',sqlplan,null,-1);
					if(ds_planObra.getMaxRowIndex() > 0){
						
						hcipiso_rel_codauto.codautoplan = ds_planObra.getValue(1,1);
						hcipiso_rel_codauto.codautoplan3 = ds_planObra.getValue(1,1);
						hcipiso_rel_codauto.codautoplan4 = ds_planObra.getValue(1,1);
						hcipiso_rel_codauto.codautoplan6 = ds_planObra.getValue(1,1);
					}
						
					isValidSave = databaseManager.saveData(hcipiso_rel_codauto.getRecord(1));
					if(isValidSave){
						var paciente = utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_apelnom);
						var afiliado = utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_nrobenef);
						enviarEmail(paciente,afiliado,nomeDesc,fecha,sector,hora);
					}
					
				}
				
				// Interfase Visual Medica
				if(utils.stringTrim(modalidad).length > 0){
					
					if((hcipiso_rel_buscar_obrasocial.obr_espami == 2 && hcipiso_rel_buscar_servicio.servcodigo != 6) || hcipiso_rel_buscar_obrasocial.obr_espami != 2){
						globals.GenerarTXTInterfaseVisualMedica(1, servicio, nroPedido, hcipiso_numero_to_tbc_admision.adm_histclin, fecha, 0, hora)
						
					}
				}
				
				// TODO SERV-REALIZA-TEC 
				// alctualmente los servicios 1 y 12 tienen valor 1
				if(hcipiso_rel_buscar_servicio.servrealizatec == 0){
					
				}
			}
		}
		
		if(!isValidSave){
			
			var error1 = ''
			var error2 = ''
			var array = databaseManager.getFailedRecords()
			for (var i = 0; i < array.length; i++) {
				var record = array[i];
				var jstable = databaseManager.getTable(record);
				var tableSQLName = jstable.getSQLName();
				error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
				error2 = 'Error en grabación ' + record.exception;
				if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
					// exception thrown in pre-insert/update/delete event method
					var thrown = record.exception.getValue()
					//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
				}
			}

			//databaseManager.rollbackTransaction()

			if (error1 != '') {
				globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
				globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error1, "Aceptar")
				globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error2, "Aceptar")
			}
			globals.DIALOGS.showErrorDialog("Error en grabación", hcipiso_rel_buscar_servicio.servabrevia + "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")	
		}
			
	}
}

/**
 * @properties={typeid:24,uuid:"1B1988D0-959E-4D2F-B0C6-E8AAC1D54CBB"}
 */
function obtenerSector() {
	
	var sector = 0;
	globals.Hcipiso_camCama = hcipiso_numero_to_tbc_admision.adm_cama;
	globals.Hcipiso_camHabita = hcipiso_numero_to_tbc_admision.adm_habita;
	
	if(hcipiso_rel_buscar_cama.getSize() > 0){
		
		sector = hcipiso_rel_buscar_cama.cam_utilstand;
		                         
		var i;
		for(i = 1; i <= 5; i++){
			
			if(hcipiso_rel_buscar_cama['cam_utilactual_'+ i] == 1){
				
				sector = hcipiso_rel_buscar_cama['cam_utilalterna_'+ i]
			}
		}
	}
	
	return sector;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} serverName
 * @param {String} tableName
 * @param {String} columnName
 * @param {String} primaryKey
 * @param {Number} keyValue
 *
 * @properties={typeid:24,uuid:"2E1DA26B-8934-4A71-B67D-1D322B1F6CB1"}
 */
function obtenerNumerador (serverName,tableName,columnName,primaryKey,keyValue) {
	
	var numero = 0;
	
	var msg = '';
	var msgEn = '';
	
	var sql = "begin; lock table " + tableName + " in row exclusive mode;";
    var done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
	if (done) {
		
		// Lock de registros
		sql = "select * from " + tableName + " where " + primaryKey + " = " + keyValue + " for update;";
		done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
		if (done) {
			
			sql = "SELECT " + columnName + " FROM " + tableName + " WHERE " + primaryKey + " = " + keyValue;
			var vDataset = databaseManager.getDataSetByQuery(serverName, sql, null, 1);
			
			if(vDataset.getMaxRowIndex() > 0){
				
				sql = "update " + tableName + " set " + columnName + " = " + columnName + " + 1 where " + primaryKey + " = " + keyValue + "; commit;";
				done = plugins.rawSQL.executeSQL(serverName, tableName, sql);
				if(done){
					
					numero = vDataset.getValue(1,1) + 1;
				}
				else{
					
					plugins.rawSQL.executeSQL(serverName, tableName, "end;");
					globals.DIALOGS.showWarningDialog("¡Atencion!", "No ha sido posible actualizar el numerador : \n" + msgEn, "Aceptar");
				}
			}
			else{
				
				plugins.rawSQL.executeSQL(serverName, tableName, "end;");
				globals.DIALOGS.showWarningDialog("¡Atencion!", "No existe el numerador : \n" + msgEn, "Aceptar");
			}
		}
		else{
			
			plugins.rawSQL.executeSQL(serverName, tableName, "end;");
			globals.DIALOGS.showWarningDialog("¡Atencion!", "Error al consultar tabla de numerador :\n" + msgEn + "Error en Select for update" , 'Aceptar');
		}
	}
	else{
		
		msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		globals.DIALOGS.showWarningDialog("¡Atencion!", "Error al consultar tabla de numerador :\n" + msgEn + "\nSQL exception:" + msg, 'Aceptar');
	}
	
	return numero;
}

/**
 * @properties={typeid:24,uuid:"34CE342A-1F47-4DB3-86C0-B207FABF12C6"}
 */
function generarLaboratorio() {
	
	globals.Palab_hisclin = hcipiso_numero_to_tbc_admision.adm_histclin;
	globals.Palab_medCodigo = globals.Hcipiso_vLega;
	
	globals.Palab_listAnalisis = new Array();
	globals.Palab_listAnalisis.push(1000);
	globals.Palab_listAnalisis.push(1029);
	globals.Palab_listAnalisis.push(1030);
	
	if(hcipiso_rel_tbc_hciint_to_tbc_hciint.hiitsele_4 == 2)
		globals.Palab_listAnalisis.push(1013);
	
	openPedidoLaboratorio();
}

/**
 * @properties={typeid:24,uuid:"DB827C65-25CE-4020-B2FB-AB18F63738AB"}
 */
function generarCoagulograma() {
	
	globals.Palab_hisclin = hcipiso_numero_to_tbc_admision.adm_histclin;
	globals.Palab_medCodigo = globals.Hcipiso_vLega;
	
	globals.Palab_listAnalisis = new Array();
	globals.Palab_listAnalisis.push(1013);
	
	openPedidoLaboratorio();
	
}

/**
 * @properties={typeid:24,uuid:"F2A29653-598B-46E3-B997-1AD99764B289"}
 */
function openPedidoLaboratorio() {
	
	var win2 = application.createWindow("pedido_laboratorio", JSWindow.MODAL_DIALOG);
	win2.title = 'Pedido de Laboratorio';
	win2.resizable = false;
	win2.show(forms.Palab_interface_palab_inter);
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"3EE9E624-53B4-4103-B1E1-3805EED0D735"}
 */
function generarInterconsultaCardio (fecha,hora) {
	
	var message = "Dr." + globals.Hcipiso_vOperador;
	message += "\nA continuación se realizará un pedido de interconsulta"
	message += "\n con el servicio de Cardiología."
	globals.DIALOGS.showWarningDialog("Atención!", message, "Aceptar");
	
	//TOMO-NUMERO-INTERCONS
	var nroInterCons = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",22);
	
	// GRABO-INTERCONS-CARDIO
	hcipiso_rel_intercons.newRecord();
	hcipiso_rel_intercons.intercons1 = nroInterCons;
	hcipiso_rel_intercons.intercons2 = 2;
	hcipiso_rel_intercons.intercons3 = 1;
	hcipiso_rel_intercons.intercons4 = "ESTA INTERCONSULTA SE GENERA AUTOMATICAMENTE PARA EVALUACION DE RIESGO QUIRURG";
	hcipiso_rel_intercons.intercons6 = 0;
	hcipiso_rel_intercons.intercons7 = 0;
	hcipiso_rel_intercons.intercons8 = 0;
	var saveData = databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	
	if(saveData){
		
		hcipiso_rel_intercons.newRecord();
		hcipiso_rel_intercons.intercons1 = nroInterCons;
		hcipiso_rel_intercons.intercons2 = 2;
		hcipiso_rel_intercons.intercons3 = 2;
		hcipiso_rel_intercons.intercons4 = "ICO";
		hcipiso_rel_intercons.intercons6 = 0;
		hcipiso_rel_intercons.intercons7 = 0;
		hcipiso_rel_intercons.intercons8 = 0;
		saveData = databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	}
	
	if(saveData){
		
		hcipiso_rel_intercons.newRecord();
		hcipiso_rel_intercons.intercons1 = nroInterCons;
		hcipiso_rel_intercons.intercons2 = 0;
		hcipiso_rel_intercons.intercons3 = 0;
		hcipiso_rel_intercons.intercons4 = " ";
		hcipiso_rel_intercons.intercons6 = 0;
		hcipiso_rel_intercons.intercons7 = 2;
		hcipiso_rel_intercons.intercons8 = 0;
		saveData =  databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	}
	
	if(saveData){
		//GRABO-INTERCONSULTA
		grabarInterconsulta(nroInterCons,fecha,hora,6,0);
	}
	else{
		var msgIntercons = "Error al grabar INTERCONS-CARDIO: databaseManager.saveData(hcipiso_rel_intercons.getRecord(1))";
		grabaLog(msgIntercons,hcipiso_numero_to_asistencial_admision.adm_histclin)
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {number} nroInterCons
 * @param {number} fecha
 * @param {number} hora
 * @param {number} especialidad
 * @param {number} wEqui
 *
 * @properties={typeid:24,uuid:"D790E4C8-78AE-4A58-B5DB-A13B79F55851"}
 */
function grabarInterconsulta(nroInterCons,fecha,hora,especialidad,wEqui){
	globals.Hcipiso_nrointercons=nroInterCons;
	hcipiso_rel_intcons_it.newRecord();
	inicializarRelacionIntConsIt();
	
	globals.Hcipiso_nroHabi = hcipiso_numero_to_asistencial_admision.adm_habita;
	hcipiso_rel_intcons_it.intconssector  = 0;
	if(hcipiso_rel_buscar_habita.getSize() > 0)
		hcipiso_rel_intcons_it.intconssector = hcipiso_rel_buscar_habita.hab_sector; 
	
	globals.Hcipiso_nrointercons=nroInterCons;
	hcipiso_rel_intcons_it.intconsnro = nroInterCons;
	hcipiso_rel_intcons_it.intconsnro4 = nroInterCons;
	hcipiso_rel_intcons_it.intconsfechacarga = fecha;
	hcipiso_rel_intcons_it.intconshoracarga = hora;
	hcipiso_rel_intcons_it.intconsespecialidad = especialidad;
	hcipiso_rel_intcons_it.intconshclinica = hcipiso_numero_to_asistencial_admision.adm_histclin;
	hcipiso_rel_intcons_it.intconshclinica5 = hcipiso_numero_to_asistencial_admision.adm_histclin;
	hcipiso_rel_intcons_it.intconshclinica6 = hcipiso_numero_to_asistencial_admision.adm_histclin;
	hcipiso_rel_intcons_it.intconshclinica8 = hcipiso_numero_to_asistencial_admision.adm_histclin;
	hcipiso_rel_intcons_it.intconstipomed = globals.Hcipiso_vTipoOperador;
	hcipiso_rel_intcons_it.intconsmedico = globals.Hcipiso_vLega;
	hcipiso_rel_intcons_it.intconsapellido = utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_apellido);
	hcipiso_rel_intcons_it.intconsnombre = utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_nombre);
	hcipiso_rel_intcons_it.intconsobra = hcipiso_numero_to_asistencial_admision.adm_obrsoc;
	hcipiso_rel_intcons_it.intconsurgente = 1;
	hcipiso_rel_intcons_it.intconshabi = hcipiso_numero_to_asistencial_admision.adm_habita;
	hcipiso_rel_intcons_it.intconscama = hcipiso_numero_to_asistencial_admision.adm_cama;
	hcipiso_rel_intcons_it.intconsutiliza = hcipiso_numero_to_asistencial_admision.adm_utiliza;
	hcipiso_rel_intcons_it.intconsequipo = wEqui == 1 ? 1 : 0;
	
	var saveData = databaseManager.saveData(hcipiso_rel_intcons_it.getRecord(1));
	if(!saveData){
		var msgIntercons = "databaseManager.saveData(hcipiso_rel_intcons_it.getRecord(1))";
		grabaLog(msgIntercons,hcipiso_numero_to_asistencial_admision.adm_histclin)
	}
	
	return saveData;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"FDA6305A-3365-43FF-8B40-5C9A7C3031D3"}
 */
function generarInterconsultaTraumato(fecha,hora) {
	
	var especialidad = 18;
	globals.Hcipiso_wEquipo = 0;
	var message = '';
	if(hcipiso_numero_to_tbc_admision.adm_obrsoc == 1132){
		
		var medico = "Dr." + globals.Hcipiso_vOperador;
		message = "A continuación se realizará un pedido de interconsulta con";
		message += "\nel servicio de Traumatología.";
		message += "\n\nElija una opción.";
			
		forms.Hcipiso_dlg_message_traumato.f_medico = medico;
		forms.Hcipiso_dlg_message_traumato.f_message = message;
		forms.Hcipiso_dlg_message_traumato.f_opcion = 0;
		
		var win2 = application.createWindow("seleccion_traumato", JSWindow.MODAL_DIALOG);
		win2.title = 'Atención';
		win2.resizable = false;
		win2.show(forms.Hcipiso_dlg_message_traumato);
	}
	else{
		
		message = "Dr." + globals.Hcipiso_vOperador;
		message += "\nA continuación se realizará un pedido de interconsulta"
		message += "\ncon el servicio de Traumatología."
		globals.DIALOGS.showWarningDialog("Atención!", message, "Aceptar")
	}
	
	//TOMO-NUMERO-INTERCONS
	var nroInterCons = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",22);
	
	// GRABO-INTERCONS-TRAUMATO
	hcipiso_rel_intercons.newRecord();
	hcipiso_rel_intercons.intercons1 = nroInterCons;
	hcipiso_rel_intercons.intercons2 = 2;
	hcipiso_rel_intercons.intercons3 = 1;
	hcipiso_rel_intercons.intercons4 = "ESTA INTERCONSULTA SE GENERA AUTOMATICAMENTE PARA EVALUACION POR PROFESIONALES";
	hcipiso_rel_intercons.intercons6 = 0;
	hcipiso_rel_intercons.intercons7 = 0;
	hcipiso_rel_intercons.intercons8 = 0;
	var saveData = databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	
	if(saveData){
		
		globals.Hcipiso_espCodi = globals.Hcipiso_vEspeMed;
		var texto = "DE LA ESPECIALIDAD " + utils.stringTrim(hcipiso_rel_buscar_especial.esp_descrip) + " PERTENECIENTES"; 
		if(globals.Hcipiso_wEquipo == 1)
			texto += " AL SANATORIO COLEGIALES" 
		else
			texto += " A " + utils.stringTrim(hcipiso_rel_buscar_obrasocial.obr_razonsoc);
		
		hcipiso_rel_intercons.newRecord();
		hcipiso_rel_intercons.intercons1 = nroInterCons;
		hcipiso_rel_intercons.intercons2 = 2;
		hcipiso_rel_intercons.intercons3 = 2;
		hcipiso_rel_intercons.intercons4 = texto;
		hcipiso_rel_intercons.intercons6 = 0;
		hcipiso_rel_intercons.intercons7 = 0;
		hcipiso_rel_intercons.intercons8 = 0;
		saveData = databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	}
	
	if(saveData){
		
		hcipiso_rel_intercons.newRecord();
		hcipiso_rel_intercons.intercons1 = nroInterCons;
		hcipiso_rel_intercons.intercons2 = 2;
		hcipiso_rel_intercons.intercons3 = 3;
		hcipiso_rel_intercons.intercons4 = "Diagnostico Presuntivo: " + utils.stringTrim(hcipiso_rel_tbc_hciint_to_tbc_hciint.hcipiso_rel_buscar_patologia_1.pat_descrip);
		hcipiso_rel_intercons.intercons6 = 0;
		hcipiso_rel_intercons.intercons7 = 0;
		hcipiso_rel_intercons.intercons8 = 0;
		saveData = databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
	}
	
	if(saveData){
		
		hcipiso_rel_intercons.newRecord();
		hcipiso_rel_intercons.intercons1 = nroInterCons;
		hcipiso_rel_intercons.intercons2 = 0;
		hcipiso_rel_intercons.intercons3 = 0;
		hcipiso_rel_intercons.intercons4 = " ";
		hcipiso_rel_intercons.intercons6 = 0;
		hcipiso_rel_intercons.intercons7 = 3;
		hcipiso_rel_intercons.intercons8 = 0;
		saveData =  databaseManager.saveData(hcipiso_rel_intercons.getRecord(1));
		
	}
	
	if(saveData){
		//GRABO-INTERCONSULTA
		saveData = grabarInterconsulta(nroInterCons,fecha,hora,especialidad,globals.Hcipiso_wEquipo);
		if(saveData){
			
			if(hcipiso_numero_to_tbc_admision.adm_obrsoc == 1132){
				//BUSCA-PROFE
				enviarEmailInterconsulta(nroInterCons,fecha,hora);
				
				enviarSMSinterconsulta();
			}
		}
		
	}
	else{
		var msgIntercons = "Error al grabar INTERCONS-TRAUMATO: databaseManager.saveData(hcipiso_rel_intercons.getRecord(1))";
		grabaLog(msgIntercons,hcipiso_numero_to_asistencial_admision.adm_histclin)
	}
	
}

/**
 * @properties={typeid:24,uuid:"98F995AB-1591-4168-A76A-DB3178905DE2"}
 */
function inicializarRelacionImapediNew() {
	
	hcipiso_rel_imapedi_new.ipedpedido= 0;
	hcipiso_rel_imapedi_new.ipedservicio= 0;
	hcipiso_rel_imapedi_new.ipedadmis= 0;
	hcipiso_rel_imapedi_new.ipedadmis4= 0;
	hcipiso_rel_imapedi_new.ipedatendiportecnico= 0;
	hcipiso_rel_imapedi_new.ipedcama= ' ';
	hcipiso_rel_imapedi_new.ipedcodianeste= 0;
	hcipiso_rel_imapedi_new.ipedcodioper= 0;
	hcipiso_rel_imapedi_new.ipedestado= 0;
	hcipiso_rel_imapedi_new.ipedfechadife= 0;
	hcipiso_rel_imapedi_new.ipedfechapedido= 0;
	hcipiso_rel_imapedi_new.ipedfechapedido4= 0;
	hcipiso_rel_imapedi_new.ipedfecharesul= 0;
	hcipiso_rel_imapedi_new.ipedhabi= 0;
	hcipiso_rel_imapedi_new.ipedhcprotesis= 0;
	hcipiso_rel_imapedi_new.ipedhistcldesc= ' ';
	hcipiso_rel_imapedi_new.ipedhistclinica= 0;
	hcipiso_rel_imapedi_new.ipedhoradife= 0;
	hcipiso_rel_imapedi_new.ipedhorapedido= 0;
	hcipiso_rel_imapedi_new.ipedhorapedido4= 0;
	hcipiso_rel_imapedi_new.ipedhoraresul= 0;
	hcipiso_rel_imapedi_new.ipediesolic= 0;
	hcipiso_rel_imapedi_new.ipedimpreaviso= 0;
	hcipiso_rel_imapedi_new.ipedlconfecc= 0;
	hcipiso_rel_imapedi_new.ipedlegatecni= 0;
	hcipiso_rel_imapedi_new.ipedmedsolic= 0;
	hcipiso_rel_imapedi_new.ipedmotfund= 0;
	hcipiso_rel_imapedi_new.ipedmotlegalanu= 0;
	hcipiso_rel_imapedi_new.ipednrocine= ' ';
	hcipiso_rel_imapedi_new.ipednropedunico= 0;
	hcipiso_rel_imapedi_new.ipedobra= 0;
	hcipiso_rel_imapedi_new.ipedoklectora= 0;
	hcipiso_rel_imapedi_new.ipedparticular= 0;
	hcipiso_rel_imapedi_new.ipedpatologico= 0;
	hcipiso_rel_imapedi_new.ipedplan= ' ';
	hcipiso_rel_imapedi_new.ipedresdiag= 0;
	hcipiso_rel_imapedi_new.ipedreservasesp= 0;
	hcipiso_rel_imapedi_new.ipedreservasfech= 0;
	hcipiso_rel_imapedi_new.ipedreservashora= 0;
	hcipiso_rel_imapedi_new.ipedreservasmed= 0;
	hcipiso_rel_imapedi_new.ipedsector= 0;
	hcipiso_rel_imapedi_new.ipedservicio1= 0;
	hcipiso_rel_imapedi_new.ipedservicio2= 0;
	hcipiso_rel_imapedi_new.ipedservicio3= 0;
	hcipiso_rel_imapedi_new.ipedservicio4= 0;
	hcipiso_rel_imapedi_new.ipedtipoaneste= 0;
	hcipiso_rel_imapedi_new.ipedtipohcprotesis= 0;
	hcipiso_rel_imapedi_new.ipedtipooper= 0;
	hcipiso_rel_imapedi_new.ipedtipotecni= 0;
	hcipiso_rel_imapedi_new.ipedtomo= 0;
	hcipiso_rel_imapedi_new.ipedurgen= 0;
	hcipiso_rel_imapedi_new.ipednordeges=0;
	hcipiso_rel_imapedi_new.ipedembarazo=0;
	hcipiso_rel_imapedi_new.ipedenvioimagen=0;
}

/**
 * @properties={typeid:24,uuid:"FB94AAA8-1AA7-4E8F-8633-4F3D4473831D"}
 */
function inicializarImapedetNew() {
	
	hcipiso_rel_imapedet_new.idetcodinom = 0;
	hcipiso_rel_imapedet_new.idetpedido = 0;
	hcipiso_rel_imapedet_new.idetservicio = 0;
	hcipiso_rel_imapedet_new.idettiponom = 0;
	hcipiso_rel_imapedet_new.idetadmis = 0;
	hcipiso_rel_imapedet_new.idetcodinom1 = 0;
	hcipiso_rel_imapedet_new.idetestado = 0;
	hcipiso_rel_imapedet_new.idetfechainfor = 0;
	hcipiso_rel_imapedet_new.idetfechareali = 0;
	hcipiso_rel_imapedet_new.idetflagpasaje = 0;
	hcipiso_rel_imapedet_new.idethistclinica = 0;
	hcipiso_rel_imapedet_new.idethorainfor = 0;
	hcipiso_rel_imapedet_new.idethorareali = 0;
	hcipiso_rel_imapedet_new.idetieinfor = 0;
	hcipiso_rel_imapedet_new.idetinforme = 0;
	hcipiso_rel_imapedet_new.idetlegaanu = 0;
	hcipiso_rel_imapedet_new.idetmedicamen = 0;
	hcipiso_rel_imapedet_new.idetmedinfor = 0;
	hcipiso_rel_imapedet_new.idetmotanu = 0;
	hcipiso_rel_imapedet_new.idetmotlegalanu = 0;
	hcipiso_rel_imapedet_new.idetpedido3 = 0;
	hcipiso_rel_imapedet_new.idetpedido4 = 0;
	hcipiso_rel_imapedet_new.idetpreinfor = 0;
	hcipiso_rel_imapedet_new.idetservicio3 = 0;
	hcipiso_rel_imapedet_new.idetservicio4 = 0;
	hcipiso_rel_imapedet_new.idetservicio5 = 0;
	hcipiso_rel_imapedet_new.idettipoinf = 0;
	hcipiso_rel_imapedet_new.idettiponom1 = 0;
	hcipiso_rel_imapedet_new.idettleganu = 0;
	hcipiso_rel_imapedet_new.idetinsumosol = 0;
	hcipiso_rel_imapedet_new.idetremoto = 0;
}

/**
 * @properties={typeid:24,uuid:"4C0FBB60-798E-4106-831D-03AE93B510FB"}
 */
function inicializarRelacionCodAuto(){
	
	hcipiso_rel_codauto.codautoadmi = 0;
	hcipiso_rel_codauto.codautocdar = 0;
	hcipiso_rel_codauto.codautoempr = 0;
	hcipiso_rel_codauto.codautofsol = 0;
	hcipiso_rel_codauto.codautohist = 0;
	hcipiso_rel_codauto.codautohsol = 0;
	hcipiso_rel_codauto.codautoobra = 0;
	hcipiso_rel_codauto.codautoplan = ' ';
	hcipiso_rel_codauto.codautoserv = 0;
	hcipiso_rel_codauto.codautotipo = 0;
	hcipiso_rel_codauto.codautoempr5 = 0;
	hcipiso_rel_codauto.codautoesta3 = 0;
	hcipiso_rel_codauto.codautoesta4 = 0;
	hcipiso_rel_codauto.codautoesta6 = 0;
	hcipiso_rel_codauto.codautofaut = 0;
	hcipiso_rel_codauto.codautohabita = 0;
	hcipiso_rel_codauto.codautohaut = 0;
	hcipiso_rel_codauto.codautohist3 = 0;
	hcipiso_rel_codauto.codautohist4 = 0;
	hcipiso_rel_codauto.codautohist5 = 0;
	hcipiso_rel_codauto.codautohist6 = 0;
	hcipiso_rel_codauto.codautoimpre = 0;
	hcipiso_rel_codauto.codautomedi = 0;
	hcipiso_rel_codauto.codautoobra3 = 0;
	hcipiso_rel_codauto.codautoobra4 = 0;
	hcipiso_rel_codauto.codautoobra6 = 0;
	hcipiso_rel_codauto.codautooper = 0;
	hcipiso_rel_codauto.codautopant = 0;
	hcipiso_rel_codauto.codautopedi = 0;
	hcipiso_rel_codauto.codautoplan3 = ' ';
	hcipiso_rel_codauto.codautoplan4 = ' ';
	hcipiso_rel_codauto.codautoplan6 = ' ';
	hcipiso_rel_codauto.codautosect = 0;
	hcipiso_rel_codauto.codautoserv3 = 0;
	hcipiso_rel_codauto.codautoserv4 = 0;
	hcipiso_rel_codauto.codautoserv6 = 0;
	hcipiso_rel_codauto.codautotmed = 0;
	hcipiso_rel_codauto.codautotope = 0;
	hcipiso_rel_codauto.codautoutiliza = 0;
	
}

/**
 * @properties={typeid:24,uuid:"D94166B4-1389-479E-A214-0AE92A1DF1E3"}
 */
function inicializarRelacionIntConsIt(){
	
	hcipiso_rel_intcons_it.intconsnro = 0;
	hcipiso_rel_intcons_it.intconsaefect = ' ';
	hcipiso_rel_intcons_it.intconsapellido = ' ';
	hcipiso_rel_intcons_it.intconsbaja = 0;
	hcipiso_rel_intcons_it.intconscama = ' ';
	hcipiso_rel_intcons_it.intconscontinua = 0;
	hcipiso_rel_intcons_it.intconsequipo = 0;
	hcipiso_rel_intcons_it.intconsespecialidad = 0;
	hcipiso_rel_intcons_it.intconsestafarm = 0;
	hcipiso_rel_intcons_it.intconsevolucion = 0;
	hcipiso_rel_intcons_it.intconsfechaaviso = 0;
	hcipiso_rel_intcons_it.intconsfechacarga = 0;
	hcipiso_rel_intcons_it.intconsfecharealizado = 0;
	hcipiso_rel_intcons_it.intconshabi = 0;
	hcipiso_rel_intcons_it.intconshclinica = 0;
	hcipiso_rel_intcons_it.intconshclinica5 = 0;
	hcipiso_rel_intcons_it.intconshclinica6 = 0;
	hcipiso_rel_intcons_it.intconshclinica8 = 0;
	hcipiso_rel_intcons_it.intconshoraaviso = 0;
	hcipiso_rel_intcons_it.intconshoracarga = 0;
	hcipiso_rel_intcons_it.intconshorarealizado = 0;
	hcipiso_rel_intcons_it.intconsmedico = 0;
	hcipiso_rel_intcons_it.intconsmedinter = 0;
	hcipiso_rel_intcons_it.intconsmotiinfder = 0;
	hcipiso_rel_intcons_it.intconsmotiinfizq = 0;
	hcipiso_rel_intcons_it.intconsmotikine = 0;
	hcipiso_rel_intcons_it.intconsmotisupder = 0;
	hcipiso_rel_intcons_it.intconsmotisupizq = 0;
	hcipiso_rel_intcons_it.intconsnombre = ' ';
	hcipiso_rel_intcons_it.intconsnro4 = 0;
	hcipiso_rel_intcons_it.intconsnrorespu = 0;
	hcipiso_rel_intcons_it.intconsobra = 0;
	hcipiso_rel_intcons_it.intconsoperador = 0;
	hcipiso_rel_intcons_it.intconsreactder = 0;
	hcipiso_rel_intcons_it.intconsreactizq = 0;
	hcipiso_rel_intcons_it.intconsrespmoto = 0;
	hcipiso_rel_intcons_it.intconsrespocul = 0;
	hcipiso_rel_intcons_it.intconsrespverb = 0;
	hcipiso_rel_intcons_it.intconssecrecion = 0;
	hcipiso_rel_intcons_it.intconssector = 0;
	hcipiso_rel_intcons_it.intconsseriada = 0;
	hcipiso_rel_intcons_it.intconstamaocul = 0;
	hcipiso_rel_intcons_it.intconstipohc = 0;
	hcipiso_rel_intcons_it.intconstipohc5 = 0;
	hcipiso_rel_intcons_it.intconstipohc6 = 0;
	hcipiso_rel_intcons_it.intconstipohc8 = 0;
	hcipiso_rel_intcons_it.intconstipointer = 0;
	hcipiso_rel_intcons_it.intconstipomed = 0;
	hcipiso_rel_intcons_it.intconsurgente = 0;
	hcipiso_rel_intcons_it.intconsutiliza = 0;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} paciente
 * @param {String} afiliado
 * @param {String} nomeDesc
 * @param {Number} fecha
 * @param {Number} sector
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"325ECE1C-AC15-4189-84A0-016BB8CEB72A"}
 * @AllowToRunInFind
 */
function enviarEmail(paciente,afiliado,nomeDesc,fecha,sector,hora) {
	
	if(hcipiso_rel_buscar_obrasocial.obrmodautpre == 1 || hcipiso_rel_buscar_obrasocial.obrmodautpre == 3){
		
		var mailObrTipo = 2;
		if(hcipiso_rel_buscar_obrasocial.obr_codigo == 1132)
			mailObrTipo = 4;

		var fs_mailObra = databaseManager.getFoundSet("asistencial","tbc_mail_obra");
		fs_mailObra.find();
		fs_mailObra['mailobr1'] = hcipiso_rel_buscar_obrasocial.obr_codigo
		fs_mailObra['mailobrtipo'] = mailObrTipo;
		fs_mailObra.search();
		
		if(fs_mailObra.getSize() > 0){
			
			var aux_mail_para = '';
			var aux_mail_cc = '';
			var aux_mail_cco = '';
			var aux_mail_error = '';
			for (var x=1;x<=10;x++){
				
				switch (fs_mailObra['mailobrdestino_'+x]){
					
				case 1:{
					
					if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
						
						if(utils.stringTrim(aux_mail_para).length == 0)
							aux_mail_para = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						else
							aux_mail_para += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					}
					else
						aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					
				}
				break;
				case 2:{
					
					if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
						
						if(utils.stringTrim(aux_mail_cc).length == 0)
							aux_mail_cc = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						else
							aux_mail_cc += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					}
					else
						aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
				}
				break;
				case 3:{
					
					if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
						
						if(utils.stringTrim(aux_mail_cco).length == 0)
							aux_mail_cco = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						else
							aux_mail_cco += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					}
					else
						aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
				}
				break;
			}
		}
			
			//if(utils.stringTrim(aux_mail_para).length > 0){
				
				// Medico responsable por sector
				var codAutoSect = sector;
				var firmaRecCod = 0;
				
				if( codAutoSect == 2 || codAutoSect == 6 || codAutoSect == 8 || codAutoSect == 9 || codAutoSect == 10 || codAutoSect == 12)
					firmaRecCod = 8017;
				
				if( codAutoSect == 4 || codAutoSect == 05 || codAutoSect == 11)
					firmaRecCod = 7004;
				
				if( codAutoSect == 1 || codAutoSect == 3 || codAutoSect == 13 || codAutoSect == 14 || codAutoSect == 15 || codAutoSect == 16 )
					firmaRecCod = 7127;
				
				// Buscar Medico responsable, imagen y matricula
				var fileNameFirma = "Logo300px.png";//Default
				var matricula = "";
				
				var fs_firmaRec = databaseManager.getFoundSet('maestros','tbc_firma_rec');
				fs_firmaRec.find();
				fs_firmaRec['firmareccod'] = firmaRecCod;
				fs_firmaRec.search();
				
				if(fs_firmaRec.getSize() > 0){
					
					var myMedia = solutionModel.getMedia(utils.stringTrim(fs_firmaRec['firmarecarchjpg']));
					if(myMedia)
						fileNameFirma = fs_firmaRec['firmarecarchjpg'];
					
					matricula = fs_firmaRec['firmarecmatricula'];
				}
	
				var medPerCod = firmaRecCod;
				// Buscar Medico
				var medico = "Dr. ";
				var sqlMedPer = "select MedPerApeynom from tbc_medicos_personal where MedPerCod = " + medPerCod;
				var ds_medPer = databaseManager.getDataSetByQuery("maestros",sqlMedPer,null,-1);
				if(ds_medPer.getMaxRowIndex() > 0 )
					medico += utils.stringTrim(ds_medPer.getValue(1,1));
				
				//Buscar Diagnostico
				var diagnostico = 'Dx : ';
				var patCie = hcipiso_numero_to_asistencial_admision.adm_patoling;
				
				var sqlMaxFecha = "select ptpfecha,ptphora,ptppatol from tbc_patolpac where"
				  + " ptphistclinica = " + hcipiso_numero_to_asistencial_admision.adm_histclin
				  + " and ptpfecha <= " + fecha
				  + " order by ptpfecha desc, ptphora desc";
				var ds_PatolPac = databaseManager.getDataSetByQuery('asistencial',sqlMaxFecha,null,-1);
				if(ds_PatolPac.getMaxRowIndex() > 0){
					
					if(ds_PatolPac.getValue(1,1) < fecha){
						// tomar el primer registro
						patCie = ds_PatolPac.getValue(1,3);
					}
					else{
						// mismo dia
						for(var i=1 ; i<= ds_PatolPac.getMaxRowIndex() ; i++ ){
							//evaluar la hora
							if( ds_PatolPac.getValue(i,2) <= hora){
								patCie = ds_PatolPac.getValue(i,3);
								break;
							}
						}
					}
				}
								
				if(hcipiso_rel_buscar_obrasocial.obr_espami == 1){
					// Es pami
					/*
					var fs_patCie = databaseManager.getFoundSet('maestros','tbc_patcie'); 
					fs_patCie.find();
					fs_patCie['patcie1'] = patCie;
					// TODO Faltaria un criterio de filtro, o cual de la lista tomar ??
					//TODO: fs_patCie['patcie3'] = ;
					fs_patCie.search();
					
					if(fs_patCie.getSize() > 0)
						diagnostico += utils.stringTrim(fs_patCie['patcie22']);
					*/
				}
				else{
					
					var fs_patologia = databaseManager.getFoundSet('maestros','tbc_patologia'); 
					fs_patologia.find();
					fs_patologia['pat_codi'] = patCie;
					fs_patologia.search();
					
					if(fs_patologia.getSize() > 0)
						diagnostico += utils.stringTrim(fs_patologia['pat_descrip']);
				}
				
				var $ds2 = databaseManager.createEmptyDataSet()
				$ds2.addColumn('fld_apeynom',1,JSColumn.TEXT)
				$ds2.addColumn('fld_cobertura',2,JSColumn.TEXT)
				$ds2.addColumn('fld_afiliado',3,JSColumn.TEXT)
				$ds2.addColumn('fld_cod',4,JSColumn.TEXT)
				$ds2.addColumn('fld_rp1',5,JSColumn.TEXT)
				$ds2.addColumn('fld_rp5',6,JSColumn.TEXT)
				$ds2.addColumn('fld_apeynom_dr',7,JSColumn.TEXT)
				$ds2.addColumn('fld_matricula',8,JSColumn.TEXT)
				
				var histClinica = hcipiso_numero_to_asistencial_admision.adm_histclin;
				var histClin =  histClinica.toString().substr(0,histClinica.toString().length-1)+"/"+histClinica.toString().substr(histClinica.toString().length -1,1)
				
				$ds2.addRow([paciente,hcipiso_rel_buscar_obrasocial.obr_razonsoc,afiliado,histClin,nomeDesc,diagnostico,medico,matricula])
				// Generacion de PDF
				var title = "";
				if(codAutoSect == 2 || codAutoSect == 6 || codAutoSect == 8 || codAutoSect == 10 || codAutoSect == 12)
					title = "TERAPIA INTENSIVA";
				else{
					
					if( codAutoSect == 4 || codAutoSect == 5 )
						title = "UNIDAD CORONARIA";
					else
						title = "PISO";
				}
				
				var params = {
					pr_firma: "media:///" + fileNameFirma,
					pr_recetario: "media:///RecetarioSC2_004.jpg",
					pr_titulo_dr: title
				}
				
				var fileName = hcipiso_numero_to_asistencial_admision.adm_histclin + "-"+ fecha + "-" + hora + ".pdf";
				var arch;
				try{
					arch = plugins.file.createFile(fileName);
					//application.output( arch.getAbsolutePath());
					//globals.DIALOGS.showWarningDialog("Atencion","Directorio del archivo: " + arch.getAbsolutePath(),"Aceptar");
					
				}catch(msg){
					grabaLog(msg.toString(),hcipiso_numero_to_asistencial_admision.adm_histclin);
				}
				
				if (arch){	
					try{
						//var fileName = "c:/temp/LB-CIRUAMBU-" + fechaDesde + "-" + fechaHasta;
						//plugins.jasperPluginRMI.compileReport("HCIPISO-SOL-AUT.jrxml");
						plugins.jasperPluginRMI.runReport($ds2,'HCIPISO-SOL-AUT.jasper',arch.getAbsolutePath(),plugins.jasperPluginRMI.OUTPUT_FORMAT.PDF,params)
					}catch(e){
						grabaLog(e.message,hcipiso_numero_to_asistencial_admision.adm_histclin)
					}
				}
				
				var attachment1;
				try{
					attachment1 = plugins.mail.createBinaryAttachment(fileName,plugins.file.readFile(arch.getAbsolutePath()));
					
				}catch(msg){
					grabaLog(msg.toString(),hcipiso_numero_to_asistencial_admision.adm_histclin)
				}	
				
				// Envio de email
				var subJect = "Solicitud Autoriz.- Paciente " + paciente + " - " + nomeDesc;
				
				var msgText = "Estimado/a\n\n"
				+ "                Se adjunta Practica en formato PDF para Autorizar correspondiente al paciente " + paciente + " Afiliado: " + afiliado + " con indicacion de: " + nomeDesc + "\n\n"
				
				msgText+= "Atte.\n"; 
				//msgText+= "Unidad Quirugica\n";
				msgText+= "Sanatorio Colegiales";
				
				// Enviando email
				var cuenta = '2';
				var userName = 'autorizaciones@sanatoriocolegiales.com.ar';
				var passWord = 'auto45';
				var properties = new Array();
				properties[0] = 'mail.smtp.host=200.80.43.104';
				properties[1] = 'mail.smtp.auth=true';
				properties[2] = 'mail.smtp.username=' + userName;
				properties[3] = 'mail.smtp.password=' + passWord;
				properties[4] = 'mail.smtp.port=25';
				
				//TODO  test-1
				/*
				var toAux = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
				var ccAux = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
				var ccoAux = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : null;
				application.output("TO: " + toAux);
				application.output("CC: " + ccAux);
				application.output("CCO: " + ccoAux);
				*/
				// end test-1
				var to = null;
				var cc = null;
				var cco = null;
				var url='';
				
				var largo_url=application.getServerURL().length
				if (largo_url<24){
					
					to = 'hchoque@cirendsa.com.ar';
					globals.DIALOGS.showInfoDialog("E-MAIL",msgText + '\nTo: ' + to,"Aceptar");
					
				}else{
					url = application.getServerURL().substr(0,23);
					var puerto = url.split(':');
					
					if(puerto[2]!='8080'){
						// Ambiente de pruebas
						to = globals.DIALOGS.showInputDialog(puerto[2],"Ingrese Dirección de correo electronico",'fhuertas@cirendsa.com.ar');
						cc = 'fmhuertas@yahoo.com.ar';
						//cc = 'hchoque@cirendsa.com.ar';
					}
					else{
						// Ambiente operativo
						to = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
						cc = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
						cco = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : null;
						
					}
				}
				
				var attachmentList = new Array();
				var archivo_1 = {nombre:fileName,path:arch.getAbsolutePath()};
				attachmentList.push(archivo_1);
				
				if(utils.stringTrim(aux_mail_error).length == 0){
					
					var success = plugins.mail.sendMail(to, userName, subJect, msgText,cc,cco,[attachment1], properties);
					if (!success){
						
						grabarReenviaMail(asiucotrs_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,attachmentList,cuenta);
						var msgMail = "No ha sido posible enviar la autorización de ingreso a piso via E-mail";
						grabaLog(msgMail,hcipiso_numero_to_asistencial_admision.adm_histclin);
					}
				}
				else{
					
					grabarReenviaMail(asiucotrs_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,attachmentList,cuenta);
					var msg = "No ha sido posible enviar la autorización de ingreso a piso. Direccion de correo electrónico no válido.\n E-mail: " + to;
					grabaLog(msg,hcipiso_numero_to_asistencial_admision.adm_histclin)
				}
					
				if(arch){
					
					try{
					  	plugins.file.deleteFile(arch.getAbsolutePath())
					  	plugins.file.deleteFile(arch)
					  }catch(msg){
							grabaLog("Error al elimnar archivo pdf.",hcipiso_numero_to_asistencial_admision.adm_histclin)
					}	
				}
			//}
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} nroInterCons
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"824836BA-50F5-450A-B468-37A12DD3DCEF"}
 * @AllowToRunInFind
 */
function enviarEmailInterconsulta(nroInterCons,fecha,hora) {
	
	var fs_mailProf = databaseManager.getFoundSet("maestros","tbc_mail_prof");
	fs_mailProf.find();
	fs_mailProf['mailesp'] = globals.Hcipiso_vEspeMed;
	fs_mailProf.search();
	
	if(fs_mailProf.getSize() > 0){
		
		var fechaAux = globals.IntegerToDate(fecha);
		var nroDiaOut = fechaAux.getDay();// servoy 0: Domingo 1: Lunes ...
		if(nroDiaOut == 0)
			nroDiaOut = 7;// cobol 7: domingo
			
		var wADM4;
		if(globals.Hcipiso_wEquipo == 1)
			wADM4 = 401;
		else
			wADM4 = hcipiso_numero_to_tbc_admision.adm_obrsoc;
		
		var asignarCorreo = false;
		var mailProf = "";

		for(var i = 1; i <= fs_mailProf.getSize(); i++){
			
			asignarCorreo = false;
			//Mail-DIA 0:No atiende 1:Atiende
			if(fs_mailProf.getRecord(i)['maildia_' + nroDiaOut] == 1){
				
				// MAIL-OBR-1 0=todas atiendea todas las obras sociales
				if(fs_mailProf.getRecord(i)['mailobr1'] == 0){
					
					asignarCorreo = true;
				}
					
				// MAIL-OBR-1 1=excluyntes no atiene a ciertas obras sociales
				if(fs_mailProf.getRecord(i)['mailobr1'] == 1){
					
					asignarCorreo = true;
					for (var x=1;x<=10;x++){
						
						if(fs_mailProf.getRecord(i)['mailobr2exclu_'+x] == wADM4){
							asignarCorreo = false;
							break;
						}
					}
				}
				
				// MAIL-OBR-1 2=habilitadas solo atiende a ciertas obras sociales
				if(fs_mailProf.getRecord(i)['mailobr1'] == 2){
					
					asignarCorreo = false;
					for (var t=1;t<=10;t++){
						
						if(fs_mailProf.getRecord(i)['mailobr2habil_'+t] == wADM4){
							asignarCorreo = true;
							break;
						}
					}
				}
				
				if(asignarCorreo){
					// completa en pr-2920
					if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion']))){

						if(mailProf == "")
							mailProf = utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion']);
						else
							mailProf += "," + utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion']);
					}
					
					if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion2']))){

						if(mailProf == "")
							mailProf = utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion2']);
						else
							mailProf += "," + utils.stringTrim(fs_mailProf.getRecord(i)['maildireccion2']);
					}
					
					$_listNumberSMS.push(fs_mailProf.getRecord(i)['mailcodareacel'] + "|" + fs_mailProf.getRecord(i)['mailnrolineacel']);
				}	
			}
		}
		
		//MAIL-PROFE
		var aux_mail_para = mailProf;
		var aux_mail_cc = '';
		var aux_mail_cco = 'fhuertas@cirendsa.com.ar,fflores@sanatoriocolegiales.com.ar,clausmocovich@sanatoriocolegiales.com.ar,clongo@sanatoriocolegiales.com.ar,sgallo@cirendsa.com.ar';
		
		if(utils.stringTrim(aux_mail_para).length > 0){
			
			// Envio de email
			var paciente = utils.stringTrim(hcipiso_numero_to_asistencial_admision.adm_apelnom);
			var histClin = hcipiso_numero_to_tbc_admision.hiscli2_hcipiso;
			var habita = hcipiso_numero_to_asistencial_admision.adm_habita;
			var cama = hcipiso_numero_to_asistencial_admision.adm_cama;
			var cobertura = utils.stringTrim(hcipiso_rel_buscar_obrasocial.obr_razonsoc);
			var prioridad = "URGENTE";
			
			// Solicitud de Interconsulta Nro : 380344 - DENTRO DE LAS 24 Hs. - Paciente: URSINO MARIA ESTHER - N.Inter.246441/0 - Habitacion: 206 - Cama: B - Obras Social: OSTEE-OSTrab.Emp.Ele
			var subJect = "Solicitud de Interconsulta Nro : "+ nroInterCons + " - " + prioridad + " - Paciente: " + paciente + " - N.Inter. " + histClin + " - Habitacion: " + habita + " - Cama: " + cama + " - Obras Social: " + cobertura;
			
			var fechaMsg = fecha.toString().substr(6, 2) + "/" + fecha.toString().substr(4, 2) + "/" + fecha.toString().substr(0, 4);
			var fechaMsgSMS = fecha.toString().substr(6, 2) + "/" + fecha.toString().substr(4, 2) + "/" + fecha.toString().substr(2, 2);
			var horaMsg = convertNumberToHour_HHMM(hora);
			
			//Sr. Profesional: Se solicita una Interconsulta  Nro: 380344 - DENTRO DE LAS 24 Hs. -  del  17/01/2018 hora : 11:56, correspondiente al paciente: URSINO MARIA ESTHER - N.Inter.246441/0     - Habitacion:  206 - Cama: B - Obra Social : OSTEE-OSTrab.Emp.Ele- Medico solicito: CASAZZA GUSTAVO LUIS
			var msgText = "Sr. Profesional: Se solicita una Interconsulta  Nro: " + nroInterCons  + " - " + prioridad +  " - del " + fechaMsg + " hora : " + horaMsg + ", correspondiente al paciente: " + paciente + " - N.Inter. " + histClin + " - Habitacion: " + habita + " - Cama: " + cama + " - Obras Social: " + cobertura + " - Medico solicito: " + utils.stringTrim(globals.Hcipiso_vOperador);
			msgText += "\nRESUMEN:";
			
			// Completando Resumen y Motivo
			var sqlInter = "select * from tbc_intercons where Intercons1 = " + nroInterCons + " order by Intercons2,Intercons2";
			var ds_interCons = databaseManager.getDataSetByQuery('asistencial',sqlInter,null,-1);
			var resumen = "";
			var motivo = "";
			
			if(ds_interCons.getMaxRowIndex() > 0){
				
				for(var k=1; k <= ds_interCons.getMaxRowIndex(); k++){
					
					if(ds_interCons.getValue(k,2) < 3){
						
						if(ds_interCons.getValue(k,2)== 0)
							resumen += "\n" + utils.stringTrim(ds_interCons.getValue(k,4));
						else
							motivo += "\n" + utils.stringTrim(ds_interCons.getValue(k,4));
					}
				}
			}
			msgText += resumen;
			msgText += "\nMOTIVO:";
			msgText += motivo;
			
			msgText += "\n\nEste correo es informativo, favor no responder a esta direccion de correo. Si requiere mayor informacion sobre el contenido de este mensaje, contactar al Sanatorio Colegiales 4556-4800.";
			
			msgText+= "\n\nAtte."; 
			//msgText+= "Unidad Quirugica\n";
			msgText+= "\nSanatorio Colegiales";
			
			//ARMO-TEXTO-SMS-INTERCONSULTA
			//Sr.Profesional:Se Solicita Interconsulta Nro.380436 del 24/01/18 08:43 hs-URGENTE-Pac. GHO,CARLOS(24357/0)hAB.6A
			$_msgSMS = "Sr.Profesional:Se Solicita Interconsulta Nro." + nroInterCons + " del " + fechaMsgSMS + " " + horaMsg + " hs-URGENTE-Pac. " + paciente + "(" + histClin + ")Hab." + habita + cama;
			
			// Enviando email
			var cuenta = "1";
			var userName = 'aviso@sanatoriocolegiales.com.ar';
			var passWord = 'avi32avi';
			var properties = new Array();
			properties[0] = 'mail.smtp.host=200.80.43.104';
			properties[1] = 'mail.smtp.auth=true';
			properties[2] = 'mail.smtp.username=' + userName;
			properties[3] = 'mail.smtp.password=' + passWord;
			properties[4] = 'mail.smtp.port=25';
			
			//TODO  test-1
			/*
			var toAux = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
			var ccAux = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
			var ccoAux = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : null;
			application.output("TO: " + toAux);
			application.output("CC: " + ccAux);
			application.output("CCO: " + ccoAux);
			*/
			// end test-1
			var to = null;
			var cc = null;
			var cco = null;
			var url='';
			
			var largo_url=application.getServerURL().length
			if (largo_url<24){
				
				to = 'fhuertas@cirendsa.com.ar';
				globals.DIALOGS.showInfoDialog("E-MAIL",subJect + '\n\n' + msgText + '\nTo: ' + to,"Aceptar");
				
			}else{
				url = application.getServerURL().substr(0,23);
				var puerto = url.split(':');
				
				if(puerto[2]!='8080'){
					// Ambiente de pruebas
					to = globals.DIALOGS.showInputDialog(puerto[2],"Ingrese Dirección de correo electronico",'fhuertas@cirendsa.com.ar');
					cc = 'fmhuertas@yahoo.com.ar';
					//cc = 'hchoque@cirendsa.com.ar';
				}
				else{
					// Ambiente operativo
					to = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
					cc = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
					cco = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : null;
				}
			}
			/*
			var attachmentList = new Array();
			var archivo_1 = {nombre:fileName,path:arch.getAbsolutePath()};
			attachmentList.push(archivo_1);
			*/
			//Enviando E-Mail
			var success = plugins.mail.sendMail(to, userName, subJect, msgText,cc,cco,null, properties);
			if (!success){
				
				grabarReenviaMail(asiucotrs_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,null,cuenta);
				var msgSuccess = "No ha sido posible enviar la interconsulta de traumatologia via E-mail";
				grabaLog(msgSuccess,hcipiso_numero_to_asistencial_admision.adm_histclin);
			}
		}
		else{
			
			grabarReenviaMail(asiucotrs_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,null,cuenta);
			var msgMail = "No ha sido posible enviar la interconsulta de traumatologia. Direccion de correo electrónico no válido.\n E-mail: " + aux_mail_para;
			grabaLog(msgMail,hcipiso_numero_to_asistencial_admision.adm_histclin)
		}
	}
	else{
		var msg = "No ha sido posible enviar la interconsulta de traumatologia. No existen profecionales para la especialidad " + globals.Hcipiso_vEspeMed + " en tbc_mail_prof.";
		grabaLog(msg,hcipiso_numero_to_asistencial_admision.adm_histclin)
	}
}

/**
 * @properties={typeid:24,uuid:"BCCB4CDA-7F8A-4A47-AABA-157551FAB939"}
 */
function enviarSMSinterconsulta(){
	
	var nroCelular;
	var destinatario;
	elements.lbl_procesando.visible = true;
	application.updateUI();
	for(var j=0;j<$_listNumberSMS.length ; j++){
		
		var item = $_listNumberSMS.slice(j);
		var subItem = String(item[0]).split('|');
		nroCelular = subItem[0]+subItem[1];
		application.output("CodArea-NroCelular: " + subItem[0] + " - " + subItem[1]);
		
		// Validar codigo de area y numero celular
		
		destinatario = "";
		var url='';
		var largo_url=application.getServerURL().length
		if (largo_url<24){
			
			destinatario = "0";
			globals.DIALOGS.showInfoDialog("SMS",nroCelular + "\n" +  $_msgSMS,"Aceptar");
			
			
		}else{
			url = application.getServerURL().substr(0,23);
			var puerto = url.split(':');
			
			if(puerto[2]!='8080'){
				// Ambiente de pruebas 
				destinatario = globals.DIALOGS.showInputDialog(puerto[2],"Ingrese Nro. de Celular de prueba",'3484360393');
				
			}
			else{
				// Ambiente operativo
				destinatario = nroCelular;
			}
		}
		
		// Enviando SMS
		
		//var vString = vServer.executeCommand('ssh -l svysc 10.200.0.90 -C "sh sh-pruebaservoy1"');
		//var vString = vServer.executeCommand("`/usr/bin/curl --insecure --progress-bar -X POST -F 'number=03484360393' -F 'text=Prueba de comando' https://10.200.0.65:44443/EnvioSMS.php`");
		//var vString = vServer.executeCommand("/usr/bin/curl  --insecure https://10.200.0.65:44443/EnvioSMS.php?number=3484360393&text=Hola Mundo");
		//var vString = vServer.executeCommand("/app/servoy/scripts/sh-curl "+3484360393+" "+ftexto1+" "+ftexto2+" "+ftexto1+" "+ftexto2+" "+ftexto1+" "+ftexto2+" "+ftexto1+" "+ftexto2);
		if(utils.stringToNumber(destinatario) > 0){
			
			plugins.UserManager.register( "Hypertelia", "q9SA5eCyb085cvATVO8s9onGe3iBzJyCTel8Y7J72BuG599wodOiU5OL26/pkKyv");
			var vServer = plugins.UserManager.Server();
			var vString = vServer.executeCommand("/app/servoy/scripts/sh-curl "+destinatario+" "+$_msgSMS);
			//ENVIO OK
		}
		
	}
	elements.lbl_procesando.visible = false;
	application.updateUI();
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} texto
 * @param {Number} histClin 
 *
 * @properties={typeid:24,uuid:"D80AC142-598F-4736-9340-D16311175EE6"}
 */
function grabaLog(texto,histClin) {
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
	var dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
		dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("bases_auxiliares","cirugia_errores")
	var fechacarga = application.getServerTimeStamp();
	fs.newRecord()
	fs['id'] = id;
	fs['hiscli'] = histClin;
	fs['protocolo'] = 0;
	fs['texto_errores'] = application.getSolutionName() + "|" +  application.getIPAddress() + "|" + controller.getName() + "|" +  texto;
	fs['tipo_pac'] = 'Int';
	fs['fecha']=application.getServerTimeStamp();
	fs['hora']=fechacarga.getHours()+''+fechacarga.getMinutes()
	
	databaseManager.startTransaction()
	var result = databaseManager.saveData(fs);
	if(result){
		databaseManager.commitTransaction();				
	}
	else{
		var error1 = ''
		var error2 = ''
		var array = databaseManager.getFailedRecords()
		for (var i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
		
				var thrown = record.exception.getValue()
			
			}
		}
		databaseManager.rollbackTransaction()
	}
}

/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"07E24333-F7A2-411A-9A0F-402AF9591D26"}
 */
function onLoad_inicializarForm(event) {
	
	initFormFirstShow();
}

/**
 * @properties={typeid:24,uuid:"F04A809E-87CD-452C-A2F9-7506ADB9449E"}
 */
function initFormFirstShow(){
	
	inicializarForm();
	f_medico = utils.stringTrim(globals.Hcipiso_vOperador);
	mostrarRecordatorio();
	
	if(globals.Hcipiso_vTipoOperador == 0){
		
		var ds_personal = databaseManager.getDataSetByQuery('maestros','select per_espemed from tbc_personal where per_legajo = ' + globals.Hcipiso_vLega,null,-1);
		globals.Hcipiso_vEspeMed = ds_personal.getMaxRowIndex() > 0 ? ds_personal.getValue(1,1) : 0;
	}	
	else{
		
		var ds_medicos = databaseManager.getDataSetByQuery('maestros','select med_espemed from tbc_medicos where med_codigo = ' + globals.Hcipiso_vLega,null,-1);
		globals.Hcipiso_vEspeMed = ds_medicos.getMaxRowIndex() > 0 ? ds_medicos.getValue(1,1) : 0;
	}
	
	// Evaluando si el usuario logeado es ostee    		
	var $form = controller.getName();
	for (var i = 1; i <= globals.Hcipiso_permisos.getMaxRowIndex(); i++){	
		
		if ($form == globals.Hcipiso_permisos.getValue(i,3)){
			
			if('user_ostee' == globals.Hcipiso_permisos.getValue(i,4)){
					
				if(globals.Hcipiso_permisos.getValue(i,6)==true){
						
					$_isUserOSTEE = true;
					break;
				}
			}
			
		}
	}
	
	// Inicializando impresion
	forms.Hcipiso_print.onShow_inicializarForm(true,null);
}

/**
 * 
 * @param {Number} hisCli
 * @param {String} to
 * @param {String} cc
 * @param {String} cco
 * @param {String} asunto
 * @param {String} mensaje
 * @param {Array<Object>} attachment
 * @param {String} cuenta
 *
 * @properties={typeid:24,uuid:"D524EA61-9F69-4E60-A42D-DB68C628FF6F"}
 */
function grabarReenviaMail(hisCli,to,cc,cco,asunto,mensaje,attachment,cuenta){
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
	var dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
		dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("desal","reenvia_mail");
	fs.newRecord();
	
	fs['id'] = id;
	fs['hiscli'] = hisCli;
	fs['fecha'] = application.getServerTimeStamp();;
	fs['mail_para'] = to;
	fs['mail_cc'] = cc;
	fs['mail_cco'] = cco;
	fs['id_cuenta_origen'] = cuenta;
	fs['asunto'] = asunto;
	fs['mensaje'] = mensaje;
	fs['estado'] = false;
	
	var fsItem = databaseManager.getFoundSet('desal','reenvia_mail_adjunto');
	if(attachment != null){
		
		var idItem;
		for(var k=0; k<attachment.length; k++){
			
			fsItem.newRecord();
			idItem = application.getUUID();
			//Verificando si existe clave primaria
			sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
			dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			while(dsExists.getValue(1,1) == 1){
				idItem = application.getUUID();
				sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
				dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			}
			
			fsItem['id'] = idItem;
			fsItem['id_reenvia_mail'] = id;
			fsItem['nombre_archivo'] = attachment[k]['nombre'];
			fsItem['archivo'] = plugins.file.readFile(attachment[k]['path']);
		}
	}
	
	databaseManager.startTransaction()
	var resultFs = databaseManager.saveData(fs);
	
	var resultItem = true;
	if(fsItem.getSize() > 0)
		resultItem = databaseManager.saveData(fsItem);
	
	if(resultFs && resultItem){

		databaseManager.commitTransaction();				
	}
	else{
		
		databaseManager.rollbackTransaction();
		var msgMail = "No ha sido posible grabar en tabla reenvia_mail. HC " + hisCli + "para " + to + cc + cco;
		grabaLog(msgMail,hisCli);
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"C82F8EEE-EC4A-497C-B004-6A4B57FF7EF6"}
 */
function onAction_nextCampoGral(event) {
	switch (event.getElementName()){
	case 'txt_frecuencia':elements.txt_tensionMax.requestFocus();break;
	case 'txt_tensionMax':elements.txt_tensionMin.requestFocus();break;
	case 'txt_tensionMin':elements.cbo_temperatura.requestFocus();break;
	case 'cbo_temperatura':elements.txt_temperatura.requestFocus();break;
	case 'txt_temperatura':elements.txt_diagnostico1.requestFocus();break;
	}
}

/**
 * @properties={typeid:24,uuid:"8AC88FAD-1CCD-44F4-B620-A90DD9B15463"}
 * @AllowToRunInFind
 */
function insertar_xml_requestsc(){
	var fs_nomen=databaseManager.getFoundSet("maestros","tbc_nomencla")
	fs_nomen.find()
	fs_nomen['nome_tipo']=1
	fs_nomen['nome_codigo']=f_eges_codpres
	fs_nomen.search()
	var $descri = " ";
	if(fs_nomen.getSize()>0){
		$descri=fs_nomen['nome_descr']
		f_eges_nompres=$descri.toString().substr(0,60)
	}else{
		f_eges_nompres=" "
	}
	var $idmsj=' ';
	switch (f_eges_idmsj.toString().length){
		case 1:$idmsj='         '+f_eges_idmsj;break;
		case 2:$idmsj='        '+f_eges_idmsj;break;
		case 3:$idmsj='       '+f_eges_idmsj;break;
		case 4:$idmsj='      '+f_eges_idmsj;break;
		case 5:$idmsj='     '+f_eges_idmsj;break;
		case 6:$idmsj='    '+f_eges_idmsj;break;
		case 7:$idmsj='   '+f_eges_idmsj;break;
		case 8:$idmsj='  '+f_eges_idmsj;break;
		case 9:$idmsj=' '+f_eges_idmsj;break;
		default:$idmsj=f_eges_idmsj;break;
	}
	var $xml=''
	$xml= '<Orden> '
    $xml+= '<MSH Version="SCNetTerm7.1" Emisor="SC"'
    $xml+= ' Receptor="EGeS" Fecha="'         
	$xml+= f_eges_fechor
    $xml+= '" TipoMsj="'
    $xml+= f_eges_tipomsj
	$xml+= '" TipoProc="" IDMensaje="'
	$xml+= $idmsj
    $xml+= '"> '
    $xml+= '</MSH> '
    $xml+= '<MSA> '
    $xml+= '<Estado>'
    $xml+= '</Estado> '
    $xml+= '<IDMensajeIda>'
    $xml+= '</IDMensajeIda> '
    $xml+= '<Errores> '
    $xml+= '<Error /> '
    $xml+= '</Errores> '
    $xml+= '</MSA> '
    $xml+= '<ID>'
    $xml+= '</ID> '
    $xml+= '<NroComprobante>'
	$xml+= '8100'+f_eges_ipednroi+'-1'
    $xml+= '</NroComprobante> '
	$xml+= '<AccessionNumber> '
	$xml+= '8100'+f_eges_ipednroi+'-1'
    $xml+= '</AccessionNumber> '
    $xml+= '<Estado/> '
    $xml+= '<EstadoCodigo>10</EstadoCodigo> '
    $xml+= '<EstadoFecha>'
    $xml+= f_eges_estfec
    $xml+= '</EstadoFecha> '
    $xml+= '<EstadoHora>'
    $xml+= f_eges_esthor
    $xml+= '</EstadoHora> '
    $xml+= '<FechaCreacion>'
    $xml+= f_eges_fehocre
    $xml+= '</FechaCreacion> '
    $xml+= '<Creador Usuario=""'
    $xml+= ' Nombre=""'
    $xml+= ' Apellido=""'
    $xml+= '> '
    $xml+= '</Creador> '
    $xml+= '<Verificador/> '
    $xml+= '<Prioridad/> '
    $xml+= '<Centro> '
    $xml+= '<Division>SC</Division> '
    $xml+= '<Nombre>Sanatorio Colegiales</Nombre> '
    $xml+= '<Servicio>'
    $xml+= '</Servicio> '
    $xml+= '<Sector>'
    $xml+= f_eges_sector
    $xml+= '</Sector> '
    $xml+= '<Cama>'
    $xml+= f_eges_habcam
    $xml+= '</Cama> '
    $xml+= '</Centro> '
    $xml+= '<Solicitante> '
    $xml+= '<Nombre>'
    $xml+= '</Nombre> '
    $xml+= '<Apellido>'
    $xml+= f_eges_aynmedsol
    $xml+= '</Apellido> '
    $xml+= '<MatriculaTipo>MN</MatriculaTipo> '
    $xml+= '<MatriculaNumero>'
    $xml+= f_eges_matmedsol
    $xml+= '</MatriculaNumero> '
    $xml+= '<IDSC></IDSC> '
    $xml+= '<IDEspecialidad /> '
    $xml+= '<DescEspecialidad /> '
    $xml+= '</Solicitante> '
    $xml+= '<Efector> '
    $xml+= '<Nombre/> '
    $xml+= '<Apellido></Apellido> '
    $xml+= '<MatriculaTipo></MatriculaTipo> '
    $xml+= '<MatriculaNumero></MatriculaNumero> '
    $xml+= '<IDSC /> '
    $xml+= '<IDEspecialidad></IDEspecialidad> '
    $xml+= '<DescEspecialidad></DescEspecialidad> '
    $xml+= '</Efector> '
    $xml+= '<Diagnostico>'
    $xml+= f_eges_diagno
    $xml+= '</Diagnostico>'
    $xml+= '<ObservacionesOrden>'
    $xml+= f_eges_motfun
    $xml+= '</ObservacionesOrden>'
    $xml+= '<PV1> '
    $xml+= '<PV1Fecha>'
    $xml+= f_eges_fectur
    $xml+=  '</PV1Fecha> '
    $xml+= '<PV1Hora>'
    $xml+= f_eges_hortur
    $xml+= '</PV1Hora> '
    $xml+= '<PV1Servicio>'
    $xml+= '0'+f_eges_servi
    $xml+= '</PV1Servicio> '
    $xml+= '<LUGAR_ATENCION></LUGAR_ATENCION> '
    $xml+= '<PV1TipoTurno></PV1TipoTurno> '
    $xml+= '<CLASE_PACIENTE></CLASE_PACIENTE> '
    $xml+= '<ADMISION_TIPO> '
    $xml+= '</ADMISION_TIPO> '
    $xml+= '</PV1> '
    $xml+= '<Paciente> '
    $xml+= '<NroHistoriaClinica>'
    $xml+= f_eges_histcli
    $xml+= '</NroHistoriaClinica> '
    $xml+= '<Nombre>'
    $xml+= f_eges_nombre
    $xml+= '</Nombre> '
    $xml+= '<Apellido>'
    $xml+= f_eges_apellido
    $xml+= '</Apellido> '
    $xml+= '<TipoDocumento>'
    $xml+= f_eges_tipdoc
    $xml+= '</TipoDocumento> '
    $xml+= '<NroDocumento>'
    $xml+= f_eges_numdoc
    $xml+= '</NroDocumento> '
    $xml+= '<NroInternacion>'
    $xml+= f_eges_nrointer
    $xml+= '</NroInternacion> '
    $xml+= '<Modalidad>'
    $xml+= f_eges_modal
    $xml+= '</Modalidad> '
    $xml+= '<FechaNacimiento>'
    $xml+= f_eges_fecnac
    $xml+= '</FechaNacimiento> '
    $xml+= '<Sexo>'
    $xml+= f_eges_sexo
    $xml+= '</Sexo> '
    $xml+= '<EstadoCivil /> '
    $xml+= '<Nacionalidad /> '
    $xml+= '<Cobertura>'
    $xml+= f_eges_cober 
    $xml+= '</Cobertura> '
    $xml+= '<Plan>'
    $xml+= f_eges_plan
    $xml+= '</Plan> '
    $xml+= '<Afiliado>'
    $xml+= f_eges_afiliado
    $xml+= '</Afiliado> '
    $xml+= '<CondicionIVA>'
    $xml+= f_eges_condiva
    $xml+= '</CondicionIVA> '
    $xml+= '<Email>'
    $xml+= f_eges_email
    $xml+= '</Email> '
    $xml+= '<Telefono>'
    $xml+= '<CodArea />'
    $xml+= '<Numero />'
    $xml+= '</Telefono> '
    $xml+= '<Celular>'
    $xml+= '<CodArea>'
    $xml+= '</CodArea> '
    $xml+= '<Numero>'
    $xml+= '</Numero> '
    $xml+= '</Celular>   '
    $xml+= '<Domicilio>'
    $xml+= '</Domicilio> '
    $xml+= '<Localidad>'
    $xml+= '</Localidad> '
    $xml+= '<Provincia>'
    $xml+= '</Provincia> '
    $xml+= '<CodPostal>'
    $xml+= '</CodPostal> '
    $xml+= '<AutorizacionEnvioInformeMail>'
    $xml+= f_eges_autori
    $xml+= '</AutorizacionEnvioInformeMail> '
    $xml+= '</Paciente> '
    $xml+= '<PR1S> '
    $xml+= '<PR1> '
    
	    $xml+= '<SET_ID>'
		$xml+= f_eges_seqpres
		$xml+= '</SET_ID> '
		$xml+= '<ID>'
		$xml+= f_eges_codpres
		$xml+= '</ID> '
		$xml+= '<DESCRIPCION_PRESTACION>'
		$xml+= f_eges_nompres.substr(0,60)
		$xml+= '</DESCRIPCION_PRESTACION> '
		$xml+= '<NOMENCLADOR>1</NOMENCLADOR> '
		$xml+= '<CANTIDAD>1</CANTIDAD> '
    
    $xml+= '<Observaciones /> '
    $xml+= '</PR1> '
    $xml+= '</PR1S> '
    $xml+= '</Orden> '
	
	var fs = databaseManager.getFoundSet("validaciones","requestsc")
	fs.newRecord()
	fs['idmensaje']=f_eges_idmsj
	fs['mensaje']=$xml
	fs['estadomensaje']='E'
	fs['fechamensaje']=f_eges_fechamensaje
	fs['codigo']=0
		
	try{
		databaseManager.saveData(fs)
	}catch(msg){
		plugins.dialogs.showErrorDialog("Error grabacion REQUESTSC",msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de requestsc",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de requestsc",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		
	}
}
