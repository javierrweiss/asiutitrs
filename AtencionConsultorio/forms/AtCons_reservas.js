/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"39A9F0AE-1074-4EEC-BF09-075E62FCFD11",variableType:4}
 */
var f_estadtur_consulta = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9D627BAC-4366-4D8C-BAB2-BB5A77A3B336",variableType:4}
 */
var f_estadtur_practica = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D0F3A313-EAFC-473C-A05A-3E0829563F13"}
 */
var f_eges_condicioniva = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AEA2EF06-E8BB-4747-9B91-13039807741C"}
 */
var f_eges_obrpla_x = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"02620DB0-8CAA-4AFF-A775-83AA76235000",variableType:4}
 */
var f_eges_estadocodigo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AA60CA56-2E4B-4287-9F04-8C92AEF4D6BB",variableType:4}
 */
var f_eges_esp_prestacion = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"63E44BB7-F6EB-4DF2-8611-28E913144140"}
 */
var f_eges_nomprof = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0CFE05BB-B824-472B-BD56-0E984C60FA33"}
 */
var f_eges_mail = ' ';

/**
 * @properties={typeid:35,uuid:"1183F88A-4872-4494-BB58-C686761CCE40",variableType:-4}
 */
var f_eges_imacodidescod = new Array();

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A13E085C-185C-47BE-9D98-1326C0117537"}
 */
var f_eges_nroorden = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0FFD3326-4348-4816-8960-2B5F7F872EAA"}
 */
var f_eges_tiposol = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"20764853-6B89-4012-BA0A-AE70D69388DF"}
 */
var f_eges_nrodocumento = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9B626F21-28FD-41E5-83E2-827655326434"}
 */
var f_eges_tipodocumento = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A7FC635F-3D44-4B64-B2AC-424C9EA1311E"}
 */
var f_eges_errores = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9A6C7060-64A3-439E-9623-1FBC14F91CB4",variableType:8}
 */
var f_idmensaje_requesteg = 0;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"3C7248F0-5E54-4AE7-8ECE-C760A4647759",variableType:93}
 */
var f_eges_fechamensaje = new Date();

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9E9DC2A0-A274-4439-963C-6440E7E80487"}
 */
var f_eges_estadomensaje = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4AA0BDC1-2BCA-4247-AEBE-FD529A129FC7"}
 */
var f_mensaje = 'null';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AB4C3B6D-4BB2-4A13-A013-455B1E0E3188"}
 */
var f_error_msa = ' ';

/**
 * @properties={typeid:35,uuid:"6EF850D2-5C78-411C-95DB-B19ABCE3DD86",variableType:-4}
 */
var f_retorno_msa = false;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"99114242-5E77-4BCD-92C5-7B39FBC3D177"}
 */
var f_eges_hiscli = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6142C306-AFE1-448C-BF7C-0C6842E75166"}
 */
var f_eges_pv1tipoturno = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B87382F6-BD1F-4B3C-904B-65269FD0FABE"}
 */
var f_eges_pv1hora = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9AC355AC-25F0-47D3-9969-B2CB6324761F"}
 */
var f_eges_pv1fecha = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7EEFB553-9DC7-41EF-A4F3-1F56342C0BE1",variableType:4}
 */
var f_eges_idmensaje = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8EF31A8C-CFB3-4353-8EC1-61D38C8814EB",variableType:4}
 */
var f_eges_matricula = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DD756644-F14E-40D8-80E9-0EF0EE9E6D8E",variableType:4}
 */
var f_eges_resecoddiag = 0;

/**
 * @properties={typeid:35,uuid:"45A2F8BE-1828-4977-91FA-2C410AB65F37",variableType:-4}
 */
var f_eges_resecodl = new Array();

/**
 * @properties={typeid:35,uuid:"5548BC8F-E884-4B63-A87F-E6EC55B1B693",variableType:-4}
 */
var f_eges_resecodcantid = new Array();

/**
 * @properties={typeid:35,uuid:"A21ACFE8-ACAD-4491-AED5-54496A37C76D",variableType:-4}
 */
var f_eges_resecodnumcod = new Array();

/**
 * @properties={typeid:35,uuid:"E893F575-E275-46A3-B0A5-2915676FF81F",variableType:-4}
 */
var f_eges_resecodtipcod = new Array();

/**
 * @properties={typeid:35,uuid:"ABE84FC8-2A7F-435F-B7AC-060436BF7820",variableType:-4}
 */
var f_eges_resecoditem = new Array();

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6F2FA280-8475-46A8-B9CF-20CFDD1778E5",variableType:4}
 */
var f_eges_resecodhora = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"792D2636-24EA-4607-9801-8A0207CB51BD",variableType:4}
 */
var f_eges_resecodfech = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1066B6FF-521B-4B27-8E42-755C21B1DC32",variableType:4}
 */
var f_eges_resecodmed = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7E970640-00AA-4F5F-B72E-325ED224C25F",variableType:4}
 */
var f_eges_resecodesp = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4CAD7B95-1FC3-439C-9AF5-0513938AB3B5",variableType:4}
 */
var f_eges_tip_servicio = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9B1B6C51-7349-43F0-A21D-D34117D9CA01",variableType:4}
 */
var f_eges_servicio = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4FC11441-72C0-4544-AB63-5BE8C191BF49",variableType:4}
 */
var f_eges_sexo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0E6F2C36-1851-4D40-A08A-4E848DE6282A",variableType:4}
 */
var f_eges_tip_opera = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A51768D0-E13A-45DF-A7A3-DB042432C01C",variableType:4}
 */
var f_eges_operador = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1D70232E-531F-4C93-B0E0-2CD1BFE9FD85"}
 */
var f_eges_benef = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9AFA092B-3AB4-492C-8073-4E461347F2F5"}
 */
var f_eges_obrpla = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D5694893-E386-4476-8C85-B328382C9C3A",variableType:4}
 */
var f_eges_obra = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2200E514-3B1B-489F-A30B-BB72C24E30CC",variableType:4}
 */
var f_eges_consul = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4BD285F3-9694-4C18-8DDA-0126AF56A415",variableType:4}
 */
var f_eges_hora = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"743DE910-65E7-4AA9-8B9D-337948140733",variableType:4}
 */
var f_eges_fech = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D2C7A299-CDA2-40FF-A0C7-D4F7D86DB0B7",variableType:4}
 */
var f_eges_med = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F33CE1D0-D14B-45FD-8A72-C3A48F392959",variableType:4}
 */
var f_eges_esp = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3DD493C4-D976-42F4-9F18-A6EC2942F476"}
 */
var f_vacio = '  ';

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"1B9F8FED-CA4B-431C-A55F-BA10319CE32E",variableType:93}
 */
var f_fecha_dia = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"42D14AFB-549E-4FEE-987F-C6568BF36636",variableType:4}
 */
var f_hubo_turno = 0;

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"00AE37A7-B360-451D-939C-3DF09F67AF89"}
 * @AllowToRunInFind
 */
function onShow(firstShow, event) {	
	obtengo_turnos_Eges()
//  filtro  de estados
	if (atcons_vs_to_tbc_reservas.find() == false) 
		{globals.AtCons_vmensaje = 'Error al buscar reservas' 
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		return }	

	atcons_vs_to_tbc_reservas.reservasatendi = '0||2||3||4' 
	atcons_vs_to_tbc_reservas.reservasesta 	 = '0||1'
		
	
	if (atcons_vs_to_tbc_reservas.search() == 0) {
		if (firstShow )
		{globals.AtCons_vmensaje = 'NO encontró pacientes agendados en esta grilla' 
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		onAction_salir(event)
		return}  
	}
	if (atcons_vs_to_tbc_reservas.getSize()>0){
		var $largo_reservas = atcons_vs_to_tbc_reservas.getSize()
		for(var i=1;i<=$largo_reservas;i++){
			atcons_vs_to_tbc_reservas.setSelectedIndex(i);
			if(atcons_vs_to_tbc_reservas.reservasipedido!=null&&atcons_vs_to_tbc_reservas.reservasipedido!=0&&atcons_vs_to_tbc_reservas.reservasservicio!=null&&atcons_vs_to_tbc_reservas.reservasservicio!=0){
				grabar_resecod_en_auxiliar(atcons_vs_to_tbc_reservas.reservasesp, atcons_vs_to_tbc_reservas.reservasmed, atcons_vs_to_tbc_reservas.reservasfech, atcons_vs_to_tbc_reservas.reservashora, atcons_vs_to_tbc_reservas.reservastipser, atcons_vs_to_tbc_reservas.reservasipedido, atcons_vs_to_tbc_reservas.reservasservicio);
			}
		}
	}
 
	return
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"755A7683-D9A4-49FD-BF8B-DC9D1AEB3862"}
 */
function onAction_salir(event) {
	var cuantos_hay = foundset.getSize()
	// TODO hay que controlar que no quede ninguno pendiente ? 
	// TODO ver si se hace recorrida de histpac_ing y se graban de prepo
	if (cuantos_hay != 0)
	{	scopes.globals.AtCons_vmensaje = 'Hay pacientes pendientes de atencion' + '\n' +  'Está seguro que quiere salir?'   // Solo avisa
		var resp = globals.DIALOGS.showQuestionDialog('¡Atención!',scopes.globals.AtCons_vmensaje , 'Si', 'No');
		if (resp == 'No')
			{return}	
	}   

	//plugins.scheduler.removeJob('turnos_refresh')   // 26/6/2018
	detener_cron()   // 27/6/2018
	
	var $win = application.getWindow("reservas");
	if ($win != null){
		$win.hide() 
		$win.destroy()}
	else {return}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"5CC97530-BE66-4C5E-AAFC-0BCB944A603C"}
 * @AllowToRunInFind
 */
function onAction_ausente(event) {
	
if (reservasatendi == 3)		 
	{scopes.globals.AtCons_vmensaje = 'Paciente en Espera - Finalizar antencion'
	 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
	 return}
if (reservasatendi == 4)	   
	{scopes.globals.AtCons_vmensaje = 'Paciente Tomado por otro profesional'
	 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
	 return}

scopes.globals.AtCons_vmensaje = '¿Está seguro que marca como ausente al paciente?'   
var resp = globals.DIALOGS.showQuestionDialog('¡Atención!',scopes.globals.AtCons_vmensaje , 'Si', 'No');
if (resp == 'No')
	{return}
	
//databaseManager.setAutoSave(false)   // se puso al inicio de la solucion  21/06/2018
var indice = foundset.getSelectedIndex()
databaseManager.refreshRecordFromDatabase(foundset, indice)
if (reservasatendi == 9)	    // 28/06/2018 x baja simultanea = mismo medico en 2 pantallas diferentes
	{scopes.globals.AtCons_vmensaje = 'Paciente Dado de baja por otro profesional'
	 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
	 onShow(false,event)
	 return}

detener_cron()  // 28/06/2018
//// RESERVAS  cambia estado = 9  segun programa cobol y pone hora hora atencion/final
	reservasatendi = 9 
	f_fecha_dia = application.getServerTimeStamp()  
	var $anio = f_fecha_dia.getFullYear()
    var $mes  = f_fecha_dia.getMonth() + 1
    var $dia  = f_fecha_dia.getDate()
	var $hora = f_fecha_dia.getHours()
	var $min  = f_fecha_dia.getMinutes()
	var $seg  = f_fecha_dia.getSeconds()
	var $mseg = f_fecha_dia.getMilliseconds()
	/*if ($mseg < 10)
			{$mseg = "0" + $mseg}
	else
	if ($mseg > 99)
		{var $mseg_aux = $mseg + ''
		$mseg = $mseg_aux.substr(1,2) * 1}   */

		var $seg_ed =""
		if ($seg < 10)
			{$seg_ed = "0" + $seg}
		else{$seg_ed = $seg}
		
		var $mseg_ed=""		
		if ($mseg < 10)
			{$mseg_ed = "0" + $mseg}
		else
		if ($mseg > 99)
			{var $mseg_aux = $mseg + ''
			$mseg_ed = $mseg_aux.substr(1,2)}
			else{
				$mseg_ed = $mseg}		
		
	//reservashoraatenc =  $hora * 1000000 + $min * 10000
	reservashoraatenc =  $hora +'' + $min + '' + '0000'

	var cual_es = foundset.getSelectedIndex()
	var msg = ''
	try {databaseManager.saveData(foundset.getRecord(cual_es))}
	//try {databaseManager.saveData()}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error al grabar 'Ausente' en tbc_reserva",msg.toString(),"ok"))
		//	application.output(msg.rhinoException.getMessage())
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(foundset)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de 'Ausente' en tbc_reserva",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de 'Ausente' en tbc_reserva",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		arrancar_cron()
		return}
				
	if(reservasipedido!=0){
		anular_pedido(reservasservicio, reservasipedido, 2, globals.AtCons_vlega, globals.AtCons_vmedico_tipo)
	}
		
/*    MOVE 1      TO WMOD(1)                                     
	  MOVE 1      TO TXT-1G                                     
	  MOVE 1      TO TXT-3                                        
	  MOVE 1      TO TXT-2.    */
	
//// TBL_PARAMETROS
/*
	var fs_param  = databaseManager.getFoundSet('desal', 'tbl_parametros')
	if (fs_param.find() == false)
		{databaseManager.revertEditedRecords(foundset)
		scopes.globals.AtCons_vmensaje = 'No encontró tbl_parametros al grabar ausente '
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		return }
	fs_param.paramid = 16
	if (fs_param.search() == 0)  
		{databaseManager.revertEditedRecords(foundset)
		scopes.globals.AtCons_vmensaje = 'No encontró Numeracion para textos al grabar ausente '
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		return }
	
	fs_param.contador_entero = fs_param.contador_entero + 1 
	*/
////NUMERACION MOTIVO para HISTPAC_TXT 
	var nro_motivo = null;
	var nro_de_contador = 16
	nro_motivo = scopes.globals.numeracion_txt(nro_de_contador)
	if (nro_motivo == null) 
		{globals.DIALOGS.showWarningDialog("Atención!","No ha sido posible tomar el numero del Texto del Motivo. Vuelva a intentar.\nSi el problema persiste contacte al administrador del sistema.","Aceptar")
			arrancar_cron()
			return}	
	
//// HISTAPC_TXT
	var fs_histpac_txt  = databaseManager.getFoundSet('asistencial', 'tbc_histpac_txt')
	fs_histpac_txt.newRecord()
	// solo una linea de texto
	fs_histpac_txt.txt1  = nro_motivo
	fs_histpac_txt.txt1g = 1
	fs_histpac_txt.txt2  = 1   // linea de texto
	fs_histpac_txt.txt3  = 1
	fs_histpac_txt.txt4  = 'EL PACIENTE NO CONCURRIO A LA CONSULTA'
	fs_histpac_txt.txt6  = 0 // solo para cabecera 
		
	// cabecera	
	fs_histpac_txt.newRecord()  // cabecera
	fs_histpac_txt.txt1  = nro_motivo
	fs_histpac_txt.txt1g = 1   // grupo
	fs_histpac_txt.txt2  = 0   // 0=cabecera
	fs_histpac_txt.txt3  = 0   // va 0 
	fs_histpac_txt.txt4  = ' '
	fs_histpac_txt.txt6  = 1  // solo para cabecera   va cant renglones
	/// GRABAR HISTPAC_TXT
	try {databaseManager.saveData(fs_histpac_txt)}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error al grabar 'Ausente' en tbc_histpac_txt",msg.toString(),"ok"))
	}	
	error1=''
	error2=''
	array = databaseManager.getFailedRecords(fs_histpac_txt)
	for (i = 0; i < array.length; i++) {
		record = array[i];
		jstable = databaseManager.getTable(record);
		tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_histpac_txt",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_histpac_txt",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		arrancar_cron()  // 28/06/2018
		return}
	//// HISTPAC	
	var fs_histpac      = databaseManager.getFoundSet('asistencial', 'tbc_histpac')
	fs_histpac.newRecord()
	fs_histpac.histpacnro  = reservashiscli
	fs_histpac.histpacfec  = reservasfech
	
	var $hora_min_string = reservashora + ''
	if (reservashora < 10000000) 
		{$hora_min_string = '0' + reservashora + ''}
    var $hora_string = $hora_min_string.substr(0,2)
    var $min_string  = $hora_min_string.substr(2,2)
	var $segm_string = $hora_min_string.substr(4,4)
	fs_histpac.histpach = $hora_string
	fs_histpac.histpacm = $min_string 
	fs_histpac.histpacr = $segm_string   
	fs_histpac.histpace = 1
	fs_histpac.histpacespfir  = reservasesp
	fs_histpac.histpacnro1    = reservashiscli
	fs_histpac.histpacmedfir  = scopes.globals.AtCons_vlegajo  // sin dig. verif. ?? es atcon_lega
	fs_histpac.histpacnro2    = reservashiscli
	fs_histpac.histpacfec1    = reservasfech
	fs_histpac.histpacespfir1 = reservasesp
	fs_histpac.histpacmedfirnya = scopes.globals.AtCons_vmedico  
	fs_histpac.histpacmedfirmat = scopes.globals.AtCons_vmedico_mat
	fs_histpac.histpacmotivo = nro_motivo
	fs_histpac.histpachorasobre = reservashorasobre 
	fs_histpac.histpachfinal = $hora    // es el time
	fs_histpac.histpacmfinal = $min     
	//fs_histpac.histpacrfinal = $seg * 100  + $mseg  
	fs_histpac.histpacrfinal = $seg_ed +''+ $mseg_ed
	fs_histpac.histpacdiagno = ' '     // not null
	fs_histpac.histpacpatolo = 0
	fs_histpac.histpactratam = 0       // not null  
	fs_histpac.histpacestudi = 0
	fs_histpac.histpachatenc = $hora   // es el time
	fs_histpac.histpacmatenc = $min   
	fs_histpac.histpacratenc = fs_histpac.histpacrfinal  
	fs_histpac.histpacobra    = reservasobra  
    if (atcons_tbc_reservas_to_tbc_plan_obra.getSize() != 1) {
    	fs_histpac.histpacpplan  = " "
    	if (reservasobrpla != "          ")
    		{fs_histpac.histpacpplan   = reservasobrpla
    		//scopes.globals.AtCons_vmensaje = 'NO Existe Obra/Plan en tabla TBC_Plan_Obra'
    		//globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")	
    		//return
			}}
    	else
    		{fs_histpac.histpacpplan   = atcons_tbc_reservas_to_tbc_plan_obra.ploplanx}
	
    fs_histpac.histpacplan    = reservasobrpla
    fs_histpac.histpacafil    = reservasnroben
    fs_histpac.histpacderiva = 0
	fs_histpac.histpacderivads  = 0
	fs_histpac.histpacderivasec = ' '   // not null
	fs_histpac.histpacpedambula  = 0
	fs_histpac.histpacconshiv    = ' '  // not null
    fs_histpac.histpacinterconsu = 0
	fs_histpac.histpacentregado  = 9
	fs_histpac.histpacctro    = 0
    fs_histpac.histpaccancd   = 0
	fs_histpac.histpacyodo    = "N"    // not null
   
///// GRABA HISTPAC
	try {databaseManager.saveData(fs_histpac)}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error al grabar 'Ausente' en tbc_histpac",msg.toString(),"ok"))
		//	application.output(msg.rhinoException.getMessage())
	}
	error1=''
	error2=''
	i = 0
	array = databaseManager.getFailedRecords(fs_histpac)
	for (i = 0; i < array.length; i++) {
		record = array[i];
		jstable = databaseManager.getTable(record);
		tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_histpac",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_histpac",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		arrancar_cron()  // 28/06/2018
		return}
	
scopes.globals.AtCons_vmensaje = 'Grabo Ausente correctamente'
globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")	
onShow(false,event)
arrancar_cron()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"3E40895E-758C-46D8-80BC-53916135B66C"}
 * @AllowToRunInFind
 */
function onAction_ir_a_paciente(event) 
{ 	
	// TODO onAction_refresh() es muy lento
	var indice = foundset.getSelectedIndex()
	databaseManager.refreshRecordFromDatabase(foundset, indice)	
	if (reservasesta == 0)		 
		{scopes.globals.AtCons_vmensaje = 'Paciente no Confirmado aún'
		 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		 return}  

	if (reservasatendi == 1)		 
		{scopes.globals.AtCons_vmensaje = 'Paciente ya atendido'
		 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		 return} 
	
	if (reservasatendi == 4)		// TODO 11/06/2018  
		{scopes.globals.AtCons_vmensaje = 'Paciente Tomado por otro profesional'
		 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		 return}
	 
	/*    
	// TODO parece que solo se pregunta para informar que ciertos campos son obligatorios
              ->   quitar si se confirma
	// ver primera vez    deberia ser primera vez en la especialidad
    var fs_histpac  = databaseManager.getFoundSet('asistencial', 'tbc_histpac')
	if(fs_histpac.find() == false)
	{scopes.globals.AtCons_vmensaje = 'No encontró historia clinica del paciente';
	plugins.dialogs.showInfoDialog('Aviso' , globals.AtCons_vmensaje ,'Ok')
	return}
	
	fs_histpac.histpacespfir = scopes.globals.AtCons_vespecial
	fs_histpac.histpacnro1 = reservashiscli
	if (fs_histpac.search() == 0)    // si no encontro es primera vez = 1
		{reservasprimeravez = 1}
	else
		{reservasprimeravez = 0}   // si  encontro no es primera vez = 0
	//  GRABAR tbc_reservas
	*/ 
	
	// TODO  mensaje vademecum el mensaje hace referencia a "Medicamentos" que no se desarrolló
	/* if (reservasobra == 352)  // cobermed verificar  NO ponerlo 12/4/2018
	{
		scopes.globals.AtCons_vmensaje =
	  'SR. PROFESIONAL                                    ' + '\n' +
	  '  LE RECORDAMOS QUE ES OBLIGATORIO LA UTILIZACION  ' + '\n' +
	  '  DE LA GUIA FARMACOTERAPEUTICA (VADEMECUM); QUE   ' + '\n' +
	  '  ESTA CONFECCIONADA SEGUN LEGISLACION VIGENTE, POR' + '\n' +
	  '  "GENERICOS"; PARA LOS PACIENTES DE LA COBERTURA  ' + '\n' +
	  '  COBERMED.  LA CUAL PODRA CONSULTAR EN LA OPCION  ' + '\n' +
	  '  "Medicamentos a recetar".                        ' + '\n' +
	  '                         LA DIRECCION.-            '
	  globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar") 
	}  */
	
	if (reservashiscli == null) 
		{scopes.globals.AtCons_vmensaje = 'NO hay reservas '
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		onAction_salir(event)
		return}
	
	 //  parametros tipo, hclin, muestra, sicarga // modulo ya desarrollado
	var hubo_alerta = scopes.globals.ControlAlerta(1, reservashiscli, 1, 0)
	
	scopes.globals.AtCons_vhistcli       = reservashiscli
	scopes.globals.AtCons_crono_vhisclinro  = reservashiscli   // 17-11-2018 para cronologia
	if (scopes.globals.AtCons_vhistcli == null)    //  solo para ver que tiene x error
		{scopes.globals.AtCons_vmensaje = 'NO hay reservas '
		globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")}
	
	if (atcons_tbc_reservas_to_tbc_hist_cab == 0)
		{scopes.globals.AtCons_vmensaje = 'NO existe Nro. Historia Clinica ' + reservashiscli +' en tbc_hist_cab'
		 globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")
		 return}
	scopes.globals.Atcons_paciente_nya   = atcons_tbc_reservas_to_tbc_hist_cab.histcab_apellnom
	scopes.globals.Atcons_paciente_obra  = reservasobra
	scopes.globals.Atcons_paciente_obra_descr = atcons_tbc_reservas_to_tbc_obras.obr_nomadmis
	scopes.globals.Atcons_paciente_obra_plan  = reservasobrpla
	//scopes.globals.Atcons_paciente_sexo = reservassexo // todas las columnas tienen null
	scopes.globals.Atcons_paciente_sexo  = atcons_tbc_reservas_to_tbc_hist_cab.histcab_sexo
	scopes.globals.Atcons_paciente_edad  = scopes.globals.CalculoEdad(atcons_tbc_reservas_to_tbc_hist_cab.histcab_fecnac)
	scopes.globals.Atcons_paciente_nro_afil = reservasnroben
	scopes.globals.Atcons_vreservashora = reservashora    // 26/06/2018
	
	var ing = atcons_reservas_to_atcons_histpac_ing
	if (atcons_reservas_to_atcons_histpac_ing.getSize() == 0)  // aun no fue dado de alta en tabla auxiliar
	{			
		//var ing = atcons_reservas_to_atcons_histpac_ing
		atcons_reservas_to_atcons_histpac_ing.newRecord()
		
		if (atcons_vlegajo_to_tbc_medtur.medturtip == 'E'){
			ing.histpacmedfirmat = atcons_tbc_reservas_to_tbc_medicos.med_matricula
			ing.histpacmedfirnya = atcons_tbc_reservas_to_tbc_medicos.med_apenom}
		else {
			ing.histpacmedfirmat = atcons_tbc_reservas_to_tbc_personal.per_codmatri
			ing.histpacmedfirnya = atcons_tbc_reservas_to_tbc_personal.per_apelnom	
		}
		ing.histpacmedfir  = scopes.globals.AtCons_vlegajo    // con dig verif
		ing.histpacobra    = reservasobra 
		if (atcons_tbc_reservas_to_tbc_plan_obra.getSize() != 1) {
			ing.histpacplan   = " "
			if (reservasobrpla != "          ")
			{ing.histpacplan   = "          "
			//scopes.globals.AtCons_vmensaje = 'NO Existe Obra/Plan en tabla TBC_Plan_Obra'
			//globals.DIALOGS.showInfoDialog('Aviso',scopes.globals.AtCons_vmensaje,"Aceptar")	
			//return
			}}
		else
		{ing.histpacplan   = atcons_tbc_reservas_to_tbc_plan_obra.ploplanx}
	    ing.histpacpplan   = reservasobrpla   //atcons_tbc_reservas_to_tbc_hist_cab.histcab_planx
		ing.histpacafil    = reservasnroben
		ing.histpacnro     = reservashiscli
		ing.histpacnro1    = reservashiscli
		ing.histpacnro2    = reservashiscli
		ing.histpacfec     = reservasfech
		ing.histpacfec1    = reservasfech
		ing.histpacespfir  = reservasesp
		ing.histpacespfir1 = reservasesp
		ing.histpace       = 1
		ing.histpac_horareserva = reservashora
		f_fecha_dia = application.getServerTimeStamp()  
		var $anio = f_fecha_dia.getFullYear()
	    var $mes  = f_fecha_dia.getMonth() + 1
	    var $dia  = f_fecha_dia.getDate()
		var $hora = f_fecha_dia.getHours()
		var $min  = f_fecha_dia.getMinutes()
		var $seg  = f_fecha_dia.getSeconds()
		var $mseg = f_fecha_dia.getMilliseconds()
		var $seg_ed =""
		if ($seg < 10)
			{$seg_ed = "0" + $seg}
			else{
				$seg_ed = $seg}
			
		var $mseg_ed=""		
		if ($mseg < 10)
			{$mseg_ed = "0" + $mseg}
		else
		if ($mseg > 99)
			{var $mseg_aux = $mseg + ''
			$mseg_ed = $mseg_aux.substr(1,2)}
			else{
				$mseg_ed = $mseg}

		ing.histpachatenc = $hora   // es el time de inicio
		ing.histpacmatenc = $min 
		//ing.histpacratenc = $seg * 100  + $mseg 
		ing.histpacratenc = $seg_ed +''+ $mseg_ed

		// es sobreturno ?
		var $hora_min_string = reservashora + ''
		if (reservashora < 10000000) 
			{$hora_min_string = '0' + reservashora + ''}
	    var $hora_string = $hora_min_string.substr(0,2)
	    var $min_string  = $hora_min_string.substr(2,2)
		var $segm_string = $hora_min_string.substr(4,4)
	    ing.histpachorasobre = reservashorasobre   //  va la hora del sobreturno de reserva ?

	    ing.histpach = $hora_string    // hora del turno de reservas
	    ing.histpacm = $min_string
	    ing.histpacr = $segm_string
		
	    ing.histpacconshiv   = " "   // no null
		ing.histpacderivasec = "           "   // no null
		ing.histpacderiva = 0 
		ing.histpacderivads = 0
		ing.histpacyodo    = "0"
		ing.histpacctro    = 0	
		ing.histpacentregado  = 9	
		ing.histpacinterconsu = 0		
		ing.histpaccancd   = 0
		
		ing.histpacmotivo  = null
		ing.histpacdiagno  = ''   
		ing.histpacestudi  = null
		ing.histpactratam  = null
		ing.histpacpatolo  = null
		
		ing.dietacod       = null
		scopes.globals.AtCons_dieta_cod = null
	    ing.test_si_no     = 0
	    ing.testcancer        = 0
	    ing.testdiagverosimil = 0
	    ing.testedema       = 0
	    ing.testedemafovea  = 0
	    ing.testhichazon    = 0
	    ing.testhipersensi  = 0
	    ing.testparalisis   = 0
	    ing.testpostracion  = 0
	    ing.testvenasnovari = 0
	    ing.testdimerod     = 0
		
	    ing.yodoalergico    = "0"
		ing.yodoaque        =  0
		ing.yodoaque4       = " "
		ing.yodocardio4     = " "
		ing.yodocualcardio  =  0
		ing.yodoenfcardio    = "0"
		ing.yodoestcontraste = "0"
		ing.yodoinsrenal     = "0"
			
		ing.ambulapedido = null
		ing.ambulafecped = null
		ing.ambulahorped = null
		ing.ambulafectra = null
		ing.ambulahortra = null 
		ing.ambulatxt    = null
		ing.ambulaoxig   = null
		ing.ambulatipo   = null
		ing.hist_hubo_crono = 0
		ing.hist_anat_pat = 0 
		ing.reservasatendi_orig = reservasatendi  // TOMADO   12/06/2018
		ing.hist_hubo_alerta = hubo_alerta
		scopes.globals.gbl_con_diagnostico = null
		
	}
	else
	{databaseManager.refreshRecordFromDatabase(ing,ing.getSelectedIndex())
		scopes.globals.AtCons_dieta_cod = atcons_reservas_to_atcons_histpac_ing.dietacod
		ing.reservasatendi_orig = reservasatendi  // TOMADO   12/06/2018
		//if (ing.histpacdiagno != null && ing.histpacdiagno != '' && ing.histpacdiagno != ' ')
		//	{forms.AtCons_carga_diagnos.elements.diagno.enabled = false}   // TODO 25/06/2018
		} 
	
	try {databaseManager.saveData(atcons_reservas_to_atcons_histpac_ing)}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error en 'Atender Paciente' al grabar en atcons_histpac_ing",msg.toString(),"ok"))
		//	application.output(msg.rhinoException.getMessage())
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(atcons_reservas_to_atcons_histpac_ing)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de atcons_histpac_ing",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de atcons_histpac_ing",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		return}	
	
	//---------------------------
	detener_cron()       // 27/06/2018
	//---------------------------
	reservasatendi = 4   // TOMADO   11/06/2018
	try {databaseManager.saveData(foundset.getRecord(indice))}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error al grabar 'Tomado' en tbc_reserva",msg.toString(),"ok"))
		//	application.output(msg.rhinoException.getMessage())
	}
	var error3=''
	var error4=''
	//var i = 0
	var array1 = databaseManager.getFailedRecords(foundset)
	for (i = 0; i < array1.length; i++) {
		var record1 = array1[i];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3='Error de Grabación en Tabla: ' + tableSQLName1 + ' en server: ' + jstable1.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error4='Error en grabación '+record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown1 = record1.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown1)
		}
	}
	if(error3!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error3,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error4,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		arrancar_cron()   // 28/06/2018
		return }	
	globals.AtCons_vespecial=foundset.reservasesp	
	forms.AtCons_carga_diagnos.f_diagnos = ing.histpacdiagno
	
	/*
	forms.AtCons_carga.elements.btn_cefalea.visible=false
	forms.AtCons_carga.elements.btn_cefalea.enabled=false		
	if(foundset.reservasesp==365){
		forms.AtCons_carga.elements.btn_cefalea.visible=true
		forms.AtCons_carga.elements.btn_cefalea.enabled=true
	}
	
	forms.AtCons_carga.elements.tabs.setTabEnabledAt(7,false)
	*/
	if(foundset.reservasipedido!=0){
		//forms.AtCons_carga.elements.tabs.setTabEnabledAt(7,true)
		//forms.AtCons_carga.f_tiene_consulta=false
		globals.AtCons_tiene_consulta=false
		globals.AtCons_nroPedido=foundset.reservasipedido
		globals.AtCons_servicio=foundset.reservasservicio
		
		if(atcons_reservas_to_tbc_resecod.getSize()>1){
			for(var ii=1;ii<=atcons_reservas_to_tbc_resecod.getSize()&&!globals.AtCons_tiene_consulta;ii++){
				atcons_reservas_to_tbc_resecod.setSelectedIndex(ii)
				if(atcons_reservas_to_tbc_resecod.resecodnumcod==420101){
					globals.AtCons_tiene_consulta=true
				}
			}
		}else{
			globals.AtCons_tiene_consulta=false
		}
	}else{
		globals.AtCons_nroPedido=0
		globals.AtCons_servicio=0
		globals.AtCons_tiene_consulta=true
	}
	/*
	
	if(forms.AtCons_carga.foundset.getSize()>0){
		var j=0
		if(forms.AtCons_carga.f_tiene_consulta==true){
			for(j=1;j<=6;j++){
				forms.AtCons_carga.elements.tabs.setTabEnabledAt(j,true)
			}
		}else{
			for(j=1;j<=6;j++){
				forms.AtCons_carga.elements.tabs.setTabEnabledAt(j,false)
			}
		}
	}
	
	if(forms.AtCons_carga.f_tiene_consulta){
		//forms.AtCons_carga_motivo.elements.histpacmotivo.requestFocus()
		if  (atcons_vs_to_atcons_histpac_ing.histpacmotivo == '' ||   
		atcons_vs_to_atcons_histpac_ing.histpacmotivo == null ||
		atcons_vs_to_atcons_histpac_ing.histpacmotivo == ' ')		
			{forms.AtCons_carga.elements.tabs.setTabFGColorAt(1, '#E60026')}
		else{forms.AtCons_carga.elements.tabs.setTabFGColorAt(1, '#000000')}

		if  (atcons_vs_to_atcons_histpac_ing.histpacdiagno == '' ||
		atcons_vs_to_atcons_histpac_ing.histpacdiagno == null ||
		atcons_vs_to_atcons_histpac_ing.histpacdiagno == ' ')		
	 		{forms.AtCons_carga.elements.tabs.setTabFGColorAt(3, '#E60026')}
	 	else{forms.AtCons_carga.elements.tabs.setTabFGColorAt(3,  '#000000')}

	 	if  (atcons_vs_to_atcons_histpac_ing.histpactratam == '' ||
	 	atcons_vs_to_atcons_histpac_ing.histpactratam == null ||
	 	atcons_vs_to_atcons_histpac_ing.histpactratam == ' ')		
			{forms.AtCons_carga.elements.tabs.setTabFGColorAt(4, '#E60026')}
		else{forms.AtCons_carga.elements.tabs.setTabFGColorAt(4, '#000000')}
		forms.AtCons_carga.elements.tabs.tabIndex=1
		forms.AtCons_carga.controller.focusFirstField()
	}else{
		//forms.AtCons_carga_informe.controller.focusFirstField()
		forms.AtCons_carga.elements.tabs.tabIndex=7
		forms.AtCons_carga.controller.focusFirstField()
	}
	//elements.tabless_1.enabled=false
	if(globals.AtCons_servicio!=null&&globals.AtCons_servicio!=0){
		if(atcons_to_tbc_servicios.servpatologico!=1){
			if(atcons_vs_to_atcons_imapedet_inf.getSize()>0){
				atcons_vs_to_atcons_imapedet_inf.setSelectedIndex(1)
				globals.AtCons_patologico=atcons_vs_to_atcons_imapedet_inf.imapedipatologico
			}else{
				globals.AtCons_patologico=0
			}
			forms.AtCons_carga_informe.elements.patologico_lbl.visible=true
			forms.AtCons_carga_informe.elements.patologico_cbo.visible=true
		}else{
			forms.AtCons_carga_informe.elements.patologico_lbl.visible=false
			forms.AtCons_carga_informe.elements.patologico_cbo.visible=false
			globals.AtCons_patologico=1
		}
	}else{
		forms.AtCons_carga_informe.elements.patologico_lbl.visible=false
		forms.AtCons_carga_informe.elements.patologico_cbo.visible=false
		globals.AtCons_patologico=0
	}
	*/
	forms.AtCons_carga_tab.elements.tabless.tabIndex=1
	var $win = application.createWindow("carga",JSWindow.MODAL_DIALOG)
			        $win.title = " Atención Ambulatoria "
			        //$win.setSize(990,700) 
			        $win.show(forms.AtCons_carga_tab)
					$win.destroy()	
	
	//forms.AtCons_carga_tab.controller.show()
	arrancar_cron()	// 27/06/2018			
}

/**
 * @properties={typeid:24,uuid:"7345E20C-9DE5-4E5C-B135-FBD9676C8CCF"}
 */
function onAction_refresh() {
	//databaseManager.refreshRecordFromDatabase(atcons_vs_to_tbc_reservas,-1)  // tarda una eternidad 10/05/2018
	//reemplazar el refreshRecords con lo sig , xq tarda mucho // 11/05/2018
	// TODO aun asi tarda mucho 22/6/2018
	obtengo_turnos_Eges()
	var indice = foundset.getSelectedIndex()
	var hay = foundset.getSize()
	for (var i = 1 ; i < hay + 1 ; i++)  
	{
		foundset.setSelectedIndex(i)
		foundset.getSelectedIndex()
		if(foundset.reservasipedido!=null&&foundset.reservasipedido!=0&&foundset.reservasservicio!=null&&foundset.reservasservicio!=0){
			grabar_resecod_en_auxiliar(foundset.reservasesp, foundset.reservasmed, foundset.reservasfech, foundset.reservashora, foundset.reservastipser, foundset.reservasipedido, foundset.reservasservicio)
		}
		databaseManager.refreshRecordFromDatabase(foundset,i)
	}
	if (indice > 0) 
		{foundset.setSelectedIndex(indice)}
	else
		{foundset.setSelectedIndex(1)}
}

/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"62781399-F4ED-41CB-9846-4120435C3DAF"}
 */
function onLoad(event) { // se quita del "onload del form"  26/6/2018
	arrancar_cron()
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"393D4512-B462-4DD2-96CE-75DD4DE74C1C"}
 */
function onHide(event) {
	return false
}

/**
 * Perform the element default action.
 *
 * @properties={typeid:24,uuid:"2DAA992B-031E-42D5-8DBF-F423237C9B7B"}
 */
function onAction_boton_refresh() {
	obtengo_turnos_Eges()
	var indice = foundset.getSelectedIndex()
	onShow(false, null)
	onAction_refresh()
	if (indice > 0) 
		{foundset.setSelectedIndex(indice)}
	else
		{foundset.setSelectedIndex(1)}
	
}

/**
 * @properties={typeid:24,uuid:"348BEA4F-C5CD-42AB-9202-D5F780E5E24E"}
 */
function arrancar_cron() {
	plugins.scheduler.removeJob('turnos_refresh')
	//plugins.scheduler.addCronJob('turnos_refresh','0 0/2 * * * ?',onAction_refresh)
	plugins.scheduler.addCronJob('turnos_refresh','0 0/5 * * * ?',onAction_boton_refresh)
}

/**
 * @properties={typeid:24,uuid:"32C9625A-4ECB-415F-AC94-A463EFB53095"}
 */
function detener_cron() {
	plugins.scheduler.removeJob('turnos_refresh')
}

/**
 * @properties={typeid:24,uuid:"4E7F6C98-7F45-491B-B684-245905A499F3"}
 */
function obtengo_turnos_Eges(){
	f_mensaje=''
	var $plan=new Array();
	var sql = "select mensaje1, mensaje2, mensaje3, mensaje4, mensaje5, mensaje6, mensaje7, mensaje8, estadomensaje, fechamensaje, idmensaje from requesteg where estadomensaje='R' and tipomsj='ORM_O01'"
 //var sql = "select mensaje1, mensaje2, mensaje3, mensaje4, mensaje5, mensaje6, mensaje7, mensaje8 from requesteg where estadomensaje=0 and tipomsj='ORM'"
	var dataset = new Array() 
	if(databaseManager.getDataSetByQuery("validaciones",sql,null,-1)!=null){
		dataset=databaseManager.getDataSetByQuery("validaciones",sql,null,-1)
	}else{
		return
	}
	var kanti = dataset.getMaxRowIndex()
	f_retorno_msa=true
	f_error_msa=''
	if(kanti>0){
		for(var i=1;i<=kanti;i++){
			f_mensaje=dataset.getValue(i,1)+dataset.getValue(i,2)+dataset.getValue(i,3)+dataset.getValue(i,4)+dataset.getValue(i,5)+dataset.getValue(i,6)+dataset.getValue(i,7)+dataset.getValue(i,8)
			f_eges_estadomensaje=dataset.getValue(i,9)
			f_eges_fechamensaje=dataset.getValue(i,10)
			f_idmensaje_requesteg=dataset.getValue(i,11)
			
			if(parseo_xml_Eges(f_mensaje)){
				if(f_eges_esp_prestacion!=null&&f_eges_esp_prestacion!=0&&f_eges_esp_prestacion!=''){
					if(f_eges_esp_prestacion>0&&f_eges_esp_prestacion<=9999){
						f_eges_esp=f_eges_esp_prestacion
					}
				}
				$plan=f_eges_obrpla.toString().split('-')
				if($plan[1]=="General"){
					f_eges_obrpla=' '
					f_eges_obrpla_x=' '
				}else{
					f_eges_obrpla=obtenerPlan(f_eges_obra, $plan[1])
					f_eges_obrpla_x=$plan[1]
				}
				if(filtra_campos_clave_Reservas()){
					if(f_eges_estadocodigo==10){
						
							if(valida_turno_en_Reservas()){
								if(valida_hiscli()){
									if(insertar_turno()){
										insertar_resecod()
										graba_estadtur(true)
										actualiza_requesteg()
									}
								}
							}else{
								if(valida_hiscli()){
									if(regrabar_turno()){
										insertar_resecod()
										graba_estadtur(false)
										actualiza_requesteg()
									}
								}
							}
							insertar_responseeg()
				
					}else{
						if(f_eges_estadocodigo==40){
							cancelar_turno()
						}
					}
				}
				if(f_eges_servicio==35){
					insertar_tbl_teleconsulta()
					actualiza_requesteg()
				}
			}
		}
	}
	//getfoundset requesteg()
	//recorro foundset de mensajes
	//parseo
	//valida si existe turno
	//insertar turno en reservas
	//insertar practicas en resecod
}

/**
 * TODO generated, please specify type and doc for the params
 * @param mensaje
 *
 * @properties={typeid:24,uuid:"4135CFD5-B2F1-42D2-A27A-77A1A96D07CD"}
 */
function parseo_xml_Eges(mensaje){
	var nodes = plugins.XmlReader.readXmlDocumentFromString(mensaje);
	var childs = new Array()
	var subChilds = new Array()
	var subChilds2 = new Array()
	var ii = 0
	var jj = 0
	var ll = 0
	var xx = 0
	var $efector=false
	var $efector2=false
	f_eges_matricula=null
	f_eges_esp=null
	f_eges_pv1fecha=null
	f_eges_pv1hora=null
	f_eges_servicio=null
	f_eges_hiscli=null
	f_eges_resecodtipcod=new Array()
	f_eges_resecodnumcod=new Array()
	f_eges_resecodl=new Array()
	f_eges_resecoditem=new Array()
	f_eges_resecodcantid=new Array()
	f_eges_imacodidescod=new Array()
	f_eges_mail=' '
	f_eges_esp_prestacion=null
	f_eges_estadocodigo=0
						
	childs = nodes[0].getChildNodes()
	
	for(ii=0;ii<childs.length;ii++){
		if(childs[ii].getName().substr(0,3)=="MSH"){
			f_eges_idmensaje=childs[ii].getAttributeValue("IDMensaje")
		}
		switch (childs[ii].getName()){
			case 'Efector':$efector=true;$efector2=true;break;
			case 'MSA':break;
			case 'EstadoCodigo':f_eges_estadocodigo=utils.stringToNumber(childs[ii].getTextValue());break;
			case 'Apellido':if($efector2){f_eges_nomprof=childs[ii].getTextValue(); $efector2=false;}break;
			case 'MatriculaNumero':if($efector){f_eges_matricula=childs[ii].getTextValue(); $efector=false;}break;
			case 'IDEspecialidad':f_eges_esp=childs[ii].getTextValue();break;
			case 'PV1Fecha':f_eges_pv1fecha=childs[ii].getTextValue();break;
			case 'PV1Hora':f_eges_pv1hora=childs[ii].getTextValue();break;
			case 'Servicio':f_eges_servicio=childs[ii].getTextValue();break;
			case 'PV1Servicio':break;
			case 'PV1TipoTurno':break;
			case 'NroHistoriaClinica':f_eges_hiscli=childs[ii].getTextValue();break;
			case 'Sexo':break;
			case 'Cobertura':f_eges_obra=utils.stringToNumber(childs[ii].getTextValue());break;
			case 'Plan':f_eges_obrpla=childs[ii].getTextValue();break;
			case 'Afiliado':f_eges_benef=childs[ii].getTextValue();break;
			case 'CondicionIVA':f_eges_condicioniva=childs[ii].getTextValue();break;
			case 'PRIS':break;
			case 'PR1':break;
			case 'SET_ID':break;
			case 'ID':f_eges_nroorden=childs[ii].getTextValue();break;
			case 'NOMENCLADOR':break;
			case 'CANTIDAD':break;
			case 'ESPECIALIDAD_PRESTACION':if(childs[ii].getTextValue()!=null&&childs[ii].getTextValue()!=0){f_eges_esp_prestacion=childs[ii].getTextValue()};break;
		}
		if (f_eges_servicio!=30&&f_eges_servicio!=35){
			return false;
		}else{
			subChilds = childs[ii].getChildNodes()
			if(subChilds.length>0){
				for(jj=0;jj<subChilds.length;jj++){
					switch (subChilds[jj].getName()){
					case 'Efector':$efector=true;break;
					case 'EstadoCodigo':f_eges_estadocodigo=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'Apellido':if($efector2){f_eges_nomprof=subChilds[jj].getTextValue(); $efector2=false;}break;
					case 'MatriculaNumero':if($efector){f_eges_matricula=subChilds[jj].getTextValue(); $efector=false;}break;
					case 'IDEspecialidad':f_eges_esp=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'PV1Fecha':f_eges_pv1fecha=subChilds[jj].getTextValue();break;
					case 'PV1Hora':f_eges_pv1hora=subChilds[jj].getTextValue();break;
					case 'Servicio':f_eges_servicio=subChilds[jj].getTextValue();break;
					case 'PV1Servicio':break;
					case 'LUGAR_ATENCION':f_eges_consul=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'PV1TipoTurno':f_eges_pv1tipoturno=subChilds[jj].getTextValue();break;
					case 'NroHistoriaClinica':f_eges_hiscli=subChilds[jj].getTextValue();break;
					case 'NroDocumento':f_eges_nrodocumento=subChilds[jj].getTextValue();break;
					case 'TipoDocumento':f_eges_tipodocumento=subChilds[jj].getTextValue();break;
					case 'Sexo':break;
					case 'Cobertura':f_eges_obra=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'Plan':f_eges_obrpla=subChilds[jj].getTextValue();break;
					case 'Afiliado':f_eges_benef=subChilds[jj].getTextValue();break;
					case 'CondicionIVA':f_eges_condicioniva=subChilds[jj].getTextValue();break;
					case 'PRIS':break;
					case 'PR1':break;
					case 'SET_ID':break;
					case 'Email':f_eges_mail=subChilds[jj].getTextValue();break;
					case 'ID':f_eges_resecodnumcod[xx]=subChilds[jj].getTextValue();break;
					case 'DESCRIPCION_PRESTACION':f_eges_imacodidescod[xx]=subChilds[jj].getTextValue();break;
					case 'NOMENCLADOR':f_eges_resecodtipcod[xx]=subChilds[jj].getTextValue();break;
					case 'CANTIDAD':f_eges_resecodcantid[xx]=subChilds[jj].getTextValue();xx++;break;
					case 'ESPECIALIDAD_PRESTACION':if(subChilds[jj].getTextValue()!=null&&subChilds[jj].getTextValue()!=0){f_eges_esp_prestacion=subChilds[jj].getTextValue()};break;
					}
					
					subChilds2 = subChilds[jj].getChildNodes()
					if(subChilds2.length>0){
					
						for(ll=0;ll<subChilds2.length;ll++){
							
							switch (subChilds2[ll].getName()){
							case 'Efector':$efector=true;break;
							case 'EstadoCodigo':f_eges_estadocodigo=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'MatriculaTipo':break;
							case 'MatriculaNumero':if($efector){f_eges_matricula=subChilds2[ll].getTextValue(); $efector=false;};break;
							case 'IDEspecialidad':f_eges_esp=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'PV1Fecha':f_eges_pv1fecha=subChilds2[ll].getTextValue();break;
							case 'PV1Hora':f_eges_pv1hora=subChilds2[ll].getTextValue();break;
							case 'Servicio':f_eges_servicio=subChilds2[ll].getTextValue();break;
							case 'PV1Servicio':break;
							case 'LUGAR_ATENCION':f_eges_consul=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'PV1TipoTurno':f_eges_pv1tipoturno=subChilds2[ll].getTextValue();break;
							case 'NroHistoriaClinica':f_eges_hiscli=subChilds2[ll].getTextValue();break;
							case 'NroDocumento':f_eges_nrodocumento=subChilds2[ll].getTextValue();break;
							case 'TipoDocumento':f_eges_tipodocumento=subChilds2[ll].getTextValue();break;
							case 'Sexo':break;
							case 'Cobertura':f_eges_obra=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'Plan':f_eges_obrpla=subChilds2[ll].getTextValue();break;
							case 'Afiliado':f_eges_benef=subChilds2[ll].getTextValue();break;
							case 'CondicionIVA':f_eges_condicioniva=subChilds2[ll].getTextValue();break;
							case 'PRIS':break;
							case 'PR1':break;
							case 'SET_ID':break;
							case 'Email':f_eges_mail=subChilds2[ll].getTextValue();break;
							case 'ID':f_eges_resecodnumcod[xx]=subChilds2[ll].getTextValue();break;
							case 'DESCRIPCION_PRESTACION':f_eges_imacodidescod[xx]=subChilds2[ll].getTextValue();break;
							case 'NOMENCLADOR':f_eges_resecodtipcod[xx]=subChilds2[ll].getTextValue();break;
							case 'CANTIDAD':f_eges_resecodcantid[xx]=subChilds2[ll].getTextValue();xx++;break;
							case 'ESPECIALIDAD_PRESTACION':if(subChilds2[ll].getTextValue()!=null&&subChilds2[ll].getTextValue()!=0){f_eges_esp_prestacion=subChilds2[ll].getTextValue()};break;
							}
						}
					}
				}
			}
		}
	}
	if(!f_eges_hiscli||!f_eges_esp||!f_eges_matricula||!f_eges_pv1fecha||!f_eges_pv1hora||!f_eges_servicio){
		return false
	}else{
		return true
	}
}

/**
 * @properties={typeid:24,uuid:"36858C3C-7D22-4440-B7F6-7E3808603395"}
 * @AllowToRunInFind
 */
function filtra_campos_clave_Reservas(){
	if(f_eges_servicio!=30&&f_eges_servicio!=35){
		return false
	}
	if(f_eges_pv1fecha==null||f_eges_pv1hora==null){
		return false
	}
	if(f_eges_esp!=globals.AtCons_vespecial){
		return false
	}
	var i=0
	var fin_matricula=false
	var fin_especialidad=false
	f_eges_med=null
	var fs_medper = databaseManager.getFoundSet("maestros","tbc_medicos_personal")
	var fs_especialidad = databaseManager.getFoundSet("maestros","tbc_especial")
	fs_especialidad.find()
	fs_especialidad['esp_codi']=f_eges_esp
	fs_especialidad.search()
	if(fs_especialidad.getSize()>0){
		fin_especialidad=true
	}
	fs_medper.find()
	fs_medper['medpermatricun']=f_eges_matricula
	fs_medper.search()
	if(fs_medper.getSize()>0){
		for(i=1;i<=fs_medper.getSize()&&!fin_matricula&&fin_especialidad;i++){
			fs_medper.setSelectedIndex(i)
			if(fs_medper['medpercod']==globals.AtCons_vlega){
				f_eges_med=globals.AtCons_vlegajo
				if(fs_medper['medpertipoie']==0){
					f_eges_tiposol='I'
				}else{
					f_eges_tiposol='E'
				}
				fin_matricula=true
			}
		}
	}
	f_eges_hora=f_eges_pv1hora+"0000"
	f_eges_fech=f_eges_pv1fecha.substr(6,4)+f_eges_pv1fecha.substr(3,2)+f_eges_pv1fecha.substr(0,2)
	
	if(f_eges_fech!=globals.AtCons_vfecha_integer && f_eges_servicio==30){
		//if(f_eges_med!=6040){
			return false
		//}
	}
	
	if(!fin_especialidad||!fin_matricula){
		return false
	}else{
		return true
	}
}

/**
 * @properties={typeid:24,uuid:"4E46FD59-6D43-456A-8BE0-E1857E597198"}
 * @AllowToRunInFind
 */
function valida_turno_en_Reservas(){
	var fs_reservas = databaseManager.getFoundSet("asistencial","tbc_reservas")
	fs_reservas.find()
	fs_reservas['reservasesp']=f_eges_esp
	fs_reservas['reservasmed']=f_eges_med
	fs_reservas['reservasfech']=f_eges_fech
	fs_reservas['reservashora']=f_eges_hora
	fs_reservas.search()
	if (fs_reservas.getSize()>0){
		if(fs_reservas['reservashiscli']!=f_eges_hiscli){
			f_retorno_msa=false
			f_error_msa='Turno Existente'
			while (!f_retorno_msa){
				f_eges_hora=f_eges_hora+10000
				fs_reservas.find()
				fs_reservas['reservasesp']=f_eges_esp
				fs_reservas['reservasmed']=f_eges_med
				fs_reservas['reservasfech']=f_eges_fech
				fs_reservas['reservashora']=f_eges_hora
				fs_reservas.search()
				if (fs_reservas.getSize()<1){
					f_retorno_msa=true
				}
			}
			return true
		}else{
			/*
			if(fs_reservas['reservashiscli']==f_eges_hiscli&&f_eges_med==6040){
				f_retorno_msa=false
				f_error_msa='Turno Existente'
				while (!f_retorno_msa){
					f_eges_hora=f_eges_hora+10000
					fs_reservas.find()
					fs_reservas['reservasesp']=f_eges_esp
					fs_reservas['reservasmed']=f_eges_med
					fs_reservas['reservasfech']=f_eges_fech
					fs_reservas['reservashora']=f_eges_hora
					fs_reservas.search()
					if (fs_reservas.getSize()<1){
						f_retorno_msa=true
					}
				}
				return true
			}else{
			*/
			f_retorno_msa=false
			f_error_msa='Turno Existente'
			return false
			//}
		}
	}else{
		f_retorno_msa=true
		f_error_msa=''
		return true
	}
}

/**
 * @properties={typeid:24,uuid:"6AF0E65C-ACDE-4F87-8182-B9FF5291E9BC"}
 */
function insertar_turno(){
	forms.AtCons_reservas.foundset.newRecord()
	globals.InicializarDatos("AtCons_reservas","asistencial","tbc_reservas")
	//mover campos
	//
	//
	var $largo_hora4=0
	if(f_eges_hora>9999999){
		$largo_hora4=4
	}else{
		$largo_hora4=3
	}
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	var $condiva=0
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	if(f_eges_condicioniva=='O'){
		$condiva=1
	}else{
		if(f_eges_condicioniva=='V'){
			$condiva=3
		}else{
			$condiva=2
		}
	}
	forms.AtCons_reservas.foundset.reservasatendi=0
	forms.AtCons_reservas.foundset.reservasatendicef=0
	forms.AtCons_reservas.foundset.reservasconsu=f_eges_consul
	forms.AtCons_reservas.foundset.reservasesp1=f_eges_esp
	forms.AtCons_reservas.foundset.reservasesp2=f_eges_esp
	forms.AtCons_reservas.foundset.reservasesp3=f_eges_esp
	forms.AtCons_reservas.foundset.reservasesp6=f_eges_esp
	forms.AtCons_reservas.foundset.reservasesp=f_eges_esp
	forms.AtCons_reservas.foundset.reservasesta=1
	forms.AtCons_reservas.foundset.reservasestacef=1
	forms.AtCons_reservas.foundset.reservasfech1=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfech2=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfech3=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfech5=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfech6=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfech=f_eges_fech
	forms.AtCons_reservas.foundset.reservasfechaconf=$anio+$ed_mes+$ed_dia
	forms.AtCons_reservas.foundset.reservasfechaped=$anio+$ed_mes+$ed_dia
	forms.AtCons_reservas.foundset.reservashiscli=utils.stringToNumber(f_eges_hiscli)
	forms.AtCons_reservas.foundset.reservashora1=f_eges_hora
	forms.AtCons_reservas.foundset.reservashora2=f_eges_hora
	forms.AtCons_reservas.foundset.reservashora3=f_eges_hora
	forms.AtCons_reservas.foundset.reservashora5=f_eges_hora
	forms.AtCons_reservas.foundset.reservashora6=f_eges_hora
	forms.AtCons_reservas.foundset.reservashora=f_eges_hora
	forms.AtCons_reservas.foundset.reservashoraatenc=f_eges_hora
	forms.AtCons_reservas.foundset.reservashoracef=f_eges_hora
	forms.AtCons_reservas.foundset.reservashoraconf=$hora_ped+$ed_min
	forms.AtCons_reservas.foundset.reservashoraped=$hora_ped+$ed_min
	forms.AtCons_reservas.foundset.reservasmed1=f_eges_med
	forms.AtCons_reservas.foundset.reservasmed2=f_eges_med
	forms.AtCons_reservas.foundset.reservasmed3=f_eges_med
	forms.AtCons_reservas.foundset.reservasmed6=f_eges_med
	forms.AtCons_reservas.foundset.reservasmed=f_eges_med
	
	
	forms.AtCons_reservas.foundset.reservasnroben=f_eges_benef
	forms.AtCons_reservas.foundset.reservasobra=f_eges_obra
	forms.AtCons_reservas.foundset.reservasobrpla=f_eges_obrpla
	forms.AtCons_reservas.foundset.reservasopera=f_eges_operador
	forms.AtCons_reservas.foundset.reservasoperaconf=f_eges_operador
	forms.AtCons_reservas.foundset.reservasservicio=f_eges_servicio
	forms.AtCons_reservas.foundset.reservassexo=f_eges_sexo
	forms.AtCons_reservas.foundset.reservastipo="P"
	forms.AtCons_reservas.foundset.reservastipoopera=f_eges_tip_opera
	forms.AtCons_reservas.foundset.reservastipooperaconf=f_eges_tip_opera
	forms.AtCons_reservas.foundset.reservastipser=f_eges_tip_servicio
	forms.AtCons_reservas.foundset.reservastipsercef=f_eges_tip_servicio
	forms.AtCons_reservas.foundset.reservastipsol=f_eges_tiposol
	forms.AtCons_reservas.foundset.reservasiva=$condiva
	forms.AtCons_reservas.foundset.reservasnordeges=0;
	try{
		databaseManager.saveData(forms.AtCons_reservas.foundset)
	}catch(msg){
		plugins.dialogs.showErrorDialog("Error grabacion RESERVAS",msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(forms.AtCons_reservas.foundset)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		f_retorno_msa=false
		f_error_msa+=' - No se pudo grabar el turno en RESERVAS' 
	}else{
		f_retorno_msa=true
		f_error_msa+=' ' 
	}
	return f_retorno_msa
}

/**
 * @properties={typeid:24,uuid:"D7EDA2F5-418B-4626-ACA1-306A6E3F4BFB"}
 * @AllowToRunInFind
 */
function insertar_resecod(){
	f_eges_resecodesp=f_eges_esp
	f_eges_resecodmed=f_eges_med
	f_eges_resecodfech=f_eges_fech
	f_eges_resecodhora=f_eges_hora
	var $imapedet=false
	var $item=0
	var fs = databaseManager.getFoundSet("asistencial","tbc_resecod")
	var largo_resecod = f_eges_resecodnumcod.length
	var $tiene_practica=false
	f_estadtur_practica=0;
	f_estadtur_consulta=0;
	for(var xx=0;xx<largo_resecod;xx++){
		if(f_eges_resecodnumcod[xx]!=420101){
			$tiene_practica=true
			f_estadtur_practica=2
		}else{
			f_estadtur_consulta=1
		}
	}
	if($tiene_practica){
			insertar_imapedi()
	}
	for(var ii=0;ii<largo_resecod;ii++){
		$item++
		fs.find()
		fs['resecodesp']=f_eges_resecodesp
		fs['resecodmed']=f_eges_resecodmed
		fs['resecodfech']=f_eges_resecodfech
		fs['resecodhora']=f_eges_resecodhora
		fs['resecoditem']=$item
		fs.search()
		if(fs.getSize()<1){
			fs.newRecord()
			fs['resecodesp']=f_eges_resecodesp
			fs['resecodmed']=f_eges_resecodmed
			fs['resecodfech']=f_eges_resecodfech
			fs['resecodhora']=f_eges_resecodhora
			fs['resecoditem']=$item
			fs['resecodtipcod']=f_eges_resecodtipcod[ii]
			fs['resecodnumcod']=f_eges_resecodnumcod[ii]
			fs['resecodcantid']=f_eges_resecodcantid[ii]
			fs['resecodl']=0
			fs['resecoddiag']=f_eges_resecoddiag
			
			try{
				databaseManager.saveData(fs)
			}catch(msg){
				plugins.dialogs.showErrorDialog("Error grabacion RESECOD",msg.message)
			}
			var error1=''
			var error2=''
			var i = 0
			var array = databaseManager.getFailedRecords(fs)
			for (i = 0; i < array.length; i++) {
				var record = array[i];
				var jstable = databaseManager.getTable(record);
				var tableSQLName = jstable.getSQLName();
				error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
				error2='Error en grabación '+record.exception;
				if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
					var thrown = record.exception.getValue()
					plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
				}
			}
			if(error1!=''){
				plugins.dialogs.showErrorDialog("Error en grabacion de tbc_resecod",error1,"Ok")
				plugins.dialogs.showErrorDialog("Error en grabacion de tbc_resecod",error2,"Ok")
				plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
				f_retorno_msa=false
				f_error_msa+=' - No se pudo grabar el registro en RESECOD' 
			}else{
				f_retorno_msa=true
				f_error_msa+=' ' 
			}
			graba_rendicion(ii)
			if(f_eges_resecodtipcod[ii]==1&&f_eges_resecodnumcod[ii]!=420101&&f_eges_resecodnumcod[ii]!=420104&&f_eges_resecodnumcod[ii]!=420120&&f_eges_resecodnumcod[ii]!=420102&&f_eges_resecodnumcod[ii]!=420201){
				globals.AtCons_codinom=f_eges_resecodnumcod[ii]
				if(atcons_vs_to_tbc_imacodi.getSize()<1){
					insertarImacodi(ii)
				}
				$imapedet=insertar_imapedet(ii, $item)
				if($imapedet){
					//grabar_resecod_en_auxiliar(f_eges_resecodesp, f_eges_resecodmed, f_eges_resecodfech, f_eges_resecodhora, f_eges_tip_servicio, atcons_vs_to_tbc_reservas.reservasipedido, f_eges_servicio);
					globals.AtCons_hiscli=utils.stringToNumber(f_eges_hiscli)
					insertar_atcons_imapedet_inf(ii, $item)
				}
			}
		}
	}
}

/**
 * @properties={typeid:24,uuid:"A85CF17A-E397-4C57-81FB-9ABF5CFBCAC2"}
 * @AllowToRunInFind
 */
function insertar_responseeg(){
	var $posicion_estado=f_mensaje.indexOf("</Estado>")
	var $posicion_idida=f_mensaje.indexOf("</IDMensajeIda>")
	var $posicion_iErrores=f_mensaje.indexOf("<Errores>")
	var $posicion_fErrores=f_mensaje.indexOf("</Errores>")
	var $estado_ida=''
	var $codigo=0
	if(f_retorno_msa){
		$estado_ida="AA"
		$codigo=0
	}else{
		$estado_ida="AE"
		$codigo=1
	}
	var $mensaje=f_mensaje.substr(0,$posicion_estado-5)+$estado_ida+f_mensaje.substr($posicion_estado,$posicion_idida-$posicion_estado-6)+f_eges_idmensaje+f_mensaje.substr($posicion_idida,$posicion_iErrores-$posicion_idida+9)+f_error_msa+f_mensaje.substr($posicion_fErrores,f_mensaje.length-$posicion_fErrores)
	var fs = databaseManager.getFoundSet("validaciones","responseeg")
	fs.clear()
	fs.find()
	fs['idmensaje']=f_idmensaje_requesteg
	fs.search()
	if(fs.getSize()<1){
		fs.newRecord()
	}
	fs['idmensaje']=f_idmensaje_requesteg
	//fs['idmensaje']=f_eges_idmensaje
	fs['mensaje']=$mensaje
	fs['estadomensaje']=f_eges_estadomensaje
	fs['fechamensaje']=f_eges_fechamensaje
	fs['codigo']=$codigo
		
	try{
		databaseManager.saveData(fs)
	}catch(msg){
		plugins.dialogs.showErrorDialog("Error grabacion RESPONSEEG",msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de responseeg",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de responseeg",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		
	}
}

/**
 * @properties={typeid:24,uuid:"798630C9-805A-4C84-AE5F-FDF895D7DCDE"}
 * @AllowToRunInFind
 */
function actualiza_requesteg(){
	var fs = databaseManager.getFoundSet("validaciones","requesteg")
	fs.find()
	fs['idmensaje']=f_idmensaje_requesteg
	fs.search(true,false)
	if(fs.getSize()>0){
		fs['estadomensaje']= 'P'
		try{
			databaseManager.saveData(fs)
		}catch(msg){
			plugins.dialogs.showErrorDialog("Error grabacion REQUESTEG",msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
				plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
			}
		}
		if(error1!=''){
			plugins.dialogs.showErrorDialog("Error en grabacion de requesteg",error1,"Ok")
			plugins.dialogs.showErrorDialog("Error en grabacion de requesteg",error2,"Ok")
			plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		}
	}
}

/**
 * @properties={typeid:24,uuid:"EF9D5EB5-C578-4737-AAD8-2DFC9CC2B5C9"}
 * @AllowToRunInFind
 */
function valida_hiscli(){
	var $hiscli=0
	var $hisclinum=0
	$hisclinum=utils.stringToNumber(f_eges_hiscli)
	
	if($hisclinum>2000000){
		$hiscli=busca_hiscli_x_documento()
	}else{
		$hiscli=f_eges_hiscli
	}
	var fs = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs.clear()
	fs.find()
	fs['histcab_nrounico']=$hiscli
	fs.search()
	if(fs.getSize()>0){
		fs.setSelectedIndex(1)
		f_eges_hiscli=fs['histcab_nrounico']
		//f_eges_obra=fs['histcab_obra']
		//f_eges_obrpla=fs['histcab_planx']
		//f_eges_benef=fs['histcab_nrobenef']
		if(f_eges_obra!=fs['histcab_obra']||f_eges_obrpla!=fs['histcab_planx']||f_eges_benef!=fs['histcab_nrobenef']){
			actualiza_histcab()
		}
		f_retorno_msa=true
		f_error_msa='' 
		return true
	}else{
		$hiscli=busca_hiscli_x_documento()
		if($hiscli==0){
			f_retorno_msa=false
			f_error_msa+=' - No se encontro Historia Clinica' 
			return false
		}else{
			fs.clear()
			fs.find()
			fs['histcab_nrounico']=$hiscli
			fs.search()
			if(fs.getSize()>0){
				fs.setSelectedIndex(1)
				f_eges_hiscli=fs['histcab_nrounico']
				//f_eges_obra=fs['histcab_obra']
				//f_eges_obrpla=fs['histcab_planx']
				//f_eges_benef=fs['histcab_nrobenef']
				f_retorno_msa=true
				f_error_msa+=' ' 
				return true
			}else{
				f_retorno_msa=false
				f_error_msa+=' - No se encontro Historia Clinica' 
				return false
			}
		}
	}
}

/**
 * @properties={typeid:24,uuid:"436D6DF0-97AE-4B75-BEF8-8C826D17D140"}
 * @AllowToRunInFind
 */
function busca_hiscli_x_documento(){
	var $hiscli1=0
	var $encontrado=false
	var fs = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs.clear()
	fs.find()
	fs['histcab_tipdoc']=f_eges_tipodocumento
	fs['histcab_nrodoc']=f_eges_nrodocumento
	fs.search()
	if(fs.getSize()>0){
		for(var i=1;i<=fs.getSize();i++){
			fs.setSelectedIndex(i)
			$hiscli1=fs['histcab_nrounico']
		}
	}else{
		for(var j=1;j<=5&&!$encontrado;j++){
			fs.find()
			fs['histcab_tipdoc']=j
			fs['histcab_nrodoc']=f_eges_nrodocumento
			fs.search()
			if(fs.getSize()>0){
				fs.setSelectedIndex(1)
				$hiscli1=fs['histcab_nrounico']
				$encontrado=true
			}
		}
	}
	return $hiscli1
}

/**
 * @param {Number} indice
 * @param {Number} item
 * @properties={typeid:24,uuid:"F0585023-D5B8-4E8E-9F7A-C91D0DFF873C"}
 * @AllowToRunInFind
 */
function insertar_atcons_imapedet_inf(indice, item){
	var $descri_nomencla=' '
	var fs = databaseManager.getFoundSet("maestros","tbc_nomencla")
	fs.find()
	fs['nome_tipo']=f_eges_resecodtipcod[indice]
	fs['nome_codigo']=f_eges_resecodnumcod[indice]
	fs.search()
	if(fs.getSize()>0){
		$descri_nomencla=utils.stringLeft(fs['nome_descr'], 60)
	}
	forms.AtCons_imapedet.foundset.newRecord();
	globals.AtCons_vespecial_rel=f_eges_resecodesp
	globals.AtCons_vfecha_integer=f_eges_resecodfech
	globals.Atcons_vreservashora=f_eges_resecodhora
	forms.AtCons_imapedet.foundset.imapedetservicio=globals.AtCons_servicio;
	forms.AtCons_imapedet.foundset.imapedetpedido=globals.AtCons_nroPedido;
	forms.AtCons_imapedet.foundset.imapedettiponom=f_eges_resecodtipcod[indice];
	forms.AtCons_imapedet.foundset.imapedetcodinom=f_eges_resecodnumcod[indice];
	forms.AtCons_imapedet.foundset.imapedetadmis=1;
	forms.AtCons_imapedet.foundset.imapedethiscli=globals.AtCons_hiscli
	//forms.AtCons_imapedet.foundset.imapedethiscli=utils.stringToNumber(f_eges_hiscli)
	forms.AtCons_imapedet.foundset.imapedetapeynom=atcons_vhistcli_to_tbc_hist_cab.histcab_apellnom;
	forms.AtCons_imapedet.foundset.imapedetdescrinom=$descri_nomencla;
	forms.AtCons_imapedet.foundset.imapedetestado=false;
	forms.AtCons_imapedet.foundset.imapedetesp=globals.AtCons_vespecial;
	forms.AtCons_imapedet.foundset.imapedetmed=globals.AtCons_vlegajo;
	forms.AtCons_imapedet.foundset.imapedetfch=globals.AtCons_vfecha_integer;
	forms.AtCons_imapedet.foundset.imapedethora=globals.Atcons_vreservashora;
	forms.AtCons_imapedet.foundset.imapedetnroinforme=0;
	globals.AtCons_codinom_ed=f_eges_resecodnumcod[indice]
	if(f_eges_resecodnumcod[indice]<100000){
		forms.AtCons_imapedet.foundset.imapedetcodinom_ed='0'+globals.AtCons_codinom_ed.substr(0,1)+'.'+globals.AtCons_codinom_ed.substr(1,2)+'.'+globals.AtCons_codinom_ed.substr(3,2)
	}else{
		forms.AtCons_imapedet.foundset.imapedetcodinom_ed=globals.AtCons_codinom_ed.substr(0,2)+'.'+globals.AtCons_codinom_ed.substr(2,2)+'.'+globals.AtCons_codinom_ed.substr(4,2)
	}
	
	try {databaseManager.saveData(forms.AtCons_imapedet.foundset.getRecord(1))}
	catch (msg){
		(plugins.dialogs.showInfoDialog("Error en 'Atender Paciente' al grabar en atcons_imapedet_inf",msg.toString(),"ok"))
		//	application.output(msg.rhinoException.getMessage())
	}
	var error1=''
	var error2=''
	var array = databaseManager.getFailedRecords(forms.AtCons_imapedet.foundset)
	for (var i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion ",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion ",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		return
	}
}

/**
 * @properties={typeid:24,uuid:"9D11CAF6-40E2-4C8F-9B4E-A5F964401543"}
 */
function insertar_imapedi(){
	var hora_actual = application.getServerTimeStamp()
	var hora= 0
	var minutos = 0
	var hora_ed = ' '
	var minutos_ed = ' '
	hora=hora_actual.getHours()
	minutos=hora_actual.getMinutes()
	if(hora<10){
		hora_ed = '0'+hora
	}else{
		hora_ed = hora
	}
	if(minutos<10){
		minutos_ed = '0'+minutos
	}else{
		minutos_ed = minutos
	}
	
	globals.AtCons_nroPedido = 0;
	globals.AtCons_nroPedidoUnico = 0;
		
	globals.AtCons_servicio = atcons_vlegajo_to_tbc_medtur_esp.medturservicio;
	if(globals.AtCons_servicio==0||globals.AtCons_servicio==null||globals.AtCons_servicio=='  '){
		if(f_eges_esp == 25 || f_eges_esp == 45 || f_eges_esp == 6 || f_eges_esp == 27 || f_eges_esp == 39 || f_eges_esp == 42 || f_eges_esp == 19 || f_eges_esp == 47 || f_eges_esp == 10 || f_eges_esp == 268 || f_eges_esp == 44){
			switch (f_eges_esp){
				case 25:globals.AtCons_servicio=23;break;
				case 45:globals.AtCons_servicio=7;break;
				case 6:globals.AtCons_servicio=8;break;
				case 27:globals.AtCons_servicio=16;break;
				case 39:globals.AtCons_servicio=21;break;
				case 42:globals.AtCons_servicio=22;break;
				case 19:globals.AtCons_servicio=24;break;
				case 47:globals.AtCons_servicio=25;break;
				case 44:globals.AtCons_servicio=8;break;
				case 10:globals.AtCons_servicio=12;break;
				case 268:globals.AtCons_servicio=11;break;
			}
		}else{
			return
		}
	}
	
	if(globals.AtCons_servicio == 7)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",30);
	
	if(globals.AtCons_servicio == 8)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",31);
	
	if(globals.AtCons_servicio == 16)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",32);
	
	if(globals.AtCons_servicio == 21)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",33);
	
	if(globals.AtCons_servicio == 22)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",34);
	
	if(globals.AtCons_servicio == 23)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",35);
			
	if(globals.AtCons_servicio == 24)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",36);
	
	if(globals.AtCons_servicio == 25)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",37);
		
	if(globals.AtCons_servicio == 1)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",20);
	
	if(globals.AtCons_servicio == 12)
		globals.AtCons_nroPedido = obtenerNumerador("desal","tbl_parametros","contador_entero","paramid",21);
	
	if (globals.AtCons_nroPedido > 0) {
		atcons_to_tbc_imapedi_new.newRecord();
		inicializarRelacionImapediNew();
				
		// Completando imapedi
		atcons_to_tbc_imapedi_new.ipedpedido = globals.AtCons_nroPedido;
		atcons_to_tbc_imapedi_new.ipedservicio = globals.AtCons_servicio;
		atcons_to_tbc_imapedi_new.ipedservicio1 = globals.AtCons_servicio;
		atcons_to_tbc_imapedi_new.ipedservicio2 = globals.AtCons_servicio;
		atcons_to_tbc_imapedi_new.ipedservicio3 = globals.AtCons_servicio;
		atcons_to_tbc_imapedi_new.ipedservicio4 = globals.AtCons_servicio;
		atcons_to_tbc_imapedi_new.ipedadmis=1
		atcons_to_tbc_imapedi_new.ipedadmis4=1
		atcons_to_tbc_imapedi_new.ipedsector = 2; 
		atcons_to_tbc_imapedi_new.ipedhistclinica = atcons_tbc_reservas_to_tbc_hist_cab.histcab_nrounico;
		atcons_to_tbc_imapedi_new.ipedhistcldesc = utils.stringTrim(atcons_tbc_reservas_to_tbc_hist_cab.histcab_apellnom);
		atcons_to_tbc_imapedi_new.ipedfechapedido = globals.AtCons_vfecha_integer;
		atcons_to_tbc_imapedi_new.ipedfechapedido4 = globals.AtCons_vfecha_integer;
		atcons_to_tbc_imapedi_new.ipedhorapedido = hora_ed+''+minutos_ed 
		atcons_to_tbc_imapedi_new.ipedhorapedido4 = hora_ed+''+minutos_ed;
		
		atcons_to_tbc_imapedi_new.ipedobra = atcons_tbc_reservas_to_tbc_hist_cab.histcab_obra;
		atcons_to_tbc_imapedi_new.ipedplan = utils.stringTrim(atcons_tbc_reservas_to_tbc_hist_cab.histcab_planx).length > 0 ? utils.stringTrim(atcons_tbc_reservas_to_tbc_hist_cab.histcab_planx) : ' ';
		atcons_to_tbc_imapedi_new.ipedmedsolic = globals.AtCons_vlega;
		atcons_to_tbc_imapedi_new.ipediesolic = scopes.globals.AtCons_vmedico_tipo;
		atcons_to_tbc_imapedi_new.ipedhabi = 0;
		atcons_to_tbc_imapedi_new.ipedcama = " ";
		atcons_to_tbc_imapedi_new.ipedurgen = 2;
		atcons_to_tbc_imapedi_new.ipednropedunico = 0;
		atcons_to_tbc_imapedi_new.ipedreservasesp=f_eges_resecodesp
		atcons_to_tbc_imapedi_new.ipedreservasfech=f_eges_resecodfech
		atcons_to_tbc_imapedi_new.ipedreservashora=f_eges_resecodhora
		atcons_to_tbc_imapedi_new.ipedreservasmed=f_eges_resecodmed
		atcons_to_tbc_imapedi_new.ipednordeges=f_eges_nroorden
		//globals.AtCons_vespecial=f_eges_resecodesp
		//globals.AtCons_vfecha_integer=f_eges_resecodfech
		globals.Atcons_vreservashora=f_eges_resecodhora
		//globals.AtCons_vlegajo=f_eges_resecodmed
	
		try{
			databaseManager.saveData(atcons_to_tbc_imapedi_new.getRecord(1));
		} catch(msg){
			globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
		}
		var error1 = ''
		var error2 = ''
		var array = databaseManager.getFailedRecords(atcons_to_tbc_imapedi_new)
		for (var i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2 = 'Error en grabación ' + record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				// exception thrown in pre-insert/update/delete event method
				var thrown = record.exception.getValue()
			}
		}

		if (error1 != '') {
			globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error1, "Aceptar")
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error2, "Aceptar")
		}
		globals.AtCons_vespecial_rel=f_eges_resecodesp
		globals.AtCons_vfecha_integer=f_eges_resecodfech
		globals.Atcons_vreservashora=f_eges_resecodhora
		// Actualiza registro de RESERVAS con numero de Pedido del IMAPEDI y codigo de Servicio
		atcons_unico_to_tbc_reservas.reservasipedido=globals.AtCons_nroPedido
		atcons_unico_to_tbc_reservas.reservasservicio=globals.AtCons_servicio
		atcons_unico_to_tbc_reservas.reservastipser=1
		try{
			databaseManager.saveData(atcons_unico_to_tbc_reservas.getRecord(1))
		} catch(msg){
			globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
		}
		error1 = ''
		error2 = ''
		var array2 = databaseManager.getFailedRecords(atcons_unico_to_tbc_reservas)
		for (i = 0; i < array2.length; i++) {
			var record2 = array2[i];
			var jstable2 = databaseManager.getTable(record2);
			var tableSQLName2 = jstable2.getSQLName();
			error1 = 'Error de Grabación en Tabla:' + tableSQLName2 + ' en server:' + jstable2.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2 = 'Error en grabación ' + record2.exception;
			if (record2.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				// exception thrown in pre-insert/update/delete event method
				var thrown2 = record2.exception.getValue()
			}
		}

		if (error1 != '') {
			globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error1, "Aceptar")
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error2, "Aceptar")
		}
	}
}

/**
 * @param {Number} indice
 * @param {Number} item
 * @properties={typeid:24,uuid:"081CB440-D530-4DC3-AE15-BDE16E1DA1EC"}
 */
function insertar_imapedet(indice, item){
	if(globals.AtCons_servicio==0||globals.AtCons_servicio==null||globals.AtCons_servicio=='  '){
		return false
	}else{
		atcons_to_tbc_imapedet_new.newRecord();
		inicializarImapedetNew();
			
		atcons_to_tbc_imapedet_new.idetservicio = globals.AtCons_servicio;
		atcons_to_tbc_imapedet_new.idetservicio3 = globals.AtCons_servicio;
		atcons_to_tbc_imapedet_new.idetservicio4 = globals.AtCons_servicio;
		atcons_to_tbc_imapedet_new.idetservicio5 = globals.AtCons_servicio;
		atcons_to_tbc_imapedet_new.idetpedido = globals.AtCons_nroPedido;
		atcons_to_tbc_imapedet_new.idetpedido3 = globals.AtCons_nroPedido;
		atcons_to_tbc_imapedet_new.idetpedido4 = globals.AtCons_nroPedido;
		
		atcons_to_tbc_imapedet_new.idettiponom = globals.AtCons_uno;
		atcons_to_tbc_imapedet_new.idettiponom1 = globals.AtCons_uno;
		atcons_to_tbc_imapedet_new.idetcodinom = globals.AtCons_codinom;	
		atcons_to_tbc_imapedet_new.idetcodinom1 = globals.AtCons_codinom;
		atcons_to_tbc_imapedet_new.idethistclinica = atcons_tbc_reservas_to_tbc_hist_cab.histcab_nrounico;
		atcons_to_tbc_imapedet_new.idetadmis=1
		
		try{
			databaseManager.saveData(atcons_to_tbc_imapedet_new.getRecord(1));
		} catch(msg){
			globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
		}
		var error1 = ''
		var error2 = ''
		var array = databaseManager.getFailedRecords(atcons_to_tbc_imapedet_new)
		for (var i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2 = 'Error en grabación ' + record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				// exception thrown in pre-insert/update/delete event method
				var thrown = record.exception.getValue()
			}
		}
	
		if (error1 != '') {
			globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error1, "Aceptar")
			globals.DIALOGS.showErrorDialog("Error en grabacion ", error2, "Aceptar")
			return false
		}else{
			return true
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param serverName
 * @param tableName
 * @param columnName
 * @param primaryKey
 * @param keyValue
 *
 * @properties={typeid:24,uuid:"9B18FD63-D901-4FF5-B584-6A029CDA10CD"}
 */
function obtenerNumerador (serverName,tableName,columnName,primaryKey,keyValue) {
	
	var numero = 0;
	
	var msg = '';
	var msgEn = '';
	
	var sql = "begin; lock table " + tableName + " in row exclusive mode;";
    var done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
	if (done) {
		
		// Lock de registros
		sql = "select * from " + tableName + " where " + primaryKey + " = " + keyValue + " for update;";
		done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
		if (done) {
			
			sql = "SELECT " + columnName + " FROM " + tableName + " WHERE " + primaryKey + " = " + keyValue;
			var vDataset = databaseManager.getDataSetByQuery(serverName, sql, null, 1);
			
			if(vDataset.getMaxRowIndex() > 0){
				
				sql = "update " + tableName + " set " + columnName + " = " + columnName + " + 1 where " + primaryKey + " = " + keyValue + "; commit;";
				done = plugins.rawSQL.executeSQL(serverName, tableName, sql);
				if(done){
					
					numero = vDataset.getValue(1,1) + 1;
				}
				else{
					
					plugins.rawSQL.executeSQL(serverName, tableName, "end;");
					globals.DIALOGS.showWarningDialog("¡Atencion!", "No ha sido posible actualizar el numerador : \n" + msgEn, "Aceptar");
				}
			}
			else{
				
				plugins.rawSQL.executeSQL(serverName, tableName, "end;");
				globals.DIALOGS.showWarningDialog("¡Atencion!", "No existe el numerador : \n" + msgEn, "Aceptar");
			}
		}
		else{
			
			plugins.rawSQL.executeSQL(serverName, tableName, "end;");
			globals.DIALOGS.showWarningDialog("¡Atencion!", "Error al consultar tabla de numerador :\n" + msgEn + "Error en Select for update" , 'Aceptar');
		}
	}
	else{
		
		msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		globals.DIALOGS.showWarningDialog("¡Atencion!", "Error al consultar tabla de numerador :\n" + msgEn + "\nSQL exception:" + msg, 'Aceptar');
	}
	
	return numero;
}

/**
 * @properties={typeid:24,uuid:"25FB0852-B401-42F8-9E5B-36EA4A1DE226"}
 */
function inicializarRelacionImapediNew() {
	
	atcons_to_tbc_imapedi_new.ipedpedido= 0;
	atcons_to_tbc_imapedi_new.ipedservicio= 0;
	atcons_to_tbc_imapedi_new.ipedadmis= 0;
	atcons_to_tbc_imapedi_new.ipedadmis4= 0;
	atcons_to_tbc_imapedi_new.ipedatendiportecnico= 0;
	atcons_to_tbc_imapedi_new.ipedcama= ' ';
	atcons_to_tbc_imapedi_new.ipedcodianeste= 0;
	atcons_to_tbc_imapedi_new.ipedcodioper= 0;
	atcons_to_tbc_imapedi_new.ipedestado= 0;
	atcons_to_tbc_imapedi_new.ipedfechadife= 0;
	atcons_to_tbc_imapedi_new.ipedfechapedido= 0;
	atcons_to_tbc_imapedi_new.ipedfechapedido4= 0;
	atcons_to_tbc_imapedi_new.ipedfecharesul= 0;
	atcons_to_tbc_imapedi_new.ipedhabi= 0;
	atcons_to_tbc_imapedi_new.ipedhcprotesis= 0;
	atcons_to_tbc_imapedi_new.ipedhistcldesc= ' ';
	atcons_to_tbc_imapedi_new.ipedhistclinica= 0;
	atcons_to_tbc_imapedi_new.ipedhoradife= 0;
	atcons_to_tbc_imapedi_new.ipedhorapedido= 0;
	atcons_to_tbc_imapedi_new.ipedhorapedido4= 0;
	atcons_to_tbc_imapedi_new.ipedhoraresul= 0;
	atcons_to_tbc_imapedi_new.ipediesolic= 0;
	atcons_to_tbc_imapedi_new.ipedimpreaviso= 0;
	atcons_to_tbc_imapedi_new.ipedlconfecc= 0;
	atcons_to_tbc_imapedi_new.ipedlegatecni= 0;
	atcons_to_tbc_imapedi_new.ipedmedsolic= 0;
	atcons_to_tbc_imapedi_new.ipedmotfund= 0;
	atcons_to_tbc_imapedi_new.ipedmotlegalanu= 0;
	atcons_to_tbc_imapedi_new.ipednrocine= ' ';
	atcons_to_tbc_imapedi_new.ipednropedunico= 0;
	atcons_to_tbc_imapedi_new.ipedobra= 0;
	atcons_to_tbc_imapedi_new.ipedoklectora= 0;
	atcons_to_tbc_imapedi_new.ipedparticular= 0;
	atcons_to_tbc_imapedi_new.ipedpatologico= 0;
	atcons_to_tbc_imapedi_new.ipedplan= ' ';
	atcons_to_tbc_imapedi_new.ipedresdiag= 0;
	atcons_to_tbc_imapedi_new.ipedreservasesp= 0;
	atcons_to_tbc_imapedi_new.ipedreservasfech= 0;
	atcons_to_tbc_imapedi_new.ipedreservashora= 0;
	atcons_to_tbc_imapedi_new.ipedreservasmed= 0;
	atcons_to_tbc_imapedi_new.ipedsector= 0;
	atcons_to_tbc_imapedi_new.ipedservicio1= 0;
	atcons_to_tbc_imapedi_new.ipedservicio2= 0;
	atcons_to_tbc_imapedi_new.ipedservicio3= 0;
	atcons_to_tbc_imapedi_new.ipedservicio4= 0;
	atcons_to_tbc_imapedi_new.ipedtipoaneste= 0;
	atcons_to_tbc_imapedi_new.ipedtipohcprotesis= 0;
	atcons_to_tbc_imapedi_new.ipedtipooper= 0;
	atcons_to_tbc_imapedi_new.ipedtipotecni= 0;
	atcons_to_tbc_imapedi_new.ipedtomo= 0;
	atcons_to_tbc_imapedi_new.ipedurgen= 0;
	atcons_to_tbc_imapedi_new.ipedenvioimagen= 0;
	atcons_to_tbc_imapedi_new.ipedembarazo= 0;
	atcons_to_tbc_imapedi_new.ipednordeges= ' ';
	
}

/**
 * @properties={typeid:24,uuid:"CA6651A8-0459-4FA6-A546-6F05F8276DFA"}
 */
function inicializarImapedetNew() {
	
	atcons_to_tbc_imapedet_new.idetcodinom = 0;
	atcons_to_tbc_imapedet_new.idetpedido = 0;
	atcons_to_tbc_imapedet_new.idetservicio = 0;
	atcons_to_tbc_imapedet_new.idettiponom = 0;
	atcons_to_tbc_imapedet_new.idetadmis = 0;
	atcons_to_tbc_imapedet_new.idetcodinom1 = 0;
	atcons_to_tbc_imapedet_new.idetestado = 0;
	atcons_to_tbc_imapedet_new.idetfechainfor = 0;
	atcons_to_tbc_imapedet_new.idetfechareali = 0;
	atcons_to_tbc_imapedet_new.idetflagpasaje = 0;
	atcons_to_tbc_imapedet_new.idethistclinica = 0;
	atcons_to_tbc_imapedet_new.idethorainfor = 0;
	atcons_to_tbc_imapedet_new.idethorareali = 0;
	atcons_to_tbc_imapedet_new.idetieinfor = 0;
	atcons_to_tbc_imapedet_new.idetinforme = 0;
	atcons_to_tbc_imapedet_new.idetlegaanu = 0;
	atcons_to_tbc_imapedet_new.idetmedicamen = 0;
	atcons_to_tbc_imapedet_new.idetmedinfor = 0;
	atcons_to_tbc_imapedet_new.idetmotanu = 0;
	atcons_to_tbc_imapedet_new.idetmotlegalanu = 0;
	atcons_to_tbc_imapedet_new.idetpedido3 = 0;
	atcons_to_tbc_imapedet_new.idetpedido4 = 0;
	atcons_to_tbc_imapedet_new.idetpreinfor = 0;
	atcons_to_tbc_imapedet_new.idetservicio3 = 0;
	atcons_to_tbc_imapedet_new.idetservicio4 = 0;
	atcons_to_tbc_imapedet_new.idetservicio5 = 0;
	atcons_to_tbc_imapedet_new.idettipoinf = 0;
	atcons_to_tbc_imapedet_new.idettiponom1 = 0;
	atcons_to_tbc_imapedet_new.idettleganu = 0;
	atcons_to_tbc_imapedet_new.idetinsumosol = 0;
	atcons_to_tbc_imapedet_new.idetremoto = 0;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $esp
 * @param $med
 * @param $fech
 * @param $hora
 * @param $tipser
 * @param $ipedido
 * @param $servicio
 *
 * @properties={typeid:24,uuid:"2FEB79F9-327C-4324-B55A-1E877AABAFCB"}
 */
function grabar_resecod_en_auxiliar($esp, $med, $fech, $hora, $tipser, $ipedido, $servicio){
	globals.AtCons_vespecial=$esp
	globals.AtCons_vlegajo=$med
	globals.AtCons_vfecha_integer=$fech
	globals.Atcons_vreservashora=$hora
	globals.AtCons_nroPedido=$ipedido
	globals.AtCons_servicio=$servicio
	if(atcons_vs_to_atcons_imapedet_inf.getSize()>0){
		return
	}
	if(atcons_to_tbc_imapedi_new.getSize()<1){
		return
	}
	if(atcons_to_tbc_imapedi_new.ipedestado>1){
		return
	}
	f_eges_resecodesp=$esp
	f_eges_resecodmed=$med
	f_eges_resecodfech=$fech
	f_eges_resecodhora=$hora
	f_eges_resecodnumcod=new Array()
	f_eges_resecodtipcod=new Array()
	f_eges_resecodcantid=new Array()
	f_eges_resecoditem=new Array()
	globals.AtCons_hiscli=atcons_to_tbc_imapedi_new.ipedhistclinica
	/*
	var ii=0
	if(largo_resecod > 1){
		if($tipser==0&&$ipedido==0&&$servicio==0){
				insertar_imapedi()
		}
	}
	for(var i=1;i<=largo_resecod;i++){
		atcons_reservas_to_tbc_resecod.setSelectedIndex(i)
		if(atcons_reservas_to_tbc_resecod.resecodnumcod!=420101&&atcons_reservas_to_tbc_resecod.resecodnumcod!=420104&&atcons_reservas_to_tbc_resecod.resecodnumcod!=420120&&atcons_reservas_to_tbc_resecod.resecodnumcod!=420102&&atcons_reservas_to_tbc_resecod.resecodnumcod!=420201){
			f_eges_resecodtipcod[ii]=atcons_reservas_to_tbc_resecod.resecodtipcod
			f_eges_resecodnumcod[ii]=atcons_reservas_to_tbc_resecod.resecodnumcod
			f_eges_resecodcantid[ii]=atcons_reservas_to_tbc_resecod.resecodcantid
			f_eges_resecoditem[ii]=atcons_reservas_to_tbc_resecod.resecoditem
			ii++
		}
	}
	for(var j=0;j<f_eges_resecodnumcod.length;j++){
		if(f_eges_resecodtipcod[j]==1&&f_eges_resecodnumcod[j]!=420101){
			globals.AtCons_codinom=f_eges_resecodnumcod[j]
			if($tipser==0&&$ipedido==0&&$servicio==0){
					insertar_imapedet(j, f_eges_resecoditem[j])
			}else{
				globals.AtCons_nroPedido=$ipedido
				globals.AtCons_servicio=$servicio
			}
			insertar_atcons_imapedet_inf(j, f_eges_resecoditem[j])
		}
	}
	*/
	var largo_imapedet = atcons_vs_to_tbc_imapedet_new.getSize()
	if (largo_imapedet > 0){
		for(var i=1;i<=largo_imapedet;i++){
			atcons_vs_to_tbc_imapedet_new.setSelectedIndex(i)
			if(atcons_vs_to_tbc_imapedet_new.idetestado==0){
				f_eges_resecodtipcod[i]=atcons_vs_to_tbc_imapedet_new.idettiponom
				f_eges_resecodnumcod[i]=atcons_vs_to_tbc_imapedet_new.idetcodinom
				f_eges_resecodcantid[i]=1
				f_eges_resecoditem[i]=1
				globals.AtCons_codinom=f_eges_resecodnumcod[i]
				insertar_atcons_imapedet_inf(i, f_eges_resecoditem[i])
			}
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param servicio
 * @param pedido
 * @param motivo
 * @param legajo
 * @param tipo
 *
 * @properties={typeid:24,uuid:"230ECA2C-4FA1-4B87-B7C9-76A12FF631CD"}
 * @AllowToRunInFind
 */
function anular_pedido(servicio, pedido, motivo, legajo, tipo){
	globals.AtCons_nroPedido=pedido
	globals.AtCons_servicio=servicio
	if(atcons_to_tbc_imapedi_new.getSize()<1){
		return
	}
	atcons_to_tbc_imapedi_new.ipedestado=9
	atcons_to_tbc_imapedi_new.ipedmotlegalanu=motivo
	try{
		databaseManager.saveData(atcons_to_tbc_imapedi_new.getRecord(1));
	} catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	var error1 = ''
	var error2 = ''
	var array = databaseManager.getFailedRecords(atcons_to_tbc_imapedi_new)
	for (var i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error2 = 'Error en grabación ' + record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown = record.exception.getValue()
		}
	}
	if (error1 != '') {
		globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error1, "Aceptar")
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error2, "Aceptar")
	}
	var fs = databaseManager.getFoundSet("asistencial","tbc_imapedet_new")
	fs.find()
	fs['idetservicio']=globals.AtCons_servicio
	fs['idetpedido']=globals.AtCons_nroPedido
	fs.search()
	if(fs.getSize()>0){
		for(i=1;i<=fs.getSize();i++){
			fs.setSelectedIndex(i)
			fs.idetestado=9
			fs.idetmotanu=4
			fs.idetmotlegalanu=motivo
			fs.idetlegaanu=legajo
			fs.idettleganu=tipo
			try{
				databaseManager.saveData(fs.getRecord(i));
			} catch(msg){
				globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
			}
			error1 = ''
			error2 = ''
			array = databaseManager.getFailedRecords(fs)
			for (var ii = 0; ii < array.length; ii++) {
				record = array[ii];
				jstable = databaseManager.getTable(record);
				tableSQLName = jstable.getSQLName();
				error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
				error2 = 'Error en grabación ' + record.exception;
				if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
					// exception thrown in pre-insert/update/delete event method
					thrown = record.exception.getValue()
				}
			}

			if (error1 != '') {
				globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
				globals.DIALOGS.showErrorDialog("Error en grabacion ", error1, "Aceptar")
				globals.DIALOGS.showErrorDialog("Error en grabacion ", error2, "Aceptar")
			}
		}
	}
}
/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"1D3156DF-1741-4968-AD0B-7B62AA9A7336"}
 */
function onDataChange_atcons_especialidad(oldValue, newValue, event) {
	onAction_refreshNew()
	return true
}

/**
 * @properties={typeid:24,uuid:"0B3DE566-58E1-4190-8859-E664A7E2CDCA"}
 */
function onAction_refreshNew() {
	//databaseManager.refreshRecordFromDatabase(atcons_vs_to_tbc_reservas,-1)  // tarda una eternidad 10/05/2018
	//reemplazar el refreshRecords con lo sig , xq tarda mucho // 11/05/2018
	// TODO aun asi tarda mucho 22/6/2018
	
	//obtengo_turnos_Eges()
	var indice = foundset.getSelectedIndex()
	var hay = foundset.getSize()
	for (var i = 1 ; i < hay + 1 ; i++)  
	{
		foundset.setSelectedIndex(i)
		foundset.getSelectedIndex()
		if(foundset.reservasipedido!=null&&foundset.reservasipedido!=0&&foundset.reservasservicio!=null&&foundset.reservasservicio!=0){
			grabar_resecod_en_auxiliar(foundset.reservasesp, foundset.reservasmed, foundset.reservasfech, foundset.reservashora, foundset.reservastipser, foundset.reservasipedido, foundset.reservasservicio)
		}
		databaseManager.refreshRecordFromDatabase(foundset,i)
	}
	if (indice > 0) 
		{foundset.setSelectedIndex(indice)}
	else
		{foundset.setSelectedIndex(1)}
}

/**
 * @properties={typeid:24,uuid:"38CB7EB5-775F-472F-B169-FBAAA1B0ECDE"}
 * @AllowToRunInFind
 */
function regrabar_turno(){
	var $largo_hora4=0
	if(f_eges_hora>9999999){
		$largo_hora4=4
	}else{
		$largo_hora4=3
	}
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	
	f_retorno_msa=false
	var fs = databaseManager.getFoundSet("asistencial","tbc_reservas")
	fs.find()
	fs.reservasesp=f_eges_esp             
	fs.reservasfech=f_eges_fech           
	fs.reservashora=f_eges_hora           
	fs.reservasmed=f_eges_med 
	fs.search()
	if(fs.getSize()>0){
		fs.reservasatendi=0
		fs.reservasatendicef=0
		fs.reservasconsu=f_eges_consul
		fs.reservasesta=1
		fs.reservasestacef=1
		fs.reservasfechaconf=$anio+$ed_mes+$ed_dia
		fs.reservasfechaped=$anio+$ed_mes+$ed_dia
		fs.reservashiscli=utils.stringToNumber(f_eges_hiscli)
		fs.reservashoraconf=$hora_ped+$ed_min
		fs.reservashoraped=$hora_ped+$ed_min
		fs.reservasnroben=f_eges_benef
		fs.reservasobra=f_eges_obra
		fs.reservasobrpla=f_eges_obrpla
		fs.reservasopera=f_eges_operador
		fs.reservasoperaconf=f_eges_operador
		fs.reservasservicio=f_eges_servicio
		fs.reservassexo=f_eges_sexo
		fs.reservastipo="P"
		fs.reservastipoopera=f_eges_tip_opera
		fs.reservastipooperaconf=f_eges_tip_opera
		fs.reservastipser=f_eges_tip_servicio
		fs.reservastipsercef=f_eges_tip_servicio
		fs.reservastipsol=f_eges_tiposol
		
		try{
			databaseManager.saveData(fs.getRecord(1))
		}catch(msg){
			plugins.dialogs.showErrorDialog("Error grabacion RESERVAS",msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
				plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
			}
		}
		if(error1!=''){
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error1,"Ok")
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_reserva",error2,"Ok")
			plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
			f_retorno_msa=false
			f_error_msa+=' - No se pudo regrabar el turno en RESERVAS' 
		}else{
			f_retorno_msa=true
			f_error_msa+=' ' 
		}
	}
	return f_retorno_msa
	
}


/**
 * @properties={typeid:24,uuid:"FB796C74-0A9B-4C65-A5BE-0755F94245C3"}
 * @AllowToRunInFind
 */
function insertar_tbl_teleconsulta(){
	var fs_medper = databaseManager.getFoundSet("maestros","tbc_medicos_personal")
	fs_medper.find()
	fs_medper['medpermatricun']=f_eges_matricula
	fs_medper.search()
	if(fs_medper.getSize()>0){
		for(i=1;i<=fs_medper.getSize();i++){
			fs_medper.setSelectedIndex(i)
			f_eges_med=fs_medper['medpercod']+'0'
		}
	}else{
		return
	}
	globals.AtCons_hiscli=utils.stringToNumber(f_eges_hiscli)
	globals.atcons_especial=f_eges_esp
	globals.AtCons_obra=atcons_vhistcli_to_tbc_hist_cab.histcab_obra
	f_eges_hora=f_eges_pv1hora+"0000"
	f_eges_fech=f_eges_pv1fecha.substr(6,4)+f_eges_pv1fecha.substr(3,2)+f_eges_pv1fecha.substr(0,2)
	var fs = databaseManager.getFoundSet("scweb","tbl_teleconsulta")
	fs.newRecord()
	fs['histclin']=utils.stringToNumber(f_eges_hiscli)
	fs['codprofesional']=f_eges_med
	fs['codespecial']=f_eges_esp
	fs['fechaturno']=f_eges_fech
	fs['horaturno']=f_eges_hora
	fs['apeynom']=atcons_vhistcli_to_tbc_hist_cab.histcab_apellnom
	fs['nomprofesional']=f_eges_nomprof
	fs['descespecial']=atcons_especial_to_tbc_especial.esp_descrip
	fs['codobrasoc']=atcons_vhistcli_to_tbc_hist_cab.histcab_obra
	fs['plan']=atcons_vhistcli_to_tbc_hist_cab.histcab_planx
	fs['nroafiliado']=atcons_vhistcli_to_tbc_hist_cab.histcab_nrobenef
	fs['mail']=f_eges_mail
	fs['estado']=0
	fs['tipodoc']=atcons_vhistcli_to_tbc_hist_cab.histcab_tipdoc
	fs['numedoc']=atcons_vhistcli_to_tbc_hist_cab.histcab_nrodoc
	fs['nomobrasoc']=atcons_obra_to_tbc_obras.obr_razonsoc
	switch (atcons_vhistcli_to_tbc_hist_cab.histcab_obra){
		case 352:fs['sucursal']=1;break;
		case 1950:fs['sucursal']=1;break;
		case 1956:fs['sucursal']=1;break;
		default:fs['sucursal']=0;break;
	}
	
		
	try{
		databaseManager.saveData(fs)
	}catch(msg){
		plugins.dialogs.showErrorDialog("Error grabacion tbl_teleconsulta",msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
			plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
		}
	}
	if(error1!=''){
		plugins.dialogs.showErrorDialog("Error en grabacion de tbl_teleconsulta",error1,"Ok")
		plugins.dialogs.showErrorDialog("Error en grabacion de tbl_teleconsulta",error2,"Ok")
		plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
		f_error_msa+=' - No se pudo grabar en tbl_teleconsulta' 
		
	}
}

/**
 * @param indice
 * @properties={typeid:24,uuid:"EBFB70FE-3B4C-46C2-B39A-08459AAB420A"}
 */
function graba_rendicion(indice){
	var $fecha_actual = application.getServerTimeStamp()
	var $anio=0
	$anio=$fecha_actual.getFullYear()
	var $mes = 0
	var $mes_ed = ' '
	var $dia = 0
	var $dia_ed = ' '
	var $hora = 0
	var $min = 0
	var $hora_ed = ' '
	var $min_ed = ' '
	var $planX=' '
	var $condiva=0
	$dia=$fecha_actual.getDate()
	$mes=$fecha_actual.getMonth()+1
	$hora=$fecha_actual.getHours()
	$min=$fecha_actual.getMinutes()
	if($mes<10){
		$mes_ed='0'+$mes
	}else{
		$mes_ed=$mes
	}
	if($dia<10){
		$dia_ed='0'+$dia
	}else{
		$dia_ed=$dia
	}
	if($hora<10){
		$hora_ed='0'+$hora
	}else{
		$hora_ed=$hora
	}
	if($min<10){
		$min_ed='0'+$min
	}else{
		$min_ed=$min
	}
	globals.AtCons_periodo=$anio+''+$mes_ed
	globals.AtCons_vhistcli=utils.stringToNumber(f_eges_hiscli)
	globals.AtCons_obra=f_eges_obra
	if(atcons_obra_to_tbc_obras.obr_cantcierres==4){
		if($dia>=22){
			globals.AtCons_cierre=4
		}else{
			if($dia>=15){
				globals.AtCons_cierre=3
			}else{
				if($dia>=8){
					globals.AtCons_cierre=2
				}else{
					if($dia>=1){
						globals.AtCons_cierre=1
					}
				}
			}
		}
	}else{
		if(atcons_obra_to_tbc_obras.obr_cantcierres==3){
			if($dia>=21){
				globals.AtCons_cierre=3
			}else{
				if($dia>=11){
					globals.AtCons_cierre=2
				}else{
					if($dia>=1){
						globals.AtCons_cierre=1
					}
				}
			}
		}else{
			if(atcons_obra_to_tbc_obras.obr_cantcierres==2){
				if($dia>=16){
					globals.AtCons_cierre=2
				}else{
					if($dia>=1){
						globals.AtCons_cierre=1
					}
				}
			}else{
				globals.AtCons_cierre=1
			}
		}
	}
	if(f_eges_condicioniva=='O'){
		$condiva=1
	}else{
		if(f_eges_condicioniva=='V'){
			$condiva=3
		}else{
			$condiva=2
		}
	}
	if(atcons_vs_to_tbc_rend_cab.getSize()<1){
		atcons_vs_to_tbc_rend_cab.newRecord()
		globals.InicializarDatosDeRelacion(atcons_vs_to_tbc_rend_cab,"asistencial","tbc_rend_cab")
		//inicializar_rend_cab()
		atcons_vs_to_tbc_rend_cab.rcadmision1=2
		atcons_vs_to_tbc_rend_cab.rcadmision2=2
		atcons_vs_to_tbc_rend_cab.rcadmision3=2
		atcons_vs_to_tbc_rend_cab.rcadmision4=2
		atcons_vs_to_tbc_rend_cab.rcadmision=2
		
		atcons_vs_to_tbc_rend_cab.rcempresa1=1
		atcons_vs_to_tbc_rend_cab.rcempresa2=1
		atcons_vs_to_tbc_rend_cab.rcempresa3=1
		atcons_vs_to_tbc_rend_cab.rcempresa4=1
		atcons_vs_to_tbc_rend_cab.rcempresa5=1
		atcons_vs_to_tbc_rend_cab.rcempresa=1
		
		atcons_vs_to_tbc_rend_cab.rchclinica2=globals.AtCons_vhistcli
		atcons_vs_to_tbc_rend_cab.rchclinica3=globals.AtCons_vhistcli
		atcons_vs_to_tbc_rend_cab.rchclinica5=globals.AtCons_vhistcli
		atcons_vs_to_tbc_rend_cab.rchclinica=globals.AtCons_vhistcli
		
		atcons_vs_to_tbc_rend_cab.rccierre2=globals.AtCons_cierre
		atcons_vs_to_tbc_rend_cab.rccierre3=globals.AtCons_cierre
		atcons_vs_to_tbc_rend_cab.rccierre=globals.AtCons_cierre
		
		atcons_vs_to_tbc_rend_cab.rcperiodo2=globals.AtCons_periodo
		atcons_vs_to_tbc_rend_cab.rcperiodo6=globals.AtCons_periodo
		atcons_vs_to_tbc_rend_cab.rcperiodo=globals.AtCons_periodo
		atcons_vs_to_tbc_rend_cab.rcperiodo3=globals.AtCons_periodo
		
		atcons_vs_to_tbc_rend_cab.rcestado5=0
		atcons_vs_to_tbc_rend_cab.rcestado=0
		atcons_vs_to_tbc_rend_cab.rcobra5=globals.AtCons_obra
		atcons_vs_to_tbc_rend_cab.rcobra=globals.AtCons_obra
		atcons_vs_to_tbc_rend_cab.rcfactura=0
		atcons_vs_to_tbc_rend_cab.rctipograb=2
		
		atcons_vs_to_tbc_rend_cab.rciva=$condiva
		
		globals.AtCons_hiscli=globals.AtCons_vhistcli
		atcons_vs_to_tbc_rend_cab.rcpaciente=atcons_vhistcli_to_tbc_hist_cab.histcab_apellnom
		/*
		if(atcons_tbc_reservas_to_tbc_plan_obra.getSize()>0){
			if(atcons_tbc_reservas_to_tbc_plan_obra.ploplanx!=null){
				$planX=atcons_tbc_reservas_to_tbc_plan_obra.ploplanx
			}else{
				$planX=' '
			}
		}else{
			$planX=' '
		}
		*/
		atcons_vs_to_tbc_rend_cab.rcfecha = $anio+''+$mes_ed+''+$dia_ed;
		atcons_vs_to_tbc_rend_cab.rchora = $hora_ed+''+$min_ed;
		atcons_vs_to_tbc_rend_cab.rcimpobra = 0;
		atcons_vs_to_tbc_rend_cab.rcimppaciente1 = 0;
		atcons_vs_to_tbc_rend_cab.rcimppaciente2 = 0;
		atcons_vs_to_tbc_rend_cab.rcimpfiller = 0;
		atcons_vs_to_tbc_rend_cab.rcplan = f_eges_obrpla_x;
		atcons_vs_to_tbc_rend_cab.rcafiliado = f_eges_benef;
		atcons_vs_to_tbc_rend_cab.rcfechaemision = $anio+''+$mes_ed+''+$dia_ed;
		atcons_vs_to_tbc_rend_cab.rchoraemision = $hora_ed+''+$min_ed;
		atcons_vs_to_tbc_rend_cab.rcatencion = 1;
		atcons_vs_to_tbc_rend_cab.rcsecuencia = scopes.globals.numeracion_txt(40)
		if(atcons_vs_to_tbc_rend_cab.rcsecuencia > 0){
			try{
				databaseManager.saveData(atcons_vs_to_tbc_rend_cab.getRecord(1));
				
			} catch(msg){
				globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
			}
			var error3 = ''
			var error4 = ''
			var array1 = databaseManager.getFailedRecords(atcons_vs_to_tbc_rend_cab)
			for (var j = 0; j < array1.length; j++) {
				var record1 = array1[j];
				var jstable1 = databaseManager.getTable(record1);
				var tableSQLName1 = jstable1.getSQLName();
				error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
				error4 = 'Error en grabación ' + record1.exception;
				if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
					// exception thrown in pre-insert/update/delete event method
					var thrown1 = record1.exception.getValue()

				}
			}

			if (error3 != '') {
				globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown1)
				globals.DIALOGS.showErrorDialog("Error en grabacion ", error3, "Aceptar")
				globals.DIALOGS.showErrorDialog("Error en grabacion ", error4, "Aceptar")
				f_error_msa+=' - No se pudo grabar en REND-CAB'
			}
		}
	}
	globals.AtCons_fecha_rend=$anio+''+$mes_ed+''+$dia_ed;
	globals.AtCons_hora_rend=$hora_ed+''+$min_ed;
	globals.AtCons_codinom=f_eges_resecodnumcod[indice];
	globals.AtCons_tiponom=f_eges_resecodtipcod[indice];
	if(atcons_vs_to_tbc_nomencla.getSize()>0){
		if(atcons_vs_to_tbc_nomencla.nome_pantalla!=null){
			globals.AtCons_nome_panta=atcons_vs_to_tbc_nomencla.nome_pantalla;
		}else{
			globals.AtCons_nome_panta=10;
		}
	}else{
		globals.AtCons_nome_panta=10;
	}
	try{
		if(atcons_vs_to_tbc_rend_det.getSize()<1){
			insertaRegistroRendDet()
		}
	}catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	
}

/**
 * @properties={typeid:24,uuid:"2CD57149-0960-4822-A5C7-836B08D866D3"}
 */
function insertaRegistroRendDet(){
	atcons_vs_to_tbc_rend_det.newRecord();
	globals.InicializarDatosDeRelacion(atcons_vs_to_tbc_rend_det,"asistencial","tbc_rend_det");
	
	atcons_vs_to_tbc_rend_det.rdempresa = 1;
	atcons_vs_to_tbc_rend_det.rdadmision = 2;
	atcons_vs_to_tbc_rend_det.rdadmision1 = 2;
	atcons_vs_to_tbc_rend_det.rdhclinica = globals.AtCons_vhistcli;
	atcons_vs_to_tbc_rend_det.rdperiodo = globals.AtCons_periodo;
	atcons_vs_to_tbc_rend_det.rdcierre = globals.AtCons_cierre;
	atcons_vs_to_tbc_rend_det.rdpantalla = globals.AtCons_nome_panta;
	atcons_vs_to_tbc_rend_det.rdfecha = globals.AtCons_fecha_rend;
	atcons_vs_to_tbc_rend_det.rdhora = globals.AtCons_hora_rend;
	atcons_vs_to_tbc_rend_det.rdtipo = 1;
	atcons_vs_to_tbc_rend_det.rdcodnom = globals.AtCons_codinom;
	atcons_vs_to_tbc_rend_det.rdmodalidad = 4;
	atcons_vs_to_tbc_rend_det.rdfechahasta = 0;
	atcons_vs_to_tbc_rend_det.rdduracion = 0;
	atcons_vs_to_tbc_rend_det.rddias = 10;
	//atcons_vs_to_tbc_rend_det.rdcantmod = 1;
	atcons_vs_to_tbc_rend_det.rdespec=foundset.reservasesp;
	atcons_vs_to_tbc_rend_det.rdmed=foundset.reservasmed;
	
	if(atcons_gbl_to_tbc_medicos_personal.getSize()>0){
		atcons_vs_to_tbc_rend_det.rdtipomed=atcons_gbl_to_tbc_medicos_personal.medpertipoie
	}
	
	try{
		databaseManager.saveData(atcons_vs_to_tbc_rend_det.getRecord(1));
		
	} catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	var error3 = ''
	var error4 = ''
	var array1 = databaseManager.getFailedRecords(atcons_vs_to_tbc_rend_det)
	for (var j = 0; j < array1.length; j++) {
		var record1 = array1[j];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error4 = 'Error en grabación ' + record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown1 = record1.exception.getValue()

		}
	}

	if (error3 != '') {
		globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown1)
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error3, "Aceptar")
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error4, "Aceptar")
		f_error_msa+=' - No se pudo grabar en REND-DET'
	}
}

/**
 * @param {Boolean} $insertar
 * @properties={typeid:24,uuid:"51043A67-6EB7-416E-B57E-C23554814A83"}
 */
function graba_estadtur($insertar){
	globals.AtCons_hiscli=utils.stringToNumber(f_eges_hiscli)
	globals.AtCons_vespecial_rel=f_eges_resecodesp
	globals.AtCons_vfecha_integer=f_eges_resecodfech
	globals.Atcons_vreservashora=f_eges_resecodhora
	globals.AtCons_obra=f_eges_obra
	if($insertar){
		atcons_vs_to_tbc_estadtur.newRecord();
		globals.InicializarDatosDeRelacion(atcons_vs_to_tbc_estadtur,"asistencial","tbc_estadtur");
	}
	atcons_vs_to_tbc_estadtur.estadturfecha=globals.AtCons_vfecha_integer
	atcons_vs_to_tbc_estadtur.estadturfecha1=globals.AtCons_vfecha_integer
	atcons_vs_to_tbc_estadtur.estadturhora=globals.Atcons_vreservashora
	atcons_vs_to_tbc_estadtur.estadturhora1=globals.Atcons_vreservashora
	atcons_vs_to_tbc_estadtur.estadturmed=globals.AtCons_vlega
	atcons_vs_to_tbc_estadtur.estadturesp=globals.AtCons_vespecial_rel
	atcons_vs_to_tbc_estadtur.estadturmednya=atcons_vlegajo_to_tbc_medtur_esp.medturnya
	atcons_vs_to_tbc_estadtur.estadturobr=atcons_vhistcli_to_tbc_hist_cab.histcab_obra
	atcons_vs_to_tbc_estadtur.estadturobrdes=atcons_obra_to_tbc_obras.obr_razonsoc
	if(atcons_vlegajo_to_tbc_medtur_esp.medturtip=="E"){
		atcons_vs_to_tbc_estadtur.estadturtipomed=1
	}else{
		atcons_vs_to_tbc_estadtur.estadturtipomed=0
	}
	atcons_vs_to_tbc_estadtur.estadturtipotur="P"
	atcons_vs_to_tbc_estadtur.estadturplan=atcons_vhistcli_to_tbc_hist_cab.histcab_planx
	atcons_vs_to_tbc_estadtur.estadturconsulta=0
	atcons_vs_to_tbc_estadtur.estadturentro=0
	atcons_vs_to_tbc_estadtur.estadturaten=f_estadtur_consulta + f_estadtur_practica
	atcons_vs_to_tbc_estadtur.estadturtipserv=atcons_vlegajo_to_tbc_medtur_esp.medturtipser
	atcons_vs_to_tbc_estadtur.estadturservicio=atcons_vlegajo_to_tbc_medtur_esp.medturservicio
	atcons_vs_to_tbc_estadtur.estadturausente=0
	
	try{
		databaseManager.saveData(atcons_vs_to_tbc_estadtur.getRecord(1));
		
	} catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	var error3 = ''
	var error4 = ''
	var array1 = databaseManager.getFailedRecords(atcons_vs_to_tbc_estadtur)
	for (var j = 0; j < array1.length; j++) {
		var record1 = array1[j];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error4 = 'Error en grabación ' + record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown1 = record1.exception.getValue()

		}
	}

	if (error3 != '') {
		globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown1)
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error3, "Aceptar")
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error4, "Aceptar")
		f_error_msa+=' - No se pudo grabar en ESTADTUR'
	}
}

/**
 * @properties={typeid:24,uuid:"5C7F1F63-017F-4AD3-B0B1-C373A60349A3"}
 */
function cancelar_turno(){
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $obra
 * @param $plan
 *
 * @properties={typeid:24,uuid:"2E9F2286-2BBC-43D6-ACA4-6756C6A793FA"}
 */
function obtenerPlan($obra, $plan){
	var $plan_retorno=" ";
	globals.Atcons_obrax=$obra
	globals.AtCons_planx=$plan
	if(atcons_vs_to_tbc_plan_obra.getSize()>0){
		$plan_retorno=atcons_vs_to_tbc_plan_obra.plo_planx10
	}
	return $plan_retorno;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $indice
 *
 * @properties={typeid:24,uuid:"25E66E17-A32F-4AB5-BC8D-901091657DEB"}
 */
function insertarImacodi($indice){
	globals.AtCons_tiponom=1
	atcons_vs_to_tbc_imacodi.newRecord()
	globals.InicializarDatosDeRelacion(atcons_vs_to_tbc_imacodi,"maestros","tbc_imacodi");
	
	atcons_vs_to_tbc_imacodi.icodcodinom=globals.AtCons_codinom;
	atcons_vs_to_tbc_imacodi.icoddescrcod=atcons_vs_to_tbc_nomencla.nome_descr
	atcons_vs_to_tbc_imacodi.icodtiponom=globals.AtCons_tiponom
	atcons_vs_to_tbc_imacodi.icodservicio1=globals.AtCons_servicio
	atcons_vs_to_tbc_imacodi.icodservicio2=globals.AtCons_servicio
	
	try{
		databaseManager.saveData(atcons_vs_to_tbc_imacodi.getRecord(1));
		
	} catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	var error3 = ''
	var error4 = ''
	var array1 = databaseManager.getFailedRecords(atcons_vs_to_tbc_imacodi)
	for (var j = 0; j < array1.length; j++) {
		var record1 = array1[j];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error4 = 'Error en grabación ' + record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown1 = record1.exception.getValue()

		}
	}

	if (error3 != '') {
		globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown1)
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error3, "Aceptar")
		globals.DIALOGS.showErrorDialog("Error en grabacion ", error4, "Aceptar")
		f_error_msa+=' - No se pudo grabar en IMACODI'
	}
}

/**
 * @properties={typeid:24,uuid:"33F93814-6EAC-4CE4-8D91-FBF7EDAA33B7"}
 * @AllowToRunInFind
 */
function actualiza_histcab(){
	var fs_histcab = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs_histcab.clear()
	fs_histcab.find()
	fs_histcab['histcab_nrounico']=f_eges_hiscli
	fs_histcab.search()
	if(fs_histcab.getSize()>0){
		fs_histcab['histcab_obra']=f_eges_obra
		fs_histcab['histcab_planx']=f_eges_obrpla
		fs_histcab['histcab_nrobenef']=f_eges_benef
		try{
			databaseManager.saveData(fs_histcab.getRecord(1))
		}catch(msg){
			plugins.dialogs.showErrorDialog("Error grabacion HIST-CAB",msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs_histcab)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
				plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
			}
		}
		if(error1!=''){
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_hist_cab",error1,"Ok")
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_hist_cab",error2,"Ok")
			plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
			f_retorno_msa=false
			f_error_msa+=' - No se pudo regrabar la cobertura en HIST-CAB' 
		}else{
			//actualiza_histcab_obras()
			f_retorno_msa=true
			f_error_msa+=' ' 
		}
	}
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"ABA7784A-3E1C-4D1A-B7B9-9C0A1276AB43"}
 */
function actualiza_histcab_obras(){
	var $sec=0
	var $largo=0
	var $encontrado=false
	var fs_histcab_obras = databaseManager.getFoundSet("asistencial","tbc_hist_cab_obras")
	fs_histcab_obras.clear()
	fs_histcab_obras.find()
	fs_histcab_obras['histcabobrasnrounico']=f_eges_hiscli
	fs_histcab_obras.search()
	if(fs_histcab_obras.getSize()>0){
		$largo=fs_histcab_obras.getSize()
		for(var i=1;i<=$largo&&!$encontrado;i++){
			fs_histcab_obras.setSelectedIndex(i)
			if(fs_histcab_obras['histcabobrasobra']==f_eges_obra&&fs_histcab_obras['histcabobrasplanx']==f_eges_obrpla&&fs_histcab_obras['histcabobrasnrobenef']==f_eges_benef){
				$encontrado=true
			}
			$sec=fs_histcab_obras['histcabobrassec']
		}
	}
	if(!$encontrado){
		$sec++
		fs_histcab_obras.newRecord()
		fs_histcab_obras['histcabobrasnrounico']=f_eges_hiscli
		fs_histcab_obras['histcabobrassec']=$sec
		fs_histcab_obras['histcabobrasobra']=f_eges_obra
		fs_histcab_obras['histcabobrasplanx']=f_eges_obrpla
		fs_histcab_obras['histcabobrasnrobenef']=f_eges_benef
		fs_histcab_obras['histcabobrasstado']=0
		fs_histcab_obras['histcabtipolegajo']=0
		fs_histcab_obras['histcablegajo']=0
		fs_histcab_obras['histcabfechacarga']=f_eges_fech
		try{
			databaseManager.saveData(fs_histcab_obras.getRecord(1))
		}catch(msg){
			plugins.dialogs.showErrorDialog("Error grabacion HIST-CAB-OBRAS",msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs_histcab_obras)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
				plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
			}
		}
		if(error1!=''){
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_hist_cab_obras",error1,"Ok")
			plugins.dialogs.showErrorDialog("Error en grabacion de tbc_hist_cab_obras",error2,"Ok")
			plugins.dialogs.showInfoDialog("Reintentar","Reintente grabar!!")
			f_retorno_msa=false
			f_error_msa+=' - No se pudo regrabar la cobertura en HIST-CAB-OBRAS' 
		}else{
			f_retorno_msa=true
			f_error_msa+=' ' 
		}
	}
}