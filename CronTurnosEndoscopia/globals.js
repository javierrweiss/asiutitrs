/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"12521B4C-D9FB-403B-9365-86993AC12469",variableType:4}
 */
var cron_eges_rend_nome_panta = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1C28F69D-EE38-4228-98C1-F8FBFFEBF35B",variableType:4}
 */
var cron_eges_rend_tiponom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E0E44C36-B43B-41D8-B80E-AC69E470D443",variableType:4}
 */
var cron_eges_rend_codinom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F7EC2AF5-B95E-49B0-90F4-574C1D7A5F49",variableType:4}
 */
var cron_eges_rend_hora = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"92F5A760-B487-4C8C-A343-F861434C11CD",variableType:4}
 */
var cron_eges_rend_fech = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1EF43638-BCCD-4EBD-A343-98AF6B2E93B2",variableType:4}
 */
var cron_eges_rend_periodo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7F19913E-49D3-423C-BB40-4C870AEDC5FA",variableType:4}
 */
var cron_eges_rend_cierre = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D744629B-BFE3-4D90-A03C-5503133ED8D3",variableType:4}
 */
var cron_eges_estadtur_med = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E10EEC17-F2B6-4F77-AC58-EC0830D88B6A",variableType:4}
 */
var cron_eges_tipomed = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4EE46686-0747-4959-B561-4B6DFB9716A3"}
 */
var cron_eges_obrades = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"578DF3A9-6CC2-4730-AC6E-50AD32562548"}
 */
var cron_eges_mednya = ' ';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"335FB333-081C-41A0-8147-34F3063B0B18",variableType:8}
 */
var cron_eges_nropedidounico = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AF4AABED-6C25-4DE0-B416-A8BD5DD73FB3",variableType:4}
 */
var cron_eges_horaguar = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"62DE7E90-5220-472A-8E84-86227E2A8D9F",variableType:4}
 */
var cron_eges_fechguar = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C7210C66-8B24-4D38-8DD1-8F1ACECC0346"}
 */
var cron_eges_condicioniva = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2B4FF8A3-0C9F-40D3-9D9D-14AA7621DF99"}
 */
var cron_eges_nroorden = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"EC639734-5370-4313-8EB2-FAFC7984DB94"}
 */
var cron_eges_tiposol = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D4E7F96A-7DC1-4EAB-9472-6B9EE4FF0BCF"}
 */
var cron_eges_nrodocumento = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B5E9FD43-082C-449A-874F-D2BC06E3998E"}
 */
var cron_eges_tipodocumento = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B726064F-05BF-4009-B8D8-885A34319AA5"}
 */
var cron_eges_errores = ' ';
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"33F49FBE-B88D-4DEF-97D7-4292CF69931A",variableType:4}
 */
var cron_idmensaje_requesteg = 0;
/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"1F19EDC3-97A3-48FE-AFD9-0B0497D212A1",variableType:93}
 */
var cron_eges_fechamensaje = new Date();
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7D6CCABB-51A5-4A2B-9F44-69D8000C497D"}
 */
var cron_eges_estadomensaje = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C802F854-C6D3-4286-8391-5DB4CFD55B18"}
 */
var cron_mensaje = 'null';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"73E1F65E-4FB8-44B5-9B03-2828DCAB9434"}
 */
var cron_error_msa = ' ';
/**
 * @properties={typeid:35,uuid:"F400D938-B819-4FF2-BE73-8F30B79D89A3",variableType:-4}
 */
var cron_retorno_msa = false;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"66B7C701-18AA-4BCF-92E9-6B945CC0C369"}
 */
var cron_eges_hiscli = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B1F847DB-8C7F-4834-A25D-0CDC8D808B05"}
 */
var cron_eges_pv1tipoturno = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"853A5EEA-BB64-40D2-A11C-BE5D551CC2D1"}
 */
var cron_eges_pv1hora = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8AFA2082-A7D4-4690-A708-3ABB95295812"}
 */
var cron_eges_pv1fecha = ' ';
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"3F677468-1A48-4DB5-B797-B9308446EE87",variableType:4}
 */
var cron_eges_idmensaje = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C54B30E1-239F-42E1-9055-82113E48B104",variableType:4}
 */
var cron_eges_matricula = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"07FB708F-1FC3-4D03-B959-4136B28DBE85",variableType:4}
 */
var cron_eges_resecoddiag = 0;
/**
 * @properties={typeid:35,uuid:"861F59D4-3119-4B6E-871E-CBF2CC95FA7B",variableType:-4}
 */
var cron_eges_resecodl = new Array();
/**
 * @properties={typeid:35,uuid:"2A7839E3-5E04-43DF-A69B-C5ABC408BDB7",variableType:-4}
 */
var cron_eges_resecodcantid = new Array();
/**
 * @properties={typeid:35,uuid:"0BECED08-DF94-4149-8ADD-0BBF2B7E0F37",variableType:-4}
 */
var cron_eges_resecodnumcod = new Array();
/**
 * @properties={typeid:35,uuid:"7757E843-BE3D-4214-AECA-C261A1C7EBD9",variableType:-4}
 */
var cron_eges_resecodtipcod = new Array();
/**
 * @properties={typeid:35,uuid:"B73ADFC2-8219-40A2-817F-AEF0D8810CB5",variableType:-4}
 */
var cron_eges_resecoditem = new Array();
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F8D2649E-1FE2-445D-9574-7F38715EF72F",variableType:4}
 */
var cron_eges_resecodhora = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"53B6739F-3C29-4228-8AC3-8E0E9BFC3518",variableType:4}
 */
var cron_eges_resecodfech = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"3447961F-260E-4F0D-9C57-F632CF2497E2",variableType:4}
 */
var cron_eges_resecodmed = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C5A92DF8-73F6-40AC-81C8-66B0FA4EDD16",variableType:4}
 */
var cron_eges_resecodesp = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"3EE4F1ED-4DCF-4387-A05B-26583DCE2227",variableType:4}
 */
var cron_eges_tip_servicio = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8BB08828-A7CF-4B14-B331-9ED3339F961F",variableType:4}
 */
var cron_eges_servicio = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6D59B394-9902-442A-AA18-BB79CE852DC5",variableType:4}
 */
var cron_eges_sexo = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B325736B-0363-4234-B7AA-DA9819A55018",variableType:4}
 */
var cron_eges_tip_opera = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"37F6B5FB-572C-463D-AD27-4AC635A1DD55",variableType:4}
 */
var cron_eges_operador = 0;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"34094988-4861-404A-9506-70D0BA1B48D3"}
 */
var cron_eges_benef = ' ';
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0BF560A9-FB70-4FDC-9B18-687D4299A660"}
 */
var cron_eges_obrpla = ' ';
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"63C3AC60-528C-4643-BE99-B57061BFFD80",variableType:4}
 */
var cron_eges_obra = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E7A8AE2B-344B-4CFF-929C-EF2A9FAFF1E8",variableType:4}
 */
var cron_eges_consul = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"82EC6624-66B4-4A0E-90D3-E9BBAA2A5F03",variableType:4}
 */
var cron_eges_hora = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D82D0082-1AD3-4AC1-B8A3-B499A04DAF1A",variableType:4}
 */
var cron_eges_fech = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2E7BA0F4-9431-4895-9B1F-FFDF8E5FD19B",variableType:4}
 */
var cron_eges_med = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B05BF9C7-C86D-4F8F-BA65-2E036193BEC6",variableType:4}
 */
var cron_eges_esp = 0;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3A257BE9-743E-400A-AF2A-023A2795D37F"}
 */
var cron_vacio = '  ';
/**
 * @properties={typeid:35,uuid:"95194A86-25FE-4619-8A0E-7E298F2ECC65",variableType:-4}
 */
var cron_fecha_dia = null;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"39696F80-DB85-4501-9F81-224C9C4DD455",variableType:4}
 */
var cron_hubo_turno = 0;
/**
 * @properties={typeid:35,uuid:"8E0BF8BF-B7B3-4D78-98F9-2796F290CE99",variableType:-4}
 */
var cron_eges_imacodidescod = new Array();
/**
 * @properties={typeid:24,uuid:"00A4FC15-833C-48D3-9305-687E1752ABFC"}
 */
function cronObtenerEndoscopiasEges() {
	/*
	 * El método cronObtenerEndoscopiasEges, por alguna razón, no pasa por la estructura de control de validación y, por ende, 
	 * no llama a cron_insertar_responseeg ni a cron_actualiza_requesteg. El problema es que el código de este método y de otros 
	 * métodos a los que este llama no envíanningún tipo de excepción cuando fallan..
	 */
	cron_mensaje=''
	var sql = "select mensaje1, mensaje2, mensaje3, mensaje4, mensaje5, mensaje6, mensaje7, mensaje8, estadomensaje, fechamensaje, idmensaje from requesteg where estadomensaje='R' and tipomsj='ORM_O01'"
	//var sql = "select mensaje1, mensaje2, mensaje3, mensaje4, mensaje5, mensaje6, mensaje7, mensaje8 from requesteg where estadomensaje=0 and tipomsj='ORM'"
	var dataset = new Array() 
	//if(databaseManager.getDataSetByQuery("validaciones",sql,null,-1)!=null){
		dataset=databaseManager.getDataSetByQuery("validaciones",sql,null,-1)
	//}else{
		//return
	//}
	var kanti = dataset.getMaxRowIndex()
	var resultado=false
	var $plan = new Array();
	cron_retorno_msa=true
	cron_error_msa=''
	if(kanti>0){
		var $fecha=0
		for(var i=1;i<=kanti;i++){
			cron_mensaje=dataset.getValue(i,1)+dataset.getValue(i,2)+dataset.getValue(i,3)+dataset.getValue(i,4)+dataset.getValue(i,5)+dataset.getValue(i,6)+dataset.getValue(i,7)+dataset.getValue(i,8)
			cron_eges_estadomensaje=dataset.getValue(i,9)
			cron_eges_fechamensaje=dataset.getValue(i,10)
			cron_idmensaje_requesteg=dataset.getValue(i,11)
			
			application.output("Mensaje: ")
			application.output(cron_mensaje)
			application.output("Fecha: ")
			application.output(cron_eges_fechamensaje)
			
			if(cron_parseo_xml_Eges(cron_mensaje)){
				application.output("Parseo")
				$fecha=cron_eges_pv1fecha.substr(6,4)+''+cron_eges_pv1fecha.substr(3,2)+''+cron_eges_pv1fecha.substr(0,2)
				$plan=cron_eges_obrpla.toString().split('-')
				if($plan[1]=="General"){
					cron_eges_obrpla=' '
				}else{
					cron_eges_obrpla=obtenerPlan(cron_eges_obra, $plan[1])
				}
				if(cron_filtra_campos_clave_Reservas(cron_eges_esp, $fecha)){
					application.output("Filtrado de campos")
					if(cron_valida_turno_en_Reservas()){
						application.output("Validación de turnos")
						if(cron_valida_hiscli()){
							application.output("Validación de historia clínica")
							if(cron_insertar_turno()){
								application.output("Inserción de turno")
								if(cron_insertar_guardia()){
									application.output("Cron inserta guardia")
									if(cron_insertar_resecod()){
										application.output("Cron inserta resecod")
										cron_insertar_pracquiro()
										globals.GenerarTXTInterfaseVisualMedica(3, 6, 0, utils.stringToNumber(cron_eges_hiscli), cron_eges_fechguar, 0, cron_eges_horaguar)
									}
									cron_actualiza_requesteg()
									application.output("******************Cron actualiza requesteg********************")
								}
								graba_estadtur(true)
							}
						}
					}
					/*else{
						if(cron_valida_hiscli()){
							if(cron_regrabar_turno()){
								if(cron_insertar_guardia()){
									if(cron_insertar_resecod()){
										cron_insertar_pracquiro()
										globals.GenerarTXTInterfaseVisualMedica(3, 6, 0, utils.stringToNumber(cron_eges_hiscli), cron_eges_fechguar, 0, cron_eges_horaguar)
									}
									cron_actualiza_requesteg()
								}
								graba_estadtur(false)
							}
						}
					}
					*/
					application.output("****************Cron inserta responseeg*******************")
					cron_insertar_responseeg()
				}
			}
		}
	}
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param mensaje
 *
 * @properties={typeid:24,uuid:"69FFDD13-6004-4A84-924F-03F276D1F0DD"}
 */
function cron_parseo_xml_Eges(mensaje){
	var nodes = plugins.XmlReader.readXmlDocumentFromString(mensaje);
	var childs = new Array()
	var subChilds = new Array()
	var subChilds2 = new Array()
	var ii = 0
	var jj = 0
	var ll = 0
	var xx = 0
	var $efector=false
	cron_eges_matricula=null
	cron_eges_esp=null
	cron_eges_pv1fecha=null
	cron_eges_pv1hora=null
	cron_eges_servicio=null
	cron_eges_hiscli=null
	cron_eges_condicioniva=null
	cron_eges_resecodtipcod=new Array()
	cron_eges_resecodnumcod=new Array()
	cron_eges_resecodl=new Array()
	cron_eges_resecoditem=new Array()
	cron_eges_resecodcantid=new Array()
	cron_eges_imacodidescod=new Array()
	
	var xml_valido = true
						
	childs = nodes[0].getChildNodes()
	
	for(ii=0;ii<childs.length&&xml_valido;ii++){
		if(childs[ii].getName().substr(0,3)=="MSH"){
			cron_eges_idmensaje=childs[ii].getAttributeValue("IDMensaje")
		}
		switch (childs[ii].getName()){
			case 'Efector':$efector=true;break;
			case 'MSA':break;
			case 'MatriculaNumero':if($efector){cron_eges_matricula=childs[ii].getTextValue(); $efector=false;}break;
			case 'IDEspecialidad':cron_eges_esp=childs[ii].getTextValue();break;
			case 'PV1Fecha':cron_eges_pv1fecha=childs[ii].getTextValue();break;
			case 'PV1Hora':cron_eges_pv1hora=childs[ii].getTextValue();break;
			case 'Servicio':cron_eges_servicio=childs[ii].getTextValue();break;
			case 'PV1Servicio':break;
			case 'PV1TipoTurno':break;
			case 'NroHistoriaClinica':cron_eges_hiscli=childs[ii].getTextValue();break;
			case 'Sexo':break;
			case 'Cobertura':cron_eges_obra=utils.stringToNumber(childs[ii].getTextValue());break;
			case 'Plan':cron_eges_obrpla=childs[ii].getTextValue();break;
			case 'Afiliado':cron_eges_benef=childs[ii].getTextValue();break;
			case 'CondicionIVA':cron_eges_condicioniva=childs[ii].getTextValue();break;
			case 'PRIS':break;
			case 'PR1':break;
			case 'SET_ID':break;
			case 'ID':cron_eges_nroorden=childs[ii].getTextValue();break;
			case 'NOMENCLADOR':break;
			case 'CANTIDAD':break;
		}
		if (cron_eges_servicio!=null&&cron_eges_servicio!=6){
			xml_valido=false
		}else{
			subChilds = childs[ii].getChildNodes()
			if(subChilds.length>0){
				for(jj=0;jj<subChilds.length;jj++){
					switch (subChilds[jj].getName()){
					case 'Efector':$efector=true;break;
					case 'MatriculaNumero':if($efector){cron_eges_matricula=subChilds[jj].getTextValue(); $efector=false;}break;
					case 'IDEspecialidad':cron_eges_esp=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'PV1Fecha':cron_eges_pv1fecha=subChilds[jj].getTextValue();break;
					case 'PV1Hora':cron_eges_pv1hora=subChilds[jj].getTextValue();break;
					case 'Servicio':cron_eges_servicio=subChilds[jj].getTextValue();break;
					case 'PV1Servicio':break;
					case 'LUGAR_ATENCION':cron_eges_consul=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'PV1TipoTurno':cron_eges_pv1tipoturno=subChilds[jj].getTextValue();break;
					case 'NroHistoriaClinica':cron_eges_hiscli=subChilds[jj].getTextValue();break;
					case 'NroDocumento':cron_eges_nrodocumento=subChilds[jj].getTextValue();break;
					case 'TipoDocumento':cron_eges_tipodocumento=subChilds[jj].getTextValue();break;
					case 'Sexo':break;
					case 'Cobertura':cron_eges_obra=utils.stringToNumber(subChilds[jj].getTextValue());break;
					case 'Plan':cron_eges_obrpla=subChilds[jj].getTextValue();break;
					case 'Afiliado':cron_eges_benef=subChilds[jj].getTextValue();break;
					case 'CondicionIVA':cron_eges_condicioniva=subChilds[jj].getTextValue();break;
					case 'PRIS':break;
					case 'PR1':break;
					case 'SET_ID':break;
					case 'ID':cron_eges_resecodnumcod[xx]=subChilds[jj].getTextValue();break;
					case 'DESCRIPCION_PRESTACION':cron_eges_imacodidescod[xx]=subChilds[jj].getTextValue();break;
					case 'NOMENCLADOR':cron_eges_resecodtipcod[xx]=subChilds[jj].getTextValue();break;
					case 'CANTIDAD':cron_eges_resecodcantid[xx]=subChilds[jj].getTextValue();xx++;break;
					}
					
					subChilds2 = subChilds[jj].getChildNodes()
					if(subChilds2.length>0){
					
						for(ll=0;ll<subChilds2.length;ll++){
							
							switch (subChilds2[ll].getName()){
							case 'Efector':$efector=true;break;
							case 'MatriculaTipo':break;
							case 'MatriculaNumero':if($efector){cron_eges_matricula=subChilds2[ll].getTextValue(); $efector=false;};break;
							case 'IDEspecialidad':cron_eges_esp=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'PV1Fecha':cron_eges_pv1fecha=subChilds2[ll].getTextValue();break;
							case 'PV1Hora':cron_eges_pv1hora=subChilds2[ll].getTextValue();break;
							case 'Servicio':cron_eges_servicio=subChilds2[ll].getTextValue();break;
							case 'PV1Servicio':break;
							case 'LUGAR_ATENCION':cron_eges_consul=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'PV1TipoTurno':cron_eges_pv1tipoturno=subChilds2[ll].getTextValue();break;
							case 'NroHistoriaClinica':cron_eges_hiscli=subChilds2[ll].getTextValue();break;
							case 'NroDocumento':cron_eges_nrodocumento=subChilds2[ll].getTextValue();break;
							case 'TipoDocumento':cron_eges_tipodocumento=subChilds2[ll].getTextValue();break;
							case 'Sexo':break;
							case 'Cobertura':cron_eges_obra=utils.stringToNumber(subChilds2[ll].getTextValue());break;
							case 'Plan':cron_eges_obrpla=subChilds2[ll].getTextValue();break;
							case 'Afiliado':cron_eges_benef=subChilds2[ll].getTextValue();break;
							case 'CondicionIVA':cron_eges_condicioniva=subChilds2[ll].getTextValue();break;
							case 'PRIS':break;
							case 'PR1':break;
							case 'SET_ID':break;
							case 'ID':cron_eges_resecodnumcod[xx]=subChilds2[ll].getTextValue();break;
							case 'DESCRIPCION_PRESTACION':cron_eges_imacodidescod[xx]=subChilds2[ll].getTextValue();break;
							case 'NOMENCLADOR':cron_eges_resecodtipcod[xx]=subChilds2[ll].getTextValue();break;
							case 'CANTIDAD':cron_eges_resecodcantid[xx]=subChilds2[ll].getTextValue();xx++;break;
							}
						}
					}
				}
			}
		}
	}
	
	if(cron_eges_hiscli==null||cron_eges_esp==null||cron_eges_matricula==null||cron_eges_pv1fecha==null||cron_eges_pv1hora==null||cron_eges_servicio==null){
		return false
	}else{
		return true
	}
}


/**
 * @AllowToRunInFind
 * 
 * TODO generated, please specify type and doc for the params
 * @param especialidad
 * @param fecha
 *
 * @properties={typeid:24,uuid:"530BA9D4-DA1F-4EBA-9599-0CD4AFB5639E"}
 */
function cron_filtra_campos_clave_Reservas(especialidad, fecha){
	if(cron_eges_servicio!=6){
		return false
	}
	if(cron_eges_pv1fecha==null||cron_eges_pv1hora==null){
		return false
	}
	if(cron_eges_esp!=especialidad){
		return false
	}
	var i=0
	var $codigo_med=0
	var fin_matricula=false
	var fs_medper = databaseManager.getFoundSet("maestros","tbc_medicos_personal")
	var fs_medtur = databaseManager.getFoundSet("asistencial","tbc_medtur")
	var fin_especialidad=false
	cron_eges_med=null
	cron_eges_estadtur_med=null
	var fs_especialidad = databaseManager.getFoundSet("maestros","tbc_especial")
	fs_especialidad.find()
	fs_especialidad['esp_codi']=cron_eges_esp
	fs_especialidad.search()
	if(fs_especialidad.getSize()>0){
		fin_especialidad=true
	}
	fs_medper.find()
	fs_medper['medpermatricun']=cron_eges_matricula
	fs_medper.search()
	if(fs_medper.getSize()>0){
		for(i=1;i<=fs_medper.getSize()&&!fin_matricula&&fin_especialidad;i++){
			fs_medper.setSelectedIndex(i)
			$codigo_med=fs_medper['medpercod']+'0'
			fs_medtur.find()
			fs_medtur['medturcod']=$codigo_med
			fs_medtur['medturesp']=cron_eges_esp
			fs_medtur.search()
			if(fs_medtur.getSize()>0){
				if(fs_medtur['medturbaja']==0){
					cron_eges_med=fs_medtur['medturcod']
					cron_eges_estadtur_med=fs_medper['medpercod']
					if(fs_medper['medpertipoie']==0){
						cron_eges_tiposol='I'
					}else{
						cron_eges_tiposol='E'
					}
					cron_eges_tipomed=fs_medper['medpertipoie']
					cron_eges_mednya=fs_medper['medperapeynom']
					fin_matricula=true
				}
			}
		}
	}
	cron_eges_hora=cron_eges_pv1hora+"0000"
	cron_eges_fech=cron_eges_pv1fecha.substr(6,4)+cron_eges_pv1fecha.substr(3,2)+cron_eges_pv1fecha.substr(0,2)
	
	if(cron_eges_fech!=utils.stringToNumber(fecha)){
		return false
	}
	
	if(!fin_especialidad||!fin_matricula){
		return false
	}else{
		return true
	}
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"AC60C2CB-FFAD-4600-8E8B-EABC33F8E6BA"}
 */
function cron_valida_turno_en_Reservas(){
	var fs_reservas = databaseManager.getFoundSet("asistencial","tbc_reservas")
	fs_reservas.clear()
	fs_reservas.find()
	fs_reservas['reservasesp']=cron_eges_esp
	fs_reservas['reservasmed']=cron_eges_med
	fs_reservas['reservasfech']=cron_eges_fech
	fs_reservas['reservashora']=cron_eges_hora
	fs_reservas.search()
	if (fs_reservas.getSize()>0){
		cron_retorno_msa=false
		cron_error_msa='Turno Existente'
		while (!cron_retorno_msa){
			cron_eges_hora=cron_eges_hora+10000
			fs_reservas.find()
			fs_reservas['reservasesp']=cron_eges_esp
			fs_reservas['reservasmed']=cron_eges_med
			fs_reservas['reservasfech']=cron_eges_fech
			fs_reservas['reservashora']=cron_eges_hora
			fs_reservas.search()
			if (fs_reservas.getSize()<1){
				cron_retorno_msa=true
			}
		}
		return true	
	}else{
		cron_retorno_msa=true
		cron_error_msa=''
		return true
	}
}


/**
 * @properties={typeid:24,uuid:"FCBBED47-874D-4991-8470-D12D508BD955"}
 */
function cron_insertar_turno(){
	var fs = databaseManager.getFoundSet("asistencial","tbc_reservas")
	fs.newRecord()
	//globals.InicializarDatos("AtCons_reservas","asistencial","tbc_reservas")
	//mover campos
	//
	//
	
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	var $ed_hora=''
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	if($hora_ped<10){
		$ed_hora='0'+$hora_ped
	}else{
		$ed_hora=$hora_ped
	}
	fs.reservasatendi=0
	fs.reservasatendicef=0
	//fs.reservasconsu=cron_eges_consul
	fs.reservasesp1=cron_eges_esp
	fs.reservasesp2=cron_eges_esp
	fs.reservasesp3=cron_eges_esp
	fs.reservasesp6=cron_eges_esp
	fs.reservasesp=cron_eges_esp
	fs.reservasesta=1
	fs.reservasestacef=1
	fs.reservasfech1=cron_eges_fech
	fs.reservasfech2=cron_eges_fech
	fs.reservasfech3=cron_eges_fech
	fs.reservasfech5=cron_eges_fech
	fs.reservasfech6=cron_eges_fech
	fs.reservasfech=cron_eges_fech
	fs.reservasfechaconf=$anio+$ed_mes+$ed_dia
	fs.reservasfechaped=$anio+$ed_mes+$ed_dia
	fs.reservashiscli=utils.stringToNumber(cron_eges_hiscli)
	fs.reservashora1=cron_eges_hora
	fs.reservashora2=cron_eges_hora
	fs.reservashora3=cron_eges_hora
	fs.reservashora5=cron_eges_hora
	fs.reservashora6=cron_eges_hora
	fs.reservashora=cron_eges_hora
	fs.reservashoraatenc=cron_eges_hora
	fs.reservashoracef=cron_eges_hora
	fs.reservashoraconf=$ed_hora+$ed_min
	fs.reservashoraped=$ed_hora+$ed_min
	fs.reservasmed1=cron_eges_med
	fs.reservasmed2=cron_eges_med
	fs.reservasmed3=cron_eges_med
	fs.reservasmed6=cron_eges_med
	fs.reservasmed=cron_eges_med
	fs.reservasnroben=cron_eges_benef.toString()
	fs.reservasobra=cron_eges_obra
	fs.reservasobrpla=cron_eges_obrpla.toString()
	fs.reservasopera=cron_eges_operador
	fs.reservasoperaconf=cron_eges_operador
	fs.reservasservicio=cron_eges_servicio
	fs.reservassexo=cron_eges_sexo
	fs.reservastipo='P'
	fs.reservastipoopera=cron_eges_tip_opera
	fs.reservastipooperaconf=cron_eges_tip_opera
	fs.reservastipser=cron_eges_tip_servicio
	fs.reservastipsercef=cron_eges_tip_servicio
	//fs.reservastipsol=cron_eges_tiposol
	switch (cron_eges_condicioniva){
	case 'O':fs.reservasiva=1;break;
	case 'V':fs.reservasiva=3;break;
	default:fs.reservasiva=2;break;
	}
	fs.reservasnumerofc=0
	fs.reservasletrafc=' '	 
	fs.reservasmedsol=0	
	fs.reservastipsol=' '	 
	fs.reservasprimeravez=0
	fs.reservasipedido=0
	fs.reservashorasobre=0
	fs.reservassexo=0	
	fs.reservascron=0	
	fs.reservasllamadaestado=' ' 
	fs.reservasllamadadestino=0	
	fs.reservasfechcef=cron_eges_fech
	fs.reservasmedicab=' '	             
	fs.reservasautoriza=' '	            
	fs.reservasconsu=0
	fs.reservaspartespe=0
	fs.reservasconestudio=0
	fs.reservasetipoestudio_10=0
	fs.reservasetipoestudio_9=0
	fs.reservasetipoestudio_8=0
	fs.reservasetipoestudio_7=0
	fs.reservasetipoestudio_6=0
	fs.reservasetipoestudio_5=0
	fs.reservasetipoestudio_4=0
	fs.reservasetipoestudio_3=0
	fs.reservasetipoestudio_2=0
	fs.reservasetipoestudio_1=0
	fs.reservaspamifup=0
	fs.reservasmarcapasos=' '	          
	fs.reservaspvezxesp=0
	fs.reservasmenoracom=0	
		
	
	try{
		databaseManager.saveData(fs.getRecord(1))
	}catch(msg){
		application.output(msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
		}
	}
	if(error1!=''){
		application.output(error1)
		application.output(error2)
		cron_retorno_msa=false
		cron_error_msa+=' - No se pudo grabar el turno en RESERVAS' 
	}else{
		cron_retorno_msa=true
		cron_error_msa+=' ' 
	}
	return cron_retorno_msa
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"E43CDB39-0780-47B3-AD40-B347409968E7"}
 */
function cron_regrabar_turno(){
	
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	var $ed_hora=''
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	if($hora_ped<10){
		$ed_hora='0'+$hora_ped
	}else{
		$ed_hora=$hora_ped
	}
	cron_retorno_msa=false
	var fs = databaseManager.getFoundSet("asistencial","tbc_reservas")
	fs.find()
	fs.reservasesp=cron_eges_esp             
	fs.reservasfech=cron_eges_fech           
	fs.reservashora=cron_eges_hora           
	fs.reservasmed=cron_eges_med 
	fs.search()
	if(fs.getSize()>0){
		fs.reservasatendi=0
		fs.reservasatendicef=0
		fs.reservasconsu=cron_eges_consul
		fs.reservasesta=1
		fs.reservasestacef=1
		fs.reservasfechaconf=$anio+$ed_mes+$ed_dia
		fs.reservasfechaped=$anio+$ed_mes+$ed_dia
		fs.reservashiscli=utils.stringToNumber(cron_eges_hiscli)
		fs.reservashoraconf=$ed_hora+$ed_min
		fs.reservashoraped=$ed_hora+$ed_min
		fs.reservasnroben=cron_eges_benef
		fs.reservasobra=cron_eges_obra
		fs.reservasobrpla=cron_eges_obrpla
		fs.reservasopera=cron_eges_operador
		fs.reservasoperaconf=cron_eges_operador
		fs.reservasservicio=cron_eges_servicio
		fs.reservassexo=cron_eges_sexo
		fs.reservastipo="P"
		fs.reservastipoopera=cron_eges_tip_opera
		fs.reservastipooperaconf=cron_eges_tip_opera
		fs.reservastipser=cron_eges_tip_servicio
		fs.reservastipsercef=cron_eges_tip_servicio
		fs.reservastipsol=cron_eges_tiposol
		switch (cron_eges_condicioniva){
		case 'O':fs.reservasiva=1;break;
		case 'V':fs.reservasiva=3;break;
		default:fs.reservasiva=2;break;
		}
		
		try{
			databaseManager.saveData(fs.getRecord(1))
		}catch(msg){
			application.output(msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
			}
		}
		if(error1!=''){
			application.output(error1)
			application.output(error2)
			cron_retorno_msa=false
			cron_error_msa+=' - No se pudo regrabar el turno en RESERVAS' 
		}else{
			cron_retorno_msa=true
			cron_error_msa+=' ' 
		}
	}
	return cron_retorno_msa
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"BEA1B0A5-2218-4AC3-9165-B2BE70FD5EB0"}
 */
function cron_valida_hiscli(){
	var $hiscli=0
	if(cron_eges_hiscli>2000000){
		$hiscli=cron_busca_hiscli_x_documento()
	}else{
		$hiscli=cron_eges_hiscli
	}
	var fs = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs.clear()
	fs.find()
	fs['histcab_nrounico']=$hiscli
	fs.search()
	if(fs.getSize()>0){
		fs.setSelectedIndex(1)
		if(cron_eges_obra!=fs['histcab_obra']||cron_eges_obrpla!=fs['histcab_planx']||cron_eges_benef!=fs['histcab_nrobenef']){
			actualiza_histcab()
		}
		cron_retorno_msa=true
		cron_error_msa+=' ' 
		return true
	}else{
		cron_retorno_msa=false
		cron_error_msa+=' - No se encontro Historia Clinica' 
		return false
	}
}


/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"43B1E14E-85D2-43A4-9868-CBED9CE088C5"}
 */
function cron_busca_hiscli_x_documento(){
	var $hiscli1=0
	var $encontrado=false
	var fs = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs.clear()
	fs.find()
	fs['histcab_tipdoc']=cron_eges_tipodocumento
	fs['histcab_nrodoc']=cron_eges_nrodocumento
	fs.search()
	if(fs.getSize()>0){
		for(var i=1;i<=fs.getSize();i++){
			fs.setSelectedIndex(i)
			$hiscli1=fs['histcab_nrounico']
		}
	}else{
		for(var j=1;j<=5&&!$encontrado;j++){
			fs.find()
			fs['histcab_tipdoc']=j
			fs['histcab_nrodoc']=cron_eges_nrodocumento
			fs.search()
			if(fs.getSize()>0){
				fs.setSelectedIndex(1)
				$hiscli1=fs['histcab_nrounico']
				$encontrado=true
			}
		}
	}
	return $hiscli1
}

/**
 * @properties={typeid:24,uuid:"0295D11B-707B-4CB1-8DF3-AA43DDB3473C"}
 * @AllowToRunInFind
 */
function cron_insertar_responseeg(){
	var $posicion_estado=cron_mensaje.indexOf("</Estado>")
	var $posicion_idida=cron_mensaje.indexOf("</IDMensajeIda>")
	var $posicion_iErrores=cron_mensaje.indexOf("<Errores>")
	var $posicion_fErrores=cron_mensaje.indexOf("</Errores>")
	var $estado_ida=''
	if(cron_retorno_msa){
		$estado_ida="AA"
	}else{
		$estado_ida="AE"
	}
	var $mensaje=cron_mensaje.substr(0,$posicion_estado-5)+$estado_ida+cron_mensaje.substr($posicion_estado,$posicion_idida-$posicion_estado-6)+cron_eges_idmensaje+cron_mensaje.substr($posicion_idida,$posicion_iErrores-$posicion_idida+9)+cron_error_msa+cron_mensaje.substr($posicion_fErrores,cron_mensaje.length-$posicion_fErrores)
	var fs = databaseManager.getFoundSet("validaciones","responseeg")
	
	fs.clear()
	fs.find()
	fs['idmensaje']=cron_idmensaje_requesteg
	fs.search()
	if(fs.getSize()<1){
		fs.newRecord()
		fs['idmensaje']=cron_idmensaje_requesteg
	}
	fs['mensaje']=$mensaje
	fs['estadomensaje']=cron_eges_estadomensaje
	fs['fechamensaje']=cron_eges_fechamensaje
	fs['codigo']=0
	
	application.output("Mensaje: ")
	application.output($mensaje)
	application.output(fs['mensaje'])
	application.output("Estado mensaje: ")
	application.output(cron_eges_estadomensaje)
	application.output(fs['estadomensaje'])
	
	try{
		databaseManager.saveData(fs)
	}catch(msg){
		application.output(msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
		}
	}
	if(error1!=''){
		application.output(error1)
		application.output(error2)
	}
}


/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"F853B904-1440-4054-944E-72471312C742"}
 */
function cron_actualiza_requesteg(){
	var fs = databaseManager.getFoundSet("validaciones","requesteg")
	fs.find()
	fs['idmensaje']=cron_idmensaje_requesteg
	fs.search()
	//fs.search(true,false)
	if(fs.getSize()>0){
		fs['estadomensaje']= 'P';
			application.output("Registro a grabarse con estado mensaje cambiado a P: ")
			application.output(fs.getSelectedRecord())
		try{
			databaseManager.saveData(fs)
		}catch(msg){
			application.output(msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			 record.exception.getStackTrace()
			}
		}
		if(error1!=''){
			application.output(error1)
			application.output(error2)
		}
	}
}


/**
 * @properties={typeid:24,uuid:"53C53B11-7007-467E-A8FF-5A639E2FA76C"}
 * @AllowToRunInFind
 */
function cron_insertar_guardia(){
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	cron_eges_fechguar=0
	cron_eges_horaguar=0
	var fs_histcab = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs_histcab.find()
	fs_histcab['histcab_nrounico']=utils.stringToNumber(cron_eges_hiscli)
	fs_histcab.search()
	if(fs_histcab.getSize()>0){
		cron_retorno_msa=false
		var fs = databaseManager.getFoundSet("asistencial","tbc_guardia")
		fs.newRecord()
		fs['guar_histclinica']=utils.stringToNumber(cron_eges_hiscli)
		fs['guar_fechaingreso']=$anio+''+$ed_mes+''+$ed_dia
		fs['guar_horaingreso']=$hora_ped+''+$ed_min
		cron_eges_fechguar=$anio+''+$ed_mes+''+$ed_dia
		cron_eges_horaguar=$hora_ped+''+$ed_min
		fs['guar_especialidad']=5
		fs['guar_estado']=1
		fs['guar_fechaingreso1']=$anio+''+$ed_mes+''+$ed_dia
		fs['guar_horaingreso1']=$hora_ped+''+$ed_min
		fs['guar_histclinica1']=utils.stringToNumber(cron_eges_hiscli)
		fs['guar_especialidad1']=5
		fs['guar_estado1']=1
		fs['guar_fechaingreso3']=$anio+''+$ed_mes+''+$ed_dia
		fs['guar_horaingreso3']=$hora_ped+''+$ed_min
		fs['guar_especialidad3']=5
		fs['guar_estado3']=1
		fs['guar_apenom']=fs_histcab['histcab_apellnom']
		fs['guar_obra']=cron_eges_obra
		fs['guar_plan']=cron_eges_obrpla
		fs['guar_nroben']=cron_eges_benef
		fs['guar_medico']=0
		fs['guar_tipomed']=0
		fs['guar_diagnostico']=1014
		fs['guar_fechaalta']=0
		fs['guar_horaalta']=0
		fs['guar_turno']=0
		fs['guar_primeravez']=0
		fs['guar_espmed']=0
		fs['guar_horaatenc']=0
		fs['guar_letrafc']=' '
		fs['guar_numefc']=0
		fs['guar_tipooperador']=0
		fs['guar_operador']=0
		fs['guar_deriva']=0
		fs['guar_derivasec']=0
		fs['guar_habita']=0
		fs['guar_cama']=' '
		fs['guar_medicab']=' '
		fs['guar_pamifup']=0
		fs['guar_anestesia']=0
		fs['guar_ctro']=0
		fs['guar_reingreso']=0
		fs['guar_fechacama']=0
		fs['guar_horacama']=0
		fs['guar_fechaepic']=0
		fs['guar_menoracom']=0
		fs['guar_opetipreingreso']=0
		fs['guar_opelegreingreso']=0
		fs['guar_opetipcama']=0
		fs['guar_opelegcama']=0
		fs['guar_estadofebril']=0
		fs['guar_quienanula']=0
		fs['guar_otrctro']=0
		switch (cron_eges_condicioniva){
			case 'O':fs['guariva']=1;break;
			case 'V':fs['guariva']=3;break;
			default:fs['guariva']=2;break;
		}
			
		
		try{
			databaseManager.saveData(fs)
		}catch(msg){
			application.output(msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				var thrown = record.exception.getValue()
			}
		}
		if(error1!=''){
			application.output(error1)
			application.output(error2)
			cron_retorno_msa=false
			cron_error_msa+=' - No se pudo grabar el registro en GUARDIA' 
		}else{
			cron_retorno_msa=true
			cron_error_msa+=' ' 
		}
	}else{
		cron_retorno_msa=false
		cron_error_msa+=' - No se pudo grabar el registro en GUARDIA, no existe HC' 
	}
	return cron_retorno_msa
}

/**
 * @properties={typeid:24,uuid:"F92461F5-4716-4E4B-AA89-F4F9D2B55389"}
 */
function cron_insertar_pracquiro(){
	var $dia_hora_actual=application.getServerTimeStamp()
	var $anio=$dia_hora_actual.getFullYear()
	var $mes=$dia_hora_actual.getMonth()+1
	var $hora_ped=$dia_hora_actual.getHours()
	var $min_ped=$dia_hora_actual.getMinutes()
	var $dia=$dia_hora_actual.getDate()
	var $ed_mes=''
	var $ed_dia=''
	var $ed_min=''
	if($mes>=10){
		$ed_mes=$mes
	}else{
		$ed_mes='0'+$mes
	}
	if($dia>=10){
		$ed_dia=$dia
	}else{
		$ed_dia='0'+$dia
	}
	if($min_ped>=10){
		$ed_min=$min_ped
	}else{
		$ed_min='0'+$min_ped
	}
	
	cron_eges_nropedidounico = 0
	var done0 = plugins.rawSQL.executeSQL("parametros", "param2", "begin; lock table param2 in row exclusive mode;")
	if (!done0) {
		var msg0 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg0)
	}
	var done = plugins.rawSQL.executeSQL("parametros", "param2", "select * from param2 where key_param2 = 1 for update;")
	if (!done) {
		var msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg)
	}
	var vQuery = " SELECT * FROM param2 WHERE key_param2 = 1";
	var vDataset = databaseManager.getDataSetByQuery("parametros", vQuery, null, 1);
	
	var nombre_campo='prm2_54';
	var numero_campo=54;
	cron_eges_nropedidounico=vDataset.getValue(1,numero_campo)+1;
	var done1 = plugins.rawSQL.executeSQL("parametros", "param2", "update param2 set " + nombre_campo + " = " + nombre_campo +" + 1 where key_param2 = 1; commit;")
	if (!done1) {
		var msg1 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg1)
	}
	
	
	cron_retorno_msa=false
	var fs = databaseManager.getFoundSet("asistencial","tbc_pracquiro")
	fs.newRecord()
	fs['pracquirohistclinica']=utils.stringToNumber(cron_eges_hiscli)
	fs['pracquirofechacarga']=$anio+''+$ed_mes+''+$ed_dia
	fs['pracquirohoracarga']=$hora_ped+''+$ed_min
	fs['pracquiroresp']=cron_eges_esp 
	fs['pracquirormed']=cron_eges_med 
	fs['pracquirorfech']=cron_eges_fech 
	fs['pracquirorhora']=cron_eges_hora 
	fs['pracquiroghistclinica']=utils.stringToNumber(cron_eges_hiscli)
	fs['pracquirogfechaingreso']=cron_eges_fechguar
	fs['pracquiroghoraingreso']=cron_eges_horaguar
	fs['pracquirohhiscli']=0
	fs['pracquirohfecha']=0
	fs['pracquirohhora']=0
	fs['pracquiroservicio']=6
	fs['pracquiroestado']=0
	fs['pracquiroprotocolo']=0
	fs['pracquironropedunico']=cron_eges_nropedidounico
			
	
	try{
		databaseManager.saveData(fs)
	}catch(msg){
		application.output(msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
		}
	}
	if(error1!=''){
		application.output(error1)
		application.output(error2)
		cron_retorno_msa=false
		cron_error_msa+=' - No se pudo grabar el registro en PRACQUIRO' 
	}else{
		cron_retorno_msa=true
		cron_error_msa+=' ' 
	}
	
	
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"7AAE2E6F-89BB-4E06-B1BC-C328048F1B85"}
 */
function cron_insertar_resecod(){
	cron_eges_resecodesp=cron_eges_esp
	cron_eges_resecodmed=cron_eges_med
	cron_eges_resecodfech=cron_eges_fech
	cron_eges_resecodhora=cron_eges_hora
	var $item=0
	var fs = databaseManager.getFoundSet("asistencial","tbc_resecod")
	var largo_resecod = cron_eges_resecodnumcod.length
	if(largo_resecod > 0){
		for(var ii=0;ii<largo_resecod;ii++){
			$item++
			fs.find()
			fs['resecodesp']=cron_eges_resecodesp
			fs['resecodmed']=cron_eges_resecodmed
			fs['resecodfech']=cron_eges_resecodfech
			fs['resecodhora']=cron_eges_resecodhora
			fs['resecoditem']=$item
			fs.search()
			if(fs.getSize()<1){
				fs.newRecord()
				fs['resecodesp']=cron_eges_resecodesp
				fs['resecodmed']=cron_eges_resecodmed
				fs['resecodfech']=cron_eges_resecodfech
				fs['resecodhora']=cron_eges_resecodhora
				fs['resecoditem']=$item
				fs['resecodtipcod']=cron_eges_resecodtipcod[ii]
				fs['resecodnumcod']=cron_eges_resecodnumcod[ii]
				fs['resecodcantid']=cron_eges_resecodcantid[ii]
				fs['resecodl']=0
				fs['resecoddiag']=cron_eges_resecoddiag
				
				try{
					databaseManager.saveData(fs)
				}catch(msg){
					application.output(msg.message)
				}
				var error1=''
				var error2=''
				var i = 0
				var array = databaseManager.getFailedRecords(fs)
				for (i = 0; i < array.length; i++) {
					var record = array[i];
					var jstable = databaseManager.getTable(record);
					var tableSQLName = jstable.getSQLName();
					error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
					error2='Error en grabación '+record.exception;
					if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
						var thrown = record.exception.getValue()
						
					}
				}
				if(error1!=''){
					application.output(error1)
					application.output(error2)
					cron_retorno_msa=false
					cron_error_msa+=' - No se pudo grabar el registro en RESECOD' 
				}else{
					cron_retorno_msa=true
					cron_error_msa+=' ' 
				}
				cron_eges_graba_rendicion(ii)
				cron_eges_graba_turno_quirofano(ii)
			}else{
				cron_retorno_msa=true
				cron_error_msa+=' ' 
			}
		}
	}else{
		cron_retorno_msa=false
		cron_error_msa+=' - No se pudo grabar el registro en RESECOD'
	}
	return cron_retorno_msa
}


/**
 * Callback method for when solution is opened.
 *
 * @properties={typeid:24,uuid:"2634E321-61C5-40CA-B4EF-24E8867CC9E8"}
 */
function onSolutionOpen_cronTurnosEndoscopia() {
	plugins.scheduler.addCronJob('cron_endoscopia', '0 0/5 * * * ?', cronObtenerEndoscopiasEges)
}

/**
 * Callback method for when solution is closed, force boolean argument tells if this is a force (not stopable) close or not.
 *
 * @param {Boolean} force if false then solution close can be stopped by returning false
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"1F1EE962-4510-4E02-B561-6BF62B8CB7AC"}
 */
function onSolutionClose_cronTurnosEndoscopia(force) {
	plugins.scheduler.removeJob('cron_endoscopia')
	return true
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $insertar
 *
 * @properties={typeid:24,uuid:"F59F0A2D-5D62-43AA-8A95-8BB638F53AFB"}
 */
function graba_estadtur($insertar){
	var fs = databaseManager.getFoundSet("asistencial","tbc_estadtur")
	
	if($insertar){
		fs.newRecord()
	}
	fs.estadturfecha=cron_eges_fech
	fs.estadturfecha1=cron_eges_fech
	fs.estadturhora=cron_eges_hora
	fs.estadturhora1=cron_eges_hora
	fs.estadturmed=cron_eges_med
	fs.estadturesp=cron_eges_esp
	fs.estadturmednya=cron_eges_mednya
	fs.estadturobr=cron_eges_obra
	fs.estadturobrdes=cron_eges_obrades
	fs.estadturtipomed=cron_eges_tipomed
	fs.estadturtipotur="P"
	fs.estadturplan=cron_eges_obrpla
	fs.estadturconsulta=0
	fs.estadturentro=0
	fs.estadturaten=2
	fs.estadturtipserv=1
	fs.estadturservicio=6
	fs.estadturausente=0
	
	try{
		databaseManager.saveData(fs.getRecord(1));
		
	} catch(msg){
		globals.DIALOGS.showErrorDialog("Error en grabación", "\nSe ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
	}
	var error3 = ''
	var error4 = ''
	var array1 = databaseManager.getFailedRecords(fs)
	for (var j = 0; j < array1.length; j++) {
		var record1 = array1[j];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error4 = 'Error en grabación ' + record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown1 = record1.exception.getValue()

		}
	}

	if(error3!=''){
		//cron_retorno_msa=false
		application.output(error3)
		application.output(error4)
		cron_error_msa+=' - No se pudo grabar el registro en ESTADTUR' 
	}else{
		//cron_retorno_msa=true
		cron_error_msa+=' ' 
	}
}


/**
 * TODO generated, please specify type and doc for the params
 * @param indice
 *
 * @properties={typeid:24,uuid:"9BB8F249-EE5F-4182-9D3D-03F1B48E4877"}
 * @AllowToRunInFind
 */
function cron_eges_graba_rendicion(indice){
	var fs = databaseManager.getFoundSet("asistencial","tbc_rend_cab")
	var fs_obra = databaseManager.getFoundSet("maestros","tbc_obras")
	var fs_histcab = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	var fs_planobra = databaseManager.getFoundSet("maestros","tbc_plan_obra")
	var $fecha_actual = application.getServerTimeStamp()
	var $anio=0
	$anio=$fecha_actual.getFullYear()
	var $mes = 0
	var $mes_ed = ' '
	var $dia = 0
	var $dia_ed = ' '
	var $hora = 0
	var $min = 0
	var $hora_ed = ' '
	var $min_ed = ' '
	var $planX=' '
	var $condiva=0;
	$dia=$fecha_actual.getDate()
	$mes=$fecha_actual.getMonth()+1
	$hora=$fecha_actual.getHours()
	$min=$fecha_actual.getMinutes()
	if($mes<10){
		$mes_ed='0'+$mes
	}else{
		$mes_ed=$mes
	}
	if($dia<10){
		$dia_ed='0'+$dia
	}else{
		$dia_ed=$dia
	}
	if($hora<10){
		$hora_ed='0'+$hora
	}else{
		$hora_ed=$hora
	}
	if($min<10){
		$min_ed='0'+$min
	}else{
		$min_ed=$min
	}
	fs_obra.find()
	fs_obra['obr_codigo']=cron_eges_obra
	fs_obra.search()
	if(fs_obra.getSize()>0){
		cron_eges_obrades=fs_obra['obr_razonsoc']
		if(fs_obra['obr_cantcierres']==4){
			if($dia>=22){
				cron_eges_rend_cierre=4
			}else{
				if($dia>=15){
					cron_eges_rend_cierre=3
				}else{
					if($dia>=8){
						cron_eges_rend_cierre=2
					}else{
						if($dia>=1){
							cron_eges_rend_cierre=1
						}
					}
				}
			}
		}else{
			if(fs_obra['obr_cantcierres']==3){
				if($dia>=21){
					cron_eges_rend_cierre=3
				}else{
					if($dia>=11){
						cron_eges_rend_cierre=2
					}else{
						if($dia>=1){
							cron_eges_rend_cierre=1
						}
					}
				}
			}else{
				if(fs_obra['obr_cantcierres']==2){
					if($dia>=16){
						cron_eges_rend_cierre=2
					}else{
						if($dia>=1){
							cron_eges_rend_cierre=1
						}
					}
				}else{
					cron_eges_rend_cierre=1
				}
			}
		}
	}
	fs_histcab.find()
	fs_histcab['histcab_nrounico']=utils.stringToNumber(cron_eges_hiscli)
	fs_histcab.search()
	/*
	if(fs_histcab.getSize()>0){
		cron_eges_benef=fs_histcab['histcab_nrobenef']
	}else{
		cron_eges_benef=' '
	}
	*/
	fs_planobra.find()
	fs_planobra['plo_obra1']=cron_eges_obra
	fs_planobra['plo_planx10']=cron_eges_obrpla
	fs_planobra.search()
	if(fs_planobra.getSize()>0){
		if(fs_planobra['plo_planx']!=null){
			$planX=fs_planobra['plo_planx']
		}else{
			$planX=' '
		}
	}else{
		$planX=' '
	}
	cron_eges_rend_periodo=$anio+''+$mes_ed;
	if(cron_eges_condicioniva=='O'){
		$condiva=1
	}else{
		if(cron_eges_condicioniva=='V'){
			$condiva=3
		}else{
			$condiva=2
		}
	}
	fs.find()
	fs.rcadmision=2
	fs.rcempresa=1
	fs.rchclinica=utils.stringToNumber(cron_eges_hiscli)
	fs.rcperiodo=cron_eges_rend_periodo
	fs.rccierre=cron_eges_rend_cierre
	fs.search()
	if(fs.getSize()<1){
		fs.newRecord()
		fs.rcadmision1=2
		fs.rcadmision2=2
		fs.rcadmision3=2
		fs.rcadmision4=2
		fs.rcadmision=2
		fs.rcempresa1=1
		fs.rcempresa2=1
		fs.rcempresa3=1
		fs.rcempresa4=1
		fs.rcempresa5=1
		fs.rcempresa=1
		fs.rchclinica2=utils.stringToNumber(cron_eges_hiscli)
		fs.rchclinica3=utils.stringToNumber(cron_eges_hiscli)
		fs.rchclinica5=utils.stringToNumber(cron_eges_hiscli)
		fs.rchclinica=utils.stringToNumber(cron_eges_hiscli)
		fs.rccierre2=cron_eges_rend_cierre
		fs.rccierre3=cron_eges_rend_cierre
		fs.rccierre=cron_eges_rend_cierre
		fs.rcperiodo2=cron_eges_rend_periodo
		fs.rcperiodo6=cron_eges_rend_periodo
		fs.rcperiodo=cron_eges_rend_periodo
		fs.rcperiodo3=cron_eges_rend_periodo
		fs.rcestado5=0
		fs.rcestado=0
		fs.rcobra5=cron_eges_obra
		fs.rcobra=cron_eges_obra
		fs.rcfactura=0
		fs.rctipograb=2
		fs.rciva=$condiva
		fs.rcpaciente=fs_histcab['histcab_apellnom']
		fs.rcfecha = $anio+''+$mes_ed+''+$dia_ed;
		fs.rchora = $hora_ed+''+$min_ed;
		fs.rcimpobra = 0;
		fs.rcimppaciente1 = 0;
		fs.rcimppaciente2 = 0;
		fs.rcimpfiller = 0;
		fs.rcplan = $planX;
		fs.rcafiliado = cron_eges_benef;
		fs.rcfechaemision = $anio+''+$mes_ed+''+$dia_ed;
		fs.rchoraemision = $hora_ed+''+$min_ed;
		fs.rcatencion = 1;
		fs.libre=0;
		fs.rchcturnos=0;
		fs.rcperiodofact=0;
		fs.rcultfechapac=0;
		fs.rctipooperador=0;
		fs.rcoperador=0;
		fs.rcmarca=0;
		fs.rcletrafc=' ';
		fs.rcptovtafc=0;
		fs.rcquienfac=0;
		fs.rcsecuencia = globals.cron_eges_numeracion_txt(40)
		
		if(fs.rcsecuencia > 0){
			try{
				databaseManager.saveData(fs.getRecord(1));
				
			} catch(msg){
				application.output("error en grabacion rend-cab")
			}
			var error3 = ''
			var error4 = ''
			var array1 = databaseManager.getFailedRecords(fs)
			for (var j = 0; j < array1.length; j++) {
				var record1 = array1[j];
				var jstable1 = databaseManager.getTable(record1);
				var tableSQLName1 = jstable1.getSQLName();
				error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
				error4 = 'Error en grabación ' + record1.exception;
				if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
					// exception thrown in pre-insert/update/delete event method
					var thrown1 = record1.exception.getValue()

				}
			}
			if(error3!=''){
				//cron_retorno_msa=false
				application.output(error3)
				application.output(error4)
				cron_error_msa+=' - No se pudo grabar el registro en REND-CAB' 
			}else{
				//cron_retorno_msa=true
				cron_error_msa+=' ' 
			}
		}
	}
	cron_eges_rend_fech=$anio+''+$mes_ed+''+$dia_ed;
	cron_eges_rend_hora=$hora_ed+''+$min_ed;
	cron_eges_rend_codinom=cron_eges_resecodnumcod[indice];
	cron_eges_rend_tiponom=cron_eges_resecodtipcod[indice];
	try{
		insertaRegistroRendDet()
		
	}catch(msg){
		application.output("error al insertaRegistroRendDet()")
	}
	
}

/**
 * @properties={typeid:24,uuid:"640D754C-5DE8-4972-8905-F3F9672124B2"}
 * @AllowToRunInFind
 */
function insertaRegistroRendDet(){
	var fs = databaseManager.getFoundSet("asistencial","tbc_rend_det")
	var fs_nomencla = databaseManager.getFoundSet("maestros","tbc_nomencla")
	fs_nomencla.find()
	fs_nomencla['nome_tipo']=1
	fs_nomencla['nome_codigo']=cron_eges_rend_codinom;
	fs_nomencla.search()
	if(fs_nomencla.getSize()>0){
		cron_eges_rend_nome_panta=fs_nomencla['nome_pantalla']
	}else{
		cron_eges_rend_nome_panta=10
	}
	fs.find()
	fs.rdempresa = 1;
	fs.rdadmision = 2;
	fs.rdadmision1 = 2;
	fs.rdhclinica = utils.stringToNumber(cron_eges_hiscli);
	fs.rdperiodo = cron_eges_rend_periodo;
	fs.rdcierre = cron_eges_rend_cierre;
	fs.rdpantalla = cron_eges_rend_nome_panta;
	fs.rdfecha = cron_eges_rend_fech;
	fs.rdhora = cron_eges_rend_hora;
	fs.rdtipo = 1;
	fs.rdcodnom = cron_eges_rend_codinom;
	fs.rdmodalidad = 4;
	fs.search()
	if(fs.getSize()<1){
		fs.newRecord()
	}
		
	fs.rdempresa = 1;
	fs.rdadmision = 2;
	fs.rdadmision1 = 2;
	fs.rdhclinica = utils.stringToNumber(cron_eges_hiscli);
	fs.rdperiodo = cron_eges_rend_periodo;
	fs.rdcierre = cron_eges_rend_cierre;
	fs.rdpantalla = cron_eges_rend_nome_panta;
	fs.rdfecha = cron_eges_rend_fech;
	fs.rdhora = cron_eges_rend_hora;
	fs.rdtipo = 1;
	fs.rdcodnom = cron_eges_rend_codinom;
	fs.rdmodalidad = 4;
	fs.rdfechahasta = 0;
	fs.rdduracion = 0;
	fs.rddias = 10;
	fs.rdcantmod = 1;
	fs.rdespec=cron_eges_esp;
	fs.rdmed=cron_eges_med;
	fs.rdtipomed=cron_eges_tipomed
	fs.rdhon=0;
	fs.rdgto=0;
	fs.rdedcodigo=0;
	fs.rdnivelpami=0;
	fs.rdordencarga=0;
	fs.rdmarca=0;
	fs.rdopetipo=0;
	fs.rdopelega=0;
	fs.rdimpo=0;
	fs.rdunit=0;
	fs.rdpaso=0;
	
	
	try{
		databaseManager.saveData(fs.getRecord(1));
		
	} catch(msg){
		application.output("error en grabacion rend-det")
	}
	var error3 = ''
	var error4 = ''
	var array1 = databaseManager.getFailedRecords(fs)
	for (var j = 0; j < array1.length; j++) {
		var record1 = array1[j];
		var jstable1 = databaseManager.getTable(record1);
		var tableSQLName1 = jstable1.getSQLName();
		error3 = 'Error de Grabación en Tabla:' + tableSQLName1 + ' en server:' + jstable1.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error4 = 'Error en grabación ' + record1.exception;
		if (record1.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			// exception thrown in pre-insert/update/delete event method
			var thrown1 = record1.exception.getValue()

		}
	}

	if(error3!=''){
		//cron_retorno_msa=false
		application.output(error3)
		application.output(error4)
		cron_error_msa+=' - No se pudo grabar el registro en REND-DET' 
	}else{
		//cron_retorno_msa=true
		cron_error_msa+=' ' 
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $paramid
 *
 * @properties={typeid:24,uuid:"AB5346F6-D14D-40A5-85DC-C8C27F8A2096"}
 */
function cron_eges_numeracion_txt($paramid) {
	var nro_tomado = null;
	var done0 = plugins.rawSQL.executeSQL("desal", "tbl_parametros", "begin; lock table tbl_parametros in row exclusive mode;")
	if (!done0) {
		var msg0 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg0);
	}
	var done = plugins.rawSQL.executeSQL("desal", "tbl_parametros", "select * from tbl_parametros where paramid = " + $paramid + "for update;");
	if (!done) {
		var msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg);
	}

	var vQuery = " SELECT contador_entero FROM tbl_parametros WHERE paramid = " + $paramid;
	var vDataset = databaseManager.getDataSetByQuery("desal", vQuery, null, 1);
	
	var done1 = plugins.rawSQL.executeSQL("desal", "tbl_parametros", "update tbl_parametros set contador_entero = contador_entero + 1 where paramid = " + $paramid + "; commit;")
	if (done1) {
		
		nro_tomado = vDataset.getValue(1,1) + 1;
	}
	else{
		var msg1 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		application.output('SQL exception: ' + msg1)
	}
	return nro_tomado
}

/**
 * @AllowToRunInFind
 * 
 * TODO generated, please specify type and doc for the params
 * @param $obra
 * @param $plan
 *
 * @properties={typeid:24,uuid:"CB992747-A08B-4A00-968E-2C045F4AA7B0"}
 */
function obtenerPlan($obra, $plan){
	var $plan_retorno=" ";
	var $fs_planobra=databaseManager.getFoundSet("maestros","tbc_plan_obra")
	$fs_planobra.clear()
	$fs_planobra.find()
	$fs_planobra['plo_obra']=$obra
	$fs_planobra['plo_planx']=$plan
	$fs_planobra.search()
	if($fs_planobra.getSize()>0){
		$plan_retorno=$fs_planobra['plo_planx10']
	}
	return $plan_retorno;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param $indice
 *
 * @properties={typeid:24,uuid:"2503B9E9-7726-4E23-9E7A-FDB006C9E305"}
 * @AllowToRunInFind
 */
function cron_eges_graba_turno_quirofano($indice){
 var $fecha=0
 var $dhs=0
 var $hor=0
 var $min=0
 var $hhs=0
 var $anulado=true
 var $turno_libre=false
 $fecha=cron_eges_fech
 if(cron_eges_hora<100000){
	 $dhs=utils.stringToNumber(cron_eges_hora.toString().substr(0,1))
	 $min=$dhs
	 $hor=0
 }else{
	 if(cron_eges_hora<1000000){
		 $dhs=utils.stringToNumber(cron_eges_hora.toString().substr(0,2))
		 $min=$dhs
		 $hor=0
	 }else{
		 if(cron_eges_hora<10000000){
			 $dhs=utils.stringToNumber(cron_eges_hora.toString().substr(0,3))
			 $min=utils.stringToNumber(cron_eges_hora.toString().substr(1,2))
			 $hor=utils.stringToNumber(cron_eges_hora.toString().substr(0,1))
		 }else{ 
			 $dhs=utils.stringToNumber(cron_eges_hora.toString().substr(0,4))
			 $min=utils.stringToNumber(cron_eges_hora.toString().substr(2,2))
			 $hor=utils.stringToNumber(cron_eges_hora.toString().substr(0,2))
		 }
	 }
 }
 
 var fs_quirofa = databaseManager.getFoundSet("asistencial","tbc_quirofano")
 fs_quirofa.find()
 fs_quirofa['quirofanro']=11
 fs_quirofa['quirofafec']=$fecha
 fs_quirofa['quirofadhs']=$dhs
 fs_quirofa.search()
 if(fs_quirofa.getSize()>0){
	 for(var i = 1;i<=fs_quirofa.getSize()&&$anulado;i++){
	 	fs_quirofa.setSelectedIndex(i)
		if(fs_quirofa['quirofaest']==0){
			$anulado=false
		}
	 }
	 if($anulado){
		 insertar_turno_quirofano($indice,$fecha,$dhs)
	 }else{
		while (!$turno_libre){
			if($min>0){
				$min=0
				if($hor<23){
					$hor++
				}else{
					$hor=0
				}
			}else{
				$min=30
			}
			$dhs=utils.stringToNumber($hor+''+$min)
			fs_quirofa.clear()
			fs_quirofa.find()
			fs_quirofa['quirofanro']=11
			fs_quirofa['quirofafec']=$fecha
			fs_quirofa['quirofadhs']=$dhs
			fs_quirofa.search()
			if (fs_quirofa.getSize()<1){
				$turno_libre=true
			}
		}
		insertar_turno_quirofano($indice,$fecha,$dhs)
	 }
 }else{
	 insertar_turno_quirofano($indice,$fecha,$dhs)
 }
}


/**
 * TODO generated, please specify type and doc for the params
 * @param $indice
 * @param $fec
 * @param $hora
 *
 * @properties={typeid:24,uuid:"7ED12F91-451A-43CA-BD48-062000772E42"}
 * @AllowToRunInFind
 */
function insertar_turno_quirofano($indice,$fec,$hora){
	var fs_nomencla = databaseManager.getFoundSet("maestros","tbc_nomencla")
	var fs_histcab = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	var $intervencion=0;
	var $cirugia=' ';
	var $hhs=0
	$hhs=$hora
	var $min=0
	var $hor=0
	if($hhs<10){
		$min=utils.stringToNumber($hhs.toString().substr(0,1))
		$hor=0
	}else{
		if($hhs<100){
			$min=utils.stringToNumber($hhs.toString().substr(0,2))
			$hor=0
		}else{
			if($hhs<1000){
				$min=utils.stringToNumber($hhs.toString().substr(1,2))
				$hor=utils.stringToNumber($hhs.toString().substr(0,1))
			}else{
				$min=utils.stringToNumber($hhs.toString().substr(2,2))
				$hor=utils.stringToNumber($hhs.toString().substr(0,2))
			}
		}
	}
	if($min>0){
		$min=0
		if($hor<23){
			$hor++
		}else{
			$hor=0
		}
	}else{
		$min=30
	}
	$hhs=utils.stringToNumber($hor+''+$min)
	fs_nomencla.clear()
	fs_nomencla.find()
	fs_nomencla['nome_tipo']=1
	fs_nomencla['nome_codigo']=globals.cron_eges_resecodnumcod[$indice]
	fs_nomencla.search()
	if(fs_nomencla.getSize()>0){
		$cirugia=fs_nomencla['nome_descr']
		$cirugia=$cirugia.substr(0,50)
	}
	switch (scopes.globals.cron_eges_resecodnumcod[$indice]){
		case 200124:$intervencion=990;break;
		case 200120:$intervencion=108;break;
		case 900385:$intervencion=108;break;
		case 900386:$intervencion=990;break;
		case 900237:$intervencion=990;break;
		case 900236:$intervencion=108;break;
		case 900365:$intervencion=990;break;
		case 900173:$intervencion=180;break;
		default:$intervencion=108;break;
	}
	fs_histcab.clear()
	fs_histcab.find()
	fs_histcab['histcab_nrounico']=utils.stringToNumber(cron_eges_hiscli)
	fs_histcab.search()
	var fs_quirofa = databaseManager.getFoundSet("asistencial","tbc_quirofano")
	fs_quirofa.newRecord()
	fs_quirofa['quirofanro']=11
	fs_quirofa['quirofanro1']=11
	fs_quirofa['quirofafec']=$fec
	fs_quirofa['quirofafec1']=$fec
	fs_quirofa['quirofafec3']=$fec
	fs_quirofa['quirofafec4']=$fec
	fs_quirofa['quirofadhs']=$hora
	fs_quirofa['quirofadhs1']=$hora
	fs_quirofa['quirofadhs3']=$hora
	fs_quirofa['quirofadhs4']=$hora
	fs_quirofa['quirofahhs']=$hhs
	fs_quirofa['quirofahhs1']=$hhs
	fs_quirofa['quirofahhs3']=$hhs
	fs_quirofa['quirofahhs4']=$hhs
	fs_quirofa['quirofahiscli']=utils.stringToNumber(cron_eges_hiscli);
	fs_quirofa['quirofamed']=cron_eges_estadtur_med
	fs_quirofa['quirofatipmed']=cron_eges_tipomed
	fs_quirofa['quirofaadmi']=2
	fs_quirofa['quirofaapyno']=fs_histcab['histcab_apellnom']
	fs_quirofa['quirofatipo']=1
	fs_quirofa['quirofaciru']=$intervencion
	fs_quirofa['quirofacirudes']=$cirugia
	fs_quirofa['quirofaobra']=fs_histcab['histcab_obra']
	fs_quirofa['quirofatanestesia']=1
	fs_quirofa['quirofaafi']=fs_histcab['histcab_nrobenef']
	fs_quirofa['quirofatelpac']=fs_histcab['histcab_nrolinea_1']	           
	//fs_quirofa['quirofatelpac1']=fs_histcab['histcab_nrolineacel_1']
	//fs_quirofa['quirofamailpac']=fs_histcab['histcab_email']
	fs_quirofa['quirofalegoper']=0
	fs_quirofa['quirofatipoper']=0
    fs_quirofa['quirofafeccar']=globals.CapturaFechaSistema()
	fs_quirofa['quirofahorcar']=globals.CapturaHoraSistema("HHMM")
	fs_quirofa['quirofatipdoc']=fs_histcab['histcab_tipdoc']
	fs_quirofa['quirofanrodoc']=fs_histcab['histcab_nrodoc']
	fs_quirofa['quirofaorigen']=1
	fs_quirofa['quirofaest']=0
	fs_quirofa['quirofamot']=0
	fs_quirofa['quirofaobs']=' '
	fs_quirofa['quirofaleganest']=0
	fs_quirofa['quirofatipanest']=' '
	fs_quirofa['quirofaanes']=' '
	fs_quirofa['quirofainst']=' '
	fs_quirofa['quirofaprotesis']=0
	fs_quirofa['quirofaradiologia']=0
	fs_quirofa['quirofatorre']=0
	fs_quirofa['quirofahabi']=0
	fs_quirofa['quirofacama']=' '
	fs_quirofa['quirofatelmed']=0
	fs_quirofa['quirofadadreq']=0
	fs_quirofa['quirofadadpre']=0
	fs_quirofa['quirofafecmod']=0
	fs_quirofa['quirofahormod']=0
	fs_quirofa['quirofalegoperm']=0
	fs_quirofa['quirofatipoperm']=0
	fs_quirofa['quirofafecsus']=0
	fs_quirofa['quirofahorsus']=0
	fs_quirofa['quirofalegopers']=0
	fs_quirofa['quirofatipopers']=0
	fs_quirofa['quirofafecbaj']=0
	fs_quirofa['quirofahorbaj']=0
	fs_quirofa['quirofalegoperb']=0
	fs_quirofa['quirofatipoperb']=0
	fs_quirofa['quirofacdoc_10']=0
	fs_quirofa['quirofacdoc_9']=0
	fs_quirofa['quirofacdoc_8']=0
	fs_quirofa['quirofacdoc_7']=0
	fs_quirofa['quirofacdoc_6']=0
	fs_quirofa['quirofacdoc_5']=0
	fs_quirofa['quirofacdoc_4']=0
	fs_quirofa['quirofacdoc_3']=0
	fs_quirofa['quirofacdoc_2']=0
	fs_quirofa['quirofacdoc_1']=0
	fs_quirofa['quirofaadm1']=0
	fs_quirofa['quirofapronro']=0
	fs_quirofa['quirofaproqui']=0
	fs_quirofa['quirofaprofec']=0
	fs_quirofa['quirofadatosalta']=0
	fs_quirofa['quirofaobsmot']=' '
		
	try{
		databaseManager.saveData(fs_quirofa.getRecord(1))
	}catch(msg){
		application.output("Error grabacion QUIROFANO "+msg.message)
	}
	var error1=''
	var error2=''
	var i = 0
	var array = databaseManager.getFailedRecords(fs_quirofa)
	for (i = 0; i < array.length; i++) {
		var record = array[i];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
			var thrown = record.exception.getValue()
		}
	}
	if(error1!=''){
		application.output(error1)
		application.output(error2)
		//cron_retorno_msa=false
		cron_error_msa+=' - No se pudo grabar QUIROFANO' 
	}else{
		//cron_retorno_msa=true
		cron_error_msa+=' '
	}
	
}


/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"1E7F341F-2904-41C1-A155-914FA5C83006"}
 */
function actualiza_histcab(){
	var fs_histcab = databaseManager.getFoundSet("asistencial","tbc_hist_cab")
	fs_histcab.clear()
	fs_histcab.find()
	fs_histcab['histcab_nrounico']=utils.stringToNumber(cron_eges_hiscli)
	fs_histcab.search()
	if(fs_histcab.getSize()>0){
		fs_histcab['histcab_obra']=cron_eges_obra
		fs_histcab['histcab_planx']=cron_eges_obrpla
		fs_histcab['histcab_nrobenef']=cron_eges_benef
		try{
			databaseManager.saveData(fs_histcab.getRecord(1))
		}catch(msg){
			application.output("Error grabacion HIST-CAB "+msg.message)
		}
		var error1=''
		var error2=''
		var i = 0
		var array = databaseManager.getFailedRecords(fs_histcab)
		for (i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				record.exception.getStackTrace()
			}
		}
		if(error1!=''){
			application.output(error1)
			application.output(error2)
			//cron_retorno_msa=false
			cron_error_msa+=' - No se pudo regrabar la cobertura en HIST-CAB' 
		}else{
			//cron_retorno_msa=true
			cron_error_msa+=' '
			actualiza_histcab_obras()
		}
		
	}
}


/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"68FDE952-F76B-4953-8214-50D1FD74A22D"}
 */
function actualiza_histcab_obras(){
	var $sec=0
	var $largo=0
	var $encontrado=false
	var fs_histcab_obras = databaseManager.getFoundSet("asistencial","tbc_hist_cab_obras")
	fs_histcab_obras.clear()
	fs_histcab_obras.find()
	fs_histcab_obras['histcabobrasnrounico']=utils.stringToNumber(cron_eges_hiscli)
	fs_histcab_obras.search()
	if(fs_histcab_obras.getSize()>0){
		$largo=fs_histcab_obras.getSize()
		for(var i=1;i<=$largo&&!$encontrado;i++){
			fs_histcab_obras.setSelectedIndex(i)
			if(fs_histcab_obras['histcabobrasobra']==cron_eges_obra&&fs_histcab_obras['histcabobrasplanx']==cron_eges_obrpla&&fs_histcab_obras['histcabobrasnrobenef']==cron_eges_benef){
				$encontrado=true
			}
			$sec=fs_histcab_obras['histcabobrassec']
		}
	}
	if(!$encontrado){
		$sec++
		fs_histcab_obras.newRecord()
		fs_histcab_obras['histcabobrasnrounico']=utils.stringToNumber(cron_eges_hiscli)
		fs_histcab_obras['histcabobrassec']=$sec
		fs_histcab_obras['histcabobrasobra']=cron_eges_obra
		fs_histcab_obras['histcabobrasplanx']=cron_eges_obrpla
		fs_histcab_obras['histcabobrasnrobenef']=cron_eges_benef
		fs_histcab_obras['histcabobrasstado']=0
		fs_histcab_obras['histcabtipolegajo']=0
		fs_histcab_obras['histcablegajo']=0
		fs_histcab_obras['histcabfechacarga']=cron_eges_fech
		try{
			databaseManager.saveData(fs_histcab_obras.getRecord(1))
		}catch(msg){
			application.output("Error grabacion HIST-CAB-OBRAS "+msg.message)
		}
		var error1=''
		var error2=''
		var array = databaseManager.getFailedRecords(fs_histcab_obras)
		for (var j = 0; j < array.length; j++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla: ' + tableSQLName + ' en server: ' + jstable.getServerName() + ' falló la grabación. Avise a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
				record.exception.getScriptStackTrace()
			}
		}
		if(error1!=''){
			application.output(error1)
			application.output(error2)
			//cron_retorno_msa=false
			cron_error_msa+=' - No se pudo regrabar la cobertura en HIST-CAB-OBRAS' 
		}else{
			//cron_retorno_msa=true
			cron_error_msa+=' ' 
		}
	}
}