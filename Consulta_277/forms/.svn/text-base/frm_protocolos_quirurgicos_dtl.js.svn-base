/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8277274A-560C-4F84-A97D-8B1B7FFE30B2",variableType:4}
 */
var f_quirofano = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"02355869-E23B-487A-A708-A3B81BB7CC95"}
 */
var f_itvDesc = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2A6BA4A7-1BC4-438C-9A29-F272EBF1EB01"}
 */
var f_html = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6793DEA7-6076-4B3E-AEB1-D19183349CD0"}
 */
var f_instrumentista_cont = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AB7714DC-B095-4914-8949-F3A39042E3C9"}
 */
var f_especialista_cont = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"EB188275-EDAD-40EB-A303-D3AC0EFBB836"}
 */
var f_ayudante_3_cont = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"64449F40-DD05-4FB7-9985-4DC4E7D25B4F"}
 */
var f_ayudante_2_cont = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7354304E-AF5A-4D11-9383-22E2AE0CF20B"}
 */
var f_ayudante_1_cont = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BDBC4644-2957-46BA-84B7-9746597D382F"}
 */
var f_anestesista_cont = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"83451E1E-47AC-4267-9F83-1FC6D8A249A6",variableType:4}
 */
var indexTotal = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8A3C543D-398F-4F2E-BCA5-48FD580C6059",variableType:4}
 */
var indexActual = 0;

/**
 * @properties={typeid:35,uuid:"609EF037-5923-4E1B-A91B-D21052CCA523",variableType:-4}
 */
var dsIntervencion = databaseManager.createEmptyDataSet();

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"190E4DE3-22C7-4E0B-8ABE-C358C793F6CC"}
 */
var f_anestesista_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BBF7A829-9FE0-4AFC-A9F6-F399024DFE5C"}
 */
var f_instrumentista_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"EEFC3400-F397-46E9-BE93-9AD4F87BBB8C"}
 */
var f_ayudante_3_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6C149FB3-ACDF-4461-BE49-F8D1FD2F8BC3"}
 */
var f_ayudante_2_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C7D868A1-4C3B-4095-9422-A4761D1C0158"}
 */
var f_ayudante_1_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"46D55BC0-F4AF-492A-A3B5-B45A15A3F651"}
 */
var f_especialista_hon = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BC794C9D-03A6-4EEF-A670-81795C48E071"}
 */
var f_instrumentista = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"567E4CFE-330B-49B8-A86A-51C9FEE617C7"}
 */
var f_anestesista = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C37A52B8-79DD-4520-B520-67855BE3B384"}
 */
var f_ayudante_3 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CDFB0319-1ABA-48DD-8A83-118F30519E82"}
 */
var f_ayudante_2 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D80C2B85-84AE-4275-AC66-7BAA4CE1838A"}
 */
var f_ayudante_1 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"43BFD49D-6DB8-4454-B44F-66E9B2A62811"}
 */
var f_especialista = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A2951195-66D9-44E5-B483-27BCEACCD104"}
 */
var f_intervencion = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3E5D6036-624D-47A1-AF1D-1E32E29619EE"}
 */
var f_codigo = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"953F4731-0617-4508-9649-FCB402CEB883"}
 */
var historiaClinica = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A0727B72-72E2-4B85-863A-377E30F89E51"}
 */
var f_prueba = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AA7AC1C2-332A-4148-9715-5EEDB76ABC60"}
 */
var f_plan = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D6A66FB2-4EE3-407A-A632-0FBC6045ADA1"}
 */
var f_cobertura = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"FD4497A5-C055-423C-8362-69560E7B0C83"}
 */
var f_protocolo = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7E00E023-5043-46E6-BFF9-4EAC83C94D42"}
 */
var f_fechaCarga = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4D8EBF2E-E3A6-44DA-8ABA-0405E78659FC"}
 */
var f_paciente = '';

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"130C7888-FD2E-4F4C-B2FD-F01456D15B93"}
 */
function onShow_inicializarForm(firstShow, event) {
		
	limpiarIntervencionForm();
	for(var i=1;i<=9;i++){
		globals['proto'+i]='';
	}
	globals.tempHTML = '';
	
	var data = forms.lst_protocolos_quirurgicos.foundset.getSelectedRecord();
	historiaClinica = data.cirihistcl;	
	f_fechaCarga = String(data.cirifechacarga).substr(6,2) + '/' + String(data.cirifechacarga).substr(4,2) + '/' + String(data.cirifechacarga).substr(0,4); 
	f_paciente = data.nombre;
	f_protocolo = data.ciriprotocolo;
	f_cobertura = data.cobertura;
	f_plan = data.plan;
	f_itvDesc = data.itv_descripcion;
	f_quirofano = data.cirinroquirofa;
	
	globals.gbl_protocolo = f_protocolo;
	globals.gbl_historiaClinica = historiaClinica;
	globals.gbl_grupo = 1;
	mostrarEvaluacion();
	
	var sql2 = 'SELECT nom.Nome_Tipo, nom.Nome_Codigo, nom.Nome_Descr, prof.medperapeynom especialista,cir.CiriPorcen_1'
		+ ' ,ayu_2.MedPerApeynom ayu2,cir.CiriPorcen_2, ayu_3.MedPerApeynom ayu3,cir.CiriPorcen_3,ayu_4.MedPerApeynom ayu4,cir.CiriPorcen_4'
		+ ' ,ayu_5.MedPerApeynom ayu5,cir.CiriPorcen_5, ayu_7.per_apelnom ayu7,cir.CiriPorcen_7,prof.medpertipoie'
		+ ' ,ayu_2.medpertipoie,ayu_3.medpertipoie,ayu_4.medpertipoie,ayu_5.medpertipoie'
		+ ' FROM tbc_cirugint_dtl cir'
		+ ' left join maestros.tbc_nomencla nom on nom.Nome_Codigo = cir.CiriCodNome and nom.Nome_Tipo = cir.CiriTipoNome'
		+ ' left join maestros.tbc_medicos_personal prof on prof.medpercod = cir.CiriCodMed_1'
		+ ' left join maestros.tbc_medicos_personal ayu_2 on ayu_2.MedPerCod = cir.CiriCodMed_2'
		+ ' left join maestros.tbc_medicos_personal ayu_3 on ayu_3.MedPerCod = cir.CiriCodMed_3'
		+ ' left join maestros.tbc_medicos_personal ayu_4 on ayu_4.MedPerCod = cir.CiriCodMed_4'
		+ ' left join maestros.tbc_medicos_personal ayu_5 on ayu_5.MedPerCod = cir.CiriCodMed_5'
		+ ' left join validalegajo.tbc_personal_login ayu_7 on ayu_7.per_legajo = cir.CiriCodMed_7'
		+ ' WHERE CiriCodNome <> 0 and CiriTipoNome <> 0'
		+ ' AND CiriHistCl = ' + historiaClinica
		+ ' AND CiriProtocolo = ' + f_protocolo;
		
		dsIntervencion = databaseManager.getDataSetByQuery('asistencial',sql2,null,-1);
		indexTotal = dsIntervencion.getMaxRowIndex();
		
		loadIntervencion(1);
		elements.tabs.tabIndex = 1;
}

/**
 * @properties={typeid:24,uuid:"B2CBF03C-2077-4C09-9599-17882DAEC95E"}
 */
function loadIntervencion(fila) {
	
	if(dsIntervencion.getMaxRowIndex() > 0){		
		
		limpiarIntervencionForm();
		var code = dsIntervencion.getValue(fila,1);
		if(String(dsIntervencion.getValue(fila,1)).length < 10){
			code =  '0' + dsIntervencion.getValue(fila,1);
		}
		
		var codeNom = String(dsIntervencion.getValue(fila,2));
		if(codeNom.length == 5){
			code += ' 0' + codeNom.substr(0,1) + '.' + codeNom.substr(1,2) + '.' + codeNom.substr(3,2);
		}
		else{
			code += ' ' + codeNom.substr(0,2) + '.' + codeNom.substr(2,2) + '.' + codeNom.substr(4,2);
		}
		
		f_codigo = code;
		f_intervencion = dsIntervencion.getValue(fila,3);
		
		f_especialista = utils.stringTrim(dsIntervencion.getValue(fila,4));
		if(f_especialista != ''){
			f_especialista_hon = formatearHonorario(dsIntervencion.getValue(fila,5));
			f_especialista_cont = application.getValueListDisplayValue('vl_tipo_medico', dsIntervencion.getValue(fila,16));
		}
		
		f_ayudante_1 = utils.stringTrim(dsIntervencion.getValue(fila,6));
		if(f_ayudante_1 != ''){
			f_ayudante_1_hon = formatearHonorario(dsIntervencion.getValue(fila,7));
			f_ayudante_1_cont = application.getValueListDisplayValue('vl_tipo_medico', dsIntervencion.getValue(fila,17));
		}
		
		f_ayudante_2 = utils.stringTrim(dsIntervencion.getValue(fila,8));
		if(f_ayudante_2 != ''){
			f_ayudante_2_hon = formatearHonorario(dsIntervencion.getValue(fila,9));
			f_ayudante_2_cont = application.getValueListDisplayValue('vl_tipo_medico', dsIntervencion.getValue(fila,18));
		}
		
		f_ayudante_3 = utils.stringTrim(dsIntervencion.getValue(fila,10));
		if(f_ayudante_3 != ''){
			f_ayudante_3_hon = formatearHonorario(dsIntervencion.getValue(fila,11));
			f_ayudante_3_cont = application.getValueListDisplayValue('vl_tipo_medico', dsIntervencion.getValue(fila,19));
		}
		
		f_anestesista = utils.stringTrim(dsIntervencion.getValue(fila,12));
		if(f_anestesista != ''){
			f_anestesista_hon = formatearHonorario(dsIntervencion.getValue(fila,13));
			f_anestesista_cont = application.getValueListDisplayValue('vl_tipo_medico', dsIntervencion.getValue(fila,20));
		}
		
		f_instrumentista = utils.stringTrim(dsIntervencion.getValue(fila,14));
		if(f_instrumentista != '')
			f_instrumentista_hon = formatearHonorario(dsIntervencion.getValue(fila,15));
		
		indexActual = fila;
		elements.lbl_posicion.text = indexActual + ' de ' + indexTotal;		
	}
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"28907864-BE70-46FD-B748-F013C99A2F10"}
 */
function onAction_siguiente(event) {
	
	var indexNext = indexActual + 1;
	
	if( indexNext <= indexTotal ){
		loadIntervencion(indexNext);
	}
}

/**
 * @properties={typeid:24,uuid:"BD24B947-2451-4688-915F-6DD7F5160CD6"}
 */
function limpiarIntervencionForm() {
	
	f_anestesista = '';
	f_anestesista_hon = '';
	f_anestesista_cont = '';
	f_ayudante_1 = '';
	f_ayudante_1_hon = '';
	f_ayudante_1_cont = '';
	f_ayudante_2 = '';
	f_ayudante_2_hon = '';
	f_ayudante_2_cont = '';
	f_ayudante_3 = '';
	f_ayudante_3_hon = '';
	f_ayudante_3_cont = '';
	f_codigo = '';
	f_especialista = '';
	f_especialista_hon = '';
	f_especialista_cont = '';
	f_instrumentista = '';
	f_instrumentista_hon = '';
	f_instrumentista_cont = '';
	f_intervencion = '';	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"C10507E4-3C14-4A88-A5CC-8E3C14B17858"}
 */
function onAction_anterior(event) {
	
	var indexPrevious = indexActual - 1;
	
	if(indexPrevious > 0){
		loadIntervencion(indexPrevious);
	}
}

/**
 * @properties={typeid:24,uuid:"6C42C6A3-5DE9-4311-A72C-F8393CBA0E86"}
 */
function formatearHonorario(valor) {
	if(valor == 0.0)
		return valor ='';
	else
		return '%' + ' ' + valor;
}

/**
 * @properties={typeid:24,uuid:"588E4A96-6BEB-4675-81FB-F692811A181E"}
 */
function mostrarEvaluacion() {
		
	var names_campo = new Array();
	names_campo[0] = "anestxt_protocolo";
	names_campo[1] = "anestxt_grupo";
	names_campo[2] = "anestxt_nro1";
	names_campo[3] = "anestxt_secuen";
	names_campo[4] = "anestxt_linea";
	names_campo[5] = "anestxt_tope";
	names_campo[6] = "anestxt_filler";
	
	formatearEvaluacion(names_campo, 'tbc_aneste_txt_to_tbc_aneste_txt', 'gbl_evaluacionText')
}

/**
 * @properties={typeid:24,uuid:"8EA6333D-219F-4C34-8C8D-2E627AC65307"}
 */
function formatearEvaluacion(names, relacion, campo) {
	
	var name = new Array()
	name = names;
	var filas = foundset[relacion].getSize()
	globals[campo] = '';
	if (filas > 0)
	{
		foundset[relacion].sort('anestxt_protocolo asc, anestxt_grupo asc, anestxt_nro1 asc, anestxt_secuen asc')
		
		foundset[relacion].setSelectedIndex(1)
	    globals[campo] = foundset[relacion][name[4]];
		
		for (var j=2;j<filas+1;j++)
 		{
			foundset[relacion].setSelectedIndex(j)
			
			if (globals.txt_1 < 77200){
			    globals[campo] = globals[campo] + "\n" + foundset[relacion][name[4]];
			}
			else{
			    globals[campo] = globals[campo] + foundset[relacion][name[4]];
			    
			}    
		}
	}
	
}

/**
 * @properties={typeid:24,uuid:"C821A836-359B-4E89-80E9-1203DB6BB319"}
 */
function generarMedicamento() {
	
	var $sql = 'SELECT medcprotocolo,medctipo,medcarti,a.art_descrip,a.art_presenta,medccant'
	+ ' from tbc_medic_cir_filas'
	+ ' left join maestros.tbc_articulos a on a.art_codigo = medcarti'
	+ ' where MedcProtocolo = ' + f_protocolo
	+ ' and Medcarti > 0'
	+ ' order by MedcTipo';
	var $ds = databaseManager.getDataSetByQuery('asistencial',$sql,null,-1);

	var html = '';
	globals.tempHTML = '';
	
	html += '<html><body>'
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100% align=center>' + '<u>Medicamentos / Descartables de  Cirugía</u> <br><br>' +'</td>'
	html += '</tr>'
	html += '</table>'	
	
	globals.tempHTML = html;
	
	html=''
	var i;
	for(i = 1; i <= $ds.getMaxRowIndex(); i++){
		
		if($ds.getValue(i,2) == 1){
			grabar_tmp1($ds.getValue(i,3),$ds.getValue(i,4),$ds.getValue(i,5),$ds.getValue(i,6))
		}
		else
			break;
	}	
	
	html=''
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100% align=center>' + '<br> <u> Medicamentos / Descartables de Anestesia </u><br><br>' +'</td>'
	html += '</tr>'
	html += '</table>'	
	
	globals.tempHTML += html;
	
	html=''
	for(i = 1; i <= $ds.getMaxRowIndex(); i++){
		
		if($ds.getValue(i,2) == 2){
			grabar_tmp1($ds.getValue(i,3),$ds.getValue(i,4),$ds.getValue(i,5),$ds.getValue(i,6))
		}
	}
	
	globals.tempHTML += '</body></html>'
}

/**
 * @properties={typeid:24,uuid:"E781D5B9-B8C0-4D8D-9603-EF9FA65C42F7"}
 */
function grabar_tmp1(column0,column1,column2,column3) {
	var html = '';
	
	
	html += '<table width=100% cellpadding=0 cellspacing=0>'
	html += '<tr>'
	html += '<td width=10% valign="middle" align="right">' + column0 + '</td>'
	html += '<td width=5% valign="middle" align="right">     </td>'
	html += '<td width=35% valign="middle" align="left">' + column1 + '</td>'
	html += '<td width=30% valign="middle" align="left">' + column2 + '</td>'
	html += '<td width=10% valign="middle" align="right">' + column3 + '</td>'
	html += '<td width=10% valign="middle" align="right">     </td>'
	html += '</tr>'
	html += '</table>'
	
	globals.tempHTML += html
}

/**
 * Callback method when the user changes tab in a tab panel or divider position in split pane.
 *
 * @param {Number} previousIndex index of tab shown before the change
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"05D32009-076B-4B5F-A1A4-9A571BBCEA29"}
 */
function onTabChange_cargarDatos(previousIndex, event) {
		
	switch(elements.tabs.tabIndex){
		case 1: 		
			break;
		case 2:
		if(Number(f_protocolo) <= globals.gbl_parUltNumero_1){
			globals.vNroProtocolo = f_protocolo;
			globals.MuestroTextoProtocTxt(1,'proto1');
			globals.MuestroTextoProtocTxt(2,'proto2');
			globals.MuestroTextoProtocTxt(3,'proto3');		
		}
		else{
			globals.gbl_grupo=1
			globals.proto1=tbl_protoc_txt_to_tbl_protoc_txt.texto
			globals.gbl_grupo=2
			globals.proto2=tbl_protoc_txt_to_tbl_protoc_txt.texto
			globals.gbl_grupo=3
			globals.proto3=tbl_protoc_txt_to_tbl_protoc_txt.texto
		}
			break;
		case 3:
			if(Number(f_protocolo) <= globals.gbl_parUltNumero_1){
				globals.vNroProtocolo = f_protocolo;		
				globals.MuestroTextoProtocTxt(9,'proto9');
			}
			else{		
				globals.gbl_grupo=9
				globals.proto9=tbl_protoc_txt_to_tbl_protoc_txt.texto;
			}
			break;
		case 4:
			if(Number(f_protocolo) <= globals.gbl_parUltNumero_1){
				globals.vNroProtocolo = f_protocolo;
				globals.MuestroTextoProtocTxt(4,'proto4');
			}
			else{
				globals.gbl_grupo=4
				globals.proto4=tbl_protoc_txt_to_tbl_protoc_txt.texto;
			}
			break;
		case 5:
			if(Number(f_protocolo) <= globals.gbl_parUltNumero_1){
				globals.vNroProtocolo = f_protocolo;
				globals.MuestroTextoProtocTxt(5,'proto5');
			}
			else{
				globals.gbl_grupo=5
				globals.proto5=tbl_protoc_txt_to_tbl_protoc_txt.texto;
			}
		break;
		case 6:
			if(Number(f_protocolo) <= globals.gbl_parUltNumero_1){
				globals.vNroProtocolo = f_protocolo;
				globals.MuestroTextoProtocTxt(8,'proto8');
			}
			else{
				globals.gbl_grupo=8
				globals.proto8=tbl_protoc_txt_to_tbl_protoc_txt.texto;
			}
		break;
		case 7:
			if(globals.tempHTML == '' || globals.tempHTML == null){
				generarMedicamento();
			}
			
		break;
		case 8:
		break;
		default:		
			break;
	}
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"4B5F23A8-FAE9-4E70-B8C0-7E88DE59C5E2"}
 */
function onHide_protocoloDetalle(event) {
	if(globals.gbl_cerrarDetalleProtocolo){
		var $win = application.getWindow(application.getActiveWindow().getName());
		if($win != null){
			$win.hide();
			$win.destroy();
		}
	}
	return globals.gbl_cerrarDetalleProtocolo;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"613DB500-A938-42E4-8BBE-63222FC599B8"}
 */
function onAction_Cerrar(event) {
	globals.gbl_cerrarDetalleProtocolo = true;
	onHide_protocoloDetalle(event);
}
