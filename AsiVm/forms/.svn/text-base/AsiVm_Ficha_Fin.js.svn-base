/**
 * @properties={typeid:35,uuid:"6D3F2CF6-D75C-46E8-B766-1A8B2B043F06",variableType:-4}
 */
var $_wHayArm = false;


/**
 * @properties={typeid:35,uuid:"D46DA9DC-350D-4BFA-9DAB-5CA891965B94",variableType:-4}
 */
var habilitarFechaExtubacion = false;
/**
 * @properties={typeid:35,uuid:"84CD9FE1-AC69-4AEF-B275-69B62EE9E602",variableType:-4}
 */
var isValid = true;

/**
 * @properties={typeid:35,uuid:"F322F2A3-F29B-4DDC-AB25-2CCD2B8E8A00",variableType:-4}
 */
var f_aislado_paciente = false;

/**
 * @properties={typeid:35,uuid:"85975927-F4D8-48F1-975D-52DD3630596F",variableType:-4}
 */
var f_analgésicos = null;

/**
 * @properties={typeid:35,uuid:"AC01EBE2-24D0-4DC7-B86B-A063CDE3A013",variableType:-4}
 */
var f_mecanica = null;

/**
 * @properties={typeid:35,uuid:"28274BB2-8CED-43E0-B823-73D304F93B32",variableType:-4}
 */
var f_bloqueantes_neuromsuculares = null;

/**
 * @properties={typeid:35,uuid:"952B0BB7-2A71-43C9-A172-0F2B85DAAFD5",variableType:-4}
 */
var f_cam_icu = null;

/**
 * @properties={typeid:35,uuid:"6C9E1F6E-AA73-4243-BADE-0E6EA20EEF60",variableType:-4}
 */
var f_sedación = null;

/**
 * @properties={typeid:35,uuid:"5685671D-784C-4E03-8D86-D065E5E7A198",variableType:-4}
 */
var bloqueado = false;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"30CA0877-BB6E-4343-9D98-2216AED3AB95"}
 */
var messageError = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"5C2570BC-4CEE-44EE-8C99-2F1A0AFC7B3D",variableType:4}
 */
var f_arm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"97304BB5-BAA2-4065-99DE-D5F6A77CBD7C",variableType:4}
 */
var AsiVm_Ficha_Fin_grupoTxt = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"BA3FEB33-9307-4F4E-8750-08C0BEDA5DFD",variableType:4}
 */
var AsiVm_Ficha_Fin_lineaTxt = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9D236852-9377-49BC-9DB8-8FA1531F49A9",variableType:4}
 */
var AsiVm_Ficha_Fin_horaTxt = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"875AE4F5-0351-4194-82DB-173AB70E8BC9"}
 */
var f_derivado = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"30799B63-AF1F-4390-9D12-DDC5164BAE41"}
 */
var f_ingresoUco = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"55D6D009-D1C3-4681-9054-2AE5CDE6714E"}
 */
var f_ingresoSanatorio = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"16E982CD-2A46-4283-A50D-782A7C85E2DB"}
 */
var $_msgSMS = '';

/**
 * @properties={typeid:35,uuid:"C6B882F8-8B9C-480C-A58C-013DE55A0BFB",variableType:-4}
 */
var $_listNumberSMS = new Array();

/**
 * @properties={typeid:35,uuid:"2ACB772F-2267-4EDF-B572-8514F423C8C9",variableType:-4}
 */
var $_wtrau = false;

/**
 * @properties={typeid:35,uuid:"9704E356-787E-443F-AF3F-7DD953A060BF",variableType:-4}
 */
var $_wsele = false;

/**
 * @properties={typeid:35,uuid:"BEE00C96-2EDC-4C9A-964D-BCB6A3F2A364",variableType:-4}
 */
var $_isUserOSTEE = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D7FB497C-2480-41A9-AB89-6CFD77BF26E4",variableType:4}
 */
var $_countChange = 1;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9466445E-698A-46BE-882A-B1366B95624D"}
 */
var f_habita = null;


/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A8D8B191-EF99-47A7-A333-14A743CC73E6",variableType:4}
 */
var f_lugar_internacion = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2BA4FF6C-49DE-4913-8077-25B259FAEA4A"}
 */
var f_cama = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A5CB2C77-805E-4A51-824B-D4D0BED863FD",variableType:4}
 */
var f_sexo = null;

/**
 * @properties={typeid:35,uuid:"1D094897-7E69-444E-A6E5-4A90521F0A68",variableType:-4}
 */
var f_soporte_ventilatorio = null;

/**
 * @properties={typeid:35,uuid:"604D3F1F-9056-4BF5-BE18-C7A95B521E1D",variableType:-4}
 */
var f_modo_ventilatorio = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"3E2E535E-5BDF-4276-B295-26FF0B6BD446",variableType:4}
 */

var f_ingreso_uci = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"68068273-745F-49B7-8F3A-2A923D51E6C2",variableType:4}
 */

var f_inicio_vm = 0;

/**
 * @properties={typeid:35,uuid:"57066D05-3160-49DC-A3BE-F11C1BA07725",variableType:-4}
 */
var f_motivo = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9F3C557D-83F7-4ABB-8BCB-700F864A3C63",variableType:4}
 */
var f_pulso_frecuencia = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4145C4D9-1A1A-4528-8BA8-E4F23AB6E931",variableType:4}
 */
var f_tension_arterial_min = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"41CB043A-7BFF-441E-B1E0-1A049A681653",variableType:4}
 */
var f_tension_arterial_max = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"70E717E4-FE22-45CE-B020-F4CABE649B7C",variableType:4}
 */
var f_frecuencia_cardiaca = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7D505881-6AB7-49C5-A45D-06E5CF65D3E2",variableType:4}
 */
var f_rass = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DE169AEB-3012-4FD3-906F-2FB6159630A4",variableType:4}
 */
var f_frecuencia_respiratoria = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C9EE0577-F41D-488B-8BA7-094DAB8ACE9B",variableType:4}
 */
var f_cpot = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F0E1C3B1-3984-4641-9ABD-AA620D8B1AC0",variableType:4}
 */
var f_temperatura = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"ABA7FC7F-CBEC-4343-8CDF-00443AA63352"}
 */
var f_tipo_temperatura = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3DE3E210-1657-43F9-A06B-3FB3E8EEF13A"}
 */
var f_tipo_sonda = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"11C59018-871B-43B7-B897-B41B551D965C"}
 */
var f_patologia1 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8D956E83-B07C-44A1-9E23-56AF02C5F274"}
 */
var f_patologia2 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"360D923A-838F-4D0C-8249-1A5BEF13DF1B"}
 */
var f_patologia3 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"68FDF3DF-1DB3-46B8-862F-470352429AF1"}
 */
var f_patologia = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"449A524C-E866-448C-831A-50665E199A65"}
 */
var f_descripcion_patologia1 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D3D03998-0FB7-4E46-A6DD-E3024DEF3D7D"}
 */
var f_descripcion_patologia2 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"880355D2-DC54-44D7-B99E-BCA14787BA0E"}
 */
var f_descripcion_patologia3 = '';

/**
 * @properties={typeid:35,uuid:"49321334-D8DD-4C17-B20B-40C0CB5C1ADE",variableType:-4}
 */
var f_cerrarForm = false;

/**
 * @properties={typeid:35,uuid:"2E757AFE-6C55-478D-AE3D-41A21CB11269",variableType:-4}
 */
var $isDirty = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6BA2AF4D-71D3-4597-88B6-4CF97D59BFC6",variableType:4}
 */
var f_protocolo = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"AA6B8E56-BC4E-4607-9EB4-2355E70A6F25"}
 */
var $messageErrorInter = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9FBB3501-3BAB-454B-AC08-DCAD8F6A67D1"}
 */
var f_medico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"408CC08C-7BC5-415A-9DC9-32BD087793E0"}
 */
var f_edad = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B7A55457-431E-4179-A1C7-5A7185F8DE36"}
 */
var f_cobertura = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F626B907-82DC-42B6-BE4F-5EDA73D0521E"}
 */
var f_histClinUnica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D9A8E070-7258-48DB-8A64-F1BD71A8AE1A"}
 */
var f_paciente = null;

/**
 * @properties={typeid:35,uuid:"E71F46BC-72E8-4611-8EBE-9CC3AB7F41BF",variableType:-4}
 */
var $_AsiVm_Ficha_Fin_READ_ONLY = false;

/**
 * @properties={typeid:35,uuid:"BCCF0E44-033B-4D7B-948C-661476986B99",variableType:-4}
 */
var $_AsiVm_Ficha_Fin_Recurso_Tomado = false;


/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A20706C2-EBF5-4A71-ACA7-EB8295B5E143",variableType:4}
 */
var f_liberado_venti_mecanica=0

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"D0BE57FC-0FDA-49FD-B741-0AB284C6EA8F",variableType:93}
 */
var f_fecha_extub_no_programada = null



/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8B701E16-183B-40BB-8615-CD1E0A61E0E4",variableType:4}
 */
var f_reintubado = 0

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0B3888AE-58AC-4ED0-ABAF-AA47C128A2E6"}
 */
var f_causa_reintubacion = ''
	
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D104C0C8-70D4-4859-B17B-88FCE28BC739",variableType:4}
 */
var f_pao2_fio2 = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"80697165-580B-44EA-83DB-4B5B17A96201",variableType:4}
 */
var f_neumotorax = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7C9109F8-C702-40CB-9B32-3789C70BD0D8",variableType:4}
 */
var f_shock = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B4236A7C-E74E-413A-A240-EFBBB109E8A1",variableType:4}
 */
var f_delirium = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"10651983-A3CA-4DB9-A50E-6A683F7CB3A9",variableType:4}
 */
var f_dauci = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"61315111-A174-4690-8CC5-BAB66E614E7B",variableType:4}
 */
var f_dialisis = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"72010A85-5E9B-473B-870D-9978F4AE1D35",variableType:4}
 */
var f_pafiMenor200 = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"061AFEF9-6B61-4B0A-9DA9-E31B582D1F0D",variableType:4}
 */
var f_iam = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"BFA21709-6939-4B04-8E04-0177FB70F561",variableType:4}
 */
var f_tep = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0012FBC4-F44B-4406-8C54-B09151EDF0FA",variableType:4}
 */
var f_navm  =0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7B9BC5A2-0131-4513-84C6-8A38C4C48EE9",variableType:4}
 */
var f_pcr = 0

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"DA1CC1F4-23A9-4A79-8EB3-FB6A94A7013C",variableType:93}
 */
var f_fecha_tqt = null

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8078BA58-B15A-4F47-A22D-EA59AD06D7EE",variableType:4}
 */
var f_intubado = 0


/**
 * @properties={typeid:35,uuid:"52C229EC-0027-4A00-9039-1DE0688EC836",variableType:-4}
 */
var f_fecha_paliativos = null
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7FDF6FD5-50FE-4804-AD64-B7A1CE0C7830"}
 */
var f_causa_fracaso_caf = ''

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B8559C35-3E15-4068-982D-F15AF828B9A0"}
 */
var f_complicaciones_caf = ''
	
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5CD59639-88C5-469D-A7AA-7BAF40930483"}
 */
var f_complicaciones_vni = ''

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0DBC09D0-313D-4527-A516-EE5841FDB245",variableType:4}
 */
var f_exito = 0


/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"54C1F6B6-A2C7-4AB4-90AF-6A7AC24F310A"}
 */
var f_vm_vni = ''
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8D487B10-2369-48D8-A20F-0B696829867D",variableType:4}
 */
var f_exito_vni = 0
/**
 * @properties={typeid:35,uuid:"D93F5D5B-E444-4E59-AA56-E95FFAE053ED",variableType:-4}
 */
var f_fecha_fin_vni = null
/**
 * @properties={typeid:35,uuid:"1D8FCE52-C2B5-415D-A0DD-60BF298B38D9",variableType:-4}
 */
var f_fecha_fin_vm = null
/**
 * @properties={typeid:35,uuid:"508055DF-2207-4E61-AEA4-0AB54547B5DE",variableType:-4}
 */
var f_fecha_fin_caf = null


/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E61D513B-874E-4C10-89E1-272F8151BFBA",variableType:4}
 */
var f_egreso_vivo_uci = 0
/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"4A3CC225-0BF3-4956-A670-7C78887A0B02",variableType:93}
 */
var f_fecha_egreso_uci = null
/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"659E4B98-172B-4373-8691-ED55D7D0DEDE",variableType:93}
 */
var f_fecha_egreso_sanatorio = null

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1912A84E-B4FF-443E-98F5-DBFC5A617FDD"}
 */
var f_derivacion = ''

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7DAEE7B7-67AB-4552-91DB-8464EBFB4BBC",variableType:4}
 */
var f_tqt = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"39A2D17F-F517-4B96-B7CF-A5F44A8855E8",variableType:4}
 */
var f_decanulacion = 0

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3AACEEDD-E87F-4A02-A8B4-426C06A777FA"}
 */
var f_causa_fracaso_vni = ''
	
	

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"FAF64EB1-9483-4B59-B4CB-87C2D31EA19F",variableType:93}
 */
var f_fecha_decanulacion = null 
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"42B84752-7184-4FEC-B6BF-EBF1222687A1",variableType:4}
 */
var f_sdra = 0
	
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2108A7F5-6F1B-4A88-AA72-C48A71FE417A",variableType:4}
 */
var f_paliativo = 0
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46C9E820-3389-4001-B0FC-B24601B99074",variableType:4}
 */
var f_extub_accidental = 0
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B8A70452-4762-492B-8C18-84CF633D6BDD",variableType:4}
 */
var f_auto_extub = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CB00D332-DA8F-4E1C-9D2C-BFDB458185FA",variableType:4}
 */
var f_ext_no_programada=0


/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"02CB219E-C3CE-44D9-A9ED-FB3332934C5C",variableType:93}
 */
var f_fecha_fin = null

/**
 * @properties={typeid:35,uuid:"8E0CB613-07D1-4D47-81CB-B83A735FFAD6",variableType:-4}
 */
var f_fecha_fin_ventilacion = null

/**
 * TODO generated, please specify type and doc for the params
 * @param firstShow
 * @param event
 *
 * @properties={typeid:24,uuid:"109964B1-6491-4B85-9C16-A06F350AB2D5"}
 */
function onShow_inicializarForm(firstShow, event) {

	//initFormFirstShow();
	elements.txt_paciente.requestFocus(); 
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"9D0B62EC-953A-4715-9756-A2E059E9A8A2"}
 */
function onAction_btnBuscarPaciente(event) {

	globals.AsiVm_Ficha_Fin_eventSourceButton = 1;
	openSearch();
}

/**
 * @properties={typeid:24,uuid:"302623BB-C4C4-4F92-BD24-B1AED3E41DB2"}
 */
function limpiarForm() {

	databaseManager.revertEditedRecords();

	inicializarForm();

	elements.txt_paciente.requestFocus();
	//elements.txt_paciente.requestFocus();
	$isDirty = false;

}

/**
 * @properties={typeid:24,uuid:"B0B448C0-4A01-4645-A0F3-BC8BB5F62FF4"}
 */
function inicializarForm() {

		f_liberado_venti_mecanica = 0
		 f_fecha_fin_vm = null
		//EXTUBACION
		f_ext_no_programada = 0
		f_auto_extub = 0
		f_extub_accidental = 0
		f_fecha_extub_no_programada = null
		f_reintubado = 0
		f_causa_reintubacion = ''
			
		f_vm_vni=0
		//TQT
		f_tqt  = 0
		f_fecha_tqt = null
		f_decanulacion = 0
		f_fecha_decanulacion = null
		
		//COMPLICAIONES VM
		f_sdra = 0
		f_pao2_fio2 = 0
		f_neumotorax = 0
		f_shock =0
		
		f_delirium = 0
		f_dauci = 0
		f_dialisis = 0
		f_pafiMenor200 = 0
		f_iam = 0
		f_tep = 0
		f_navm = 0
		f_pcr = 0
		
		f_fecha_fin_vni = null
		f_intubado =0
		f_exito = 0
		f_causa_fracaso_vni= ''
		f_complicaciones_vni =''
		f_fecha_fin_caf = null
		f_intubado = 0
		f_exito = 0
		f_causa_fracaso_caf= ''
		f_complicaciones_caf = ''
		
	//CAMPOS COMUNES
	f_paliativo=0
	f_fecha_paliativos=null
	
	//datos finales
	f_egreso_vivo_uci=0
	f_fecha_egreso_sanatorio=null
	f_fecha_egreso_uci=null
	f_derivacion=""
	f_cerrarForm=false
//	
//	elements.lbl_procesando.visible = false;
//	application.updateUI();
//	
//	visibleBody(false);
//	editablePaciente(true);
}


/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"35C6C70F-E7FF-4221-8BC9-F4F5866D4AD1"}
 * @AllowToRunInFind
 */
function onAction_btnGuardar(event) {
	elements.txt_edad.requestFocus()
	if(globals.errorDato){//ultimo onchange valido
		var res = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿ Esta seguro que desea cerrar ciclo de Soporte Ventilatorio ?', 'Si', 'No');
		if (res == 'Si') {
	
			if ($isDirty) {
	
				if (isValidDataForm()) {
	
					if (isValidData()) {
						
					if(asivm_rel_buscar_admision.getSize()>0){	
						if (asivm_fichakine_cierre.fecha_fin == null) { //  ficha nueva miro fecha o si es mayor a uno
							asivm_fichakine_cierre.newRecord();
							scopes.globals.InicializarDatosDeRelacion(asivm_fichakine_cierre, "desal", "tbl_ficha_cierre_kine")
	//						fecha = utils.stringToNumber(globals.CapturaFechaSistema());
	//						hora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
							var $_fechaHoraRegistro= application.getServerTimeStamp()
							// Completando cabecera
							//globals.AsiVm_hisclin = asivm_rel_buscar_admision.adm_histclin;
							asivm_fichakine_cierre.histcli = scopes.globals.AsiVm_adm_HistClin
							asivm_fichakine_cierre.histcli_unico = asivm_rel_buscar_admision.adm_histclinuni
							asivm_fichakine_cierre.fecha_fin=$_fechaHoraRegistro
							asivm_fichakine_cierre.fecha_fin_ventilacion=null
							asivm_fichakine_cierre.vm_extub_fecha=null
							asivm_fichakine_cierre.vm_extub_no_programada=null
//							asivm_fichakine.ficha_id = asivm_fichakine.
						}
	//					var fecha = 0;
	//					var hora = 0;
	//					var nuevoHciint = false;
						
						// Actualizando base de datos
						try {
							guardarDatos();
							databaseManager.startTransaction();
							var resultSave = databaseManager.saveData(asivm_fichakine_cierre.getRecord(1));
						} catch (e) {
							plugins.dialogs.showInfoDialog("Error al procesar los datos cargados. Avise a Sistemas, por favor!",e.toString(),"ok")
							// TODO: handle exception
							//plugins.Log.error("ERROR PERSISTENCIA - ", e.message);
						}
						
						if (resultSave == true) {
							databaseManager.commitTransaction();
							globals.DIALOGS.showInfoDialog("Resultado", "La Ficha de finalización se guardo correctamente.", "Aceptar");
							var print = globals.DIALOGS.showQuestionDialog('¡Atención!', ' ¿Quiere imprimir está información?', 'Si', 'No');
							if(print=='Si'){
								forms.AsiVm_Template_print.imprimirVm(asivm_fichakine_cierre.histcli,asivm_fichakine_cierre.fecha_fin,4);
							}
							
							
							$isDirty = false;
							
						} else {
							var error1 = ''
							var error2 = ''
							var array = databaseManager.getFailedRecords()
							for (var i = 0; i < array.length; i++) {
								var record = array[i];
								var jstable = databaseManager.getTable(record);
								var tableSQLName = jstable.getSQLName();
								error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
								error2 = 'Error en grabación ' + record.exception;
								if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
									// exception thrown in pre-insert/update/delete event method
									var thrown = record.exception.getMessage()
									//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
								}
							}
	
							databaseManager.rollbackTransaction()
	
							if (error1 != '') {
								globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
								globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error1, "Aceptar")
								globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error2, "Aceptar")
							}
							globals.DIALOGS.showErrorDialog("Error en grabación", "Se ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
						elements.btn_confimar_cierre.enabled=true
						}
					}else{
						globals.DIALOGS.showWarningDialog("Atención!", "Los datos no se guardaron.", "Aceptar")
					}
					}
				}
			} else {
				globals.DIALOGS.showWarningDialog("Atención!", "No hay datos para guardar.", "Aceptar")
				elements.txt_paciente.requestFocus();
			}
		} else
			elements.txt_paciente.requestFocus();
	}
}


/**
 * @properties={typeid:24,uuid:"C0AC6032-7B0F-4241-B79A-58EB740DC9BA"}
 */
function isValidDataForm() {
	globals.isValid= true;
	globals.messageError = "No ha sido posible guardar el Cierre Definitivo de la ficha. Corrija los siguientes errores y vuelva a intentar."		//var borderError = 'LineBorder,1,#ff0000';
	
	//  INICIO VALIDADOR MASIVO GENERICO 
		globals.validateRequired("AsiVm_Ficha_Fin",true,'multi_',false,0)
		globals.validateRequired("AsiVm_Ficha_Fin",true,'txt_',false,0)
		globals.validateRequired("AsiVm_Ficha_Fin",true,'cbo_',false,0)
	/*if(globals.Asivm_prestacion==1){
		
		
	}else if(globals.Asivm_prestacion==2){
		
	} else if(globals.Asivm_prestacion==3){
		
	}*/

	// fin val arm 
	if (!globals.isValid) {
		globals.DIALOGS.showWarningDialog("¡Atención!", globals.messageError, "Aceptar")
	}
	
	return globals.isValid;
}

/**
 * @properties={typeid:24,uuid:"2F47983A-7B01-4E45-939C-1D5BD0A829D5"}
 */
function isValidData() {

	 isValid = true;
	//var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
		//var borderError = 'LineBorder,1,#ff0000';
		//setDefaultBorderElements();
		/*
	 if(isValid){

	 if(f_protocolo == null){

	 var res = globals.DIALOGS.showQuestionDialog('¡Atención!','¿ Desea Guardar Ingreso de Historia Clinica de Cirugia sin Protocolo ?', 'Si', 'No');
	 if( res == 'Si'){
	 }
	 else{

	 messageError += "\nHistoria Clinica de Cirugia sin Protocolo."
	 isValid = false;
	 }
	 }
	 }
	 else{
	 globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
	 elements.txt_paciente.requestFocus();
	 }
	 */
	return isValid;

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"B3751211-6FAD-402B-8B13-1ACA79DA1652"}
 */
function onAction_btnCerrar(event) {

	if ($isDirty) {
		if (globals.DIALOGS.showQuestionDialog('¡Atención!', 'Existen datos que no han sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			f_cerrarForm = true;
	} else {
		f_cerrarForm = true;
	}

	if (f_cerrarForm) {
		
		cerrarForm();
	}
}

/**
 * @properties={typeid:24,uuid:"473795D6-97B8-4D22-A016-4EF351932012"}
 */
function cerrarForm(){
	
	f_cerrarForm = true;
	/*if(asiucotrs_hoja_rel_buscar_admision.getSize() > 0){
		if(globals.AsiVm_Ficha_Fin_bloqueado){
			globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),asiucotrs_hoja_rel_buscar_admision.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Historia Clinica");
		}
	}*/
	var $win = application.getWindow(application.getActiveWindow().getName());
	if ($win != null) {
		$win.hide();
		$win.destroy();
	}
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"D82A278C-E215-40D8-8DC2-AB7C91B9E082"}
 */
function onHide_cerrarForm(event) {
	
	if(!f_cerrarForm)
		globals.DIALOGS.showInfoDialog("Atención","Para cerrar el programa debe presionar el boton Salir.","Aceptar")
	return f_cerrarForm;
}


/**
 * TODO generated, please specify type and doc for the params
 * @param {Date} Fecha_Desde
 * @param {Date} Fecha_Hasta
 *
 * @properties={typeid:24,uuid:"82467DFA-38CB-4CF4-BEE0-D77F8CF7B6E5"}
 */
function contar_dias(Fecha_Desde, Fecha_Hasta) {
	// El hasta dede ser mayor al desde
	var $contar = 0;

	var $x = Fecha_Hasta - Fecha_Desde//diferencias entre dos dias y lo muestra en milisegundos
	var $un_dia = 1000 * 60 * 60 * 24 //ms * sec * min * hrs de un día
	var $dif_dias = $x / $un_dia //calcula la diferencia en días
		//$contar = Math.ceil($dif_dias )   //redondea
	//$contar = Math.round($dif_dias)
	$contar = Math.floor($dif_dias) //redondea

	return $contar
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} realValue
 *
 * @properties={typeid:24,uuid:"3C103EB4-D597-47B7-8CC2-BB31362C8D82"}
 */
function convertNumberToHour_HHMM(realValue) {

	var hora = "";
	if (realValue != null) {
		var value = realValue;
		if (value < 1) {
			hora = "00:00";
		} else {
			if (value < 10) {
				hora = "00:0" + value.toString().substr(0, 1);
			} else {
				if (value < 100) {
					hora = "00:" + value.toString().substr(0, 2);
				} else {
					if (value < 1000) {
						hora = "0" + value.toString().substr(0, 1) + ":" + value.toString().substr(1, 2);
					} else {
						if (value <= 2359) {
							hora = value.toString().substr(0, 2) + ":" + value.toString().substr(2, 2);
						}
					}
				}
			}
		}
	}

	return hora;
}

/**
 * 
 * @param {Number} histClin
 * @param {Number} fecha
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"38532A59-FAC0-49AE-9F37-55CCBCF754B3"}
 */
function imprimir(histClin, fecha, hora) {
	
	var texto = '';
	if(asiucotrs_rel_tbc_hojauco_to_tbc_hojauco.hucimpresa == 0)
		texto =  '¿Imprime Hoja de Evolucion Medica UCO?' 
	else
		texto = '¿Desea reimprimir Hoja de Evolucion Medica UCO?';
	
	var print = globals.DIALOGS.showQuestionDialog('¡Atención!', texto, 'Si', 'No');
	if (print == 'Si') {
		
		// 0 : imprime hoja 1 : genera PDF 
//		var absoluteFileName = globals.AsiUcoMod_Rep_imprimir(histClin,fecha,hora,0,false);
		var absoluteFileName = globals.AsiUcoMod_Rep_imprimirHoja(histClin,fecha,hora,0,false);
		
		
		/*if(asiucotrs_rel_tbc_hojauco_to_tbc_hojauco.hucimpresa == 0){
			
			asiucotrs_rel_tbc_hojauco_to_tbc_hojauco.hucimpresa = 1;
			databaseManager.saveData(asiucotrs_rel_tbc_hojauco_to_tbc_hojauco.getRecord(1));
		}*/
	}
	
	//forms.Hcipiso_print.controller.setPageFormat(210,297,10,10,10,10,1,0);
	//forms.Hcipiso_print.controller.print(false,false);
	/*
	 var win = application.createWindow("impri_paciente",JSWindow.MODAL_DIALOG);
	 win.title = "Impresion de Hitória Clínica";
	 win.resizable = false;
	 win.show(forms.Hcipiso_print)
	 */
}


/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"977B8B9A-B537-4F38-8CFB-A8AF3A4544D7"}
 */
function onLoad_inicializarForm(event) {
	
	initFormFirstShow();
	
}

/**
 * @properties={typeid:24,uuid:"82330BA8-42E0-4707-A3BE-175053930548"}
 */
function initFormFirstShow(){
	
	inicializarForm()
	f_medico = utils.stringTrim(globals.Srv_Login_Sanatorio_vOperador);
	
}

/**
 * 
 * @param {Number} value
 *
 * @properties={typeid:24,uuid:"B19B6342-53E7-455B-942C-DC8229FCB55D"}
 */
function formatear_HistClinInter(value)
{
	var hiscli1 = value.toString();
	switch (hiscli1.length){
		case 2:	hiscli1 = hiscli1.substr(0,1)+'/'+hiscli1.substr(1,1);break;
		case 3:	hiscli1 = hiscli1.substr(0,2)+'/'+hiscli1.substr(2,1);break;
		case 4:	hiscli1 = hiscli1.substr(0,3)+'/'+hiscli1.substr(3,1);break;
		case 5:	hiscli1 = hiscli1.substr(0,4)+'/'+hiscli1.substr(4,1);break;
		case 6:	hiscli1 = hiscli1.substr(0,5)+'/'+hiscli1.substr(5,1);break;
		case 7:	hiscli1 = hiscli1.substr(0,6)+'/'+hiscli1.substr(6,1);break;
		case 8:	hiscli1 = hiscli1.substr(0,7)+'/'+hiscli1.substr(7,1);break;
	}	
	return hiscli1;
}

/**
 * @properties={typeid:24,uuid:"0B75827C-D4D4-43D9-B95B-3BC48ADB3EBE"}
 */
function tratamientoARM() {
	globals.AsiArmTrs_Mod_wGraboARM = false;
	$_wHayArm = false;
	var wHoraArm = 0;
	var wFecinArm = 0;
	
	// BUSCO-TIENE-ARM
	var sqlArm = "select ArmFecing,ArmHora,ArmFecegr from tbc_arm_dia_noinva"
			   + " where ArmHcli = " + asiucotrs_hoja_rel_buscar_admision.adm_histclin
			   + " order by ArmFech desc, ArmHora desc";
			   
	var dsArm = databaseManager.getDataSetByQuery('asistencial',sqlArm,null,-1);
	if(dsArm.getMaxRowIndex() > 0){
		
		$_wHayArm = true;
		if(dsArm.getValue(1,3) == 0){
		
			wFecinArm = dsArm.getValue(1,1);		
			wHoraArm = dsArm.getValue(1,2);
		}
	}
	
	globals.AsiArmTrs_Mod_wNumLega = globals.Srv_Login_Sanatorio_vLega;
	globals.AsiArmTrs_Mod_wTipLega = globals.Srv_Login_Sanatorio_vTipoOperador;
	
	// Existe ARM
	if(wFecinArm != 0){
		
		if(f_arm == 1){
			
			// Paciente en ARM : NO : 1
			globals.DIALOGS.showInfoDialog("Resultado", "Paciente en ARM.\nDebe generar Informe y Dejar Respirador.", "Aceptar");
		}
		else{
			
			// Paciente en ARM : SI : 2
		}
		
		globals.AsiArmTrs_Mod_wHistClin = asiucotrs_hoja_rel_buscar_admision.adm_histclin;
		globals.AsiArmTrs_Mod_wFecha = utils.stringToNumber(globals.CapturaFechaSistema());
		globals.AsiArmTrs_Mod_wHora = wHoraArm;
		openARM();
		
	}
	else{
		
		// Paciene en ARM : SI : 2
		if(f_arm == 2){
			
			globals.AsiArmTrs_Mod_wHistClin = asiucotrs_hoja_rel_buscar_admision.adm_histclin;
			globals.AsiArmTrs_Mod_wFecha = utils.stringToNumber(globals.CapturaFechaSistema());
			globals.AsiArmTrs_Mod_wHora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
			
			openARM();
		}
	}	   
}

/**
 * TODO generated, please specify type and doc for the params
 * @param texto
 * @param histClin
 *
 * @properties={typeid:24,uuid:"A2D3910A-974C-4951-B5B1-7B43D6975135"}
 */
function grabaLog(texto,histClin) {
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
	var dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
		dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("bases_auxiliares","cirugia_errores")
	var fechacarga = application.getServerTimeStamp();
	fs.newRecord()
	fs['id'] = id;
	fs['hiscli'] = histClin;
	fs['protocolo'] = 0;
	fs['texto_errores'] = application.getSolutionName() + "|" +  application.getIPAddress() + "|" + controller.getName() + "|" +  texto;
	fs['tipo_pac'] = 'Int';
	fs['fecha']=application.getServerTimeStamp();
	fs['hora']=fechacarga.getHours()+''+fechacarga.getMinutes()
	
	databaseManager.startTransaction()
	var result = databaseManager.saveData(fs);
	if(result){
		databaseManager.commitTransaction();				
	}
	else{
		var error1 = ''
		var error2 = ''
		var array = databaseManager.getFailedRecords()
		for (var i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
		
				var thrown = record.exception.getValue()
			
			}
		}
		databaseManager.rollbackTransaction()
	}
}

/**
 * 
 * @param {Number} hisCli
 * @param {String} to
 * @param {String} cc
 * @param {String} cco
 * @param {String} asunto
 * @param {String} mensaje
 * @param {Array<Object>} attachment
 * @param {String} cuenta
 *
 * @properties={typeid:24,uuid:"D1832CF0-2030-4BCD-8A84-5526BAFDF5B4"}
 */
function grabarReenviaMail(hisCli,to,cc,cco,asunto,mensaje,attachment,cuenta){
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
	var dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
		dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("desal","reenvia_mail");
	fs.newRecord();
	
	fs['id'] = id;
	fs['hiscli'] = hisCli;
	fs['fecha'] = application.getServerTimeStamp();;
	fs['mail_para'] = to;
	fs['mail_cc'] = cc;
	fs['mail_cco'] = cco;
	fs['id_cuenta_origen'] = cuenta;
	fs['asunto'] = asunto;
	fs['mensaje'] = mensaje;
	fs['estado'] = false;
	
	var fsItem = databaseManager.getFoundSet('desal','reenvia_mail_adjunto');
	if(attachment != null){
		
		var idItem;
		for(var k=0; k<attachment.length; k++){
			
			fsItem.newRecord();
			idItem = application.getUUID();
			//Verificando si existe clave primaria
			sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
			dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			while(dsExists.getValue(1,1) == 1){
				idItem = application.getUUID();
				sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
				dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			}
			
			fsItem['id'] = idItem;
			fsItem['id_reenvia_mail'] = id;
			fsItem['nombre_archivo'] = attachment[k]['nombre'];
			fsItem['archivo'] = plugins.file.readFile(attachment[k]['path']);
		}
	}
	
	databaseManager.startTransaction()
	var resultFs = databaseManager.saveData(fs);
	
	var resultItem = true;
	if(fsItem.getSize() > 0)
		resultItem = databaseManager.saveData(fsItem);
	
	if(resultFs && resultItem){

		databaseManager.commitTransaction();				
	}
	else{
		
		databaseManager.rollbackTransaction();
		var msgMail = "No ha sido posible grabar en tabla reenvia_mail. HC " + hisCli + "para " + to + cc + cco;
		grabaLog(msgMail,hisCli);
	}
}


/**
 * @properties={typeid:24,uuid:"B4D4B2B7-5848-4E12-9302-B2C08DE9AF19"}
 */
function guardarDatos(){
	var seguro = 'SI'
//	var fechahora = application.getServerTimeStamp()
//	if(globals.Asivm_prestacion==1){
		//WEANING
	if(scopes.globals.AsiVm_adm_HistClin!=0){
		if(asivm_rel_respirador.getSize()>0){
			if(asivm_rel_respirador.rsp_enuso==1){
				seguro = globals.DIALOGS.showQuestionDialog("¡Aviso Importante!", "Esta cerrando una ficha y aún el paciente tiene un equipo asignado. ¿Esta seguro en cerrar la evolución? ", 'SI', 'NO')
			}
//			else{
////				globals.AsiVm_estado_uso_equipo=0
//			}
		}
	}
	if("SI"==seguro){
//		asivm_fichakine.estado=0
		asivm_fichakine_cierre.vm_liberado_vent_mec = f_liberado_venti_mecanica
		asivm_fichakine_cierre.fecha_fin = application.getServerTimeStamp()
		asivm_fichakine_cierre.fecha_fin_ventilacion = f_fecha_fin_ventilacion
		
		//EXTUBACION
		asivm_fichakine_cierre.vm_extub_no_programada = f_ext_no_programada
		asivm_fichakine_cierre.vm_extub_auto = f_auto_extub
		asivm_fichakine_cierre.vm_extub_accidental = f_extub_accidental
		asivm_fichakine_cierre.vm_extub_fecha= f_fecha_extub_no_programada
		asivm_fichakine_cierre.vm_extub_reintubado = f_reintubado
		asivm_fichakine_cierre.vm_extub_causa_reintubado = utils.stringReplace(f_causa_reintubacion,'\n',',')
		
		asivm_fichakine_cierre.vm_escenario_vni = utils.stringReplace(f_vm_vni,'\n',',')
//		asivm_fichakine_cierre.vm_exito_vni = f_exito_vni
		
		//TQT
		asivm_fichakine_cierre.vm_tqt = f_tqt
		asivm_fichakine_cierre.vm_tqt_fecha = f_fecha_tqt
		asivm_fichakine_cierre.vm_tqt_decanulacion = f_decanulacion
		asivm_fichakine_cierre.vm_tqt_fecha_decanulacion = f_fecha_decanulacion
		
		//COMPLICACIONES
		asivm_fichakine_cierre.complicaciones_sdra = f_sdra
		asivm_fichakine_cierre.complicaciones_pao2_fio2 = f_pao2_fio2
		asivm_fichakine_cierre.complicaciones_neumotorax= f_neumotorax
		asivm_fichakine_cierre.complicaciones_shock = f_shock
		
		asivm_fichakine_cierre.complicaciones_delirium = f_delirium
		asivm_fichakine_cierre.complicaciones_dauci = f_dauci
		asivm_fichakine_cierre.complicaciones_dialisis = f_dialisis
		asivm_fichakine_cierre.complicaciones_pafimenordos = f_pafiMenor200
		asivm_fichakine_cierre.complicaciones_iam = f_iam
		asivm_fichakine_cierre.complicaciones_tep = f_tep
		asivm_fichakine_cierre.complicaciones_navm = f_navm
		asivm_fichakine_cierre.complicaciones_pcr = f_pcr
		
		
		
		asivm_fichakine_cierre.intubado = f_intubado
		asivm_fichakine_cierre.exito=f_exito
//		asivm_fichakine_cierre.fecha_fin = f_fecha_fin	
	if(globals.Asivm_prestacion==2){
		asivm_fichakine_cierre.causa_fracaso = utils.stringReplace(f_causa_fracaso_vni,'\n',',') 
		asivm_fichakine_cierre.complicaciones=utils.stringReplace(f_complicaciones_vni,'\n',',')
		
	}else if(globals.Asivm_prestacion==3){
		asivm_fichakine_cierre.causa_fracaso=utils.stringReplace(f_causa_fracaso_caf,'\n',',') 
		asivm_fichakine_cierre.complicaciones=utils.stringReplace(f_complicaciones_caf,'\n',',')
	}
//	}
	//CAMPOS COMUNES
	
	//PALIATIVOS
	asivm_fichakine_cierre.paliativos = f_paliativo
	asivm_fichakine_cierre.paliativos_fecha = f_fecha_paliativos
	
	//COMPLICACIONES
	asivm_fichakine_cierre.complicaciones_sdra = f_sdra
	asivm_fichakine_cierre.complicaciones_pao2_fio2 = f_pao2_fio2
	asivm_fichakine_cierre.complicaciones_neumotorax = f_neumotorax
	asivm_fichakine_cierre.complicaciones_shock = f_shock
	
	
	//FICHA FINAL
	asivm_fichakine_cierre.egreso_vivo_uci = f_egreso_vivo_uci
	asivm_fichakine_cierre.fecha_egreso_uci = f_fecha_egreso_uci
	asivm_fichakine_cierre.fecha_egreso_sanatorio = f_fecha_egreso_sanatorio
	asivm_fichakine_cierre.derivacion =utils.stringReplace(f_derivacion,'\n',',') 
	
	//estado
	asivm_fichakine_cierre.estado = 0 // Sin uso
	}
}

/**
 * @properties={typeid:24,uuid:"B70E3B19-D490-4255-B734-C38A09BC05F9"}
 */
function cargarDatos(){
	
//	if(globals.Asivm_prestacion==1){
		//WEANING
		f_liberado_venti_mecanica = asivm_fichakine_cierre.vm_liberado_vent_mec
		f_fecha_fin = asivm_fichakine_cierre.fecha_fin
		f_fecha_fin_ventilacion = asivm_fichakine_cierre.fecha_fin_ventilacion
		f_lugar_internacion = asivm_fichakine.lugar_internacion
		//EXTUBACION
		f_ext_no_programada = asivm_fichakine_cierre.vm_extub_no_programada
		f_auto_extub = asivm_fichakine_cierre.vm_extub_auto
		f_extub_accidental = asivm_fichakine_cierre.vm_extub_accidental
		f_fecha_extub_no_programada = asivm_fichakine_cierre.vm_extub_fecha
		f_reintubado = asivm_fichakine_cierre.vm_extub_reintubado
		f_causa_reintubacion = utils.stringReplace(asivm_fichakine_cierre.vm_extub_causa_reintubado,',','\n')  
		
		f_vm_vni=asivm_fichakine_cierre.vm_escenario_vni 
//		f_exito_vni=asivm_fichakine_cierre.vm_exito_vni 
		
		//TQT
		f_tqt  = asivm_fichakine_cierre.vm_tqt
		f_fecha_tqt = asivm_fichakine_cierre.vm_tqt_fecha
		f_decanulacion = asivm_fichakine_cierre.vm_tqt_decanulacion
		f_fecha_decanulacion = asivm_fichakine_cierre.vm_tqt_fecha_decanulacion
		
		//COMPLICAIONES VM
		f_sdra = asivm_fichakine_cierre.complicaciones_sdra
		f_pao2_fio2 = asivm_fichakine_cierre.complicaciones_pao2_fio2
		f_neumotorax = asivm_fichakine_cierre.complicaciones_neumotorax
		f_shock = asivm_fichakine_cierre.complicaciones_shock
		f_delirium = asivm_fichakine_cierre.complicaciones_delirium
		f_dauci = asivm_fichakine_cierre.complicaciones_dauci
		f_dialisis = asivm_fichakine_cierre.complicaciones_dialisis
		f_pafiMenor200 = asivm_fichakine_cierre.complicaciones_pafimenordos
		f_tep=asivm_fichakine_cierre.complicaciones_tep
		f_navm = asivm_fichakine_cierre.complicaciones_navm
		f_pcr = asivm_fichakine_cierre.complicaciones_pcr
		
		
		
//	}else if(globals.Asivm_prestacion==2){
		f_fecha_fin = asivm_fichakine_cierre.fecha_fin
		f_fecha_fin_ventilacion = asivm_fichakine_cierre.fecha_fin_ventilacion
		f_intubado = asivm_fichakine_cierre.intubado
		f_exito = asivm_fichakine_cierre.exito
		f_causa_fracaso_vni= utils.stringReplace(asivm_fichakine_cierre.causa_fracaso,',','\n') 
		f_complicaciones_vni = utils.stringReplace(asivm_fichakine_cierre.complicaciones,',','\n') 
//	}else if(globals.Asivm_prestacion==3){
		f_fecha_fin_caf = asivm_fichakine_cierre.fecha_fin
		f_intubado = asivm_fichakine_cierre.intubado
		f_exito = asivm_fichakine_cierre.exito
		f_causa_fracaso_caf= utils.stringReplace(asivm_fichakine_cierre.causa_fracaso,',','\n') 
		f_complicaciones_caf = utils.stringReplace(asivm_fichakine_cierre.complicaciones,',','\n') 
		
		
//	}
	//CAMPOS COMUNES
	f_paliativo=asivm_fichakine_cierre.paliativos
	f_fecha_paliativos=asivm_fichakine_cierre.paliativos_fecha
	
	//datos finales
	f_egreso_vivo_uci=asivm_fichakine_cierre.egreso_vivo_uci
	f_fecha_egreso_uci=asivm_fichakine_cierre.fecha_egreso_uci
	f_fecha_egreso_sanatorio=asivm_fichakine_cierre.fecha_egreso_sanatorio
	f_derivacion = asivm_fichakine_cierre.derivacion
	
	elements.imprimir.enabled=true
	
}



/**
 * TODO generated, please specify type and doc for the params
 * @author gennari gustavo
 * @param formName
 * @param validarSinPropertys
 * @param patron campos con coinciden validara. Vacio validara "txt_"
 * @param validarCantCaracteres valida cantidad de caracteres en campo
 * @param minCaracteres complemento al parametro anterior
 *
 * @properties={typeid:24,uuid:"95F7851A-4981-4E80-8FB7-9142A75C2B99"}
 */
function validateRequired(formName, validarSinPropertys, patron, validarCantCaracteres, minCaracteres) {
    var ok = true;
    var textReplace=(patron!=null && !globals.IsBlank(patron))?patron:'txt_';
    var flds = forms[formName].elements;
    for (var item in flds) {
        var elm = flds[item];
        var propEncontrada = elm.getDesignTimeProperty('requerido');
        var name= elm.getName();
        //application.output(name); ver campos que se validan
        if(patron!=null && !globals.IsBlank(patron)){//pasa de largo lo que no tienen el patron.
        	if(name.indexOf(patron)==-1 && propEncontrada==undefined){ //si propEncontra no es nula hay que validar igual o no.
        		continue;
        	}
        }
        if (name!=null && name.indexOf("grp")==-1 && propEncontrada==true || validarSinPropertys &&  propEncontrada==undefined) {//si tiene propertys hay que validar // ojo cuando no es relacion
            var dp = elm.getDataProviderID() //obtenemos variable asociada
            //if (!forms[formName].foundset.getSegetSelectedRecord()[dp]) { //esto se usaba para obtener el recurso.
            var arrRelacion = (dp!=null)?dp.split("."):'';
            if (arrRelacion!='' && dp.indexOf("rel")>0 &&!globals[arrRelacion[0]][arrRelacion[1]]>=1) {
               // forms[formName].elements[name].bgcolor = "#ffbc78";
                isValid = false;
                if(propEncontrada && name.indexOf(textReplace)==-1){
        			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
        		}else{
        			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
        		}
        		if(validarCantCaracteres && propEncontrada==undefined){
        			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
        		}
            	
            }else if(dp.indexOf("rel")==-1 && dp.indexOf("cbo")==-1){
            	if((validarCantCaracteres && forms[formName][dp]!=null && forms[formName][dp].length<minCaracteres) || ""==utils.stringTrim(forms[formName][dp]) || "0"==utils.stringTrim(forms[formName][dp])  ){
            		
            		  //forms[formName].elements[name].bgcolor = "#ffbc78";
            		isValid = false;
            		if(propEncontrada && name.indexOf(textReplace)==-1){
            			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
            		}else{
            			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
            		}
            		
            		
            		if(validarCantCaracteres && propEncontrada==undefined){
            			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
            		}
            	}else{
            		// forms[formName].elements[name].bgcolor = "#d4e8d4";
            	}
            }else if(dp.indexOf("cbo")!=-1){
               	if((validarCantCaracteres && forms[formName][dp]!=null && forms[formName][dp]<minCaracteres) ||  ""==utils.stringTrim(forms[formName][dp]) ){
            		
          		  //forms[formName].elements[name].bgcolor = "#ffbc78";
          		isValid = false;
          		if(propEncontrada && name.indexOf(textReplace)==-1){
          			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
          		}else{
          			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
          		}
          		
          		
          		if(validarCantCaracteres && propEncontrada==undefined){
          			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
          		}
          	}else{
          		// forms[formName].elements[name].bgcolor = "#d4e8d4";
          	}
            }
            
            else {
                //forms[formName].elements[name].bgcolor = "#d4e8d4";
            }
            propEncontrada=false;
        }
    }
    
    return ok;
}


/**
 * TODO generated, please specify type and doc for the params
 * @param event
 *
 * @properties={typeid:24,uuid:"313EADCD-FE1F-4E35-AA83-CF8286BAD430"}
 */
function onAction_btnEditar(event) {
	// TODO Auto-generated method stub

	/*if(!asiucotrs_rel_tbc_hojauco_to_tbc_hojauco.hucimpresa==1){
	
		forms.AsiVm_Ficha_Fin_Evolucion_Uco.elements.grp_signovitale.readOnly=false
		forms.AsiVm_Ficha_Fin_Evolucion_Uco.elements.grp_signovitale.readOnly=false

		
	}else{
			plugins.dialogs.showInfoDialog("Documento fue Impreso","Esta evolución ya no será posible editar");

	}*/
	
}


/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"750DB14B-104E-4A21-8641-F2493CE11ADB"}
 */
function onDataChangePulsoFrecuencia(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	return true
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"EFA2E298-9A7D-4297-AB43-C76711341C32"}
 */
function onDataChangeArm(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	return true
}


/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"F843A89A-DAA6-4BFE-B69F-89A33C13B76F"}
 */
function onShow(firstShow, event) {
	// TODO Auto-generated method stub
	
	var relacion = asivm_rel_buscar_admision
	if(asivm_rel_buscar_admision.getSize()==0 && asivm_rel_buscar_admision_con_alta.getSize()>0){
		relacion = asivm_rel_buscar_admision_con_alta
	}
	globals.errorDato=true
	elements.txt_paciente.requestFocus(); 
	//f_paciente = globals.AsiVm_paciente;
	limpiarForm();
	//datos paciente.
	f_paciente = formatear_HistClinInter(relacion.adm_histclin) + ' ' + utils.stringTrim(relacion.adm_apelnom);
	f_histClinUnica = relacion.adm_histclinuni;
	globals.AsiVm_histClinUnica  = asivm_rel_buscar_admision.adm_histclinuni;
	f_sexo = relacion.adm_sexo;
	f_edad = globals.CalculoEdad(relacion.adm_fecnac) + ' ' + globals.vTipoEdad;
	f_habita = relacion.adm_habita;
	f_cama = relacion.adm_cama;
	f_fecha_fin = null
	f_fecha_fin_ventilacion = null
	configurarCamposSegunPrestacion();
		
	if(asivm_fichakine_cierre!=null && asivm_fichakine_cierre.fecha_fin!=null){ //|| (dsHojaUco.getMaxRowIndex() == 1 && wCerrada == 1)
		forms.AsiVm_Ficha_Fin.cargarDatos()
		var dias = globals.contar_dias(asivm_fichakine_cierre.fecha_fin,application.getServerTimeStamp())
		if(globals.Srv_Login_Sanatorio_vLegajo!='118319' && dias>=1){
//if(dias>=1){
			var funcion = globals.setearEnModoLecturaCampos;
			globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'txt_');
			globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'cbo_');
			globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'multi_')
			elements.btn_confimar_cierre.enabled=false		
		}else{
//			elements.btn_grabar.enabled=true
		}
	
		application.updateUI();
	}else{
		funcion = globals.habilitarCampos;
		globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'txt_');
		globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'cbo_');
		globals.modificarCampos("AsiVm_Ficha_Fin", funcion,'multi_')
		elements.btn_confimar_cierre.enabled=true
		
//		asivm_ficha_monitoreo.newRecord();
//		scopes.globals.InicializarDatosDeRelacion(asivm_ficha_monitoreo, "desal", "fichakine_monitoreo")
//		asivm_ficha_monitoreo.histcli = scopes.globals.AsiVm_hisclin
//		asivm_ficha_monitoreo.fichavm = scopes.globals.AsiVm_ficha_id
	}
	
}


/**
 * @properties={typeid:24,uuid:"D52CAEE5-6E2C-446A-A20C-544C69497AB5"}
 */
function configurarCamposSegunPrestacion(){
	//PRESTACION
	switch (globals.Asivm_prestacion) {
		case 1:
			elements.txt_liberado_vent_meca.enabled=true;
			elements.grp_tqt.enabled=true
			elements.grp_extubacion.enabled=true
			elements.multi_causa_fracaso_caf.visible=false
			elements.multi_complicaciones_caf.visible=false
			elements.multi_causa_fracaso_vni.visible=false
			elements.multi_complicaciones_vni.visible=false
			elements.label_causa_fracaso.visible=false
			elements.label_complicaciones.visible=false
			elements.cbo_exito.visible=false
			elements.cbo_intubado.visible=false
			
			elements.label_exito.visible=false
			elements.label_intubado.visible=false
//			elements.grp_vm_vni.visible=true
			elements.grp_escenario.visible=false
			
			elements.label_PaO2_FiO2_diag.visible=false
			elements.txt_pao2_fio2.visible= false
//			elements.grp_complicaciones.enabled=true
//			elements.cbo_intubado.enabled=false
//			elements.cbo_intubado.visible=false
//			elements.cbo_exito.enabled=false
//			elements.cbo_exito.visible=false
//			elements.multi_complicaciones_vni.enabled=false
//			elements.multi_causa_fracaso_vni.enabled=false
//			elements.multi_complicaciones_caf.enabled=false
//			elements.multi_causa_fracaso_caf.enabled=false
			
//			elements.label_complicaciones.visible=false
//			elements.label_intubado.visible=false
//			elements.label_exito.visible=false
//			elements.label_causa_fracaso.visible=false
			break;
			
		case 2:
//		elements.grp_extubacion.enabled=false
//		elements.grp_tqt.enabled=false
//		elements.grp_complicaciones.enabled=false
		elements.cbo_intubado.enabled=true
		elements.cbo_exito.enabled=true
		elements.multi_complicaciones_vni.enabled=true
		elements.multi_causa_fracaso_vni.enabled=true
		elements.multi_complicaciones_vni.visible=true
		elements.multi_causa_fracaso_vni.visible=true
		
		elements.multi_complicaciones_caf.visible=false
		elements.multi_causa_fracaso_caf.visible=false
		
		elements.label_causa_fracaso.visible=true
		elements.label_complicaciones.visible=true
		
		elements.label_exito.visible=true
		elements.label_intubado.visible=true
		
		elements.cbo_exito.visible=true
		elements.cbo_intubado.visible=true
		
		elements.label_PaO2_FiO2_diag.visible=true
		elements.txt_pao2_fio2.visible= true
		
//		elements.grp_vm_vni.visible=false
		elements.grp_escenario.visible=true
		elements.cbo_paliativos.putClientProperty("requerido",false)
		elements.txt_fecha_paliativos.putClientProperty("requerido",false)
		elements.multi_causa_fracaso_vni.putClientProperty("requerido",false)
		elements.multi_complicaciones_vni.putClientProperty("requerido",false)
			break;
		
		case 3:
//		elements.grp_extubacion.enabled=false

//		elements.grp_tqt.enabled=false
//		elements.grp_complicaciones.enabled=false
		elements.cbo_intubado.enabled=true
		elements.cbo_exito.enabled=true
		elements.multi_complicaciones_vni.enabled=false
		elements.multi_causa_fracaso_vni.enabled=false
		elements.multi_complicaciones_vni.visible=false
		elements.multi_causa_fracaso_vni.visible=false
		elements.multi_complicaciones_caf.visible=true
		elements.multi_causa_fracaso_caf.visible=true
		elements.multi_complicaciones_caf.enabled=true
		elements.multi_causa_fracaso_caf.enabled=true

		elements.label_causa_fracaso.visible=true
		elements.label_complicaciones.visible=true
		
		elements.label_exito.visible=true
		elements.label_intubado.visible=true
		
		elements.cbo_exito.visible=true
		elements.cbo_intubado.visible=true
		
		elements.label_PaO2_FiO2_diag.visible=true
		elements.txt_pao2_fio2.visible= true
		
//		elements.grp_vm_vni.visible=false
		elements.grp_escenario.visible=false
		elements.cbo_paliativos.putClientProperty("requerido",false)
		elements.txt_fecha_paliativos.putClientProperty("requerido",false)
		elements.multi_causa_fracaso_caf.putClientProperty("requerido",false)
		elements.multi_complicaciones_caf.putClientProperty("requerido",false)
		
			break;
	
	default:
		//SIN SOPORTE SIN PRESTACION
		//SOLO HABLITAR DATOS DE FINALIZACION.
	
		break;
	}
	
	if(asivm_rel_buscar_ficha_kine.getSize()>1){
		elements.grp_escenario.visible=true
	}else{
		elements.grp_escenario.visible=false
	}

}


/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"BBAE5572-E8B4-418A-A43D-B16A816C5BD3"}
 */
function onDataChangePao2_fio2(oldValue, newValue, event) {
	$isDirty=true
	globals.valida_rango_campo(0,600,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_pao2_fio2.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"16FCD5D7-E842-47FE-9CAD-53E71A30D9C5"}
 */
function onDataChangeDatoCambio(oldValue, newValue, event) {
	habilitarFechaNoProg()
	habilitarFechaPaliativos()
	habilitarFechaTQT()
	habilitarDecanulacion()
	habilitarDerivacion()
	habilitarFechaDecanulacion()
	$isDirty=true
	return true
}

/**
 * @properties={typeid:24,uuid:"C48027F2-1D0B-43C5-AFBC-D9EF2CCED3CE"}
 */
function onDataChangeExtubNoProgramada(){
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"21CCB60A-E6F0-4271-8EA1-0ED5ECEF9EE3"}
 */
function onActionSequence(event) {
	// TODO Auto-generated method stub
	var tabseq = forms.AsiVm_Ficha_Fin.controller.getTabSequence();
	if (tabseq.length > 1 && isNaN(event)) {
	var secActual= tabseq.indexOf(event.getElementName());
	    forms.AsiVm_Ficha_Fin.controller.focusField(tabseq[secActual+1], true);
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"96EA0C5E-33B0-4D70-BB74-550552E219C5"}
 */
function onDataChangeExtubNoProg(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	if(newValue==2){
		
	}
	return true
}

/**
 * @properties={typeid:24,uuid:"70C4B3AB-6044-4C2E-A1EF-075B50449186"}
 */
function habilitarFechaTQT(){
	if(f_tqt==2){
		elements.txt_fecha_tqt.enabled=true
	}else{
		elements.txt_fecha_tqt.enabled=false
	}
}

/**
 * @properties={typeid:24,uuid:"15700E68-31B8-43E4-9141-5EE6AEDBE230"}
 */
function habilitarDerivacion(){
	if(f_egreso_vivo_uci==1){
		elements.multi_derivacion.enabled=false
	}else{
		elements.multi_derivacion.enabled=true
	}
}
/**
 * @properties={typeid:24,uuid:"735C82E3-F517-4F69-BF6A-7E77A9B15CF8"}
 */
function habilitarDecanulacion(){
	if(f_tqt==1){
		elements.txt_fecha_tqt.enabled=false
		elements.cbo_decanulacion.enabled=false
	}else{
		elements.txt_fecha_tqt.enabled=true
		elements.cbo_decanulacion.enabled=true
	}
}

/**
 * @properties={typeid:24,uuid:"237F3F0F-602B-4CBB-960A-0AFBF62D1B87"}
 */
function habilitarFechaDecanulacion(){
	if(f_decanulacion==1){
		elements.txt_fecha_decanulacion.enabled=false
	}else{
		elements.txt_fecha_decanulacion.enabled=true
	}
}

/**
 * @properties={typeid:24,uuid:"4D383E22-B4C9-4C2E-8081-C3E56376ED60"}
 */
function habilitarFechaPaliativos(){
	if(f_paliativo==2){
		elements.txt_fecha_paliativos.enabled=true
	}else{
		elements.txt_fecha_paliativos.enabled=false
	}
}
/**
 * @properties={typeid:24,uuid:"3C911AC4-568E-46CD-A9D8-6582AA81E61A"}
 */
function habilitarFechaNoProg(){
	if(f_ext_no_programada==2 || f_extub_accidental==2 || f_auto_extub==2){
		elements.txt_fecha_extubacion_no_prog.enabled=true
		
	}else{
		elements.txt_fecha_extubacion_no_prog.enabled=false
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"94C2C098-AF04-40E2-A538-CC6AA7EAACC8"}
 */
function onActionPrint(event) {
	// TODO Auto-generated method stub
	if(asivm_fichakine_cierre.getSize()==1){
		forms.AsiVm_Template_print.imprimirVm(asivm_fichakine_cierre.histcli,asivm_fichakine_cierre.fecha_fin,4);
	}
	
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"D8CE5F7F-0DCC-44E3-BF61-8023BE63645E"}
 */
function onDataChangeEgresoVivoUci(oldValue, newValue, event) {
	// TODO Auto-generated method stub
//	if(newValue==2){
//		elements.txt_fecha_egreso_uci.putClientProperty("requerido",true)
//	}else{
//		elements.txt_fecha_egreso_uci.putClientProperty("requerido",false)
//	}
	habilitarDerivacion()
	$isDirty=true
	return true
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"62B2E548-9894-4007-BA5E-7517D2DB079D"}
 */
function onDataChangeEscenarioVni(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	return true
}
