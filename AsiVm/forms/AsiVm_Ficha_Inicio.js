/**
 * @properties={typeid:35,uuid:"198AD67E-AA30-419A-AEAD-5A6023907794",variableType:-4}
 */
var $_wHayArm = false;

/**
 * @properties={typeid:35,uuid:"B648E727-10EF-4BC0-BA88-625F57243246",variableType:-4}
 */
var ingresoUci=false
/**
 * @properties={typeid:35,uuid:"12A871E7-2B89-465E-BE19-8FAF62C8941E",variableType:-4}
 */
var $_fechaHoraRegistro = null
/**
 * @properties={typeid:35,uuid:"2A374BEB-2940-4546-8B3C-2DF7C5315E50",variableType:-4}
 */
var isValid = true;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D7B124A6-91ED-4555-97C8-6778172FBECE"}
 */
var f_
/**
 * @properties={typeid:35,uuid:"110087DF-CF85-4B6B-AF4A-7D8408550779",variableType:-4}
 */
var f_aislado_paciente = false;

/**
 * @properties={typeid:35,uuid:"55041B76-5EA9-4226-830F-23AB5D044760",variableType:-4}
 */
var f_fecha_inicio_ventilacion = null

/**
 * @properties={typeid:35,uuid:"5A18AB56-A030-446A-95EC-E4BDFACEF7A7",variableType:-4}
 */
var f_analgésicos = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CA380691-551C-499D-82D0-06579AB5B5EA"}
 */
var f_marca = ''
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C84554DD-0B1B-4E1B-8321-85B598D60622"}
 */
var f_antecedentes = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4D145D85-F77D-43E8-9773-E2B970DC48B6"}
 */
var f_otros_diag = ''
	
/**
 * @properties={typeid:35,uuid:"4AE321A9-63FC-40C9-9351-E9666FAE6A16",variableType:-4}
 */
var f_chk_otro_diag = false

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D33304CD-26A4-4CD1-A1CF-1701871C0011"}
 */
var f_observaciones = "";

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"519AA3EB-CA18-473C-941E-31BA04B77434"}
 */
var f_observaciones_otras = ""
/**
 * @properties={typeid:35,uuid:"149E7A74-D908-4B28-AD11-671337155912",variableType:-4}
 */
var f_mecanica = null;

///**
// * @properties={typeid:35,uuid:"0AB981C6-DE1A-4073-BCA5-70E94E6A3D79",variableType:-4}
// */
//var f_bloqueantes_neuromsuculares = null;

/**
 * @properties={typeid:35,uuid:"AA789FCA-0275-4D40-A3E3-49917513E2A6",variableType:-4}
 */
var f_cam_icu = null;

/**
 * @properties={typeid:35,uuid:"9D31C452-6646-4EBA-AC89-C3958BFD74C8",variableType:-4}
 */
var f_sedación = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D0B4F344-E006-44F0-B9E9-926ACFEDB7FB",variableType:8}
 */
var f_sobrevida = 0.0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"38F2375A-725A-4E8F-A0FA-428FF430ED91",variableType:8}
 */
var f_score_charlson = 0.0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1EE8F96C-FF22-4300-9B31-733709A7032D",variableType:8}
 */
var f_mortalidad_predicha_saps_II = 0.0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C3BE5543-9FFE-4627-B978-6C351BF7E842",variableType:8}
 */
var f_saps_II=0.0;



/**
 * @properties={typeid:35,uuid:"3C1FA878-513D-4C04-9825-4B1D0620B2B9",variableType:-4}
 */
var bloqueado = false;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C7A74744-EAEE-45AB-A696-4BEF786E8DFE"}
 */
var messageError = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1D86F17C-AD56-4B2C-AF97-916F7217CF5D",variableType:4}
 */
var f_arm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0B56CCCB-BB79-4F7A-BA37-D6D11564DA37",variableType:4}
 */
var AsiVm_grupoTxt = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"35E91E28-E4C7-4751-8D09-BCF6C04993A7",variableType:4}
 */
var AsiVm_lineaTxt = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"285F8BC1-D138-40BC-B07F-7F7C52DAA251",variableType:4}
 */
var AsiVm_horaTxt = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E194AF75-FB55-425C-8109-3BFFE37BE691"}
 */
var f_derivado = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"59203802-B901-436D-94FF-91CBF666ADB9"}
 */
var f_ingresoUco = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5E2A6F1B-19A6-4A85-94BC-F4ECF31393E0"}
 */
var f_ingresoSanatorio = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E7B1FA63-DBB2-4528-BD83-8657B9C434ED"}
 */
var $_msgSMS = '';

/**
 * @properties={typeid:35,uuid:"00A1267D-1A77-4507-AF9B-D959269C54CD",variableType:-4}
 */
var $_listNumberSMS = new Array();

/**
 * @properties={typeid:35,uuid:"CDB6CA73-EDE2-410C-AD1D-6E3981B286F4",variableType:-4}
 */
var $_wtrau = false;

/**
 * @properties={typeid:35,uuid:"9FA9F9B5-9D45-4BFE-99B4-4BFC7643A931",variableType:-4}
 */
var $_wsele = false;

/**
 * @properties={typeid:35,uuid:"B4572170-ED8B-4A59-B5CD-AA63929516D3",variableType:-4}
 */
var $_isUserOSTEE = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8E5FEAA5-59D1-40DC-B19B-2B41D43B41B2",variableType:4}
 */
var $_countChange = 1;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A7CBA479-EE02-4FEE-95D4-F91F548798FC"}
 */
var f_habita = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4AAD85AC-DE23-4EEC-8354-D9DCD99FC4D5",variableType:4}
 */
var f_lugar_internacion = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1297DB93-BBBE-46FC-93A8-3D5F9C0EF086"}
 */
var f_cama = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CB850129-8C52-4124-B406-9C451C1E2064"}
 */
var f_enUso = ''

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"EF058EA1-8B2F-4AE1-B690-0C57217B2A83",variableType:4}
 */
var f_sexo = null;





/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C56FB505-937A-47EA-B665-1D1E3334EE58",variableType:4}
 */
var f_tiene_soporte = 0

/**
 * @properties={typeid:35,uuid:"584F12E5-AC7A-4B12-8A62-02A3BCABFD26",variableType:-4}
 */

var f_modo_ventilatorio = null;



/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"01073BB9-9FA7-4E6C-B0D8-4C18811E5654"}
 */
var f_ingreso_uci = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B5C1D5AB-D9F2-4EDD-805A-EB9DD1495421",variableType:4}
 */
var f_inicio_vm = 0;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F91543E0-51E4-48B8-BCD7-75A6E4C94913"}
 */
var f_motivo = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"462C5740-E842-4050-8C1B-07EF3266A5A5",variableType:4}
 */
var f_pulso_frecuencia = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"73A75C3E-BEF7-4B65-8B77-D4525F61994B",variableType:8}
 */
var f_altura = 0.0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9D7378E1-611D-4C53-B326-F79E607EAAB7",variableType:4}
 */
var f_marca_arm = -1

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B8CBF3B3-AADE-486C-9B87-2DD0C718B73E"}
 */
var f_modelo = ''
	
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"063C1A8C-DF38-4E4B-BB72-218244928E4E"}
 */
var f_equipo =''

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46DFAB3F-5AFF-4CA1-840C-7CB0E641D81B",variableType:8}
 */
var f_peso_predicho = 0.0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"28E5FB03-7B46-4449-BFD8-6CC8C76CEC6D",variableType:8}
 */
var f_peso_estimado = 0.0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0810DAF7-CC51-496B-B6BE-59B611F4054E",variableType:4}
 */
var f_tension_arterial_min = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1175DCB6-5865-4A3B-B01F-63CAB899B976",variableType:4}
 */
var f_tension_arterial_max = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6A08D3DF-0999-4BBC-AB10-8685859ADFEA",variableType:4}
 */
var f_frecuencia_cardiaca = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"092A1D06-C957-4214-819C-D00A33C18B70",variableType:4}
 */
var f_rass = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A1AB6CA4-E140-4FF5-A30E-7EB179FB866A",variableType:4}
 */
var f_frecuencia_respiratoria = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46AA022A-03AC-48C9-BD05-A7B41ECC6B0C",variableType:4}
 */
var f_cpot = 0;



/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CC0A6612-04EE-463C-8E78-7A8FC4D13AB7",variableType:4}
 */
var f_sin_soporte = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"69DE0ECC-0AC0-4BBE-BD24-49F35B8DFE3E",variableType:4}
 */
var f_con_soporte = 0

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"79D11924-49CF-428E-BF45-FEA80C07E6D5"}
 */
var f_diagnostico = '';


/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8A7BEE34-19CE-4CB9-BDF7-44DF874DA403",variableType:4}
 */
var f_glasgow = 0

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"EA41CB80-642E-49E6-A293-955BDCB52773",variableType:4}
 */
var f_temperatura = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2C1EC0DB-E4D6-4438-B83D-2BCB29ADE8DD"}
 */
var f_tipo_temperatura = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"45F7D092-6963-4784-820F-CB25D810FCAF"}
 */
var f_tipo_sonda = ' ';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B86B7C3A-0192-4364-B2C5-8BFD676D53A1"}
 */
var f_patologia1 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"798D4E67-6D0B-4EA3-9F0A-3DE46FCDE466"}
 */
var f_patologia2 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3E2BED65-3984-45F1-A10D-BC7BBB709C4F"}
 */
var f_patologia3 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D78F944C-14D3-4FAE-9228-6A091B946C56"}
 */
var f_patologia = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C782912B-7EF5-41BD-8B32-51DB5A78CD1E"}
 */
var f_descripcion_patologia1 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"37CF2EE4-ADBF-4F19-88FA-0DEF761EB183"}
 */
var f_descripcion_patologia2 = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A438DE26-E21E-4292-A94F-F448C2BBF95B"}
 */
var f_descripcion_patologia3 = '';

/**
 * @properties={typeid:35,uuid:"405357F2-C26C-441D-B515-DA75ED759948",variableType:-4}
 */
var f_cerrarForm = false;

/**
 * @properties={typeid:35,uuid:"7D19FEF5-5E5E-4C43-9964-35856C6058D3",variableType:-4}
 */
var $isDirty = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4B3072CC-AF15-4454-AA94-E05A72B13A13",variableType:4}
 */
var f_protocolo = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1A859C01-9AC0-4242-8AAC-80F59102C3F9"}
 */
var $messageErrorInter = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9471F05D-5938-498E-ADE0-353321AF7D37"}
 */
var f_medico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"202642F4-A404-48EA-9EF9-54752459B720"}
 */
var f_edad = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F084AB48-F50B-4CE6-AF2F-83E913C01F4B"}
 */
var f_cobertura = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6323ADBB-7DB4-49FE-9AE6-3F22C16154C7"}
 */
var f_histClinUnica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5F47346C-2B33-4388-B547-30B16AEEB5A4"}
 */
var f_paciente = null;

/**
 * @properties={typeid:35,uuid:"95BAEA21-8ACE-409F-9785-BA7727FEE63F",variableType:-4}
 */
var $_AsiVm_Ficha_Inicio_READ_ONLY = false;

/**
 * @properties={typeid:35,uuid:"079E4485-65DA-4E6B-8725-6E6846529F8D",variableType:-4}
 */
var $_AsiVm_Ficha_Inicio_Recurso_Tomado = false;

/**
 * TODO generated, please specify type and doc for the params
 * @param firstShow
 * @param event
 *
 * @properties={typeid:24,uuid:"36E23A8C-9798-4BE2-80CF-BD95E418EE8D"}
 */
function onShow_inicializarForm(firstShow, event) {
//	elements.txt_observaciones.editable=true
	globals.errorDato=true
	elements.grp_tiene_arm.visible=false
//	elements.btn_observaciones.visible=true
	initFormFirstShow();
	elements.txt_paciente.requestFocus(); 
	globals.AsiVm_Fecha_dia = utils.dateFormat(application.getServerTimeStamp(),'dd/MM/yyyy hh:mm aa')
	//f_paciente = globals.AsiVm_paciente;
	//limpiarForm();
	//datos paciente.
//	if(){
//		
//	}
	var relacion = asivm_rel_buscar_admision
	if(asivm_rel_buscar_admision_con_alta.getSize()>0){
		globals.DIALOGS.showWarningDialog("¡Aviso!", "El paciente se ha ido del sanatorio. Deberá cerrar las fichas pendientes en caso que existan.", "Aceptar")
		relacion = asivm_rel_buscar_admision_con_alta
	}
	
	if(relacion.getSize()>0){
		f_paciente = formatear_HistClinInter(relacion.adm_histclin) + ' ' + utils.stringTrim(relacion.adm_apelnom);
		f_histClinUnica = relacion.adm_histclinuni;
		globals.AsiVm_histClinUnica  = relacion.adm_histclinuni;
		f_sexo = relacion.adm_sexo;
		f_edad = globals.CalculoEdad(relacion.adm_fecnac) + ' ' + globals.vTipoEdad;
		f_habita = relacion.adm_habita;
		f_cama = relacion.adm_cama;
		f_medico = utils.stringTrim(globals.Srv_Login_Sanatorio_vOperador);
		//MARCA ARM PARA FACTURAR Y TENER CONTROL DE EQUIPOS ASIGNADOS
		f_marca_arm = relacion.admarm
		
	//	f_lugar_internacion = asivm_rel_buscar_admision.adm_utiliza
		
		
		var sqlDetalle = "select Det2,Det3,Det9 from tbc_detalle" //det2 y 3 //fecha y hora de ingreso
		   + " where Det1 = " + relacion.adm_histclin
		   + " and (Det8=2 or Det8=4)"
		   + " order by Det2 asc,Det3 asc";
		   
		var dsDetalle = databaseManager.getDataSetByQuery('asistencial',sqlDetalle,null,-1);
		if(dsDetalle.getMaxRowIndex()>0){
			var fechaIngresoUCI = globals.IntegerToDate(dsDetalle.getValue(1,1)); //hora
			var horaIngresoUCI = globals.AsiVm_convertNumberToHour_HHMM(dsDetalle.getValue(1,2)); //fecha			
			if(fechaIngresoUCI!=null  && !globals.IsBlank(horaIngresoUCI)){
				var horaAux = horaIngresoUCI.split(':')
				fechaIngresoUCI.setHours(Number(horaAux[0]), Number(horaAux[1]))
				f_ingreso_uci = utils.dateFormat(fechaIngresoUCI,'dd/MM/yyyy hh:mm aa')
				ingresoUci = true
			}
			
		}else{
			f_ingreso_uci=''
		}
	
	//equipo asignado
	
	//FIN CAMPOS CABECERA
	if(asivm_rel_respirador.getSize()>0){
		f_equipo = asivm_rel_respirador.rsp_codint
		f_marca = asivm_rel_respirador.rsp_marca
		f_modelo=asivm_rel_respirador.rsp_modelo
		f_enUso= application.getValueListDisplayValue('AsiVm_vl_en_uso',asivm_rel_respirador.rsp_enuso)
		if(asivm_rel_respirador.rsp_enuso==1){
			elements.enUso.bgcolor = "#ADFF81"
			globals.AsiVm_estado_uso_equipo=true
		}else{
			elements.enUso.bgcolor = "#F67F66"
			globals.AsiVm_estado_uso_equipo=false
		}
	}
	
	
	// INICIO LOGICA DE BLOQUEO
	globals.AsiVm_Ficha_Inicio_bloqueado=false;
	$_AsiVm_Ficha_Inicio_READ_ONLY = false;
	
	bloqueado = globals.AsistFunciones_isRegisterTableLocked(application.getSolutionName(),controller.getName(),relacion.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Ficha Kinesiológica", null, null);
	//si bloqueado solo readonly
	if(bloqueado){
		$_AsiVm_Ficha_Inicio_READ_ONLY = true;
		//globals.DIALOGS.showWarningDialog("Recurso en Uso","La historia clínica que quiere acceder esta siendo usada actualmente por otro profesional. Aguarde o reintente mas tarde para poder editar información o Agregar Nueva Historia")
	}else{
		$_AsiVm_Ficha_Inicio_Recurso_Tomado = true;
		
	}
	
	//FIN LOGICA DE BLOQUEO
	if(!bloqueado){
		globals.AsiVm_Ficha_Inicio_bloqueado = true
		var message = '';
		elements.btn_cerrar_ficha.visible=true
		if (asivm_fichakine.getSize() == 1) {
//				visibleBody(true);
				cargarDatos();
				elements.btn_imprimir.enabled=true
				/*if($_AsiVm_Ficha_Inicio_READ_ONLY){
					mostrarSoloLectura();
				}else{
					mostrarModoEditable();
				}*/
				$isDirty = false;
			
				//asivm_fichakine.hiicama = asivm_rel_buscar_admision.adm_cama;
			//asivm_fichakine.hiihabi = asivm_rel_buscar_admision.adm_habita;
		} 
		else {//fICHA NUEVA
			
			showFieldByPrestacion()
			elements.cbo_motivo_vm.visible=false
			elements.cbo_motivo_vni.visible=false
			elements.cbo_motivo_caf.visible=false
			elements.grp_prestacion.visible=false
			elements.btn_monitoreos.visible=false
			elements.btn_report_monitoreo.visible=false
			if(asivm_rel_buscar_admision.getSize()>0){
				elements.btn_grabar.enabled=true
			}
			
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'txt_');
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'cbo_');
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'multi_')
			elements.grp_prestacion.enabled=false
			elements.cbo_sin_soporte.enabled=false
			elements.btn_cerrar_ficha.visible=false
		}
		
	}else{
		f_cerrarForm = true;
		limpiarForm()
			var $win = application.getWindow(application.getActiveWindow().getName());
		if ($win != null) {
			$win.hide();
			$win.destroy();
		}
		
	}
	
	}
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"5710BC70-8913-4218-A483-CF2AD8CB7F37"}
 */
function onAction_btnBuscarPaciente(event) {

	globals.AsiVm_eventSourceButton = 1;
	openSearch();
}

/**
 * @properties={typeid:24,uuid:"1D85A84B-CD3B-4027-BC7F-7AA4D93BD932"}
 */
function openSearch() {

	var win2 = application.createWindow("seleccion_internado", JSWindow.MODAL_DIALOG);
	win2.title = 'Búsqueda de Pacientes Internados';
	win2.resizable = false;
	win2.show(forms.AsiVm_dlg_buscar_internado);

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"01779FCA-DBB7-4986-94EF-C7918B040107"}
 */
function onAction_txtBusquedaRapida(event) {

	if(elements.txt_paciente.editable){
		
		globals.AsiVm_paciente = f_paciente;
		if (globals.AsiVm_paciente != '' && globals.AsiVm_paciente != null) {
			globals.AsiVm_eventSourceButton = 0;
			openSearch();
			//$isDirty = true;
		} else {
			globals.DIALOGS.showWarningDialog("Atención", 'Debe ingresar Nro. de paciente o apellido.', "Aceptar")
		}
	}
}



/**
 * @properties={typeid:24,uuid:"69F20A73-E5B6-48EC-A453-0CB52BFC8463"}
 */
function pacienteSeleccionadoInter() {

	globals.AsiVm_nroHabi = asivm_rel_buscar_admision.adm_habita;
	//globals.AsiVm_alerHistClin = asivm_rel_buscar_admision.adm_histclin;
	
	//ACC-HCL
	if(isValidDatosPacienteInter()){
		
		//CARGO-ADMISION
		editablePaciente(false);
		$isDirty = true;
		f_paciente = formatear_HistClinInter(asivm_rel_buscar_admision.adm_histclin) + ' ' + utils.stringTrim(asivm_rel_buscar_admision.adm_apelnom);
		f_histClinUnica = asivm_rel_buscar_admision.adm_histclinuni;
		f_sexo = asivm_rel_buscar_admision.adm_sexo;
		f_edad = globals.CalculoEdad(asivm_rel_buscar_admision.adm_fecnac) + ' ' + globals.vTipoEdad;
		f_habita = asivm_rel_buscar_admision.adm_habita;
		f_cama = asivm_rel_buscar_admision.adm_cama;
		globals.AsiVm_obrCodigo = asivm_rel_buscar_admision.adm_obrsoc;
		//f_cobertura = utils.stringTrim(asivm_rel_buscar_obrasocial.obr_razonsoc);
		//f_derivado = '';
		
		// Fecha de ingreso a Sanatorio
		var fechaIngreso = asivm_rel_buscar_admision.adm_fecing.toString().substr(6, 2) + "/" + asivm_rel_buscar_admision.adm_fecing.toString().substr(4, 2) + "/" + asivm_rel_buscar_admision.adm_fecing.toString().substr(0, 4);
		var hora = convertNumberToHour_HHMM(asivm_rel_buscar_admision.adm_horing);
		var horaAux = hora.split(':')
		var fechaDesde = globals.IntegerToDate(asivm_rel_buscar_admision.adm_fecing);
		fechaDesde.setHours(Number(horaAux[0]), Number(horaAux[1]));
		//var fechaActual = utils.timestampToDate(application.getServerTimeStamp());
		var fechaActual = application.getServerTimeStamp();
		var dias = contar_dias(fechaDesde, fechaActual);
		
		var fechaHora = fechaIngreso + "  " + convertNumberToHour_HHMM(asivm_rel_buscar_admision.adm_horing);
		f_ingresoSanatorio = fechaHora;
		var info = "Ingresó al Sanatorio : " + fechaHora + " Hrs." + "   " + dias + " días de Internado";

		//BUSCO-DETALLE-UCO
		//var wAmdEgr = 0;
		var wAmdIng = 0;
		var wHorIng = 0;
		var wCerrada = 0;
		var sqlDetalle = "select Det2,Det3,Det9 from tbc_detalle"
					   + " where Det1 = " + asivm_rel_buscar_admision.adm_histclin
					   + " and Det8 in (4,5)"
					   + " order by Det2,Det3";
					   
		var dsDetalle = databaseManager.getDataSetByQuery('asistencial',sqlDetalle,null,-1);
		for(var i= 1; i<=dsDetalle.getMaxRowIndex(); i++){
			
			if(dsDetalle.getValue(i,3) > 0)
				wCerrada = 1;
			
			//wAmdEgr = dsDetalle.getValue(i,3);
			wAmdIng = dsDetalle.getValue(i,1);
			wHorIng = dsDetalle.getValue(i,2);
		}
		
		//Fecha de ingreso a UCO
		fechaIngreso = wAmdIng.toString().substr(6, 2) + "/" + wAmdIng.toString().substr(4, 2) + "/" + wAmdIng.toString().substr(0, 4);
		hora = convertNumberToHour_HHMM(wHorIng);
		horaAux = hora.split(':')
		fechaDesde = globals.IntegerToDate(asivm_rel_buscar_admision.adm_fecing);
		fechaDesde.setHours(Number(horaAux[0]), Number(horaAux[1]));
		dias = contar_dias(fechaDesde, fechaActual);
		
		fechaHora = fechaIngreso + "  " + convertNumberToHour_HHMM(asivm_rel_buscar_admision.adm_horing);
		f_ingresoUco = fechaHora;
		
		info +=  "\n" + "Ingresó al Serv. UCO : " + fechaIngreso + "  " + convertNumberToHour_HHMM(asivm_rel_buscar_admision.adm_horing) + " Hrs." + "   " + dias + " días en Serv. UCO";
		info += "\n\n" + "Domicilio : " + utils.stringTrim(asivm_rel_buscar_admision.adm_domicilio) + "  T.E. : " + utils.stringTrim(asivm_rel_buscar_admision.adm_telefefono);
		info += "\n" + "Resp.Solidario : " + utils.stringTrim(asivm_rel_buscar_admision.adm_nomrespon) + "  T.E. : " + utils.stringTrim(asivm_rel_buscar_admision.adm_telefrespon);
		
		globals.DIALOGS.showInfoDialog('Atención',info,'Aceptar')
	
		//BUSCO- FICHAS
		var wImpresa = 0;
		var histclin = asivm_rel_buscar_admision.adm_histclin;
		var sqlHojaUco = "select HucFecha,HucHora,HucImpresa from tbc_hojauco"
					  + " where  HucHiscli = " + histclin
					  + " and HucFecha >= " + asivm_rel_buscar_admision.adm_fecing
					  + " order by HucFecha,HucHora";
		var dsHojaUco = databaseManager.getDataSetByQuery('asistencial',sqlHojaUco,null,-1);
		
		if(dsHojaUco.getMaxRowIndex() >= 1){ //|| (dsHojaUco.getMaxRowIndex() == 1 && wCerrada == 1)
			
			//siempre es posible agrega evoluciones
			var dsHojaUcoAux = databaseManager.createEmptyDataSet();
			dsHojaUcoAux.addColumn('id');
			dsHojaUcoAux.addColumn('fecha');
			dsHojaUcoAux.addColumn('hora');
			dsHojaUcoAux.addColumn('texto');
			
			for(var j=1; j<=dsHojaUco.getMaxRowIndex(); j++){
				
				if(dsHojaUco.getValue(j,3) == 0)
					wImpresa = 1;
				
				fechaIngreso = dsHojaUco.getValue(j,1);
				dsHojaUcoAux.addRow([histclin
									,dsHojaUco.getValue(j,1)
									,dsHojaUco.getValue(j,2)
									,fechaIngreso.toString().substr(6, 2) + "/" + fechaIngreso.toString().substr(4, 2) + "/" + fechaIngreso.toString().substr(0, 4) + "  " + convertNumberToHour_HHMM(dsHojaUco.getValue(j,2))
									]);
			}
			
			//if(wCerrada == 1 && wImpresa == 0)
			dsHojaUcoAux.addRow([0,0,0,'NUEVA']);
				
			var $tipos = [JSColumn.NUMBER,JSColumn.NUMBER,JSColumn.NUMBER,JSColumn.TEXT];
			var $frm = solutionModel.getForm('AsiVm_tbl_hciuco');
			$frm.dataSource = dsHojaUcoAux.createDataSource('ds_hciuco', $tipos);
			forms.AsiVm_tbl_hciuco.controller.recreateUI();
			
			var win2 = application.createWindow("seleccion_hciuco", JSWindow.MODAL_DIALOG);
			win2.title = 'Evolución de servicio UCO';
			win2.resizable = false;
			win2.show(forms.AsiVm_tbl_hciuco);
		}
		else{
			
			//hci a uco sin cerrar
			/*if(dsHojaUco.getMaxRowIndex() == 1){
				
				globals.AsiVm_hiuFecha = dsHojaUco.getValue(1,1);
				globals.AsiVm_hiuHora = dsHojaUco.getValue(1,2);
				globals.AsiVm_hiuHisCli = histclin;
			}*/
			
			loadData();
		}
	}
	else{
		
		elements.txt_paciente.requestFocus();
	}
}

/**
 * @properties={typeid:24,uuid:"6E9ED1A0-514C-4C94-999B-736031F02087"}
 * @AllowToRunInFind
 * @SuppressWarnings(wrongparameters)
 */
function loadData() {
	globals.AsiVm_Ficha_Inicio_bloqueado=false;
	$_AsiVm_Ficha_Inicio_READ_ONLY = false;
	
	bloqueado = globals.AsistFunciones_isRegisterTableLocked(application.getSolutionName(),controller.getName(),asivm_rel_buscar_admision.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Ficha Kinesiológica", null, null);
	//si bloqueado solo readonly
	if(bloqueado){
		$_AsiVm_Ficha_Inicio_READ_ONLY = true;
		//globals.DIALOGS.showWarningDialog("Recurso en Uso","La historia clínica que quiere acceder esta siendo usada actualmente por otro profesional. Aguarde o reintente mas tarde para poder editar información o Agregar Nueva Historia")
	}else{
		$_AsiVm_Ficha_Inicio_Recurso_Tomado = true;
		
	}
	if(!bloqueado){//si NO ESTA EN USO
		var message = '';
		if (asivm_fichakine.getSize() > 0) {
				globals.AsiVm_Ficha_Inicio_bloqueado = true
//				visibleBody(true);
				cargarDatos();
			
				if($_AsiVm_Ficha_Inicio_READ_ONLY){
					mostrarSoloLectura();
				}else{
					mostrarModoEditable();
				}
				$isDirty = false;
				//asivm_fichakine.hiicama = asivm_rel_buscar_admision.adm_cama;
			//asivm_fichakine.hiihabi = asivm_rel_buscar_admision.adm_habita;
				
		} 
		else {
			if($_AsiVm_Ficha_Inicio_READ_ONLY!=true){
				//mostrar opciones
				var win_inicio_opcion = application.createWindow("seleccion_hciuco", JSWindow.MODAL_DIALOG);
				win_inicio_opcion.title = 'Soporte';
				win_inicio_opcion.resizable = false;
				win_inicio_opcion.show(forms.AsiVm_Ficha_Inicio);
				
				if(globals.AsiVm_Con_Soporte){
					//mostrar opciones
					var opcion_vm = application.createWindow("seleccion_hciuco", JSWindow.MODAL_DIALOG);
					opcion_vm.title = 'Opciones Ventilación Mecánica';
					opcion_vm.resizable = false;
					opcion_vm.show(forms.AsiVm_Ficha_Inicio);
					
					switch (globals.AsiVm_Opcion_Vm) {
					case 'VM':
						
						break;
						
					case 'VNI':
					
						break;
					
					default: //CAF
						break;
					}
					
				}else{
					//solo mostrar obseracion
					
				}
			/*	
				elements.btn_grabar.enabled=true
		
				elements.grp_diagnostico.enabled=true
				elements.grp_signovitale.enabled=true
				
				elements.tab_informe_1.readOnly=false
				globals.AsiVm_hiuHisCli = 0;
				globals.AsiVm_hiuFecha = 0;
				globals.AsiVm_hiuFecha = 0;
				
				var fechaHoy = utils.stringToNumber(globals.CapturaFechaSistema());
				forms.AsiVm_Evolucion_Uco.elements.btn_imprimir.enabled=false
				
				
				scopes.globals.AsiVm_hiuHisCli =asivm_numero_to_tbc_admision.adm_histclin;
				
				asivm_fichakine.newRecord();
				scopes.globals.InicializarDatosDeRelacion(asivm_fichakine, "asistencial", "tbc_hojauco")
				
				globals.AsiVm_Ficha_Inicio_bloqueado=true;
				visibleBody(true);
				var elementosTab1 = forms.AsiVm_Evolucion_Uco.elements.tab_informe_1.getMaxTabIndex()
				for (var index = 1; index <= elementosTab1; index++) {
					var nombreFormulario = forms.AsiVm_Evolucion_Uco.elements.tab_informe_1.getTabFormNameAt(index);
					globals.modificarCampos(nombreFormulario, globals.habilitarCampos,'tea_texto');
					
				}
				var elementosTab2 = forms.AsiVm_Evolucion_Uco.elements.tab_informe_2.getMaxTabIndex()
				for (var index2 = 1; index2 <= elementosTab2; index2++) {
					var nombreFormulario2 = forms.AsiVm_Evolucion_Uco.elements.tab_informe_2.getTabFormNameAt(index2);
					globals.modificarCampos(nombreFormulario2, globals.habilitarCampos,'tea_texto');
				}
				
				elements.txt_pulso_frecuencia.requestFocus();	*/
			
		 }else{
			 limpiarForm();
		 }
		}
		}	
		

		elements.txt_pulso_frecuencia.requestFocus();	

}

/**
 * @properties={typeid:24,uuid:"DDBCA0ED-2125-4A59-8E09-3D805D5CD4BD"}
 */
function isValidDatosPacienteInter() {

	isValid = true;
	$messageErrorInter = '';
/*
	if($_isUserOSTEE){

		 if(asivm_rel_buscar_admision.adm_obrsoc != 1132){
			 $messageErrorInter += "\nEl paciente NO corresponde a OSTEE.";
			 isValid = false;
		 }
	 }
	*/
	
	
	 if(asivm_rel_buscar_admision.adm_fecaltaefec > 0){
		 $messageErrorInter += "\nEl paciente egresó del Sanatorio.";
		 isValid = false;
	 }
	 
	if(asivm_rel_buscar_habita.getSize() == 0){
		 $messageErrorInter += "\nEl paciente no esta en U.C.";
		 isValid = false;
	 }
	 else{
		 var utiliza = asivm_numero_to_tbc_admision.adm_utiliza
		 if( asivm_rel_buscar_habita.hab_sector != 28 && (utiliza!=4 || utiliza!=5  && asivm_rel_buscar_habita.hab_sector != 38)  ){
			 $messageErrorInter += "\nEl paciente no esta en U.C.";
			 isValid = false;
		 }
	 }
	 
	 if(!isValid){
		 globals.DIALOGS.showWarningDialog("Atención!", $messageErrorInter, "Aceptar")
	 }
	
	return isValid;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param value
 *
 * @properties={typeid:24,uuid:"1A1D8884-485F-4F2C-8DE1-356D4ED64626"}
 */
function editablePaciente(value) {
	elements.txt_paciente.editable = value;
	elements.btn_buscarPaciente.enabled = value;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"7C0CF485-28E2-468A-9B3A-65FF238C4467"}
 * @AllowToRunInFind
 */
function onAction_btnNuevo(event) {
	/*forms.AsiVm_Evolucion_Uco.elements.btn_grabar.enabled=false;
	scopes.globals.InicializarDatosDeRelacion(asivm_fichakine, "asistencial", "tbc_hojauco")

	var habilitarCampos=function(nombreForm,nameField ){
		if(nombreForm!=null && nameField!=null ){
			  forms[nombreForm].elements[nameField].readOnly = false;
		}
	}

	globals.modificarCampos("AsiVm_Evolucion_Uco", habilitarCampos,null);*/
	
	
	
	/*var limpiar = false;
	if ($isDirty) {
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!', 'Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No');
		if (respuesta == 'Si')
			limpiar = true;
	} else {
		limpiar = true;
	}

	if (limpiar) {
		
		if($_AsiVm_Ficha_Inicio_Recurso_Tomado){
			globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),asivm_numero_to_tbc_admision.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Hoja de Servicio Uco");
			//globals.AsiVm_Ficha_Inicio_bloqueado= false
		}
		limpiarForm();
	}*/
	
	limpiarForm();
}

/**
 * @properties={typeid:24,uuid:"E8517995-E783-4EC7-944A-08EBBFBF1C91"}
 */
function limpiarForm() {

	databaseManager.revertEditedRecords();

	inicializarForm();

	//elements.txt_paciente.requestFocus();
	//elements.txt_paciente.requestFocus();
	$isDirty = false;

}

/**
 * @properties={typeid:24,uuid:"6E7D807A-0392-43B4-868D-67FB92579C35"}
 */
function inicializarForm() {
	
//	globals.AsiVm_ficha_id = 0;
	f_altura = 0
	f_marca_arm = -1
	f_peso_predicho = 0
	f_peso_estimado = 0
	f_cama = ''
	f_diagnostico = ''
	f_antecedentes = 0
	f_saps_II = 0
	f_mortalidad_predicha_saps_II = 0
	f_score_charlson = 0
	f_sobrevida= 0
	f_glasgow = 0
	//f_motivo = asivm_fichakine.motivo
	f_ingreso_uci = 0
	//f_inicio_vm=asivm_fichakine.fecha_inicio_vm
	f_observaciones = ''
	f_observaciones_otras=''
	globals.AsiVm_fecha_obs = ''
	f_con_soporte = 0
	f_sin_soporte = 0
	f_tiene_soporte = 0
	f_motivo = ""
//	globals.Asivm_prestacion=0
	elements.cbo_motivo_vm.visible=false
	elements.cbo_motivo_vni.visible=false
	elements.cbo_motivo_caf.visible=false
	elements.grp_ficha_inicio.visible=false
	elements.grp_prestacion.visible=false
	globals.Asivm_prestacion=0
	globals.AsiVm_estado_uso_equipo=0
	f_fecha_inicio_ventilacion=null
	f_enUso = ''
	f_equipo=''
	f_modelo=''
	f_marca=''
	f_cerrarForm=false
	elements.enUso.bgcolor='#ffffff'
	//elements.lbl_procesando.visible = false;
	application.updateUI();
//	forms.AsiVm_Ficha_Inicio
//	forms.AsiVm_Ficha_Inicio.controller.recreateUI();
	//visibleBody(false);
	//editablePaciente(true);
	
//	application.updateUI();
	// Inicializando impresion
//	forms.AsiVm_Print.onShow_inicializarForm(true,null);
}

/**
 * 
 * @param {Boolean} value
 *
 * @properties={typeid:24,uuid:"5695FF2B-F3D0-403F-A9BC-A226E5948EC9"}
 */
function visibleBody(value) {

	elements.tab_informe_1.visible = value;
	elements.tab_informe_2.visible = value;
	elements.shs_informe.visible = value;

	if (value) {
		elements.tab_informe_1.tabIndex = 1;
		elements.tab_informe_2.tabIndex = 1;
	}
	elements.grp_diagnostico.visible = value;
	elements.grp_signovitale.visible = value;
	elements.btn_buscarPatologia1.visible = value;
	elements.btn_buscarPatologia2.visible = value;
	elements.btn_buscarPatologia3.visible = value;
	
	elements.lbl_arm.visible = value;
	elements.cbo_arm.visible = value;
	elements.shs_arm.visible = value;
	// TODO elements.grp_solicitud.visible = value;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"85945CF0-C5B2-4BAB-BCF0-A0E981A4DA62"}
 * @AllowToRunInFind
 */
function onAction_btnGuardar(event) {


	elements.txt_observaciones.requestFocus()
	if(globals.errorDato){//ultimo onchange valido
		
		var res = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿ Esta seguro que desea guardar el seguimiento de soporte ventilatorio ?', 'Si', 'No');
				
		if (res == 'Si') {
			
			if ($isDirty) {
	
				if (isValidDataForm()) {
					if (isValidData()) {
						var fecha = 0;
						var hora = 0;
						var nuevoHciint = false;
						$_fechaHoraRegistro= application.getServerTimeStamp()
						if (asivm_fichakine.fecha == null) { //  ficha nueva miro fecha o si es mayor a uno
							asivm_fichakine.newRecord();
							scopes.globals.InicializarDatosDeRelacion(asivm_fichakine, "desal", "tbl_ficha_kine")
	//						fecha = utils.stringToNumber(globals.CapturaFechaSistema());
	//						hora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
							
							// Completando cabecera
							//globals.AsiVm_hisclin = asivm_rel_buscar_admision.adm_histclin;
							asivm_fichakine.histcli = asivm_rel_buscar_admision.adm_histclin;
							asivm_fichakine.histcli_unico = asivm_rel_buscar_admision.adm_histclinuni
							asivm_fichakine.nombre_paciente = asivm_rel_buscar_admision.adm_apelnom;
							
							if(f_tiene_soporte==2){
//								asivm_fichakine.fecha_inicio = $_fechaHoraRegistro
//								asivm_fichakine.fecha = $_fechaHoraRegistro
								asivm_fichakine.fecha_inicio_ventilacion= f_fecha_inicio_ventilacion
								asivm_rel_admision_arm.admarm = f_marca_arm
								asivm_fichakine.marcaarm=f_marca_arm
//								asivm_fichakine.arm = f_marca_arm // dejo constancia de como guardo arm.
//								asivm_fichakine.fecha_inicio = $_fechaHoraRegistro
								asivm_fichakine.fecha = $_fechaHoraRegistro
								//equipo asignado // al momento de grabar ficha.
								// Si se cambia equipo por otros medios, esto esta desactualizado, se debe crear otra ficha
	//							asivm_fichakine.equipo=asivm_rel_respirador.rsp_codint
	//							asivm_fichakine.marca=asivm_rel_respirador.rsp_marca
	//							asivm_fichakine.modelo=asivm_rel_respirador.rsp_modelo
								
							}else{
								asivm_fichakine.fecha = $_fechaHoraRegistro;
								asivm_rel_admision_arm.admarm = 0
								asivm_fichakine.marcaarm=0
//								asivm_fichakine.fecha_inicio = $_fechaHoraRegistro
								asivm_fichakine.fecha_inicio_ventilacion= null
//								f_marca_arm=0 // si no tiene soporte, no deberia tener arm.
							}
	//						asivm_fichakine.fecha_ingreso_uci = 
							//scopes.globals.AsiVm_fecha_Ficha = fechahora
							if(!globals.IsBlank(f_ingreso_uci)){
								asivm_fichakine.fecha_ingreso_uci = utils.parseDate(f_ingreso_uci,'dd/MM/yyyy hh:mm aa')
							}else{
								asivm_fichakine.fecha_ingreso_uci = null
							}
							//asivm_fichakine.huchora = hora;
							//asivm_fichakine.huctipomed = globals.Srv_Login_Sanatorio_vTipoOperador;
							asivm_fichakine.kinesiologo_lega = globals.Srv_Login_Sanatorio_vLega;
						//	asivm_fichakine.hucfecha2 = fecha;
						//	asivm_fichakine.huchora2 = hora;
							//asivm_fichakine.hucapyno = utils.stringTrim(asivm_rel_buscar_admision.adm_apelnom);
							//asivm_fichakine.huchabi = asivm_rel_buscar_admision.adm_habita;
							asivm_fichakine.cama = asivm_rel_buscar_admision.adm_cama;
							asivm_fichakine.sexo = asivm_rel_buscar_admision.adm_sexo
//							asivm_fichakine.fecha_fin = null
//							asivm_fichakine.fecha_egreso_sanatorio = null
//							asivm_fichakine.fecha_egreso_uci = null
							asivm_fichakine.con_soporte_ventilatorio = f_tiene_soporte
							asivm_fichakine.lugar_internacion = f_lugar_internacion
							asivm_fichakine.edad = globals.CalculoEdad(asivm_rel_buscar_admision.adm_fecnac)
							
							//asivm_fichakine.con_soporte_ventilatorio=f_tiene_soporte
							//asivm_fichakine.hucutiliza = asivm_rel_buscar_admision.adm_utiliza;
							//asivm_fichakine.hucespec = globals.Srv_Login_Sanatorio_vEspeMed;
						}
						else{
							scopes.globals.AsiVm_fecha_Ficha=asivm_fichakine.fecha
//							fecha = utils.stringToNumber(globals.CapturaFechaSistema());
//							hora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
						}
						// Actualizando base de datos
						try {
							guardarDatos();
							var saveResultArmAdmision = true
							var resultSaveArmUso = true
	//						asivm_fichakine.hucpulsofrecuencia=''
							databaseManager.startTransaction();
						
							var resultSave = databaseManager.saveData(asivm_fichakine.getRecord(1));
							//Informo admision arm.
							if(resultSave==true && f_tiene_soporte==2){
								saveResultArmAdmision =globals.saveMarcaArmAdmision(f_marca_arm)
								//informo al ARM USO INICIO DE ARM
								if(saveResultArmAdmision==true && resultSave==true && f_marca_arm==1 && asivm_rel_asistencial_arm_uso_abierta.getSize()==0 ){
									resultSaveArmUso = globals.saveArmUsoInicio(asivm_rel_buscar_admision.adm_histclin,f_fecha_inicio_ventilacion )
									//si falla que hago? rollback!! de marca admision?
								}
							}
							if(f_tiene_soporte==1 || f_marca_arm==0 ){//si crea sin soporte o ARM EN No y tiene ventilacion arm en si. informar rend
			
//								scopes.globals.AsiVm_adm_HistClin= asivm_rel_buscar_admision.adm_histclin
								if(resultSave==true && asivm_rel_admision_arm.getSize()==1){ //actualizo marcaArrm siempre en admision
									saveResultArmAdmision =globals.saveMarcaArmAdmision(0)
									//finaliza arm
									if(saveResultArmAdmision==true && resultSave==true && asivm_rel_asistencial_arm_uso_abierta.getSize()==1){// luego mirar porque debe ser la ultima
										var fechaIngresoArmUso =asivm_rel_asistencial_arm_uso_abierta.armusofecing
										var horaIngresoArmUso =asivm_rel_asistencial_arm_uso_abierta.armusohoring
										var isSaveArmUso = globals.saveArmUsoFin(asivm_rel_buscar_admision.adm_histclin,$_fechaHoraRegistro)
										if(isSaveArmUso==true){//informar a rend cab y det
											//Defini variables rend y rendcab
											globals.AsiVm_Mod_rcHClinica=asivm_rel_buscar_admision.adm_histclin
											globals.AsiVm_Mod_rcPeriodo=utils.dateFormat($_fechaHoraRegistro,'yyyyMM')
											globals.AsiVm_Mod_rcCierre =1
											globals.AsiVm_Mod_rcAdmision=0 //internados
											globals.AsiVm_Mod_rcEmpresa=1
											globals.AsiVm_Mod_ploObra = asivm_rel_admision_arm.adm_obrsoc;
											globals.AsiVm_Mod_ploPlanx10 = asivm_rel_admision_arm.adm_planobr

											var isSaveRendDet = globals.saveRendDet(globals.AsiVm_Mod_rcHClinica,$_fechaHoraRegistro, fechaIngresoArmUso, horaIngresoArmUso)
											if(isSaveRendDet==true){
												globals.saveRendCab(asivm_rel_buscar_admision.adm_histclin,$_fechaHoraRegistro);
											}
											
										}
										//si falla que hago? rollback!!
									}
							}
							}	
						} catch (e) {
							resultSaveArmUso=false
							saveResultArmAdmision=false
							plugins.dialogs.showInfoDialog("Error. Revise que no haya iniciado un ARM con misma fecha inicio ventilacion(Ciclo de ARM), por favor!",e.toString(),"ok")							// TODO: handle exception
							//plugins.Log.error("ERROR PERSISTENCIA - ", e.message);
						}
						
						if (resultSave == true && saveResultArmAdmision==true && resultSaveArmUso==true) {
							databaseManager.commitTransaction();
							elements.btn_imprimir.enabled=true
							globals.DIALOGS.showWarningDialog("Grabado!", "Se registro correctamente su ficha")
							if(f_tiene_soporte==2){ //si tiene soporte! cargar monitoreo.
								
								//cargar equipo
	//							verificarARM();
	
								//recupero la ficha guardada anteriormente.
								scopes.globals.AsiVm_fecha_Ficha = $_fechaHoraRegistro
//								scopes.globals.AsiVm_fecha_Ficha
								scopes.globals.AsiVm_hisclin = asivm_rel_buscar_admision.adm_histclin;
								scopes.globals.AsiVm_adm_HistClin= asivm_rel_buscar_admision.adm_histclin;
//								scopes.globals.AsiVm_adm_HistClin
								scopes.globals.AsiVm_ficha_id = asivm_fichakine_seguimiento.ficha_id
								
								//globals.AsiVm_ficha_id = asivm_fichakine.fichavm_id
								elements.btn_monitoreos.visible=true
								elements.btn_report_monitoreo.visible=true
//								if(asivm_fichakine.getSize()==1){
									
//									globals.AsiVm_ficha_id = asivm_fichakine.fichavm_id
//									var win3 = application.createWindow("monitoreo", JSWindow.MODAL_DIALOG);
//									win3.title = 'Monitoreo';
//									win3.resizable = false;
//									win3.show(forms.AsiVm_Monitoreo);
//								}
								/*var $win = application.getWindow("ficha_inicio");
								if ($win != null) {
									$win.hide();
									$win.destroy();
								}*/
								
							}
							if(f_tiene_soporte==1){
//								elements.btn_observaciones.visible=true
//								scopes.globals.AsiVm_ficha_id = asivm_fichakine_seguimiento.ficha_id
							}
							
							$isDirty = false;
							
						} else {
							var error1 = ''
							var error2 = ''
							var array = databaseManager.getFailedRecords()
							for (var i = 0; i < array.length; i++) {
								var record = array[i];
								var jstable = databaseManager.getTable(record);
								var tableSQLName = jstable.getSQLName();
								error1 = 'Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
								error2 = 'Error en grabación ' + record.exception;
								if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
									// exception thrown in pre-insert/update/delete event method
									var thrown = record.exception.getMessage()
									//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
								}
							}
	
							databaseManager.rollbackTransaction()
	
							if (error1 != '') {
								globals.DIALOGS.showErrorDialog("Error de grabación", "Record validation failed: " + thrown)
								globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error1, "Aceptar")
								globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico", error2, "Aceptar")
							}
//							globals.DIALOGS.showErrorDialog("Error en grabación", "Se ha producido un error de grabación. " + '\n' + "Avise a Sistemas, por favor.", "Aceptar")
						elements.btn_grabar.enabled=true
						}
					}
				}
			} else {
				globals.DIALOGS.showWarningDialog("Atención!", "No hay datos para guardar.", "Aceptar")
				elements.txt_paciente.requestFocus();
			}
		
		} else
			elements.txt_paciente.requestFocus();
	}
}


/**
 * @properties={typeid:24,uuid:"DCF371D2-455A-4E58-B648-4C520AB868E3"}
 */
function verificarARM(){
	// ACC-ARM
	tratamientoARM();
	// Paciene en ARM : SI : 1

	if(globals.AsiArmTrs_Mod_wGraboARM){

		if(!$_wHayArm){

			grabarCodAuto();
		}else{
			//asiutitrs_rel_tbc_hciti_to_tbc_hciti.hit=1;
			asivm_fichakine.fecha_inicio_ventilacion=globals.AsiArmTrs_Mod_wFecha
//			asiutitrs_rel_tbc_hciti_to_tbc_hciti.hitfecinicioarm = globals.AsiArmTrs_Mod_wFecha
			var guardoDataArmAsociado = databaseManager.saveData(asivm_fichakine);
		}
	}

}

/**
 * 
 * @param {Number} histClin
 * @param {Number} fecha
 * @param {Number} hora
 * @param {Number} item
 * @param {String} texto
 *
 * @properties={typeid:24,uuid:"409E2484-4CCC-488F-99CD-B97FC3A9D04D"}
 */
function guardarTexto(histClin, fecha, hora, grupo, item, texto) {

	globals.AsiVm_txtHistClinica = histClin;
	globals.AsiVm_txtFecha = fecha;
	globals.AsiVm_txtHora = hora;
	globals.AsiVm_txtItem = item;
	globals.AsiVm_txtGrupo = grupo;
	
	if (asivm_rel_buscar_hojaucotxt==null || asivm_rel_buscar_hojaucotxt.getSize() == 0) {
		

		asivm_rel_buscar_hojaucotxt.newRecord();
		asivm_rel_buscar_hojaucotxt.histclinica = histClin;
		asivm_rel_buscar_hojaucotxt.fecha = fecha;
		asivm_rel_buscar_hojaucotxt.hora = hora;
		asivm_rel_buscar_hojaucotxt.grupo = grupo;
		asivm_rel_buscar_hojaucotxt.item = item;

	}

	asivm_rel_buscar_hojaucotxt.linea = utils.stringTrim(texto);
	return databaseManager.saveData(asivm_rel_buscar_hojaucotxt.getRecord(1));

}

/**
 * @properties={typeid:24,uuid:"85AB3FE6-0A2B-43D7-ABDD-56917AC9E7AD"}
 */
function isValidDataForm() {
	globals.isValid = true;
	globals.messageError = "No ha sido posible guardar la ficha. Corrija los siguientes errores y vuelva a intentar."		//var borderError = 'LineBorder,1,#ff0000';
	
	//  INICIO VALIDADOR MASIVO GENERICO 
	globals.validateRequired("AsiVm_Ficha_Inicio",true,'txt_',false,0);
	
	if(f_tension_arterial_min>f_tension_arterial_max){
		globals.messageError += "\n La Tensión Arterial Mínima debe ser menor o igual a la Máxima.";
		globals.isValid = false;
	}
	if(f_tiene_soporte==2){
		if(f_glasgow<3 || f_glasgow>15){
			globals.messageError += "\n El valor de glasgow debe estar entre 3 y 15.";
			globals.isValid = false;
		}
		
		 if(f_marca_arm==-1 || f_marca_arm==null){
				globals.messageError += "\n El valor de Marca ARM debe ser cargada.";
				globals.isValid = false;
		}
		 if(f_marca_arm!=-1){
			var resArm = globals.DIALOGS.showQuestionDialog('¡Atención!', '¿ Esta seguro de cargar el ARM en: '+application.getValueListDisplayValue('AsiVm_vl_SINO_ARM',f_marca_arm)+'?. Recuerde!. Este campo notifica un cierre o un nuevo ciclo de ARM', 'Si', 'No');
			if(resArm=='No'){
				globals.messageError += "\n Por favor Asegurese el ARM que corresponde.";
				globals.isValid = false;
			}
		 }
	
	
	
	}
	
//
//	if(globals.isValid==false){
//		 globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
//	}
//	 
	
	

	/*
	if(forms.AsiVm_tab_Varios.f_varios_balance_diario>99999 || forms.AsiVm_tab_Varios.f_varios_balance_diario<0){
		isValid = false
		messageError += "\nValor Balance diario debe ser mayor a 0 y menor a 99999";
	}*/
	// fin val arm 
	if (!globals.isValid) {
		globals.DIALOGS.showWarningDialog("¡Atención!", globals.messageError, "Aceptar")
	}

	return globals.isValid;
}

/**
 * @properties={typeid:24,uuid:"303BCB16-27F8-4C2E-BD42-45B72848335F"}
 */
function isValidData() {

	 isValid = true;
	//var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
		//var borderError = 'LineBorder,1,#ff0000';
		//setDefaultBorderElements();
		/*
	 if(isValid){

	 if(f_protocolo == null){

	 var res = globals.DIALOGS.showQuestionDialog('¡Atención!','¿ Desea Guardar Ingreso de Historia Clinica de Cirugia sin Protocolo ?', 'Si', 'No');
	 if( res == 'Si'){
	 }
	 else{

	 messageError += "\nHistoria Clinica de Cirugia sin Protocolo."
	 isValid = false;
	 }
	 }
	 }
	 else{
	 globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
	 elements.txt_paciente.requestFocus();
	 }
	 */
	

	 return isValid;

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"24BCD3CE-7CA2-4F12-8321-183238D37140"}
 * @AllowToRunInFind
 */
function onAction_btnCerrar(event) {
	controller.recreateUI()
	forms.AsiVm_ficha_kine.cargarDatosPaciente()
	if ($isDirty) {
		if (globals.DIALOGS.showQuestionDialog('¡Atención!', 'Existen datos que no han sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			f_cerrarForm = true;
	} else {
		f_cerrarForm = true;
	}

	if (f_cerrarForm) {	
		cerrarForm();
	}
	limpiarForm()
	//volver a buscar

	//scopes.globals.AsiVm_hisclin = histcli
	//forms.AsiVm_ficha_kine.foundset.clear()
	//forms.AsiVm_ficha_kine.controller.find()
	 //forms.AsiVm_ficha_kine.foundset.clear()
	 
	 forms.AsiVm_ficha_kine.realizarBusquedaGrilla();
			
//	 forms.AsiVm_ficha_kine.foundset.find();
	// forms.AsiVm_ficha_kine.controller.search()
}

/**
 * @properties={typeid:24,uuid:"FF973193-5861-4D6E-A2AB-5A3271515B60"}
 */
function cerrarForm(){
	var relacion = asivm_rel_buscar_admision
	if(asivm_rel_buscar_admision.getSize()==0 && asivm_rel_buscar_admision_con_alta.getSize()>0){
		relacion = asivm_rel_buscar_admision_con_alta
	}
	
	
	if(relacion.getSize() > 0){
		if(globals.AsiVm_Ficha_Inicio_bloqueado){
			globals.AsistFunciones_unLockRegisterTable(application.getSolutionName(),controller.getName(),relacion.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Ficha Kinesiológica");
		}
	}
	var $win = application.getWindow(application.getActiveWindow().getName());
	if ($win != null) {
		$win.hide();
		$win.destroy();
	}
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"06760226-DCA5-4D67-9B9D-FD4117F512AD"}
 */
function onHide_cerrarForm(event) {
	
	if(!f_cerrarForm)
		globals.DIALOGS.showInfoDialog("Atención","Para cerrar el programa debe presionar el boton Salir.","Aceptar")
	return f_cerrarForm;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"CF5AE830-55EE-4C6E-872A-2C79ABE7EBC8"}
 */
function onAction_buscarPatologia_1(event) {

	globals.AsiVm_patDataProvider = 'hucpat1';
	openBuscarPatologia();

}

/**
 * @properties={typeid:24,uuid:"0F6EDE54-51A2-4E48-B16D-7D3D28F61217"}
 */
function openBuscarPatologia() {

	if(!$_AsiVm_Ficha_Inicio_READ_ONLY){
		var win2 = application.createWindow("seleccion_patologia", JSWindow.MODAL_DIALOG);
		win2.title = 'Búsqueda de Diagnóstico';
		win2.resizable = false;
		win2.show(forms.AsiVm_dlg_buscar_patologia);
	}


}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"7639DD8C-1DCF-4081-B35B-875B05EC36D7"}
 */
function onAction_buscarPatologia_2(event) {

	if(forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico2.editable==true){
		globals.AsiVm_patDataProvider = 'hucpat2';
		openBuscarPatologia();
	}
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4F8DE26F-CC1D-4E79-A51C-783187A8C98D"}
 */
function onAction_buscarPatologia_3(event) {

	if(forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico3.editable==true){
		globals.AsiVm_patDataProvider = 'hucpat3';
		openBuscarPatologia();
	}

}

/**
 * @properties={typeid:24,uuid:"9793FF08-B69D-460F-B796-D4DCD1327406"}
 */
function tieneAlertas() {

	var value = false;

	var dataprovidersNames = asivm_rel_alerta.alldataproviders;
	for (var i = 0; i < dataprovidersNames.length; i++) {
		if (asivm_rel_alerta[dataprovidersNames[i]] == 1) {
			value = true;
			break;
		}
	}

	return value;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Date} Fecha_Desde
 * @param {Date} Fecha_Hasta
 *
 * @properties={typeid:24,uuid:"E4440667-C8BA-40D4-809A-421BA3203E13"}
 */
function contar_dias(Fecha_Desde, Fecha_Hasta) {
	// El hasta dede ser mayor al desde
	var $contar = 0;

	var $x = Fecha_Hasta - Fecha_Desde//diferencias entre dos dias y lo muestra en milisegundos
	var $un_dia = 1000 * 60 * 60 * 24 //ms * sec * min * hrs de un día
	var $dif_dias = $x / $un_dia //calcula la diferencia en días
		//$contar = Math.ceil($dif_dias )   //redondea
	//$contar = Math.round($dif_dias)
	$contar = Math.floor($dif_dias) //redondea

	return $contar
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} realValue
 *
 * @properties={typeid:24,uuid:"8B343E03-1250-4B8A-AEEA-39BE01C759D1"}
 */
function convertNumberToHour_HHMM(realValue) {

	var hora = "";
	if (realValue != null) {
		var value = realValue;
		if (value < 1) {
			hora = "00:00";
		} else {
			if (value < 10) {
				hora = "00:0" + value.toString().substr(0, 1);
			} else {
				if (value < 100) {
					hora = "00:" + value.toString().substr(0, 2);
				} else {
					if (value < 1000) {
						hora = "0" + value.toString().substr(0, 1) + ":" + value.toString().substr(1, 2);
					} else {
						if (value <= 2359) {
							hora = value.toString().substr(0, 2) + ":" + value.toString().substr(2, 2);
						}
					}
				}
			}
		}
	}

	return hora;
}

/**
 * Callback method when the user changes tab in a tab panel or divider position in split pane.
 *
 * @param {Number} previousIndex index of tab shown before the change
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"6E6F7671-DEFA-408A-A31C-4A32014FB84B"}
 */
function onTabChange_informe_1(previousIndex, event) {

	elements.tab_informe_1.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_1.setTabFGColorAt(elements.tab_informe_1.tabIndex, '#3336ff');
	var current = forms.AsiVm_Evolucion_Uco.elements.tab_informe_1.tabIndex;
	
	var nameTab= forms.AsiVm_Evolucion_Uco.elements.tab_informe_1.getTabFormNameAt(current);
	if(forms[nameTab].elements[0]!=undefined && nameTab!='AsiVm_txt_examen_fisico'){
		forms[nameTab].elements[0].requestFocus();
	}
	
	/*if(forms[nameTab].elements[0]!=undefined && nameTab!='AsiVm_Ti_Examen_Fisico'){
		forms[nameTab].elements[0].requestFocus();
	}*/
	
	/*elements.tab_informe_1.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_1.setTabFGColorAt(elements.tab_informe_1.tabIndex, '#3336ff');
	
	if(elements.tab_informe_1.tabIndex == 1)
		forms.AsiVm_txt_alerta.elements.chk_alergia.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 2)
		forms.AsiVm_txt_motivo_ingreso.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 3)
		forms.AsiVm_txt_motivo_consulta.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 4)
		forms.AsiVm_txt_enfermedad_actual.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 5)
		forms.AsiVm_txt_antec_personal.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_1.tabIndex == 6)
		forms.AsiVm_txt_antec_familiar.elements.tea_texto.requestFocus();*/
}

/**
 * Callback method when the user changes tab in a tab panel or divider position in split pane.
 *
 * @param {Number} previousIndex index of tab shown before the change
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"48F9BF6D-2A6C-493B-89AC-E40285A866BE"}
 */
function onTabChange_informe_2(previousIndex, event) {

	elements.tab_informe_2.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_2.setTabFGColorAt(elements.tab_informe_2.tabIndex, '#3336ff');
	var current2 = forms.AsiVm_Evolucion_Uco.elements.tab_informe_2.tabIndex;
	
	var nameTab2= forms.AsiVm_Evolucion_Uco.elements.tab_informe_2.getTabFormNameAt(current2);
	
	if(forms[nameTab2].elements[0]!=undefined){
		forms[nameTab2].elements[0].requestFocus();
	}
	
	/*elements.tab_informe_2.setTabFGColorAt(previousIndex, '#000000');
	elements.tab_informe_2.setTabFGColorAt(elements.tab_informe_2.tabIndex, '#3336ff');
	
	if(elements.tab_informe_2.tabIndex == 1)
		forms.AsiVm_txt_examen_clinico.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 2)
		forms.AsiVm_txt_examen_complementario.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 3)
		forms.AsiVm_txt_comentario_ingreso.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 4)
		forms.AsiVm_txt_plan_terapeutico.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 5)
		forms.AsiVm_txt_diagnostico_diferencial.elements.tea_texto.requestFocus();
	
	if(elements.tab_informe_2.tabIndex == 6)
		forms.AsiVm_txt_mediacion_habitual.elements.tea_texto.requestFocus();*/
}


/**
 * @properties={typeid:24,uuid:"053753D6-1FE2-4D51-86FD-D085E00F35A6"}
 */
function imprimirVm() { //histClin, fecha, hora
	
	var texto = '';
	
	texto = '¿Desea imprimir los datos de ficha?';
	
	var print = globals.DIALOGS.showQuestionDialog('¡Atención!', texto, 'Si', 'No');
	if (print == 'Si') {

		forms.frm_asivm_template_html.imprimirVm(asivm_fichakine.histcli,asivm_fichakine.fecha,1);
		
	}
}


/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"849085C7-1854-4D18-B3A9-EE5207D029F2"}
 */
function onDataChange_txtFieldPatologia1(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	validarPatologia(f_patologia1,'hucpat1');
	$isDirty = true;
	return true
}

/**
 * TODO generated, please specify type and doc for the params
 * @param oldValue
 * @param newValue
 * @param event
 *
 * @properties={typeid:24,uuid:"7AFB7D70-3857-421B-8F62-9296D939F0AE"}
 */
function onDataChange_txtFieldPatologia2(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	validarPatologia(f_patologia2,'hucpat2');
	$isDirty = true;
	return true
}

/**
 * TODO generated, please specify type and doc for the params
 * @param oldValue
 * @param newValue
 * @param event
 *
 * @properties={typeid:24,uuid:"054F5CB5-8F03-4190-A7F2-44FFF706EF80"}
 */
function onDataChange_txtFieldPatologia3(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	validarPatologia(f_patologia3,'hucpat3');
	$isDirty = true;
	return true
}

/**
 * @AllowToRunInFind
 * 
 * TODO generated, please specify type and doc for the params
 * @param patologia
 * @param secPatologia
 *
 * @properties={typeid:24,uuid:"8AC993EB-8395-4463-8818-A811F3CECFA2"}
 */
function validarPatologia(patologia, secPatologia){ //htidiagnos1, htidiagnos2, htidiagnos3
	var codigo=0;
	if(patologia==null || globals.IsBlank(patologia)){
		patologia="";
	}
	if(patologia!=0  && (!isNaN(patologia) && utils.stringToNumber(patologia)>2147483647)){
		plugins.dialogs.showInfoDialog("Valor Diagnostico","valor no valido","ok")
		return;
	}
	
	// si es codigo
	if(!globals.IsBlank(patologia) && !isNaN(patologia)){
		codigo= utils.stringToNumber(patologia);
		switch (secPatologia) {
		case 'hucpat1':
			asivm_fichakine.asivm_rel_buscar_patologia_1.pat_codi=codigo;
			asivm_fichakine[secPatologia]=codigo;
			f_descripcion_patologia1=asivm_fichakine.asivm_rel_buscar_patologia_1.pat_descrip
			forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico2.editable=true;
			if(asivm_fichakine.asivm_rel_buscar_patologia_1.getSize()==0){
				asivm_fichakine[secPatologia]=0;
				forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico2.editable=false;
				f_patologia2='';
			}
			break;
		case 'hucpat2':
			asivm_fichakine.asivm_rel_buscar_patologia_2.pat_codi=codigo;
			asivm_fichakine[secPatologia]=codigo;
			f_descripcion_patologia2=asivm_fichakine.asivm_rel_buscar_patologia_2.pat_descrip
			forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico3.editable=true;
			if(asivm_fichakine.asivm_rel_buscar_patologia_2.getSize()==0){
				asivm_fichakine[secPatologia]=0;
				forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico3.editable=false;
				f_patologia3='';
				
			}
			break;
		case 'hucpat3':
			asivm_fichakine.asivm_rel_buscar_patologia_3.pat_codi=codigo;
			asivm_fichakine[secPatologia]=codigo;
			f_descripcion_patologia3=asivm_fichakine.asivm_rel_buscar_patologia_3.pat_descrip
			if(asivm_fichakine.asivm_rel_buscar_patologia_3.getSize()==0){
				asivm_fichakine[secPatologia]=0;
			}
			break
		
		default:
			break;
		}
		
	}
	else{ 
		
		
	/*	switch (secPatologia) {
		case "hucpat1":
			forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico2.editable=true;
			forms.AsiVm_Evolucion_Uco.f_patologia1=foundset.pat_codi;
			forms.AsiVm_Evolucion_Uco.f_descripcion_patologia1 = foundset.pat_descrip
			break;
		case "hucpat2":
			forms.AsiVm_Evolucion_Uco.elements.txt1_diagnostico3.editable=true;
			forms.AsiVm_Evolucion_Uco.f_patologia2=foundset.pat_codi;
			forms.AsiVm_Evolucion_Uco.f_descripcion_patologia2 = foundset.pat_descrip
			break;
		
		case "hucpat3":
			forms.AsiVm_Evolucion_Uco.f_patologia3=foundset.pat_codi;
			forms.AsiVm_Evolucion_Uco.f_descripcion_patologia3 = foundset.pat_descrip
			break;

		default:
			break;
		}
		*/
		
		/*if(!globals.IsBlank(patologia)){
			f_pendienteDeSeleccion=true;
		}else{
			asiutitrs_rel_tbc_hciti_to_tbc_hciti[secPatologia]=0;
			switch (secPatologia) {
			case 'hucpat1':
			forms.AsiVm_Evolucion_Uco.elements.txt_diagnostico2.editable=false;
			forms.AsiVm_Evolucion_Uco.elements.txt_diagnostico3.editable=false;
			forms.AsiVm_Evolucion_Uco.f_patologia2="";
			forms.AsiVm_Evolucion_Uco.f_patologia3="";
				break;
			case 'hucpat2':
			forms.AsiVm_Evolucion_Uco.elements.txt_diagnostico3.editable=false;
			forms.AsiVm_Evolucion_Uco.f_patologia3="";
				break;
				
			default:
				break;
			}
		}*/
		
	}
	
	
	$isDirty = true;
	return true
	
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"40F7D21C-8E49-43FB-AE0B-5FCFF8FDE9BB"}
 */
function onDataChange_cboSelect(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	elements.txt_temperatura.requestFocus();
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4DCD89CE-570D-4138-9F8D-F5DD1ABA0A7C"}
 */
function onAction_imprimir(event) {
	
	if (asivm_fichakine.hucfecha > 0) {
		
		if(!$isDirty){
			
			imprimir(asivm_fichakine.huchiscli,asivm_fichakine.hucfecha,asivm_fichakine.huchora);
			//globals.AsiUcoMod_Rep_imprimir(histClin,fecha,hora,1,false,true, 'asivm_fichakine');
		}
		else
			globals.DIALOGS.showInfoDialog("Atención", "No ha sido posible imprimir. Existen modificaciones pendientes para guardar.", "Aceptar")
	} else
		globals.DIALOGS.showWarningDialog("Atención!", "No existe una evolución para imprimir.", "Aceptar");
}

/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"686820D8-FCF2-4FE2-92CC-573D4F8F4B29"}
 */
function onLoad_inicializarForm(event) {
	
	initFormFirstShow();
}

/**
 * @properties={typeid:24,uuid:"D4ACA262-4894-4F98-82A0-38830295DB58"}
 */
function initFormFirstShow(){
	
	inicializarForm()
	/*f_medico = utils.stringTrim(globals.Srv_Login_Sanatorio_vOperador);
	
	if(globals.Srv_Aislamiento_Sanatorio_vTipoOperador == 0){
		
		var ds_personal = databaseManager.getDataSetByQuery('maestros','select per_espemed from tbc_personal where per_legajo = ' + globals.Srv_Login_Sanatorio_vLega,null,-1);
		globals.Srv_Login_Sanatorio_vEspeMed = ds_personal.getMaxRowIndex() > 0 ? ds_personal.getValue(1,1) : 0;
	}	
	else{
		
		var ds_medicos = databaseManager.getDataSetByQuery('maestros','select med_espemed from tbc_medicos where med_codigo = ' + globals.Srv_Login_Sanatorio_vLega,null,-1);
		globals.Srv_Login_Sanatorio_vEspeMed = ds_medicos.getMaxRowIndex() > 0 ? ds_medicos.getValue(1,1) : 0;
	}*/
}

/**
 * 
 * @param {Number} value
 *
 * @properties={typeid:24,uuid:"80E16052-7BEB-4781-9625-DD37466A174C"}
 */
function formatear_HistClinInter(value)
{
	var hiscli1 = value.toString();
	switch (hiscli1.length){
		case 2:	hiscli1 = hiscli1.substr(0,1)+'/'+hiscli1.substr(1,1);break;
		case 3:	hiscli1 = hiscli1.substr(0,2)+'/'+hiscli1.substr(2,1);break;
		case 4:	hiscli1 = hiscli1.substr(0,3)+'/'+hiscli1.substr(3,1);break;
		case 5:	hiscli1 = hiscli1.substr(0,4)+'/'+hiscli1.substr(4,1);break;
		case 6:	hiscli1 = hiscli1.substr(0,5)+'/'+hiscli1.substr(5,1);break;
		case 7:	hiscli1 = hiscli1.substr(0,6)+'/'+hiscli1.substr(6,1);break;
		case 8:	hiscli1 = hiscli1.substr(0,7)+'/'+hiscli1.substr(7,1);break;
	}	
	return hiscli1;
}

/**
 * @properties={typeid:24,uuid:"D593C5E1-CFB8-484C-8186-5C836B777F27"}
 */
function tratamientoARM() {
	globals.AsiArmTrs_Mod_wGraboARM = false;
	$_wHayArm = false;
	var wHoraArm = 0;
	var wFecinArm = 0;
	
	// BUSCO-TIENE-ARM
	var sqlArm = "select ArmFecing,ArmHora,ArmFecegr from tbc_arm_dia_noinva"
			   + " where ArmHcli = " + asivm_rel_buscar_admision.adm_histclin
			   + " order by ArmFech desc, ArmHora desc";
			   
	var dsArm = databaseManager.getDataSetByQuery('asistencial',sqlArm,null,-1);
	if(dsArm.getMaxRowIndex() > 0){
		
		$_wHayArm = true;
		if(dsArm.getValue(1,3) == 0){
		
			wFecinArm = dsArm.getValue(1,1);		
			wHoraArm = dsArm.getValue(1,2);
		}
	}
	
	globals.AsiArmTrs_Mod_wNumLega = globals.Srv_Login_Sanatorio_vLega;
	globals.AsiArmTrs_Mod_wTipLega = globals.Srv_Login_Sanatorio_vTipoOperador;
	
	// Existe ARM
	if(wFecinArm != 0){
		
		if(f_arm == 1){
			
			// Paciente en ARM : NO : 1
			globals.DIALOGS.showInfoDialog("Resultado", "Paciente en ARM.\nDebe generar Informe y Dejar Respirador.", "Aceptar");
		}
		else{
			
			// Paciente en ARM : SI : 2
		}
		
		globals.AsiArmTrs_Mod_wHistClin = asivm_rel_buscar_admision.adm_histclin;
		globals.AsiArmTrs_Mod_wFecha = utils.stringToNumber(globals.CapturaFechaSistema());
		globals.AsiArmTrs_Mod_wHora = wHoraArm;
		openARM();
		
	}
	else{
		
		// Paciene en ARM : SI : 2
		if(f_arm == 2){
			
			globals.AsiArmTrs_Mod_wHistClin = asivm_rel_buscar_admision.adm_histclin;
			globals.AsiArmTrs_Mod_wFecha = utils.stringToNumber(globals.CapturaFechaSistema());
			globals.AsiArmTrs_Mod_wHora = utils.stringToNumber(globals.CapturaHoraSistema("HHMM"));
			
			openARM();
		}
	}	   
}

/**
 * @properties={typeid:24,uuid:"7CF5A760-090D-4AE5-86D0-C23A87DC0753"}
 */
function openARM() {
	
	var formName = 'AsiArmTrs_Mod_frm_arm_dia';
	var myform = solutionModel.getForm(formName);
	
	if(myform != null){
		
		
		var bloqueado = globals.AsistFunciones_isRegisterTableLocked(application.getSolutionName(),formName,asivm_rel_buscar_admision.adm_histclin.toString(),globals.Srv_Login_Sanatorio_vLega.toString(),"Asistencia Respiratoria Mecanica", null);
		if(!bloqueado){
			
			globals.AsiArmTrs_Mod_wPaciente = f_paciente;
			var win2 = application.createWindow("tratamiento_ARM", JSWindow.MODAL_DIALOG);
			win2.title = 'Asistencia Respiratoria Mecanica';
			win2.resizable = false;
			win2.show(forms[formName]);
		}
	}
	else
		globals.DIALOGS.showInfoDialog("Resultado", "No existe el formulario de ARM.", "Aceptar");
	
}

/**
 * @properties={typeid:24,uuid:"3AF5BFB4-135C-408D-AAEE-7C4516148901"}
 */
function grabarCodAuto() {
	
	var camaActual = 0;
	
	var sql = "select Cam_UtilActual_1,Cam_UtilActual_2,Cam_UtilActual_3,Cam_UtilActual_4,Cam_UtilActual_5"
		    + ",Cam_UtilAlterna_1,Cam_UtilAlterna_2,Cam_UtilAlterna_3,Cam_UtilAlterna_4,Cam_UtilAlterna_5,Cam_UtilStand"
			+ " from tbc_camas where Cam_Habi = " + asivm_rel_buscar_admision.adm_habita + " and cam_Cama = '" + asivm_rel_buscar_admision.adm_cama + "'";
	var ds = databaseManager.getDataSetByQuery('maestros',sql,null,-1);
	
	if(ds.getMaxRowIndex() > 0){
		
		//Cam_UtilActual_1
		if(ds.getValue(1,1) == 1)
			camaActual = ds.getValue(1,6);//Cam_UtilAlterna_1
		//Cam_UtilActual_2
		if(ds.getValue(1,2) == 1)
			camaActual = ds.getValue(1,7);//Cam_UtilAlterna_2
		//Cam_UtilActual_3
		if(ds.getValue(1,3) == 1)
			camaActual = ds.getValue(1,8);//Cam_UtilAlterna_3
		//Cam_UtilActual_4
		if(ds.getValue(1,4) == 1)
			camaActual = ds.getValue(1,9);//Cam_UtilAlterna_4
		//Cam_UtilActual_5
		if(ds.getValue(1,5) == 1)
			camaActual = ds.getValue(1,10);//Cam_UtilAlterna_5
		
		if(camaActual == 0)
			camaActual = ds.getValue(1,11);//Cam_UtilStand
	}
	
	// Cod Auto
	var empresa = 1;
	var obra = asivm_rel_buscar_admision.adm_obrsoc;
	var planX10 = asivm_rel_buscar_admision.adm_planobr;
	var nomeTipo = 1;
	var nomeCodi = 431110;
	var nomeDesc = '';

	globals.Call_2142_InicializarVariables();
	globals.Call_2142_empresa = empresa;
	globals.Call_2142_obra = obra;
	globals.Call_2142_planX10 = planX10;
	globals.Call_2142_sector = camaActual;
	globals.Call_2142_tipoNome = nomeTipo;
	globals.Call_2142_codiNome = nomeCodi;
	globals.Call_2142_planX = ' ';
	
	sql = "select PloPlanX from tbc_PLAN_OBRA where PloObra = " + obra + " and PloPlanX10 = '" + planX10 + "'";
	ds = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
	if(ds.getMaxRowIndex() > 0)
		globals.Call_2142_planX = ds.getValue(1,1);
	
	// AUTORIZACION-CODAUTO
	globals.Call_2142_ControlCodobra();
	if(globals.Call_2142_ok == true && globals.Call_2142_autori == 1){
		
		var servCodAuto = 22;
		var fecha = utils.stringToNumber(globals.CapturaFechaSistema());
		var hora = globals.CapturaHoraSistema('HHMMSSDD');
		
		asivm_rel_codauto.newRecord();
		inicializarRelacionCodAuto();
		
		asivm_rel_codauto.codautoempr = empresa;
		asivm_rel_codauto.codautoempr5 = empresa;
		asivm_rel_codauto.codautoadmi = 0;
		asivm_rel_codauto.codautoobra = obra;
		asivm_rel_codauto.codautoobra3 = obra;
		asivm_rel_codauto.codautoobra4 = obra;
		asivm_rel_codauto.codautoobra6 = obra;
		
		asivm_rel_codauto.codautohist = asivm_rel_buscar_admision.adm_histclin;
		asivm_rel_codauto.codautohist3 = asivm_rel_buscar_admision.adm_histclin;
		asivm_rel_codauto.codautohist4 = asivm_rel_buscar_admision.adm_histclin;
		asivm_rel_codauto.codautohist5 = asivm_rel_buscar_admision.adm_histclin;
		asivm_rel_codauto.codautohist6 = asivm_rel_buscar_admision.adm_histclin;
		
		asivm_rel_codauto.codautoserv = servCodAuto;
		asivm_rel_codauto.codautoserv3 = servCodAuto;
		asivm_rel_codauto.codautoserv4 = servCodAuto;
		asivm_rel_codauto.codautoserv6 = servCodAuto;
		asivm_rel_codauto.codautofsol = fecha
		asivm_rel_codauto.codautohsol = hora;
		asivm_rel_codauto.codautotipo = nomeTipo;
		asivm_rel_codauto.codautocdar = nomeCodi;
		asivm_rel_codauto.codautosect = camaActual;
		asivm_rel_codauto.codautopedi = 0;
		asivm_rel_codauto.codautotmed = globals.Srv_Login_Sanatorio_vTipoOperador;
		asivm_rel_codauto.codautomedi = globals.Srv_Login_Sanatorio_vLega;
		asivm_rel_codauto.codautoutiliza = asivm_rel_buscar_admision.adm_utiliza;
		asivm_rel_codauto.codautohabita = 0;
		
		if(asivm_rel_buscar_obrasocial.obrmodautpre == 1 || asivm_rel_buscar_obrasocial.obrmodautpre == 3){
			var codAutoEsta = 2;
			asivm_rel_codauto.codautoesta3 = codAutoEsta;
			asivm_rel_codauto.codautoesta4 = codAutoEsta;
			asivm_rel_codauto.codautoesta6 = codAutoEsta;
		}
	
		var sql_query = "select nome_pantalla,nome_descr from tbc_nomencla where nome_tipo = " + nomeTipo + " and nome_codigo = " + nomeCodi;
		var ds_nomencla = databaseManager.getDataSetByQuery('maestros',sql_query,null,-1);
		if(ds_nomencla.getMaxRowIndex() > 0){
			asivm_rel_codauto.codautopant = ds_nomencla.getValue(1,1);
			nomeDesc = utils.stringTrim(ds_nomencla.getValue(1,2));
		}
		else
			asivm_rel_codauto.codautopant = 4;
		
		asivm_rel_codauto.codautoplan = globals.Call_2142_planX;
		asivm_rel_codauto.codautoplan3 = globals.Call_2142_planX;
		asivm_rel_codauto.codautoplan4 = globals.Call_2142_planX;
		asivm_rel_codauto.codautoplan6 = globals.Call_2142_planX;
		
		var isValidSave = databaseManager.saveData(asivm_rel_codauto.getRecord(1));
		if(isValidSave){
			
			var paciente = utils.stringTrim(asivm_rel_buscar_admision.adm_apelnom);
			var afiliado = utils.stringTrim(asivm_rel_buscar_admision.adm_nrobenef);
			enviarEmail(paciente,afiliado,nomeDesc,fecha,camaActual,Number(hora));
		}
	}
}

/**
 * @AllowToRunInFind
 * 
 * @param {String} paciente
 * @param {String} afiliado
 * @param {String} nomeDesc
 * @param {Number} fecha
 * @param {Number} sector
 * @param {Number} hora
 *
 * @properties={typeid:24,uuid:"206FE8C6-610D-4B46-A5DE-1AFA70079A99"}
 */
function enviarEmail(paciente,afiliado,nomeDesc,fecha,sector,hora) {
	
	if(asivm_rel_buscar_obrasocial.obrmodautpre == 1 || asivm_rel_buscar_obrasocial.obrmodautpre == 3){
		
		var mailObrTipo = 2;
		if(asivm_rel_buscar_obrasocial.obr_codigo == 1132)
			mailObrTipo = 4;

		var fs_mailObra = databaseManager.getFoundSet("asistencial","tbc_mail_obra");
		fs_mailObra.find();
		fs_mailObra['mailobr1'] = asivm_rel_buscar_obrasocial.obr_codigo
		fs_mailObra['mailobrtipo'] = mailObrTipo;
		fs_mailObra.search();
		
		if(fs_mailObra.getSize() > 0){
			
			var aux_mail_para = '';
			var aux_mail_cc = '';
			var aux_mail_cco = '';
			var aux_mail_error = '';
			for (var x=1;x<=10;x++){
				
				switch (fs_mailObra['mailobrdestino_'+x]){
					
					case 1:{
						
						if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
							
							if(utils.stringTrim(aux_mail_para).length == 0)
								aux_mail_para = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
							else
								aux_mail_para += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						}
						else
							aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						
					}
					break;
					case 2:{
						
						if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
							
							if(utils.stringTrim(aux_mail_cc).length == 0)
								aux_mail_cc = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
							else
								aux_mail_cc += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						}
						else
							aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					}
					break;
					case 3:{
						
						if(plugins.mail.isValidEmailAddress(utils.stringTrim(fs_mailObra['mailobrmail_'+x]))){
							
							if(utils.stringTrim(aux_mail_cco).length == 0)
								aux_mail_cco = utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
							else
								aux_mail_cco += "," + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
						}
						else
							aux_mail_error += ' ' + utils.stringTrim(fs_mailObra['mailobrmail_'+x]);
					}
					break;
				}
			}
			
			//if(utils.stringTrim(aux_mail_para).length > 0){
				
				// Medico responsable por sector
				var codAutoSect = sector;
				var firmaRecCod = 0;
				
				if( codAutoSect == 2 || codAutoSect == 6 || codAutoSect == 8 || codAutoSect == 9 || codAutoSect == 10 || codAutoSect == 12)
					firmaRecCod = 8017;
				
				if( codAutoSect == 4 || codAutoSect == 05 || codAutoSect == 11)
					firmaRecCod = 7004;
				
				if( codAutoSect == 1 || codAutoSect == 3 || codAutoSect == 13 || codAutoSect == 14 || codAutoSect == 15 || codAutoSect == 16 )
					firmaRecCod = 7127;
				
				// Buscar Medico responsable, imagen y matricula
				var fileNameFirma = "Logo300px.png";//Default
				var matricula = "";
				
				var fs_firmaRec = databaseManager.getFoundSet('maestros','tbc_firma_rec');
				fs_firmaRec.find();
				fs_firmaRec['firmareccod'] = firmaRecCod;
				fs_firmaRec.search();
				
				if(fs_firmaRec.getSize() > 0){
					
					var myMedia = solutionModel.getMedia(utils.stringTrim(fs_firmaRec['firmarecarchjpg']));
					if(myMedia)
						fileNameFirma = fs_firmaRec['firmarecarchjpg'];
					
					matricula = fs_firmaRec['firmarecmatricula'];
				}
	
				var medPerCod = firmaRecCod;
				// Buscar Medico
				var medico = "Dr. ";
				var sqlMedPer = "select MedPerApeynom from tbc_medicos_personal where MedPerCod = " + medPerCod;
				var ds_medPer = databaseManager.getDataSetByQuery("maestros",sqlMedPer,null,-1);
				if(ds_medPer.getMaxRowIndex() > 0 )
					medico += utils.stringTrim(ds_medPer.getValue(1,1));
				
				//Buscar Diagnostico
				var diagnostico = 'Dx : ';
				var patCie = asivm_rel_buscar_admision.adm_patoling;
				
				var sqlMaxFecha = "select ptpfecha,ptphora,ptppatol from tbc_patolpac where"
				  + " ptphistclinica = " + asivm_rel_buscar_admision.adm_histclin
				  + " and ptpfecha <= " + fecha
				  + " order by ptpfecha desc, ptphora desc";
				var ds_PatolPac = databaseManager.getDataSetByQuery('asistencial',sqlMaxFecha,null,-1);
				if(ds_PatolPac.getMaxRowIndex() > 0){
					
					if(ds_PatolPac.getValue(1,1) < fecha){
						// tomar el primer registro
						patCie = ds_PatolPac.getValue(1,3);
					}
					else{
						// mismo dia
						for(var i=1 ; i<= ds_PatolPac.getMaxRowIndex() ; i++ ){
							//evaluar la hora
							if( ds_PatolPac.getValue(i,2) <= hora){
								patCie = ds_PatolPac.getValue(i,3);
								break;
							}
						}
					}
				}
								
				if(asivm_rel_buscar_obrasocial.obr_espami == 1){
					// Es pami
					/*
					var fs_patCie = databaseManager.getFoundSet('maestros','tbc_patcie'); 
					fs_patCie.find();
					fs_patCie['patcie1'] = patCie;
					// TODO Faltaria un criterio de filtro, o cual de la lista tomar ??
					//TODO: fs_patCie['patcie3'] = ;
					fs_patCie.search();
					
					if(fs_patCie.getSize() > 0)
						diagnostico += utils.stringTrim(fs_patCie['patcie22']);
					*/
				}
				else{
					
					var fs_patologia = databaseManager.getFoundSet('maestros','tbc_patologia'); 
					fs_patologia.find();
					fs_patologia['pat_codi'] = patCie;
					fs_patologia.search();
					
					if(fs_patologia.getSize() > 0)
						diagnostico += utils.stringTrim(fs_patologia['pat_descrip']);
				}
				
				var $ds2 = databaseManager.createEmptyDataSet()
				$ds2.addColumn('fld_apeynom',1,JSColumn.TEXT)
				$ds2.addColumn('fld_cobertura',2,JSColumn.TEXT)
				$ds2.addColumn('fld_afiliado',3,JSColumn.TEXT)
				$ds2.addColumn('fld_cod',4,JSColumn.TEXT)
				$ds2.addColumn('fld_rp1',5,JSColumn.TEXT)
				$ds2.addColumn('fld_rp5',6,JSColumn.TEXT)
				$ds2.addColumn('fld_apeynom_dr',7,JSColumn.TEXT)
				$ds2.addColumn('fld_matricula',8,JSColumn.TEXT)
				
				var histClinica = asivm_rel_buscar_admision.adm_histclin;
				var histClin =  "Nro.Inter. "+histClinica.toString().substr(0,histClinica.toString().length-1)+"/"+histClinica.toString().substr(histClinica.toString().length -1,1)
				
				$ds2.addRow([paciente,asivm_rel_buscar_obrasocial.obr_razonsoc,afiliado,histClin,nomeDesc,diagnostico,medico,matricula])
				// Generacion de PDF
				var title = "";
				if(codAutoSect == 2 || codAutoSect == 6 || codAutoSect == 8 || codAutoSect == 10 || codAutoSect == 12)
					title = "TERAPIA INTENSIVA";
				else{
					
					if( codAutoSect == 4 || codAutoSect == 5 )
						title = "UNIDAD CORONARIA";
					else
						title = "PISO";
				}
				
				var params = {
					pr_firma: "media:///" + fileNameFirma,
					pr_recetario: "media:///RecetarioSC2_004.jpg",
					pr_titulo_dr: title
				}
				
				var fileName = asivm_rel_buscar_admision.adm_histclin + "-"+ fecha + "-" + hora + "-431110.pdf";
				var arch;
				try{
					arch = plugins.file.createFile(fileName);
					//application.output( arch.getAbsolutePath());
					//globals.DIALOGS.showWarningDialog("Atencion","Directorio del archivo: " + arch.getAbsolutePath(),"Aceptar");
					
				}catch(msg){
					grabaLog(msg.toString(),asivm_rel_buscar_admision.adm_histclin);
				}
				
				if (arch){	
					try{
						//var fileName = "c:/temp/LB-CIRUAMBU-" + fechaDesde + "-" + fechaHasta;
						//plugins.jasperPluginRMI.compileReport("ASI-UCO-SOL-AUT.jrxml");
						plugins.jasperPluginRMI.runReport($ds2,'ASI-UCO-SOL-AUT.jasper',arch.getAbsolutePath(),plugins.jasperPluginRMI.OUTPUT_FORMAT.PDF,params)
					}catch(e){
						grabaLog(e.message,asivm_rel_buscar_admision.adm_histclin)
					}
				}
				
				var attachment1;
				try{
					attachment1 = plugins.mail.createBinaryAttachment(fileName,plugins.file.readFile(arch.getAbsolutePath()));
					
				}catch(msg){
					grabaLog(msg.toString(),asivm_rel_buscar_admision.adm_histclin)
				}	
				
				// Envio de email
				var subJect = "Solicitud Autoriz.- Paciente " + paciente + " - " + nomeDesc;
				
				var msgText = "Estimado/a\n\n"
				+ "                Se adjunta Practica en formato PDF para Autorizar correspondiente al paciente " + paciente + " Afiliado: " + afiliado + " con indicacion de: " + nomeDesc + "\n\n"
				
				msgText+= "Atte.\n"; 
				//msgText+= "Unidad Quirugica\n";
				msgText+= "Sanatorio Colegiales";
				
				// Enviando email
				var cuenta = '2';
				var userName = 'autorizaciones@sanatoriocolegiales.com.ar';
				var passWord = 'auto45';
				var properties = new Array();
				properties[0] = 'mail.smtp.host=200.80.43.104';
				properties[1] = 'mail.smtp.auth=true';
				properties[2] = 'mail.smtp.username=' + userName;
				properties[3] = 'mail.smtp.password=' + passWord;
				properties[4] = 'mail.smtp.port=25';
				
				//TODO  test-1
				/*
				var toAux = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
				var ccAux = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
				var ccoAux = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : null;
				application.output("TO: " + toAux);
				application.output("CC: " + ccAux);
				application.output("CCO: " + ccoAux);
				*/
				// end test-1
				var to = null;
				var cc = null;
				var cco = null;
				var url='';
				
				var largo_url=application.getServerURL().length
				if (largo_url<24){
					
					to = 'hchoque@cirendsa.com.ar';
					globals.DIALOGS.showInfoDialog("E-MAIL",msgText + '\nTo: ' + to,"Aceptar");
					
				}else{
					url = application.getServerURL().substr(0,23);
					var puerto = url.split(':');
					
					if(puerto[2]!='8080'){
						// Ambiente de pruebas
						to = globals.DIALOGS.showInputDialog(puerto[2],"Ingrese Dirección de correo electronico",'fhuertas@cirendsa.com.ar');
						//cc = 'fhuertas@cirendsa.com.ar';
						cc = 'hchoque@cirendsa.com.ar';
					}
					else{
						// Ambiente operativo
						to = utils.stringTrim(aux_mail_para).length > 0 ? aux_mail_para : null;
						cc = utils.stringTrim(aux_mail_cc).length > 0 ? aux_mail_cc : null;
						cco = utils.stringTrim(aux_mail_cco).length > 0 ? aux_mail_cco : 'fhuertas@cirendsa.com.ar';
						cco += ","+'fhuertas@cirendsa.com.ar'
					}
				}
				
				var attachmentList = new Array();
				var archivo_1 = {nombre:fileName,path:arch.getAbsolutePath()};
				attachmentList.push(archivo_1);
				
				if(utils.stringTrim(aux_mail_error).length == 0){
					
					var success = plugins.mail.sendMail(to, userName, subJect, msgText,cc,cco,[attachment1], properties);
					if (!success){
						
						grabarReenviaMail(asivm_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,attachmentList,cuenta);
						var msgMail = "No ha sido posible enviar la autorización de UCO via E-mail";
						grabaLog(msgMail,asivm_rel_buscar_admision.adm_histclin);
					}
				}
				else{
					
					grabarReenviaMail(asivm_rel_buscar_admision.adm_histclin,to,cc,cco,subJect,msgText,attachmentList,cuenta);
					var msg = "No ha sido posible enviar la autorización de UCO. Direccion de correo electrónico no válido.\n E-mail: " + aux_mail_error;
					grabaLog(msg,asivm_rel_buscar_admision.adm_histclin)
				}
				
				if(arch){
					
					try{
					  	plugins.file.deleteFile(arch.getAbsolutePath())
					  	plugins.file.deleteFile(arch)
					  }catch(msg){
							grabaLog("Error al elimnar archivo pdf.",asivm_rel_buscar_admision.adm_histclin)
					}	
				}
			//}
		}
	}
}


/**
 * @properties={typeid:24,uuid:"E96654F9-EE7A-409A-93D2-3F282C312ECA"}
 */
function inicializarRelacionCodAuto(){
	
	asivm_rel_codauto.codautoadmi = 0;
	asivm_rel_codauto.codautocdar = 0;
	asivm_rel_codauto.codautoempr = 0;
	asivm_rel_codauto.codautofsol = 0;
	asivm_rel_codauto.codautohist = 0;
	asivm_rel_codauto.codautohsol = 0;
	asivm_rel_codauto.codautoobra = 0;
	asivm_rel_codauto.codautoplan = ' ';
	asivm_rel_codauto.codautoserv = 0;
	asivm_rel_codauto.codautotipo = 0;
	asivm_rel_codauto.codautoempr5 = 0;
	asivm_rel_codauto.codautoesta3 = 0;
	asivm_rel_codauto.codautoesta4 = 0;
	asivm_rel_codauto.codautoesta6 = 0;
	asivm_rel_codauto.codautofaut = 0;
	asivm_rel_codauto.codautohabita = 0;
	asivm_rel_codauto.codautohaut = 0;
	asivm_rel_codauto.codautohist3 = 0;
	asivm_rel_codauto.codautohist4 = 0;
	asivm_rel_codauto.codautohist5 = 0;
	asivm_rel_codauto.codautohist6 = 0;
	asivm_rel_codauto.codautoimpre = 0;
	asivm_rel_codauto.codautomedi = 0;
	asivm_rel_codauto.codautoobra3 = 0;
	asivm_rel_codauto.codautoobra4 = 0;
	asivm_rel_codauto.codautoobra6 = 0;
	asivm_rel_codauto.codautooper = 0;
	asivm_rel_codauto.codautopant = 0;
	asivm_rel_codauto.codautopedi = 0;
	asivm_rel_codauto.codautoplan3 = ' ';
	asivm_rel_codauto.codautoplan4 = ' ';
	asivm_rel_codauto.codautoplan6 = ' ';
	asivm_rel_codauto.codautosect = 0;
	asivm_rel_codauto.codautoserv3 = 0;
	asivm_rel_codauto.codautoserv4 = 0;
	asivm_rel_codauto.codautoserv6 = 0;
	asivm_rel_codauto.codautotmed = 0;
	asivm_rel_codauto.codautotope = 0;
	asivm_rel_codauto.codautoutiliza = 0;
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param texto
 * @param histClin
 *
 * @properties={typeid:24,uuid:"1381A05F-94A5-4314-B534-81F82475A96A"}
 */
function grabaLog(texto,histClin) {
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
	var dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM cirugia_errores WHERE id='" + id + "')"
		dsExists = databaseManager.getDataSetByQuery('bases_auxiliares',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("bases_auxiliares","cirugia_errores")
	var fechacarga = application.getServerTimeStamp();
	fs.newRecord()
	fs['id'] = id;
	fs['hiscli'] = histClin;
	fs['protocolo'] = 0;
	fs['texto_errores'] = application.getSolutionName() + "|" +  application.getIPAddress() + "|" + controller.getName() + "|" +  texto;
	fs['tipo_pac'] = 'Int';
	fs['fecha']=application.getServerTimeStamp();
	fs['hora']=fechacarga.getHours()+''+fechacarga.getMinutes()
	
	databaseManager.startTransaction()
	var result = databaseManager.saveData(fs);
	if(result){
		databaseManager.commitTransaction();				
	}
	else{
		var error1 = ''
		var error2 = ''
		var array = databaseManager.getFailedRecords()
		for (var i = 0; i < array.length; i++) {
			var record = array[i];
			var jstable = databaseManager.getTable(record);
			var tableSQLName = jstable.getSQLName();
			error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
			error2='Error en grabación '+record.exception;
			if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
		
				var thrown = record.exception.getValue()
			
			}
		}
		databaseManager.rollbackTransaction()
	}
}

/**
 * 
 * @param {Number} hisCli
 * @param {String} to
 * @param {String} cc
 * @param {String} cco
 * @param {String} asunto
 * @param {String} mensaje
 * @param {Array<Object>} attachment
 * @param {String} cuenta
 *
 * @properties={typeid:24,uuid:"2420AF12-04D2-4CBB-B884-EFC0AA27FEDB"}
 */
function grabarReenviaMail(hisCli,to,cc,cco,asunto,mensaje,attachment,cuenta){
	
	var id = application.getUUID();
	//Verificando si existe clave primaria
	var sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
	var dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	while(dsExists.getValue(1,1) == 1){
		id = application.getUUID();
		sql = "SELECT EXISTS( SELECT id FROM reenvia_mail WHERE id='" + id + "')";
		dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
	}
	
	var fs = databaseManager.getFoundSet("desal","reenvia_mail");
	fs.newRecord();
	
	fs['id'] = id;
	fs['hiscli'] = hisCli;
	fs['fecha'] = application.getServerTimeStamp();;
	fs['mail_para'] = to;
	fs['mail_cc'] = cc;
	fs['mail_cco'] = cco;
	fs['id_cuenta_origen'] = cuenta;
	fs['asunto'] = asunto;
	fs['mensaje'] = mensaje;
	fs['estado'] = false;
	
	var fsItem = databaseManager.getFoundSet('desal','reenvia_mail_adjunto');
	if(attachment != null){
		
		var idItem;
		for(var k=0; k<attachment.length; k++){
			
			fsItem.newRecord();
			idItem = application.getUUID();
			//Verificando si existe clave primaria
			sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
			dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			while(dsExists.getValue(1,1) == 1){
				idItem = application.getUUID();
				sql = "SELECT EXISTS( SELECT id FROM reenvia_mail_adjunto WHERE id='" + idItem + "')";
				dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
			}
			
			fsItem['id'] = idItem;
			fsItem['id_reenvia_mail'] = id;
			fsItem['nombre_archivo'] = attachment[k]['nombre'];
			fsItem['archivo'] = plugins.file.readFile(attachment[k]['path']);
		}
	}
	
	databaseManager.startTransaction()
	var resultFs = databaseManager.saveData(fs);
	
	var resultItem = true;
	if(fsItem.getSize() > 0)
		resultItem = databaseManager.saveData(fsItem);
	
	if(resultFs && resultItem){

		databaseManager.commitTransaction();				
	}
	else{
		
		databaseManager.rollbackTransaction();
		var msgMail = "No ha sido posible grabar en tabla reenvia_mail. HC " + hisCli + "para " + to + cc + cco;
		grabaLog(msgMail,hisCli);
	}
}


/**
 * @properties={typeid:24,uuid:"19A4E0D2-654B-4A57-8D12-5C82032C879E"}
 */
function guardarDatos(){
	
//	asivm_fichakine.fecha_fin= null
//	asivm_fichakine.vm_extub_fecha_no_progr = null
//	asivm_fichakine.vm_tqt_fecha = null
//	asivm_fichakine.vm_tqt_fecha_decanulacion = null
//	asivm_fichakine.fecha_egreso_sanatorio=null
//	asivm_fichakine.fecha_egreso_uci = null
//	asivm_fichakine.paliativos_fecha = null
	asivm_fichakine.estado=globals.AsiVm_estado_uso_equipo // 0:equipo sin usar //1:equipo en uso.
	
	if(f_tiene_soporte==1){
		asivm_fichakine.observaciones=f_observaciones
		asivm_fichakine.soporte_ventilatorio = f_sin_soporte
//		asivm_fichakine.estado= 0
	}else{
		asivm_fichakine.prestacion = globals.Asivm_prestacion
//		asivm_fichakine.fecha_inicio= $_fechaHoraRegistro
		asivm_fichakine.observaciones=f_observaciones
		
		asivm_fichakine.altura = f_altura
		asivm_fichakine.peso_corporal_predicho = f_peso_predicho;
		asivm_fichakine.peso_estimado = f_peso_estimado
		
		asivm_fichakine.diagnostico = f_diagnostico
		asivm_fichakine.antecedentes = utils.stringReplace(f_antecedentes,'\n',',') 
		asivm_fichakine.sap2 = f_saps_II
		asivm_fichakine.mortalidad_predicha_sap2 =f_mortalidad_predicha_saps_II
//		asivm_fichakine.pac
		asivm_fichakine.kinesiologo_lega=globals.Srv_Login_Sanatorio_vLega
		
	
		asivm_fichakine.fecha_inicio_ventilacion=f_fecha_inicio_ventilacion
	
		asivm_fichakine.soporte_ventilatorio = f_con_soporte
//		asivm_fichakine.estado= 1
		
		if(globals.Asivm_prestacion==1){
			asivm_fichakine.cama = f_cama
		}
		asivm_fichakine.score_charlson=f_score_charlson
		asivm_fichakine.sobrevida_diez_anio = f_sobrevida
		asivm_fichakine.motivo =  utils.stringReplace(f_motivo,'\n',',') 
		asivm_fichakine.glasgow = f_glasgow
//		asivm_fichakine.arm = f_marca_arm
//		if(f_tiene_soporte==2){//con soporte
//			asivm_fichakine.soporte_ventilatorio = utils.stringReplace(f_soporte_multiple,'\n',',') //1,2,3
//		}else{//sin soporte
//			asivm_fichakine.soporte_ventilatorio = utils.numberFormat(f_soporte,0)
//		}
		
		
	}

	
	
}

/**
 * @properties={typeid:24,uuid:"573F0B1F-0810-4E98-BE27-4554E18F51D0"}
 */
function cargarDatos(){
	
	if(scopes.globals.AsiVm_adm_HistClin!=0){
		if(asivm_rel_respirador.getSize()>0){
			f_equipo = asivm_rel_respirador.rsp_codint
			f_marca = asivm_rel_respirador.rsp_marca
			f_modelo=asivm_rel_respirador.rsp_modelo
			f_enUso= application.getValueListDisplayValue('AsiVm_vl_en_uso',asivm_rel_respirador.rsp_enuso)
			if(asivm_rel_respirador.rsp_enuso==1){
				elements.enUso.bgcolor = "#ADFF81"
				globals.AsiVm_estado_uso_equipo=true
			}else{
				elements.enUso.bgcolor = "#F67F66"
				globals.AsiVm_estado_uso_equipo=false
			}
		}
	}

	
	//toco ver detalle.
	//ficha inicio campos.
	f_tiene_soporte=asivm_fichakine.con_soporte_ventilatorio
	f_lugar_internacion = asivm_fichakine.lugar_internacion
	globals.AsiVm_tipo = asivm_fichakine.soporte_ventilatorio
	
//	globals.AsiVm_ficha_id = asivm_fichakine.fichavm_id
//	globals.AsiVm_hisclin = asivm_fichakine.histcli
	//TIENE O NO SOPORTE
	showFieldByPrestacion()
	if(f_tiene_soporte==1){//NO TIENE SOPORTE
//		elements.grp_otras_observaciones.visible=true
		elements.cbo_sin_soporte.visible = true
		elements.grp_prestacion.visible=false
		elements.grp_ficha_inicio.visible=false
		elements.grp_prestacion.enabled=false
		elements.cbo_sin_soporte.enabled=true
		elements.grp_fecha_inicio_ventilacion.visible=false
		elements.btn_observaciones.visible=true
		f_sin_soporte = asivm_fichakine.soporte_ventilatorio
	}else if(f_tiene_soporte==2){//TIENE SOPORTE
		elements.grp_otras_observaciones.visible=false
		elements.grp_ficha_inicio.visible=true
		elements.btn_monitoreos.visible=true
		elements.btn_report_monitoreo.visible=true
		elements.cbo_sin_soporte.visible = false
		elements.grp_prestacion.visible=true
		elements.btn_observaciones.visible=false
		
		elements.grp_fecha_inicio_ventilacion.visible=true
		f_con_soporte = asivm_fichakine.soporte_ventilatorio
		elements.cbo_sin_soporte.enabled=false
		elements.grp_prestacion.enabled=true
		f_fecha_inicio_ventilacion=asivm_fichakine.fecha_inicio_ventilacion
	}
	
	f_fecha_inicio_ventilacion = asivm_fichakine.fecha_inicio_ventilacion
	f_altura = asivm_fichakine.altura
	f_peso_predicho = asivm_fichakine.peso_corporal_predicho
	f_peso_estimado = asivm_fichakine.peso_estimado
	f_cama = asivm_fichakine.cama
	f_diagnostico = utils.stringReplace(asivm_fichakine.diagnostico,',','\n') 
	f_antecedentes = utils.stringReplace(asivm_fichakine.antecedentes,',','\n')  
	f_saps_II = asivm_fichakine.sap2
	f_observaciones = asivm_fichakine.observaciones
	f_mortalidad_predicha_saps_II = asivm_fichakine.mortalidad_predicha_sap2
	f_score_charlson = asivm_fichakine.score_charlson
	f_sobrevida= asivm_fichakine.sobrevida_diez_anio
	//f_motivo = asivm_fichakine.motivo
	f_ingreso_uci =asivm_fichakine.fecha_ingreso_uci
	//f_inicio_vm=asivm_fichakine.fecha_inicio_vm
	fecha_inicio = asivm_fichakine.fecha
//	f_soporte = asivm_fichakine.soporte_ventilatorio
	globals.Asivm_prestacion= asivm_fichakine.prestacion
	
	if(asivm_fichakine.fecha_fin !=null){
		globals.AsiVm_Ficha_Cerrada = true;
	}else{
		globals.AsiVm_Ficha_Cerrada = false;
	}

	
	
	f_motivo = utils.stringReplace(asivm_fichakine.motivo,',','\n')
	if(f_motivo.match("Otro")){
		elements.chk_otro_diag.enabled=true
		elements.txt_otro_diag.enabled=true
	}
	else{
		elements.chk_otro_diag.enabled=false
		elements.txt_otro_diag.enabled=false
	}
	
	f_glasgow = asivm_fichakine.glasgow
	if(asivm_fichakine.con_soporte_ventilatorio==2 && asivm_buscar_monitoreo!=null){
		elements.btn_monitoreos.visible=true
		elements.btn_report_monitoreo.visible=true
	}else{
		elements.btn_monitoreos.visible=false
		elements.btn_report_monitoreo.visible=false
	}
	
	if(asivm_fichakine.fecha_fin!=null){
		elements.btn_dato_cierre.visible=true
		elements.btn_cerrar_ficha.enabled=false
//		elements.btn_monitoreos.enabled=false
	}else{
		elements.btn_dato_cierre.visible=false
		elements.btn_cerrar_ficha.enabled=true
	}
	
	if(asivm_fichakine_cierre.getSize()>0 || asivm_fichakine_cierre_sin_soporte.getSize()>0){
		globals.DIALOGS.showWarningDialog("¡Aviso!", "La ficha fue cerrada. Puede Ver la info en 'Ver Cierre Asociado'", "Aceptar")
		elements.btn_cerrar_ficha.text="Ver Cierre Asociado"
	}else{
		elements.btn_cerrar_ficha.text="Cerrar Ficha"
	}
	
	elements.btn_cerrar_ficha.visible=true
	//si no pasa un dia, le deja modificar
	var dias = globals.contar_dias(asivm_fichakine.fecha,application.getServerTimeStamp())
	if(globals.Srv_Login_Sanatorio_vLegajo!='118319' && dias>=1){
//if(dias>=1){
		globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'txt_');
		globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'cbo_');
		globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'multi_')
	}else{
		elements.btn_grabar.enabled=true
	}
	
	
}

/**
 * @properties={typeid:24,uuid:"57D3ABC3-381B-4828-AA33-DD3A5859C1F1"}
 */
function showFieldByPrestacion(){
//	history.removeForm('AsiVm_Ficha_Inicio')
	var formFichaInicio = solutionModel.getForm('AsiVm_Ficha_Inicio');
	var fieldAltura = formFichaInicio.getField('txt_altura')
	var fieldPesoPredicho = formFichaInicio.getField('txt_peso_predicho')
	var fieldPesoEstimado = formFichaInicio.getField('txt_peso_estimado')
	if(asivm_fichakine.prestacion==1){
		fieldAltura.removeDesignTimeProperty('requerido')
		fieldPesoPredicho.removeDesignTimeProperty('requerido')
		fieldPesoEstimado.removeDesignTimeProperty('requerido')
		forms.AsiVm_Ficha_Inicio.controller.recreateUI();
		elements.cbo_motivo_vm.visible=true
		elements.cbo_motivo_vni.visible=false
		elements.cbo_motivo_caf.visible=false
		
	}else if(asivm_fichakine.prestacion==2){
		//no obligatorios
		fieldAltura.putDesignTimeProperty('requerido',false)
		fieldPesoPredicho.putDesignTimeProperty('requerido',false)
		fieldPesoEstimado.putDesignTimeProperty('requerido',false)
		forms.AsiVm_Ficha_Inicio.controller.recreateUI();
		elements.cbo_motivo_vni.visible=true
		elements.cbo_motivo_vm.visible=false
		elements.cbo_motivo_caf.visible=false
	}else if(asivm_fichakine.prestacion==3){
		fieldAltura.putDesignTimeProperty('requerido',false)
		fieldPesoPredicho.putDesignTimeProperty('requerido',false)
		fieldPesoEstimado.putDesignTimeProperty('requerido',false)
		forms.AsiVm_Ficha_Inicio.controller.recreateUI();
		elements.cbo_motivo_caf.visible=true
		elements.cbo_motivo_vni.visible=false
		elements.cbo_motivo_vm.visible=false
	}
	
}
/**
 * TODO generated, please specify type and doc for the params
 * @author gennari gustavo
 * @param formName
 * @param validarSinPropertys
 * @param patron campos con coinciden validara. Vacio validara "txt_"
 * @param validarCantCaracteres valida cantidad de caracteres en campo
 * @param minCaracteres complemento al parametro anterior
 *
 * @properties={typeid:24,uuid:"CE42D2A3-70E0-47AF-9AA7-29DFA8509FD5"}
 */
function validateRequired(formName, validarSinPropertys, patron, validarCantCaracteres, minCaracteres) {
    var ok = true;
    var textReplace=(patron!=null && !globals.IsBlank(patron))?patron:'txt_';
    var flds = forms[formName].elements;
    for (var item in flds) {
        var elm = flds[item];
        var propEncontrada = elm.getDesignTimeProperty('requerido');
        var name= elm.getName();
        //application.output(name); ver campos que se validan
        if(patron!=null && !globals.IsBlank(patron)){//pasa de largo lo que no tienen el patron.
        	if(name.indexOf(patron)==-1 && propEncontrada==undefined){ //si propEncontra no es nula hay que validar igual o no.
        		continue;
        	}
        }
        if (name!=null && name.indexOf("grp")==-1 && propEncontrada==true || validarSinPropertys &&  propEncontrada==undefined) {//si tiene propertys hay que validar // ojo cuando no es relacion
            var dp = elm.getDataProviderID() //obtenemos variable asociada
            //if (!forms[formName].foundset.getSegetSelectedRecord()[dp]) { //esto se usaba para obtener el recurso.
            var arrRelacion = (dp!=null)?dp.split("."):'';
            if (arrRelacion!='' && dp.indexOf("rel")>0 &&!globals[arrRelacion[0]][arrRelacion[1]]>=1) {
               // forms[formName].elements[name].bgcolor = "#ffbc78";
                isValid = false;
                if(propEncontrada && name.indexOf(textReplace)==-1){
        			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
        		}else{
        			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
        		}
        		if(validarCantCaracteres && propEncontrada==undefined){
        			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
        		}
            	
            }else if(dp.indexOf("rel")==-1 && dp.indexOf("cbo")==-1){
            	if((validarCantCaracteres && forms[formName][dp]!=null && forms[formName][dp].length<minCaracteres) || ""==utils.stringTrim(forms[formName][dp]) || "0"==utils.stringTrim(forms[formName][dp])  ){
            		
            		  //forms[formName].elements[name].bgcolor = "#ffbc78";
            		isValid = false;
            		if(propEncontrada && name.indexOf(textReplace)==-1){
            			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
            		}else{
            			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
            		}
            		
            		
            		if(validarCantCaracteres && propEncontrada==undefined){
            			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
            		}
            	}else{
            		// forms[formName].elements[name].bgcolor = "#d4e8d4";
            	}
            }else if(dp.indexOf("cbo")!=-1){
               	if((validarCantCaracteres && forms[formName][dp]!=null && forms[formName][dp]<minCaracteres) ||  ""==utils.stringTrim(forms[formName][dp]) ){
            		
          		  //forms[formName].elements[name].bgcolor = "#ffbc78";
          		isValid = false;
          		if(propEncontrada && name.indexOf(textReplace)==-1){
          			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace('txt_','').replace(/\_/g,' ');
          		}else{
          			messageError += "\nDebe ingresar: " + forms[formName].elements[name].getName().replace(textReplace,'').replace(/\_/g,' ');
          		}
          		
          		
          		if(validarCantCaracteres && propEncontrada==undefined){
          			messageError+=' Con '+ minCaracteres +' caracteres como mínimo.';
          		}
          	}else{
          		// forms[formName].elements[name].bgcolor = "#d4e8d4";
          	}
            }
            
            else {
                //forms[formName].elements[name].bgcolor = "#d4e8d4";
            }
            propEncontrada=false;
        }
    }
    
    return ok;
}

/**
 * @properties={typeid:24,uuid:"44FF032B-9425-4E22-81D1-3ADE60E2562D"}
 */
function mostrarSoloLectura(){
//	forms.AsiVm_Evolucion_Uco.elements.btn_editar.enabled=false;
	//forms.AsiVm_Ficha_Inicio.elements.btn_imprimir.enabled=false;
	forms.AsiVm_Ficha_Inicio.elements.btn_grabar.enabled = false
	
}

/**
 * @properties={typeid:24,uuid:"26284AB0-71AD-4F02-BF89-A78AD7A85F45"}
 */
function mostrarModoEditable(){
}

/**
 * TODO generated, please specify type and doc for the params
 * @param event
 *
 * @properties={typeid:24,uuid:"FED36CFA-3C80-4296-954E-03E4DCA3DC97"}
 */
function onAction_btnEditar(event) {
	// TODO Auto-generated method stub

	if(!asivm_fichakine.hucimpresa==1){
	
//		forms.AsiVm_Evolucion_Uco.elements.txt_diagnostico3.editable=true;
//		forms.AsiVm_Evolucion_Uco.elements.txt_diagnostico3.enabled=true;
		forms.AsiVm_Evolucion_Uco.elements.grp_signovitale.readOnly=false
		forms.AsiVm_Evolucion_Uco.elements.grp_signovitale.readOnly=false

		
	}else{
			plugins.dialogs.showInfoDialog("Documento fue Impreso","Esta evolución ya no será posible editar");

	}
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"C9510769-BE14-4DB7-BF6B-A043EC9222AF"}
 */
function onActionPulsoFrencuencia(event) {
	// TODO Auto-generated method stub
	$isDirty = true;
//	forms.AsiVm_Evolucion_Uco.controller.
	var secuencia = controller.getTabSequence();
	 var tabSeq=secuencia.indexOf(forms.AsiVm_Evolucion_Uco.elements.txt_pulso_frecuencia.getName());
	 
	 forms.AsiVm_Evolucion_Uco.controller.focusField(secuencia[tabSeq+1], true);
	return true
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"DA5A8740-DAD6-45E3-ABBD-649449A9AA0F"}
 */
function onDataChangePulsoFrecuencia(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	return true
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"EB4D04EB-4288-48BE-9481-F30BE08F30AB"}
 */
function onDataChangeArm(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true;
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"B049D4E5-7366-4723-90B1-5AB9AD61F9E4"}
 */
function onActionFrecuenciaRespiratoria(event) {
	// TODO Auto-generated method stub
	$isDirty = true;
//	forms.AsiVm_Evolucion_Uco.controller.
//	var secuencia = controller.getTabSequence();
//	 var tabSeq=secuencia.indexOf(forms.AsiVm_Evolucion_Uco.elements.txt_frecuencia_respiratoria.getName());
	 
//	 forms.AsiVm_Evolucion_Uco.controller.focusField(secuencia[tabSeq+1], true);
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"784E09E0-F031-4F53-9800-C1CE9924600B"}
 */
function onActionTemperatura(event) {
	// TODO Auto-generated method stub
	var secuencia = controller.getTabSequence();
	 var tabSeq=secuencia.indexOf(forms.AsiVm_Evolucion_Uco.elements.txt_temperatura.getName());
	 
	 forms.AsiVm_Evolucion_Uco.controller.focusField(secuencia[tabSeq+1], true);
	return true
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"465EFCC5-9EA0-42E2-A37F-A7048B0F168C"}
 */
function onDataChangeConSoporteVentilatorio(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true
//	limpiarForm();
	if(newValue==2){
		elements.btn_observaciones.visible=false
		elements.txt_observaciones.editable=true
		elements.grp_tiene_arm.enabled=true
		elements.grp_tiene_arm.visible=true
		elements.cbo_sin_soporte.enabled=false
		elements.grp_prestacion.enabled=true
		elements.cbo_sin_soporte.visible=false
		elements.grp_prestacion.visible=true
		elements.grp_ficha_inicio.visible=true
		elements.grp_prestacion.visible=true
		elements.grp_fecha_inicio_ventilacion.visible=true
		elements.grp_otras_observaciones.visible=false
		f_sin_soporte=0
	
//		if(asivm_rel_buscar_ficha_kine_con_soporte.getSize()>0){
//			globals.DIALOGS.showInfoDialog('Atención','El paciente tiene una ficha con soporte abierta','Aceptar')
//			elements.btn_grabar.enabled=false
//			return
//		}else{
//			elements.btn_grabar.enabled=true
//		}
		if(asivm_rel_respirador.getSize()<1){
			globals.DIALOGS.showWarningDialog("¡Aviso!", "El paciente no tiene ningun equipo de soporte actualmente en uso. Asocie un equipo antes de cargar una ficha", "Aceptar")
			//confimar cambio.
//			elements.btn_grabar.enabled=false
//			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'txt_');
//			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'cbo_');
//			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.setearEnModoLecturaCampos,'multi_')
		
		}else{
			elements.btn_grabar.enabled=true
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'txt_');
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'cbo_');
			globals.modificarCampos("AsiVm_Ficha_Inicio", globals.habilitarCampos,'multi_')
		}
		
	}else if(newValue==1){
		elements.btn_grabar.enabled=true
		elements.grp_tiene_arm.enabled=false
		elements.grp_tiene_arm.visible=false
		
		globals.errorDato = true
		f_con_soporte = 0
		globals.Asivm_prestacion= 0
		elements.cbo_sin_soporte.enabled=true
		elements.cbo_sin_soporte.visible=true
		elements.grp_prestacion.enabled=false
		elements.grp_ficha_inicio.visible=false
		elements.cbo_motivo_vm.visible=false
		elements.cbo_motivo_vni.visible=false
		elements.cbo_motivo_caf.visible=false
		elements.grp_prestacion.visible=false
		elements.grp_fecha_inicio_ventilacion.visible=false
		//observaciones sin soporte
//		elements.btn_observaciones.visible=true
//		elements.txt_observaciones.editable=false

		
	}
	if(asivm_rel_buscar_admision.getSize()==1){
	f_cama = asivm_rel_buscar_admision.adm_cama;
	}
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"E0EB98E4-826B-4798-B3BA-22B0EC65C588"}
 */
function onActionConSoporteVentilatorio(event) {
	// TODO Auto-generated method stub
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"CE07F0D1-0E50-4839-99D6-C85300C62B5A"}
 */
function onDataChangePrestacion(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	mostrarMotivoSegunPrestacion(newValue)
//	forms.AsiVm_Ficha_Inicio.controller.recreateUI()
	
	return true
}

/**
 * TODO generated, please specify type and doc for the params
 * @param valor
 *
 * @properties={typeid:24,uuid:"07857740-1354-40E9-9A4E-DC340E22635C"}
 */
function mostrarMotivoSegunPrestacion(valor){
	var formFichaInicio = solutionModel.getForm('AsiVm_Ficha_Inicio');
	var fieldAltura = formFichaInicio.getField('txt_altura')
	var fieldPesoPredicho = formFichaInicio.getField('txt_peso_predicho')
	var fieldPesoEstimado = formFichaInicio.getField('txt_peso_estimado')
	switch (valor) {
	case 1:
		fieldAltura.removeDesignTimeProperty('requerido')
		fieldPesoPredicho.removeDesignTimeProperty('requerido')
		fieldPesoEstimado.removeDesignTimeProperty('requerido')
		
		elements.txt_cama.visible=true
		elements.cbo_motivo_vm.visible=true
		elements.cbo_motivo_vni.visible=false
		elements.cbo_motivo_caf.visible=false
	
		//elements.cbo_motivo.setValueListItems('AsiVm_vl_motivo_vm')
//		f_motivo = utils.stringReplace('1,2',',','\n')
		
		break;
		
	case 2:
		
	//campo peso no obligatorios
	
	fieldAltura.putDesignTimeProperty('requerido',false)
	fieldPesoPredicho.putDesignTimeProperty('requerido',false)
	fieldPesoEstimado.putDesignTimeProperty('requerido',false)
	elements.cbo_motivo_vni.visible=true
	elements.cbo_motivo_vm.visible=false
	elements.cbo_motivo_caf.visible=false
	
	elements.txt_cama.visible=false
	elements.txt_cama.visible=false
	//elements.cbo_motivo.setValueListItems('AsiVm_vl_motivo_vni')
	break;
	
	case 3: //caf
		
		fieldAltura.putDesignTimeProperty('requerido',false)
		fieldPesoPredicho.putDesignTimeProperty('requerido',false)
		fieldPesoEstimado.putDesignTimeProperty('requerido',false)
		elements.cbo_motivo_caf.visible=true
		elements.cbo_motivo_vm.visible=false
		elements.cbo_motivo_vni.visible=false
	//elements.cbo_motivo.setValueListItems('AsiVm_vl_motivo_caf')
	elements.txt_cama.visible=false
	elements.txt_cama.visible=false
		break;
	}
}
/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"5974FD69-292A-48BF-96A9-EA6F5B167E0E"}
 */
function onDataChangeObservaciones(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	if(asivm_rel_buscar_admision.getSize()==1){
		f_cama = asivm_rel_buscar_admision.adm_cama;
	}

	$isDirty = true
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"86EA6AE9-5D58-4733-B05C-483CD21F54E5"}
 */
function onActionVerMonitoreos(event) {
	// TODO Auto-generated method stub
	var win3 = application.createWindow("monitoreo", JSWindow.MODAL_DIALOG);
	win3.title = 'Monitoreo';
	win3.resizable = false;
//	globals.AsiVm_ficha_id = asivm_fichakine.ficha_id
	if(asivm_buscar_monitoreo!=null && asivm_buscar_monitoreo.getSize()>0){
		
		win3.show(forms.AsiVm_Monitoreo);
	}else{
		if(asivm_fichakine_cierre.fecha_fin==null){
			var respuesta = globals.DIALOGS.showQuestionDialog("Monitoreos","No existen monitoreos para está ficha. ¿Desea generar un Monitoreo nuevo?","SI","NO");
			if(respuesta=="SI"){
				win3.show(forms.AsiVm_Monitoreo);
			}
		}else{
			globals.DIALOGS.showInfoDialog('Info',"No se puede agregar monitoreos a una ficha cerrada")
		}

	}

	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param event
 *
 * @properties={typeid:24,uuid:"071296CB-A62F-4B51-A91C-8F9983F93267"}
 */
function onActionAddObservacion(event){
	var winObs = application.createWindow("observaciones", JSWindow.MODAL_DIALOG);
	winObs.title = 'Observacion';
	winObs.resizable = false;
//	globals.AsiVm_ficha_id = asivm_fichakine.ficha_id
	if(asivm_buscar_observacion!=null && asivm_buscar_observacion.getSize()>0){
		
			//siempre es posible agrega evoluciones
			var observacionRegistros = databaseManager.createEmptyDataSet();
			observacionRegistros.addColumn('id');
			observacionRegistros.addColumn('fecha');
			observacionRegistros.addColumn('idficha');
			observacionRegistros.addColumn('texto');
			for(var j=1; j<=asivm_buscar_observacion.getSize(); j++){
				observacionRegistros.addRow([asivm_buscar_observacion.getRecord(j).fichakine_observacion_id
									,asivm_buscar_observacion.getRecord(j).fecha
									,asivm_buscar_observacion.getRecord(j).fichavm
									,utils.dateFormat(asivm_buscar_observacion.getRecord(j).fecha,'dd/MM/yyyy hh:mm aa')
									]);
			}
			//if(wCerrada == 1 && wImpresa == 0)
			if(asivm_fichakine_cierre.fecha_fin==null && asivm_rel_buscar_admision_con_alta.getSize()==0){
				observacionRegistros.addRow([0,null,0,'NUEVA']);
			}
			
				
			var $tipos = [JSColumn.NUMBER,JSColumn.DATETIME,JSColumn.NUMBER, JSColumn.TEXT];
			var $frm = solutionModel.getForm('Asivm_tbl_hcivm_observacion');
			$frm.dataSource =""
			$frm.dataSource = observacionRegistros.createDataSource('ds_hci_observacion', $tipos);
			forms.Asivm_tbl_hcivm_observacion.controller.recreateUI();
			
				var win2 = application.createWindow("seleccion_observacion", JSWindow.MODAL_DIALOG);
				win2.title = 'Observaciones de ficha inicial sin soporte';
				win2.resizable = false;
				win2.show(forms.Asivm_tbl_hcivm_observacion);
			
			
		
		
	}else{
		if(asivm_fichakine_cierre.fecha_fin==null){
			var respuesta = globals.DIALOGS.showQuestionDialog("Observaciones","No existen observaciones para está ficha. ¿Desea generar una observación nueva?","SI","NO");
			if(respuesta=="SI"){
				winObs.show(forms.AsiVm_Observacion);
			}
		}else{
			globals.DIALOGS.showInfoDialog('Info',"No se puede agregar observaciones a una ficha cerrada")
		}

	}
}

/**
 * @properties={typeid:24,uuid:"8D45CE0A-4A00-4A94-95BF-2E59B3598EDE"}
 */
function reportMonitoreos(){
	var monitoreos = "select histcli, fecha, frecuencia_cardiaca, frecuencia_respiratoria, "
	monitoreos=monitoreos+'tension_arterial_sistolica, tension_arterial_diastolica, tesion_arterial_media, '
	monitoreos=monitoreos+'temperatura, saturacion, cpot, analgesicos, rass, sedacion, cam_icu, bloqueantes_neuromsucualares, '
	monitoreos=monitoreos+'eab_ph, eab_p02, eab_pc02, eab_hc03, eab_pa02_fi02, '
	monitoreos=monitoreos+'caf_prog_frec_respi,caf_prog_flujo,caf_prog_fio2,caf_prog_equipo,caf_prog_tamanio_canula, cnaf_spo2, cnaf_presen_secre, cnaf_empleo_muscu_accesorio, cnaf_indice_rox, '
	monitoreos=monitoreos+'vm_monit_frec_respitoria_total, vm_monit_presion_pico, vm_monit_presion_plateau, '
	monitoreos=monitoreos+'vm_monit_presion_media, vm_monit_peep_total, vm_monit_delta_presion,'
	monitoreos=monitoreos+'vm_monit_p01, vm_monit_vol_corriente_exhalado, vm_monit_compliance, vm_monit_resistencia, '
	monitoreos=monitoreos+'vm_monit_pmi, vm_monit_presion_oclusion, '
	monitoreos=monitoreos+'vm_varios_sat, vm_varios_exito, vm_varios_pre, vm_varios_eot, vm_varios_dialisis, vm_varios_aspirado_traqueal, '
	monitoreos=monitoreos+'vm_varios_balance_diario, vm_sofa_diario, mecanica, disnea, '
	monitoreos=monitoreos+'vm_modo_ventilatorio,vm_seteo_volumen_corriente,vm_seteo_presion_inspiratoria,vm_seteo_frec_respiratoria, '
	monitoreos=monitoreos+'vm_seteo_tiempo_inspiratorio,vm_seteo_pausa,vm_seteo_flujo,vm_seteo_fio2,vm_seteo_peep, '
	monitoreos=monitoreos+"vni_seteo_ventilador, vni_seteo_interfase, vni_seteo_modo, vni_seteo_presion_inspiratoria, vni_seteo_peep, vni_seteo_frec_respiratoria, vni_seteo_tiempo_inspiratorio, vni_seteo_fio2, vni_seteo_volumen_corriente from fichakine_monitoreo where histcli="+globals.AsiVm_adm_HistClin +" and fichavm="+globals.AsiVm_ficha_id;
	var ds_monitoreos = databaseManager.getDataSetByQuery('desal',monitoreos,null,-1)
	
	 var $ds2 = databaseManager.createEmptyDataSet()
	 	$ds2.addColumn('histcli',1,JSColumn.INTEGER)   
		$ds2.addColumn('fecha',2,JSColumn.DATETIME)   
		$ds2.addColumn('frecuencia_cardiaca',3,JSColumn.INTEGER)
		$ds2.addColumn('frecuencia_respiratoria',4,JSColumn.INTEGER)
		$ds2.addColumn('tension_arterial_sistolica',5,JSColumn.INTEGER)
		$ds2.addColumn('tension_arterial_diastolica',6,JSColumn.INTEGER)
		$ds2.addColumn('tesion_arterial_media',7,JSColumn.INTEGER)
		$ds2.addColumn('temperatura',8,JSColumn.NUMBER)
		$ds2.addColumn('saturacion',9,JSColumn.NUMBER)
		$ds2.addColumn('cpot',10,JSColumn.NUMBER)
		$ds2.addColumn('analgesicos',11,JSColumn.TEXT)
		$ds2.addColumn('rass',12,JSColumn.NUMBER)
		$ds2.addColumn('sedacion',13,JSColumn.TEXT)
		$ds2.addColumn('cam_icu',14,JSColumn.NUMBER)
		$ds2.addColumn('bloqueantes_neuromsucualares',15,JSColumn.NUMBER)
		
		$ds2.addColumn('eab_ph',16,JSColumn.NUMBER)
		$ds2.addColumn('eab_p02',17,JSColumn.NUMBER)
		$ds2.addColumn('eab_pc02',18,JSColumn.NUMBER)
		$ds2.addColumn('eab_hc03',19,JSColumn.NUMBER)
		$ds2.addColumn('eab_pa02_fi02',20,JSColumn.NUMBER)
		
		
		//CNAF
		$ds2.addColumn('progr_frec_respira',21,JSColumn.NUMBER)
//		$ds2.addColumn('progr_volumen_corriente',22,JSColumn.NUMBER)
//		$ds2.addColumn('progr_presion_inspiratoria',23,JSColumn.NUMBER)
//		$ds2.addColumn('progr_presion_soporte',24,JSColumn.NUMBER)
		$ds2.addColumn('progr_flujo',22,JSColumn.NUMBER)
//		$ds2.addColumn('progr_tiempo_inspiratorio',26,JSColumn.NUMBER)
		$ds2.addColumn('progr_fi02',23,JSColumn.NUMBER)
//		$ds2.addColumn('progr_peep',28,JSColumn.NUMBER)
		$ds2.addColumn('caf_prog_equipo',24,JSColumn.NUMBER)
		$ds2.addColumn('caf_prog_tamanio_canula',25,JSColumn.NUMBER)
		$ds2.addColumn('cnaf_spo2',26,JSColumn.NUMBER)
		$ds2.addColumn('cnaf_presen_secre',27,JSColumn.NUMBER)
		$ds2.addColumn('cnaf_empleo_muscu_accesorio',28,JSColumn.NUMBER)
		$ds2.addColumn('cnaf_indice_rox',29,JSColumn.NUMBER)
		
		//monitoreo
		$ds2.addColumn('vm_monit_frec_respitoria_total',30,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_presion_pico',31,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_presion_plateau',32,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_presion_media',33,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_peep_total',34,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_delta_presion',35,JSColumn.NUMBER)
		
		$ds2.addColumn('vm_monit_p01',36,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_vol_corriente_exhalado',37,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_compliance',38,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_resistencia',39,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_pmi',40,JSColumn.NUMBER)
		$ds2.addColumn('vm_monit_presion_oclusion',41,JSColumn.NUMBER)
		
		//varios
		$ds2.addColumn('vm_varios_sat',42,JSColumn.NUMBER)
		$ds2.addColumn('vm_varios_exito',43,JSColumn.NUMBER)
		
		$ds2.addColumn('vm_varios_pre',44,JSColumn.NUMBER)
		$ds2.addColumn('vm_varios_eot',45,JSColumn.NUMBER)
		$ds2.addColumn('vm_varios_dialisis',46,JSColumn.NUMBER)
		$ds2.addColumn('vm_varios_aspirado_traqueal',47,JSColumn.NUMBER)
		$ds2.addColumn('vm_varios_balance_diario',48,JSColumn.NUMBER)
		$ds2.addColumn('vm_sofa_diario',49,JSColumn.NUMBER)
	
		$ds2.addColumn('mecanica',50,JSColumn.TEXT)
		$ds2.addColumn('disnea',51,JSColumn.NUMBER)
		
		//SETEO VM
		$ds2.addColumn('vm_modo_ventilatorio',52,JSColumn.TEXT)
		$ds2.addColumn('vm_volumen_corriente',53,JSColumn.TEXT)
		$ds2.addColumn('vm_presion_inspiratoria',54,JSColumn.TEXT)
		$ds2.addColumn('vm_frec_respi',55,JSColumn.TEXT)
		$ds2.addColumn('vm_tiempo_inspiratorio',56,JSColumn.TEXT)
		$ds2.addColumn('vm_pausa',57,JSColumn.TEXT)
		$ds2.addColumn('vm_flujo',58,JSColumn.TEXT)
		$ds2.addColumn('vm_fio2',59,JSColumn.TEXT)
		$ds2.addColumn('vm_peep',60,JSColumn.TEXT)
//		$ds2.addColumn('progr_volumen_corriente',22,JSColumn.NUMBER)
//		$ds2.addColumn('progr_presion_inspiratoria',23,JSColumn.NUMBER)
//		$ds2.addColumn('progr_presion_soporte',24,JSColumn.NUMBER)
//		$ds2.addColumn('progr_tiempo_inspiratorio',26,JSColumn.NUMBER)
//		$ds2.addColumn('progr_peep',28,JSColumn.NUMBER)
		
		
		
		//SETEO VNI
		$ds2.addColumn('vni_seteo_ventilador',61,JSColumn.TEXT)
		$ds2.addColumn('vni_seteo_interfase',62,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_modo',63,JSColumn.TEXT)
		$ds2.addColumn('vni_seteo_presion_inspiratoria',64,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_peep',65,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_frec_respiratoria',66,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_tiempo_inspiratorio',67,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_fio2',69,JSColumn.NUMBER)
		$ds2.addColumn('vni_seteo_vol_corriente',69,JSColumn.NUMBER)
		
		
		
		for (var index = 1; index <= ds_monitoreos.getMaxRowIndex(); index++) {
			var array = new Array;
			for (var j = 1; j <= ds_monitoreos.getMaxColumnIndex(); j++) {
					array.push(ds_monitoreos.getValue(index,j))	
				
			}
			$ds2.addRow(array)
		}
		
		var csv = $ds2.getAsText(',','\n','"',true);
//	var $arch = plugins.file.showFileSaveDialog('stadistics_vm-' + application.getIPAddress() + '.xls')
	var js = plugins.file.showFileSaveDialog('monitoreos_vm_'+globals.AsiVm_adm_HistClin+'.xls', 'Select location to save export file');
	if (!js) return;

//	var success = plugins.file.writeTXTFile($arch.getAbsolutePath(),csv);
	var success = plugins.file.writeTXTFile(js, csv, 'UTF8', 'application/vnd.ms-excel');

}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"E67985A7-06DB-4B9B-A6F5-317A947E33FD"}
 */
function onActionCerrarFicha(event) {
	// TODO Auto-generated method stub
	
	if(asivm_fichakine.getSize()==1){//debe ser uno.
	
		if(asivm_fichakine.con_soporte_ventilatorio==1){
			var winFichaFinal = application.createWindow("Cierre Ficha Final", JSWindow.MODAL_DIALOG);
			winFichaFinal.title = 'Cierre de ficha';
			winFichaFinal.resizable = false;
			winFichaFinal.show(forms.Ficha_Final);
			
		}else{
			var winFichaCierre = application.createWindow("Ficha fin", JSWindow.MODAL_DIALOG);
			winFichaCierre.title = 'Ficha Fin';
			winFichaCierre.resizable = false;
			winFichaCierre.show(forms.AsiVm_Ficha_Fin);
		}
		
	}
	
	
	
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"47666AE2-C92C-4A4E-B704-95F56EF9A3BD"}
 */
function onDataChangeAltura(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true
	mostrarMotivoSegunPrestacion(globals.Asivm_prestacion)
	globals.valida_rango_campo(0,9999999,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_altura.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"4CA53907-DB0E-485C-9793-C411652AB43B"}
 */
function onDataChangePesoEstimado(oldValue, newValue, event) {
	forms.AsiVm_Monitoreo.$isDirty=true
	globals.valida_rango_campo(0,9999999,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_peso_estimado.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"26FA602C-E0D4-4E21-A055-A44D6B090C70"}
 */
function onDataChangePesoPredicho(oldValue, newValue, event) {
	forms.AsiVm_Monitoreo.$isDirty=true
	globals.valida_rango_campo(0,9999999,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_peso_predicho.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"C9F1865E-9E9C-49E4-8EC3-4A3890891221"}
 */
function onDataChangeSapII(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	globals.valida_rango_campo(0,100,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_saps_II.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"E94C9E8B-50B9-415C-ACDE-8D20F84B0D54"}
 */
function onDataChangeSobrevida(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	globals.valida_rango_campo(0,100,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_sobrevida.requestFocus()
		return true	
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param oldValue
 * @param newValue
 * @param event
 *
 * @properties={typeid:24,uuid:"A38AFFED-96AE-42CC-976C-2DE787E32287"}
 */
function onDataChangeGlasgow(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	globals.valida_rango_campo(3,15,newValue,oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_glasgow.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"D967EFFF-65E3-48B9-97E6-15533643FF47"}
 */
function onDataChangeMortalidad(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty = true
	globals.valida_rango_campo(0,100,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_mortalidad_predicha_Saps_II.requestFocus()
		return true	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"4148F280-EE04-4C47-85ED-223BBC4D20DA"}
 */
function onDataChangeScoreCharlson(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	globals.valida_rango_campo(0,20,newValue, oldValue,event,"0")
	if(!globals.errorDato){
		return false
	}else{
		elements.txt_score_charlson.requestFocus()
		return true	
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"A262007F-6779-43A4-918A-0712B01D15FD"}
 */
function onActionAltura(event) {
	// TODO Auto-generated method stub
	var tabseq = forms.AsiVm_Ficha_Inicio.controller.getTabSequence();
	if (tabseq.length > 1 && isNaN(event)) {
	var secActual= tabseq.indexOf(event.getElementName());
	    forms.AsiVm_Ficha_Inicio.controller.focusField(tabseq[secActual+1], true);
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"A7A3C1CE-EAEA-4A46-8CF4-9780CCBC0482"}
 */
function onActionPesoEstimado(event) {
	// TODO Auto-generated method stub
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EA841C54-3B8E-4415-889E-928EBC0E69EB"}
 */
function onActionPesoPredicho(event) {
	// TODO Auto-generated method stub
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4E06826E-E005-4CC5-AB43-A40850C8D7BD"}
 */
function onActionEnterSecuence(event) {
	// TODO Auto-generated method stub
	var tabseq = forms.AsiVm_Ficha_Inicio.controller.getTabSequence();
	if (tabseq.length > 1 && isNaN(event)) {
	var secActual= tabseq.indexOf(event.getElementName());
	    forms.AsiVm_Ficha_Inicio.controller.focusField(tabseq[secActual+1], true);
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"BBEADAFB-1ACE-4800-9E78-341756353DA1"}
 */
function onDataChangeDiagnostico(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	$isDirty=true
	return true
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"AB80F564-F7DD-44B8-B8B6-E5947EE83740"}
 */
function onActionVerDatoCierre(event) {
	// TODO Auto-generated method stub
	var win3 = application.createWindow("FichaCierre", JSWindow.MODAL_DIALOG);
	win3.title = 'Ficha Cierre';
	win3.resizable = false;
//	globals.AsiVm_ficha_id = asivm_fichakine.ficha_id
//	scopes.globals.AsiVm_fecha_Ficha = asivm_fichakine.fecha_fin
	scopes.globals.AsiVm_adm_HistClin = asivm_fichakine.histcli
	if(asivm_fichakine_cierre!=null && asivm_fichakine_cierre.getSize()>0){
		if(asivm_fichakine_cierre.fecha_inicio_ventilacion!=null){
			win3.show(forms.AsiVm_Ficha_Fin);
		}else{
			win3.show(forms.Ficha_Final);
		}
	
	}
}

/**
 * Handle changed data.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"D39E7022-6FEE-4A03-BC06-A4ECAD738FD1"}
 */
function onDataChangeVentilacion(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	if(newValue==13 || oldValue.indexOf(13)!=-1){
		elements.txt_otro_diag.enabled=true
	}else{
		elements.txt_otro_diag.enabled=true
	}
	$isDirty=true
	return true
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"850F71DB-E6EB-4B8C-AD5F-F578B54ABB72"}
 */
function onDataChangeSinSoporte(oldValue, newValue, event) {
	// TODO Auto-generated method stub
	globals.AsiVm_tipo=newValue
	if(asivm_rel_buscar_ficha_kine_sin_soporte.getSize()>0 && newValue==1){
		globals.DIALOGS.showInfoDialog('Atención','El paciente tiene una ficha sin soporte de Via área artificial','Aceptar')
		elements.btn_grabar.enabled=false
		return
	}else{
		elements.btn_grabar.enabled=true
	}
	if(asivm_rel_buscar_ficha_kine_sin_soporte_sin_via_area.getSize()>0 && newValue==2){
		globals.DIALOGS.showInfoDialog('Atención','El paciente tiene una ficha sin soporte de Sin Via área artificial','Aceptar')
		elements.btn_grabar.enabled=false
		return
	}else{
		elements.btn_grabar.enabled=true
	}
	return true
}
