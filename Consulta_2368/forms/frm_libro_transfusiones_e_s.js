/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"0EE703BB-27F7-44EF-BFFA-4D4DDC8F44FA",variableType:93}
 */
var frm_ult_fecha_act = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D6715DD5-3B4C-4FB0-AA90-541C120CA99F",variableType:4}
 */
var frm_num_hoja = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"467D2537-25A0-44A6-84D2-2E605F2C9D8A",variableType:4}
 */
var frm_num_libro = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"3443B3D8-B52E-4FA4-B810-E2D106B7EBDF",variableType:4}
 */
var frm_plaq_ml_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"F1C1F782-46A8-4746-A372-C51F357766D3",variableType:4}
 */
var frm_plaq_un_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"F8BA37BC-ABF4-4EFF-8C82-73A7F599BD4B",variableType:4}
 */
var frm_cryo_ml_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"EAC898C7-EC20-4F3C-AA01-C14EC6B536B6",variableType:4}
 */
var frm_cryo_un_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"9DFC4836-6C75-4845-AD1A-9F2B2A82A77E",variableType:4}
 */
var frm_plxaf_ml_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"C827C48B-24CE-4F5A-8BF0-03684A385F7F",variableType:4}
 */
var frm_plxaf_un_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"67FC1634-B63C-4892-A691-6E4E4D341C9E",variableType:4}
 */
var frm_pfc_un_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"56046351-C92F-4B2B-B680-F28DC2B289C2",variableType:4}
 */
var frm_pfc_ml_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"2B003357-BB09-4AA2-850D-B8E007DF36BE",variableType:4}
 */
var frm_pm_un_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"11AFC012-5982-4627-86C3-6266347EBDFA",variableType:4}
 */
var frm_pm_ml_sal = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"04BBA8F6-369E-4B9E-B03D-B8543A0FBB0D",variableType:4}
 */
var frm_grd_un_sal = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8315CB7D-436F-4AE1-90B1-EDC3FDF2D3D4",variableType:4}
 */
var frm_grd_ml_sal = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"87EF3DC8-3F84-49DB-B17E-4AFCF9ACC69F",variableType:4}
 */
var frm_st_un_sal = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"76C38294-9829-44CC-9436-8A3824EBD95B",variableType:4}
 */
var frm_st_ml_sal = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"17052B66-5856-4185-84F7-EEF3CAC06C50",variableType:4}
 */
var frm_plaq_ml_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"3AAF7BE9-7704-49EB-9B2B-7C7C44875B84",variableType:4}
 */
var frm_plaq_un_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"7E336DDC-7FF8-44B0-B093-03904E12AD8E",variableType:4}
 */
var frm_cryo_ml_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"B071DD7C-6633-4637-BB6F-EC26E4BCF121",variableType:4}
 */
var frm_cryo_un_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"2C17BDE1-2E6D-4C6B-A218-0F3C91407332",variableType:4}
 */
var frm_plxaf_ml_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"956278AB-8E00-4BB4-9322-3CFA6AB057DA",variableType:4}
 */
var frm_plxaf_un_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"A7E6A1A2-A536-4625-A639-589ECC277B0C",variableType:4}
 */
var frm_pfc_un_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"607E3D79-7ADC-4E36-8DCD-FEABE8D89A12",variableType:4}
 */
var frm_pfc_ml_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"CBCB40D0-6733-4C09-99BE-BEC1EDC573FB",variableType:4}
 */
var frm_pm_un_prm = 0;

/**
 * @type {Number}
 * @properties={typeid:35,uuid:"534F19E0-B0BF-401D-B59C-64818A949A6B",variableType:4}
 */
var frm_pm_ml_prm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"24C85F24-92FD-4AA3-B982-B18586CA296D",variableType:4}
 */
var frm_grd_un_prm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"565B7FC8-204B-4DBA-9519-D4C791C14A81",variableType:4}
 */
var frm_grd_ml_prm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"031EE593-31B8-43B7-A14A-AE9E8B8C1D18",variableType:4}
 */
var frm_st_un_prm = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"EB16C689-EB3C-46E9-B8F0-FC5C79A8A398",variableType:4}
 */
var frm_st_ml_prm = 0;

/**
 * @properties={typeid:35,uuid:"C3FFB669-A632-42A1-9BB2-84AFD12A355F",variableType:-4}
 */
var frm_aux = new Array();

/**
 * @properties={typeid:35,uuid:"56BC8434-BE24-4E56-8002-0411222737D9",variableType:-4}
 */
var frm_ds_aux = new Array();

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"EBF37489-A1BC-431E-94D4-6BF7907748C8"}
 */
var fechaCarga = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A57E395B-2326-4DF5-BAE2-49C3F7F8AB35"}
 */
var paciente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D986717D-5A93-41BD-A81A-5E1832E9ACCC"}
 */
var historiaClinica = '';

/**
 * @properties={typeid:35,uuid:"2D81BFAB-849E-405D-A0BC-42AD6B92A320",variableType:-4}
 */
var f_fechaHasta = null;

/**
 * @properties={typeid:35,uuid:"79597EBB-29C8-4096-A7FC-2F6D122BB32D",variableType:-4}
 */
var f_fechaDesde = null;

/**
 * 
 * @param event
 *
 * @properties={typeid:24,uuid:"89F0DE03-E0EF-44D9-A052-144A1F64BC4D"}
 */
function onAction_procesar(event) {
	
	if(validDataForm()){
	elements.lbl_procesando.visible = true
	application.updateUI()
	var fechaDesde = globals.FormatearFecha(f_fechaDesde,"AAAAMMDD");
	var fechaHasta = globals.FormatearFecha(f_fechaHasta,"AAAAMMDD");
	
	var $sql = 'SELECT compfechacarga, compNumero, don.donagrupo, don.donafactor, don.donaorigen, ban.badonombre, don.donanroorigen, compComponen, compCantidad ';	
		$sql += ' FROM tbc_componen';	 	
	 	$sql += ' left join tbc_donantes don on don.donanumero = compNumero';	 	
	 	$sql += ' left join tbc_bancodon ban on ban.badobanco = don.donahcldonante ';	 		
	 	$sql += ' WHERE compfechacarga <= ' + fechaHasta;
	    $sql += ' and compfechacarga >=  ' + fechaDesde;	   
	
	var $ds = databaseManager.getDataSetByQuery('asistencial',$sql,null,-1);	

	    $sql = 'SELECT compfechadestino, compNumero, don.donagrupo, don.donafactor, don.donaorigen, compDestino, compComponen, compCantidad ';
	    $sql += ' , pedh.pedhadmis, pedh.pedhhistclinica, don.donaestado, don.donarechsero, pedh.PedhHistClinica ';	    		 	
	    $sql += ' FROM tbc_componen';	 	
 	    $sql += ' left join tbc_donantes  don on don.donanumero = compNumero'; 	   
	 	$sql += ' left join tbc_preshemo pres on pres.prehnumero = compprotocolo and';
	 	$sql += ' pres.prehcodigo = compcodigo and pres.prehsecuen = compitprot';
	 	$sql += ' left join tbc_pedhemo  pedh on pedh.pedhnumero = compprotocolo';	
 	    $sql += ' WHERE compfechadestino <= ' + fechaHasta;
        $sql += ' and compfechadestino >=  ' + fechaDesde;    

    var $ds2 = databaseManager.getDataSetByQuery('asistencial',$sql,null,-1);
	
   	if($ds.getMaxRowIndex() > 0 || $ds2.getMaxRowIndex() > 0 ){
   	    //Procesar y crear nuevo Dataset
	    frm_ds_aux = databaseManager.createEmptyDataSet()
		frm_ds_aux.addColumn('tra_fecha',1,JSColumn.TEXT)   
		frm_ds_aux.addColumn('tra_numunidad',2,JSColumn.TEXT)
		frm_ds_aux.addColumn('tra_grupo',3,JSColumn.TEXT)
		frm_ds_aux.addColumn('tra_rh',4,JSColumn.TEXT)
		frm_ds_aux.addColumn('tra_procede_destina',5,JSColumn.TEXT)
		frm_ds_aux.addColumn('tra_st_ml_ing',6,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_st_un_ing',7,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_grd_ml_ing',8,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_grd_un_ing',9,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pm_ml_ing',10,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pm_un_ing',11,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pfc_ml_ing',12,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pfc_un_ing',13,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plaq_ml_ing',14,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plaq_un_ing',15,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_cryo_ml_ing',16,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_cryo_un_ing',17,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plxaf_ml_ing',18,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plxaf_un_ing',19,JSColumn.NUMBER)
		
		frm_ds_aux.addColumn('tra_st_ml_egr',20,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_st_un_egr',21,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_grd_ml_egr',22,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_grd_un_egr',23,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pm_ml_egr',24,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pm_un_egr',25,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pfc_ml_egr',26,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_pfc_un_egr',27,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plaq_ml_egr',28,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plaq_un_egr',29,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_cryo_ml_egr',30,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_cryo_un_egr',31,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plxaf_ml_egr',32,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_plxaf_un_egr',33,JSColumn.NUMBER)			
		
	    frm_ds_aux.addColumn('tra_fecha_num',34,JSColumn.NUMBER)
		frm_ds_aux.addColumn('tra_numunidad_num',35,JSColumn.NUMBER)
		
		frm_st_ml_sal    = frm_st_ml_prm
		frm_st_un_sal    = frm_st_un_prm
		frm_grd_ml_sal   = frm_grd_ml_prm
		frm_grd_un_sal   = frm_grd_un_prm
		frm_pm_ml_sal    = frm_pm_ml_prm
		frm_pm_un_sal    = frm_pm_un_prm
		frm_pfc_ml_sal   = frm_pfc_ml_prm
		frm_pfc_un_sal   = frm_pfc_un_prm
		frm_plaq_ml_sal  = frm_plaq_ml_prm
		frm_plaq_un_sal  = frm_plaq_un_prm
		frm_cryo_ml_sal  = frm_cryo_ml_prm
		frm_cryo_un_sal  = frm_cryo_un_prm
		frm_plxaf_ml_sal = frm_plxaf_ml_prm
		frm_plxaf_un_sal = frm_plxaf_un_prm
		
		for (var j = 1; j <= $ds.getMaxRowIndex(); j++){
	    	var $aux_registro = $ds.getValue(j,2)		
			var $aux_grupo    = $ds.getValue(j,3)
			var $aux_rh       = ''
			var $aux_destino  = ''			
			if($ds.getValue(j,5) == 1){
				$aux_destino = 'BSI Sanatorio Colegiales'
			}else{
				if($ds.getValue(j,6) != null){
					$aux_destino = $ds.getValue(j,6).substr(0,15) + '(' + $ds.getValue(j,7) +')'
				}else{
					$aux_destino = 'No se encontro el Banco'
				}
			}
			if($ds.getValue(j,4) == '+'){
				$aux_rh = ' + '
			}else{
				$aux_rh = 'NEG'
			}
			var $st_ml   = null
			var $st_un   = null
			var $grd_ml  = null
			var $grd_un  = null
			var $pm_ml   = null 
			var $pm_un   = null
			var $pfc_ml  = null
			var $pfc_un  = null
			var $pla_ml  = null
			var $pla_un  = null
			var $cry_ml  = null
			var $cry_un  = null
			var $plaf_ml = null
			var $plaf_un = null	
			
			switch ($ds.getValue(j,8)){
				case 0:$st_ml = $ds.getValue(j,9)  
					   $st_un = 1;
				       frm_st_ml_sal = frm_st_ml_sal + $st_ml;
				       frm_st_un_sal++;break;
				case 1:$grd_ml = $ds.getValue(j,9)  
				       $grd_un = 1;
				       frm_grd_ml_sal = frm_grd_ml_sal + $grd_ml;
			           frm_grd_un_sal++;break;
				case 3:$pm_ml = $ds.getValue(j,9)  
				       $pm_un = 1;
				       frm_pm_ml_sal = frm_pm_ml_sal + $pm_ml;
		               frm_pm_un_sal++;break;
				case 2:$pfc_ml = $ds.getValue(j,9)  
   				       $pfc_un = 1;
				       frm_pfc_ml_sal = frm_pfc_ml_sal + $pfc_ml;
	                   frm_pfc_un_sal++;break;
				case 5:$pla_ml = $ds.getValue(j,9)  
				       $pla_un = 1;
				       frm_plaq_ml_sal = frm_plaq_ml_sal + $pla_ml;
	                   frm_plaq_un_sal++;break;
				case 4:$cry_ml = $ds.getValue(j,9)  
				       $cry_un = 1;
				       frm_cryo_ml_sal = frm_cryo_ml_sal + $cry_ml;
	                   frm_cryo_un_sal++;break;
				case 6:$plaf_ml = $ds.getValue(j,9)  
				       $plaf_un = 1;
				       frm_plxaf_ml_sal = frm_plxaf_ml_sal + $plaf_ml;
	                   frm_plxaf_un_sal++;break;
				   
			}
			frm_ds_aux.addRow([$ds.getValue(j,1), $aux_registro, $aux_grupo, $aux_rh, $aux_destino,$st_ml,$st_un,$grd_ml,$grd_un,
                               $pm_ml,$pm_un,$pfc_ml,$pfc_un,$pla_ml,$pla_un,$cry_ml,$cry_un,$plaf_ml,$plaf_un,	    	               
                               null,null,null,null,null,null,null,null,null,null,null,null,null,null,
                               $ds.getValue(j,1), $ds.getValue(j,2)])
	    }
	    
	    for (j = 1; j <= $ds2.getMaxRowIndex(); j++){
	    	$aux_registro = $ds2.getValue(j,2)				    			
			$aux_grupo    = $ds2.getValue(j,3)
			$aux_rh       = ''
			$aux_destino  = '' 
			switch ($ds2.getValue(j,6)){
			    case 1: if($ds2.getValue(j,9) == 0){
					        globals.gbl_hiscli = $ds2.getValue(j,10)
					        $aux_destino = tbc_admision_scroll_to_tbc_admision_scroll.adm_apelnom
				        }else{
				        	globals.gbl_hiscli = $ds2.getValue(j,13)
					        $aux_destino = tbc_hist_cab_new_to_tbc_hist_cab_new.histcabapellnom				            
			            };break;
				case 2:	if($ds2.getValue(j,11) == 1){
						    if($ds2.getValue(j,12) == 0){
							    $aux_destino = 'Descarte por rechazo donante'
						    }else{
							    $aux_destino = 'Descarte por Serología'
						    }						
					    }else{
						    $aux_destino = 'Descarte'
					    };break;
				case 3:	$aux_destino = 'Otras Instituciones';break;							
				case 4: $aux_destino = 'Descarte por Vencimiento';break;							
				case 5:	$aux_destino = 'Laboratorio'; break;							
				case 6:	$aux_destino = 'Control de Calidad';break;							
				case 7:	$aux_destino = 'Descarte por Serología';break;							
				case 8:	$aux_destino = 'A Componentes';break;							
				case 9:	$aux_destino = 'Descarte por bolsa rota';break;							
				case 10:$aux_destino = 'Descarte por contam. c/glob. rojos';break;							
				case 11:$aux_destino = 'Descarte por Icterico';break;							
				case 12:$aux_destino = 'Descarte por Lipemia';break;							
				case 13:$aux_destino = 'Descarte por Exclusión por Personal';break;							
				case 14:$aux_destino = 'Descarte por Autoexclusión';break;
			}
						
			if($ds2.getValue(j,4) == '+'){
				$aux_rh = ' + '
			}else{
				$aux_rh = 'NEG'
			}
			
			$st_ml   = null
			$st_un   = null
			$grd_ml  = null
			$grd_un  = null
			$pm_ml   = null
			$pm_un   = null
			$pfc_ml  = null
			$pfc_un  = null
			$pla_ml  = null
			$pla_un  = null
			$cry_ml  = null
			$cry_un  = null
			$plaf_ml = null
			$plaf_un = null
			switch ($ds2.getValue(j,7)){				       
				case 0:$st_ml = $ds2.getValue(j,8)  
				       $st_un = 1;
			           frm_st_ml_sal = frm_st_ml_sal - $st_ml;
			           frm_st_un_sal--;break;
			    case 1:$grd_ml = $ds2.getValue(j,8)  
			           $grd_un = 1;
			           frm_grd_ml_sal = frm_grd_ml_sal - $grd_ml;
		               frm_grd_un_sal--;break;
			    case 3:$pm_ml = $ds2.getValue(j,8)  
			           $pm_un = 1;
			           frm_pm_ml_sal = frm_pm_ml_sal - $pm_ml;
	                   frm_pm_un_sal--;break;
			    case 2:$pfc_ml = $ds2.getValue(j,8)  
			           $pfc_un = 1;
			           frm_pfc_ml_sal = frm_pfc_ml_sal - $pfc_ml;
                       frm_pfc_un_sal--;break;
			    case 5:$pla_ml = $ds2.getValue(j,8)  
			           $pla_un = 1;
			           frm_plaq_ml_sal = frm_plaq_ml_sal - $pla_ml;
                       frm_plaq_un_sal--;break;
			    case 4:$cry_ml = $ds2.getValue(j,8)  
			           $cry_un = 1;
			           frm_cryo_ml_sal = frm_cryo_ml_sal - $cry_ml;
                       frm_cryo_un_sal--;break;
			    case 6:$plaf_ml = $ds2.getValue(j,8)  
			           $plaf_un = 1;
			           frm_plxaf_ml_sal = frm_plxaf_ml_sal - $plaf_ml;
                       frm_plxaf_un_sal--;break;
			}
			  
			frm_ds_aux.addRow([$ds2.getValue(j,1), $aux_registro, $aux_grupo, $aux_rh, $aux_destino,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
	    	                  $st_ml,$st_un,$grd_ml,$grd_un,$pm_ml,$pm_un,$pfc_ml,$pfc_un,$pla_ml,$pla_un,$cry_ml,$cry_un,$plaf_ml,$plaf_un,
							  $ds2.getValue(j,1), $ds2.getValue(j,2)])  
	    }
	    
	    frm_ds_aux.sort(49,true)
		frm_ds_aux.sort(48,true)
		
	    var $frm = solutionModel.getForm('lst_libro_transfusiones_e_s');
 	    var $tipos = [JSColumn.TEXT, JSColumn.TEXT, JSColumn.TEXT, JSColumn.TEXT, JSColumn.TEXT, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER
	                , JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER
					, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER
					, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER, JSColumn.NUMBER];
	    $frm.dataSource = frm_ds_aux.createDataSource('lst_libro_transfusiones_e_s', $tipos);
   	}
   	
	forms.lst_libro_transfusiones_e_s.controller.recreateUI();	
	elements.tabless.tabIndex=2;
	
	elements.cld_fechaDesde.readOnly = true;
	elements.cld_fechaHasta.readOnly = true;
	elements.lbl_procesando.visible  = false;	
	}
}

/**
 * @properties={typeid:24,uuid:"8C8F6A9B-D819-461A-8725-E84FA4DB5EB7"}
 */
function validDataForm() {
	
	var isValid = true;	
	var messageError = "No ha sido posible realizar la consulta. Corrija los siguientes errores y vuelva a intentar."
	
	if (f_fechaDesde == null){
		messageError += "\nDebe ingresar fecha desde.";        
        isValid = false;
	}
	
	if (f_fechaHasta == null){
		messageError += "\nDebe ingresar fecha hasta.";        
        isValid = false;
	}
	
	if (f_fechaHasta < f_fechaDesde){
		messageError += "\nLa fecha hasta debe ser mayor o igual a la fecha desde.";        
        isValid = false;
	}
	
	if(!isValid){		
		globals.DIALOGS.showWarningDialog("Atención",messageError,"Aceptar")
		elements.cld_fechaDesde.requestFocus();
	}
	
	return isValid;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"C9F851D4-31E0-4807-938B-02B3B4642A4B"}
 */
function onAction_limpiarForm(event) {

	f_fechaDesde = null;
	f_fechaHasta = null;
		
	if(forms.lst_libro_transfusiones_e_s.foundset.getSize() > 0){
		forms.lst_libro_transfusiones_e_s.foundset.clear();		
	}
	
	frm_ds_aux = new Array()
	elements.cld_fechaDesde.readOnly = false;
	elements.cld_fechaHasta.readOnly = false;
	elements.cld_fechaDesde.requestFocus();
	
	frm_st_ml_sal    = 0
	frm_st_un_sal    = 0
	frm_grd_ml_sal   = 0
	frm_grd_un_sal   = 0
	frm_pm_ml_sal    = 0
	frm_pm_un_sal    = 0
	frm_pfc_ml_sal   = 0
	frm_pfc_un_sal   = 0
	frm_plaq_ml_sal  = 0
	frm_plaq_un_sal  = 0
	frm_cryo_ml_sal  = 0
	frm_cryo_un_sal  = 0
	frm_plxaf_ml_sal = 0
	frm_plxaf_un_sal = 0
	cargar_param()
}

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"52EB5C3C-3A9F-4948-9BB0-76FCC0D70B14"}
 * @AllowToRunInFind
 */
function onShow_inicializarForm(firstShow, event) {
	frm_ds_aux = new Array()
	elements.cld_fechaDesde.requestFocus();	
	
	// control del elemento por perfil	    		
	var $form = controller.getName();
	globals.consulta_2368_controlarElementos($form);
	cargar_param()
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"419318CD-5380-4BC0-B716-9CBA926AC1CA"}
 */
function cargar_param(){
	// cargar datos desde parametro
	var fs = databaseManager.getFoundSet("desal","tbl_parametros")
	fs.find()
	fs['paramid']=5
	fs.search()
	if(fs.getSize()>0){					
		frm_ult_fecha_act = fs['fechadb'] ;
		frm_num_hoja      = fs['contador_entero'];
		frm_num_libro     = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=6
	fs.search()
	if(fs.getSize()>0){
		frm_st_ml_prm = fs['contador_entero'];
		frm_st_un_prm = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=7
	fs.search()
	if(fs.getSize()>0){
		frm_grd_ml_prm = fs['contador_entero'];
		frm_grd_un_prm = fs['contador_decimal'];					
	}	
	fs.find()
	fs['paramid']=9
	fs.search()
	if(fs.getSize()>0){
		frm_pm_ml_prm = fs['contador_entero'];
		frm_pm_un_prm = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=8
	fs.search()
	if(fs.getSize()>0){
		frm_pfc_ml_prm = fs['contador_entero'];
		frm_pfc_un_prm = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=11
	fs.search()
	if(fs.getSize()>0){
		frm_plaq_ml_prm = fs['contador_entero'];
		frm_plaq_un_prm = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=10
	fs.search()
	if(fs.getSize()>0){
		frm_cryo_ml_prm = fs['contador_entero'];
		frm_cryo_un_prm = fs['contador_decimal'];					
	}
	fs.find()
	fs['paramid']=12
	fs.search()
	if(fs.getSize()>0){
		frm_plxaf_ml_prm = fs['contador_entero'];
		frm_plxaf_un_prm = fs['contador_decimal'];					
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"D62FDB50-6A6F-4D79-8813-D4A8E43B5DF5"}
 */
function onAction_fechaDesde(event) {
	if(f_fechaDesde > globals.gbl_fecha_hoy){
	    globals.DIALOGS.showErrorDialog('Error','Fechas incorreta', 'Ok')
	    elements.cld_fechaDesde.requestFocus()
	}else{
        elements.cld_fechaHasta.requestFocus()
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EEF8C1EE-E160-4431-9D6F-993942E5D892"}
 */
function onAction_fechaHasta(event) {
	if(f_fechaDesde > f_fechaHasta){
	   globals.DIALOGS.showErrorDialog('Error','Fechas hasta no puede ser menor que fecha desde', 'Ok')
	   elements.cld_fechaHasta.requestFocus()
	}else{
		if(f_fechaHasta > globals.gbl_fecha_hoy){
			globals.DIALOGS.showErrorDialog('Error','Fechas incorreta', 'Ok')
			elements.cld_fechaHasta.requestFocus()
		}else{
	        elements.btn_procesar.requestFocus();
		}
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"99FB839E-FB6C-4502-93BA-092FDB9F09E8"}
 * @AllowToRunInFind
 */
function onAction_generarReporte(event) {
	
	try{
		var maxInter = frm_ds_aux.getMaxRowIndex() 
		if(maxInter > 0){			
			var message = "¿Esta seguro que desea generar el libro de entradas y salidas?";
			if(globals.DIALOGS.showQuestionDialog("Atención!",message,"Si", "No") == "Si"){
					
				var fechaDesde = globals.FormatearFecha(forms.frm_libro_transfusiones_e_s.f_fechaDesde,"AAAAMMDD");
				var fechaHasta = globals.FormatearFecha(forms.frm_libro_transfusiones_e_s.f_fechaHasta,"AAAAMMDD");
				var firstDate  = 0;
				var firstPage  = 0;
				var firstLib   = 0;
				
				var fs = databaseManager.getFoundSet("desal","tbl_parametros")
				fs.find()
				fs['paramid']=5
				fs.search()
				if(fs.getSize()>0){					
					firstDate = fs['fechadb'];
					firstPage = fs['contador_entero'];
					firstLib  = fs['contador_decimal'];					
				}
				// Validar que la fecha desde, debe ser 1 dia mas que la ultima fecha de la tabla param
				var firstDateAux = firstDate
				var dias = globals.Contar_dias(firstDateAux, f_fechaDesde)
				if(firstDate > 0 && dias == 1 ){					
					var $params = {					   
						firstPage        : firstPage,
						firstLib         : firstLib,
						frm_st_ml_sal    : frm_st_ml_sal,    
						frm_st_un_sal    : frm_st_un_sal,    
						frm_grd_ml_sal   : frm_grd_ml_sal,   
						frm_grd_un_sal   : frm_grd_un_sal,  
						frm_pm_ml_sal    : frm_pm_ml_sal,    
						frm_pm_un_sal    : frm_pm_un_sal,    
						frm_pfc_ml_sal   : frm_pfc_ml_sal,   
						frm_pfc_un_sal   : frm_pfc_un_sal,   
						frm_plaq_ml_sal  : frm_plaq_ml_sal,  
						frm_plaq_un_sal  : frm_plaq_un_sal,  
						frm_cryo_ml_sal  : frm_cryo_ml_sal,  
						frm_cryo_un_sal  : frm_cryo_un_sal,  
						frm_plxaf_ml_sal : frm_plxaf_ml_sal, 
						frm_plxaf_un_sal : frm_plxaf_un_sal,
						gbl_legajo_ac    : globals.gbl_Legajo_ac,
						gbl_nombre_legajo_ac : globals.gbl_nombre_legajo_ac,
						fechaDesde       : fechaDesde,
						fechaHasta       : fechaHasta
					}
						
					var fileName = "LB-CONTABILIDAD-" + fechaDesde + "-" + fechaHasta;				
					plugins.jasperPluginRMI.runReport(frm_ds_aux,'libro_contabilidad_lst.jasper', fileName + '.pdf',plugins.jasperPluginRMI.OUTPUT_FORMAT.PDF,$params)
					
					var url=''
					var largo_url=application.getServerURL().length
					if (largo_url<24){
						// Ambiente local
					}else{
						url = application.getServerURL().substr(0,23)
						var puerto = url.split(':');
						if(puerto[2]!='8080'){
							// Ambiente Desarrollo
							var vDirServer='/app/servoyd/application_server/server/webapps/ROOT/uploads/librohemoterapia'
						}
						else{
							// Ambiente Produccion
							vDirServer='/app/servoy/application_server/server/webapps/ROOT/uploads/librohemoterapia'
						}
						
						plugins.UserManager.register( "Hypertelia", "q9SA5eCyb085cvATVO8s9onGe3iBzJyCTel8Y7J72BuG599wodOiU5OL26/pkKyv" );
						plugins.UserManager.copyFileToServer(fileName + '.pdf',vDirServer,true);
						plugins.file.deleteFile(fileName + '.pdf')
					}					
				    
					var i = 0
					firstPage++			
					if(firstPage > 200){
						firstPage = 1
						firstLib++
					}					
					for (var j = 1; j <= frm_ds_aux.getMaxRowIndex(); j++){
						i++
						if (i == 42){							
							i = 1
							firstPage++
							
							if(firstPage > 200){
								firstPage = 1
								firstLib ++
							}
						}						
					}
					//Actualizar param						
					fs['fechadb']=  globals.IntegerToDate(utils.stringToNumber(fechaHasta)) //utils.stringToNumber(fechaHasta);
					fs['fechacbl']=  fechaHasta
					fs['contador_entero']=firstPage;
					fs['contador_decimal']=firstLib;
					databaseManager.startTransaction()
					if(databaseManager.saveData(fs)){
						databaseManager.commitTransaction()
					}else{
						error_al_grabar_param(fs)						
					}				
					
					fs.find()
					fs['paramid']=6
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_st_ml_sal;
						fs['contador_decimal'] = frm_st_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}
					fs.find()
					fs['paramid']=7
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_grd_ml_sal;
						fs['contador_decimal'] = frm_grd_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}	
					fs.find()
					fs['paramid']=9
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_pm_ml_sal;
						fs['contador_decimal'] = frm_pm_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}
					fs.find()
					fs['paramid']=8
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_pfc_ml_sal;
						fs['contador_decimal'] = frm_pfc_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}
					fs.find()
					fs['paramid']=11
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_plaq_ml_sal;
						fs['contador_decimal'] = frm_plaq_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}
					fs.find()
					fs['paramid']=10
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_cryo_ml_sal;
						fs['contador_decimal'] = frm_cryo_un_sal;
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}
					fs.find()
					fs['paramid']=12
					fs.search()
					if(fs.getSize()>0){
						fs['contador_entero'] = frm_plxaf_ml_sal;
						fs['contador_decimal'] = frm_plxaf_un_sal;	
						databaseManager.startTransaction()
						if(databaseManager.saveData(fs)){
							databaseManager.commitTransaction()
						}else{
							error_al_grabar_param(fs)						
						}
					}	
				    globals.DIALOGS.showInfoDialog("Resultado","El libro de Entradas y Salidas se generó correctamente.","Aceptar")	
						
			        }else{
				        var fechaError = firstDate.toString().substr(6,2)+"/"+firstDate.toString().substr(4,2)+"/"+firstDate.toString().substr(0,4);
				        firstDateAux.setTime(firstDateAux.getTime()+(1000*60*60*24));
				        fechaError = firstDateAux.getDate()+"/"+ (firstDateAux.getMonth()+1) + "/" + firstDateAux.getFullYear()
				        var messageDate = '\nLa fecha desde debe ser igual a ' + fechaError;
				        globals.DIALOGS.showWarningDialog("Atención","No ha sido posible generar el libro. Corrija los siguientes errores y vuelva a intentar." + messageDate + '.',"Aceptar")
			        }
		        }
	    }else{
		globals.DIALOGS.showWarningDialog("Atención!","No hay datos para generar el libro.","Aceptar")
	    }		
    }	catch(error){
		globals.DIALOGS.showErrorDialog("Error","No ha sido posible generar el libro. Vuelva a intentar. Si el problema persiste, contacte al administrador del sistema.","Aceptar")
	}	
}
/**
 * @param fs
 *
 * @properties={typeid:24,uuid:"D9D83FCD-B46A-4255-BD5F-70D76B396AAE"}
 */
function error_al_grabar_param(fs){
	var error1 = ''
	var error2 = ''
	var array = databaseManager.getFailedRecords(fs)
	for (var k = 0; k < array.length; k++) {
		var record = array[k];
		var jstable = databaseManager.getTable(record);
		var tableSQLName = jstable.getSQLName();
		error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
		error2='Error en grabación '+record.exception;
		if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
  	       var thrown = record.exception.getValue()							
		}
    }
    databaseManager.rollbackTransaction()
    if(error1!=''){
	    globals.DIALOGS.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
	    globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error1,"Ok")
	    globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error2,"Ok")
    }
    globals.DIALOGS.showErrorDialog("Error en grabación","Se ha producido un error de grabación. "+'\n'+"Avise a Sistemas, por favor.", "Ok")
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"A345BC89-5021-4D6F-A401-26105ECDDF9F"}
 */
function onHide_consultaRegistro(event) {
	if(globals.gbl_cerrarConsultaRegistro){
		var $win = application.getWindow(application.getActiveWindow().getName());
		if($win != null){
			$win.hide();
			$win.destroy();
		}
	}
	return globals.gbl_cerrarConsultaRegistro;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"1E76BE91-FD7F-4E61-925F-1B2ACE8924C5"}
 */
function onAction_cerrar(event) {
	globals.gbl_cerrarConsultaRegistro = true;
	onHide_consultaRegistro(event);
}
