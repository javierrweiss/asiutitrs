/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0047C376-6570-4373-A3ED-2E14B5F6BADA",variableType:4}
 */
var AsistFunciones_perpNomen = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E11928FF-5ABC-48BF-A621-DCDEEDAC4D42",variableType:4}
 */
var AsistFunciones_perpTipNom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"551DAAF9-1816-4426-A53A-3522CB294F1A",variableType:4}
 */
var AsistFunciones_perpServi = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"FDDFC5B6-4E8B-4311-8ECE-894628F85BD7",variableType:4}
 */
var AsistFunciones_perpUtilCa = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"430C3CA5-0C99-4B7B-9137-FB9599FA1ECE",variableType:4}
 */
var AsistFunciones_perpAdmi = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"17A0C7E4-DD19-4000-9728-2E0B99D0E85F",variableType:4}
 */
var AsistFunciones_perpLegajo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DFB31F21-E62A-4E54-9DC8-7BD0873BADE2",variableType:4}
 */
var AsistFunciones_perpTipLeg = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F98EC664-DF4C-4293-8985-B3B8185F5E32",variableType:4}
 */
var AsistFunciones_espn_tipoNom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"05D258F2-DCB8-46B3-898B-57BF8CC8B642",variableType:4}
 */
var AsistFunciones_espn_especial = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"83003CEE-CC37-4E07-AAB6-3A15FBE6329C",variableType:4}
 */
var AsistFunciones_espn_codiNom = 0;

/**
 * @properties={typeid:35,uuid:"16CCB7BB-379C-4B19-8D5C-D3F9EC97B226",variableType:-4}
 */
var AsistFunciones_wVilega = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6688C491-BF5F-4430-884B-4E9F58B5DCA0",variableType:4}
 */
var AsistFunciones_espnTipoNom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"69845141-D4A2-418C-BB07-6A2E96C88ECF",variableType:4}
 */
var AsistFunciones_espnEspecial = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8E6E83E6-6367-4049-B2E8-B01AFAD0260B",variableType:4}
 */
var AsistFunciones_espnCodiNom = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46921852-C4B1-4B38-BA40-87F672364C59",variableType:4}
 */
var AsistFunciones_espMed = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8C8CDB45-CE9B-402F-8BA5-430943853451",variableType:4}
 */
var AsistFunciones_jefeSe = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"83D69D88-F024-409F-8B0D-FE2CE341CD41",variableType:4}
 */
var AsistFunciones_medCodigo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8ED1C684-21C6-4DD2-B5E1-FB486E788E1E",variableType:4}
 */
var AsistFunciones_perLegajo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DEC40899-8464-4F0F-9109-BC32285A6842",variableType:4}
 */
var AsistFunciones_medAuTipLeg = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"91EE225A-7963-484C-9324-92D20B92B491",variableType:4}
 */
var AsistFunciones_medAuLegMed = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"023BE172-5A96-412E-AE51-F932D6AF22AD",variableType:4}
 */
var AsistFunciones_medAuCobertura = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6DE2C5B3-11C3-479D-A9CE-79DE251AE1AD",variableType:4}
 */
var AsistFunciones_nomeTipo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"222B05F8-1A08-4EF5-A24A-F27CDDA8FCD7",variableType:4}
 */
var AsistFunciones_nomeCodigo = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0B14B5C8-6745-4BE6-A8CB-9943DE48E757",variableType:4}
 */
var AsistFunciones_obrCodigo = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5838A343-2626-4C4E-B473-B1449E53B617"}
 */
var AsistFunciones_messageError = '';

/**
 * Controla el analisis entre la obra social y la especialidad
 * pr-1564
 * 
 * @param {Number} admis
 * @param {Number} hiscli
 * @param {Number} obra
 * @param {Number} analisis
 * @param {Number} legMed
 * @param {Number} tipoMed
 * @param {Number} jefeSe
 * @param {Number} especi
 * @param {Number} displa
 * @param {Number} autori
 * @param {Number} deProg
 * @param {Number} estado
 *
 * @return {Boolean}
 * @properties={typeid:24,uuid:"D316CDC8-78F2-4A33-95A7-3AE56D8CE7CB"}
 */
function AsistFunciones_controlarAnalisisEntreObraSocialEspecialidad(admis,hiscli,obra,analisis,legMed,tipoMed,jefeSe,especi,displa,autori,deProg,estado) {
	var isValid = true;
	
	// Si esta autorizado a pedir cualquier analisis, salir 
	if(autori == 1)
		return isValid;
	
	// Programas que si restringe: 1389(cons.ext.(429)) y 934(intern)
	if(deProg == 1770 || deProg == 1473 || deProg == 456)
		return isValid;
	
	// Por ahora no restringe para guardia
	if(admis == 1 || admis == 3)
		return isValid;
	
	globals.AsistFunciones_obrCodigo = obra;
	if(asistfunciones_rel_buscar_obras.getSize() == 0){
		globals.AsistFunciones_messageError = 'OBRAS inexistente en obra social y especiaidad';
		return isValid;
	}
	
	if(asistfunciones_rel_buscar_obras.obr_espami != 1)
		return isValid;
	
	//TODO queda pendiente el desarrollo para pami.
	
	
	return isValid;
}

/**
 * Controla PMO entre la obra social y cod.nomencla.
 * pr-1383
 * 
 * @param {Number} admis
 * @param {Number} hiscli
 * @param {Number} obra
 * @param {Number} tipoNom
 * @param {Number} codNom
 * @param {Number} legMed
 * @param {Number} tipoMed
 * @param {Number} jefeSe
 * @param {Number} partEs
 * @param {Number} displa
 * @param {Number} autori
 * @param {Number} estado
 *
 * @return {Boolean}
 * @properties={typeid:24,uuid:"2664351B-0187-4C5E-BC7B-DCBD836B0B14"}
 */
function AsistFunciones_controlarPMOEntreObraSocialNomencla(admis,hiscli,obra,tipoNom,codNom,legMed,tipoMed,jefeSe,partEs,displa,autori,estado) {
	var isValid = true;
	
	var mensOper = "SOLO PODRIA SOLICITARLO EL JEFE DE SERVICIO";
	var mensAuto = "-> SE PERMITE, PUES SOLICITA LEGAJO AUTORIZADO";
	var mensEspa = "PARA SOLICITAR ESTA PRESTACION.";
	var mensTxe1 = "Esta/n habilitada/s la/s especialidad/es :";
	var mensTxe2 = "Algunas especialidades habilitadas son   :";

	globals.AsistFunciones_obrCodigo = obra;
	if(asistfunciones_rel_buscar_obras.getSize() > 0){
		
		if(asistfunciones_rel_buscar_obras.obr_pmo == 0){
			
			globals.AsistFunciones_messageError = '';
			return isValid;
		}
	}
	else{

		globals.AsistFunciones_messageError = 'OBRAS inexistente en PMO';
		return isValid;
	}
	
	globals.AsistFunciones_nomeCodigo = codNom;
	globals.AsistFunciones_nomeTipo = tipoNom;
	if(isValid && asistfunciones_rel_buscar_nomencla.getSize() > 0){
		
		if(asistfunciones_rel_buscar_obras.obr_espami != 1){
			
			if(asistfunciones_rel_buscar_nomencla.nome_pmogral == 0){
				
				autori = mediAutori(obra,legMed,tipoMed);
				
				if(autori == 1)
					mensaOper(mensAuto);
				else{
					mensaOper("");
					isValid = false;
				}
			}
			else{
				if(asistfunciones_rel_buscar_nomencla.nome_pmojefe != 0){
					
					if(legMed > 0 && jefeSe != 1)
						buscoJefSer(tipoMed,legMed);
					
					if(globals.AsistFunciones_jefeSe == 0){
						
						autori = mediAutori(obra,legMed,tipoMed);
						if(autori == 1)
							mensaOper(mensAuto);
						else{
							mensaOper(mensOper);
							isValid = false;
						}
					}
				}
				
			}
		}
		
		if(asistfunciones_rel_buscar_obras.obr_espami == 1){
			// TODO que pendiente el desarrollo para pami
		}
		
	}
	else{
		globals.AsistFunciones_messageError = 'Nomenclador no existe en PMO';
		return isValid;
	}
	
	if(isValid == false){
		return isValid;
	}
	
	if(isValid){
		
		globals.AsistFunciones_espnCodiNom = codNom;
		globals.AsistFunciones_espnEspecial = 0;
		globals.AsistFunciones_espnTipoNom = tipoNom;
		// Si no se encuentran datos, entonces no hay restricciones
		if(asistfunciones_rel_buscar_espenome.getSize() == 0)
			return isValid;
	}
	
	if(isValid){
		
		if(globals.AsistFunciones_wVilega == false && legMed != 0)
			buscoJefSer(tipoMed,legMed);
		
		var verCartel = false;
		if(globals.AsistFunciones_wVilega == false && legMed == 0){
			
			if(partEs == 0)
				verCartel = true;
			else
				globals.AsistFunciones_espMed = partEs;
		}
		
		if(!verCartel){
			
			globals.AsistFunciones_espn_codiNom = codNom;
			globals.AsistFunciones_espn_especial = globals.AsistFunciones_espMed;
			globals.AsistFunciones_espn_tipoNom = tipoNom;
			// Evalua si esta habilitada
			if(asistfunciones_rel_comparar_espenome.getSize() > 0)
				return isValid;
			else
				verCartel = true;
		}
		
		if(verCartel){
			
			var sql = "select es.Esp_Descrip from tbc_espenome en"
				   + " left join tbc_ESPECIAL es on es.Esp_Codi = en.EspnEspecial"
				   + " where en.EspnEspecial > 0"
				   + " and en.EspnTipoNom = " + tipoNom
				   + " and en.EspnCodiNom = " + codNom;
				   
			var ds_esp = databaseManager.getDataSetByQuery('maestros',sql,null,-1);
			
			if(ds_esp.getMaxRowIndex() > 0){
				
				var mensTxes = "";
				var counPrint = 0;
				for(var i= 1;i <= ds_esp.getMaxRowIndex() ; i++){
					
					counPrint++;
					if(i == 1)
						mensTxes = "\n" + utils.stringTrim(ds_esp.getValue(i,1));
					else{
						if(counPrint < 4)
							mensTxes += " - " + utils.stringTrim(ds_esp.getValue(i,1));
						else{
							mensTxes += "\n" + utils.stringTrim(ds_esp.getValue(i,1));
							counPrint = 1;
						}
					}
				}
				
				var mensEspi;
				autori = mediAutori(obra,legMed,tipoMed);
				if(autori == 1)
					mensEspi = mensAuto;
				else{
					mensEspi = mensEspa;
					isValid = false;
				}
				mensaEspm(mensEspi,mensTxe1,mensTxes);
			}
		}

	}
	
	return isValid;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} mensPmo
 *
 * @properties={typeid:24,uuid:"01558F28-0FDB-44B8-81D2-84C085349D81"}
 */
function mensaOper(mensPmo) {
	
	globals.AsistFunciones_messageError = "LA PRESTACION NO ESTA CUBIERTA POR EL PMO EMERG.";
	globals.AsistFunciones_messageError += "\n( Resolucion Nro.201/02 Ministerio Salud )";
	globals.AsistFunciones_messageError += "\n"+ mensPmo;
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} mensaEspi
 * @param {String} mensaTxes
 * @param {String} mensaTxe1
 * 
 * @properties={typeid:24,uuid:"60D1A16F-D091-49E1-AFD5-AA7F89429689"}
 */
function mensaEspm(mensaEspi,mensaTxe1,mensaTxes) {
	
	globals.AsistFunciones_messageError = "LA ESPECIALIDAD MEDICA NO ESTA HABILITADA";
	globals.AsistFunciones_messageError += "\n"+mensaEspi;
	globals.AsistFunciones_messageError += "\n"+ mensaTxe1;
	globals.AsistFunciones_messageError += "\n"+ mensaTxes;
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} tipoMed
 * @param {Number} legMed
 *
 * @properties={typeid:24,uuid:"089AA9D3-D692-430A-AB45-6C5E75F9CB91"}
 */
function buscoJefSer(tipoMed,legMed) {
	
	globals.AsistFunciones_espMed = 0;
	globals.AsistFunciones_jefeSe = 0;
	globals.AsistFunciones_wVilega = false;
	
	if(tipoMed == 0){
		
		globals.AsistFunciones_perLegajo = legMed;
		
		if(asistfunciones_rel_buscar_personal.getSize() > 0){
			
			globals.AsistFunciones_wVilega = true;
		
			if(asistfunciones_rel_buscar_personal.per_tipliquid != 2){
				globals.AsistFunciones_espMed = 0;
				globals.AsistFunciones_jefeSe = 0;
			}
			else{
				
				globals.AsistFunciones_espMed = asistfunciones_rel_buscar_personal.per_espemed;;
				globals.AsistFunciones_jefeSe = asistfunciones_rel_buscar_personal.per_jefe;
			}
		}
	}
	else{
		globals.AsistFunciones_medCodigo = legMed;
		
		if(asistfunciones_rel_buscar_medicos.getSize() > 0){
			
			globals.AsistFunciones_wVilega = true;
			
			globals.AsistFunciones_espMed = asistfunciones_rel_buscar_medicos.med_espemed;
			globals.AsistFunciones_jefeSe = asistfunciones_rel_buscar_medicos.med_jefe;
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param obra
 * @param legMed
 * @param tipoMed
 *
 * @properties={typeid:24,uuid:"E2CAA8AB-58B2-4CEF-B5B1-75D0973375AA"}
 */
function mediAutori(obra,legMed,tipoMed) {
	
	var autori =0;
	
	globals.AsistFunciones_medAuCobertura = obra;
	globals.AsistFunciones_medAuLegMed = legMed;
	globals.AsistFunciones_medAuTipLeg = tipoMed;
	
	if(asistfunciones_rel_buscar_medi_autori.getSize() > 0)
		autori = 1;
	
	return autori;
}

/**
 * Programa pr-2439
 * Controla si el usuario esta autorizado a realizar pedidos de estudios
 * 
 * TIPLEG  Tipo legajo  0-Interno  1-Externo              
 * LEGAJO  Nro. de legajo sin digito verif.               
 * ADMI    Tipo de H.Clinica  0-Internado  1-Ambulatorio  
 * UTILCA  Codificacion del sector de internacion         
 * SERVI   Codigo de Servicio                            
 * TIPNOM  Nro. de Tipo de Nomenclador                    
 * NOMEN   Codigo del Nomenclador 
 * 
 * @param {Number} tipLeg
 * @param {Number} legajo
 * @param {Number} admi
 * @param {Number} utilCa
 * @param {Number} servi
 * @param {Number} tipNom
 * @param {Number} nomen
 *
 *@return {Boolean}
 * @properties={typeid:24,uuid:"86840DC5-0490-4B3D-95FC-A07CA197DADF"}
 */
function AsistFunciones_tienePermiPedUsuario(tipLeg,legajo,admi,utilCa,servi,tipNom,nomen) {
	
	var isValid = false;
	
	filtrarPedUsuario(tipLeg,legajo,admi,utilCa,servi,tipNom,nomen);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// BUSCO-TODOS
	filtrarPedUsuario(tipLeg,legajo,admi,utilCa,servi,tipNom,999999);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// PER-1
	filtrarPedUsuario(tipLeg,legajo,admi,utilCa,servi,99,999999);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// PER-2
	filtrarPedUsuario(tipLeg,legajo,admi,utilCa,99,99,999999);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// PER-3
	filtrarPedUsuario(9,999999,admi,utilCa,servi,tipNom,nomen);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// PER-4
	filtrarPedUsuario(9,999999,admi,utilCa,servi,tipNom,999999);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	// PER-5
	filtrarPedUsuario(9,999999,admi,utilCa,servi,99,999999);
	if(asistfunciones_rel_buscar_permiped.getSize() > 0)
		return true;
	
	if(admi == 0){
		
		// BUSCO-INTER
		filtrarPedUsuario(tipLeg,legajo,0,99,servi,tipNom,nomen);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-6
		filtrarPedUsuario(tipLeg,legajo,0,99,servi,tipNom,999999);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-7
		filtrarPedUsuario(tipLeg,legajo,0,99,servi,99,999999);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-8
		filtrarPedUsuario(tipLeg,legajo,0,99,99,99,999999);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-9
		filtrarPedUsuario(9,999999,0,99,servi,tipNom,nomen);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-10
		filtrarPedUsuario(9,999999,0,99,servi,tipNom,999999);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
		
		// PER-11
		filtrarPedUsuario(9,999999,0,99,servi,99,999999);
		if(asistfunciones_rel_buscar_permiped.getSize() > 0)
			return true;
	}
	
	/*
	if(!isValid)
		globals.DIALOGS.showWarningDialog("¡Atención!","Legajo no autorizado para realizar el pedido.","Aceptar");
	*/	
	return isValid;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {Number} tipLeg
 * @param {Number} legajo
 * @param {Number} admi
 * @param {Number} utilCa
 * @param {Number} servi
 * @param {Number} tipNom
 * @param {Number} nomen
 *
 * @properties={typeid:24,uuid:"D2AB09C0-075F-4044-9798-A89C6968CB0A"}
 */
function filtrarPedUsuario(tipLeg,legajo,admi,utilCa,servi,tipNom,nomen) {
	
	globals.AsistFunciones_perpTipLeg = tipLeg;
	globals.AsistFunciones_perpLegajo = legajo;
	globals.AsistFunciones_perpAdmi = admi;
	globals.AsistFunciones_perpUtilCa = utilCa;
	globals.AsistFunciones_perpServi = servi;
	globals.AsistFunciones_perpTipNom = tipNom;
	globals.AsistFunciones_perpNomen = nomen;
}

/**
 * Bloquea registros de una tabla
 * solucion : nombre de la solucion
 * formulario : nombre del formulario
 * id : identificador generico, historia clinica, protocolo ..
 * legajo : legajo del usuario bloqueante
 * titulo Error : Hisotiria clinica, protocolo ... 
 * 
 * @param {String} solucion
 * @param {String} formulario
 * @param {String} id
 * @param {String} legajo
 * @param {String} tituloError
 *
 * @return {Boolean}
 * @properties={typeid:24,uuid:"0EE8CA0D-8C96-4607-9DCE-83F3101BF54C"}
 */
function AsistFunciones_isRegisterTableLocked(solucion,formulario,id,legajo,tituloError) {
	
	var bloqueado = true;
	var serverName = "desal";
	var tableName = "asi_bloqueos";
	var userName = '';
	var largo_url = application.getServerURL().length;
	if (largo_url < 24)
		userName = "developer";
	else
		userName = plugins.UserManager.Client().userName;
	
	var hostName = application.getHostName();
	var ipAddress = application.getIPAddress();
	var fechaServer = application.getServerTimeStamp();
	   
	var msg = '';
	var msgEn = "Solucion : " + solucion + "\nFormulario : " + formulario + "\n" + tituloError + " : " + id;
	
	var sql = "begin; lock table " + tableName + " in row exclusive mode;";
    var done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
	if (done) {
		
		// Lock de registros
		sql = "select * from " + tableName + " where solucion = '" + solucion + "' and formulario = '" + formulario + "' and identificador = '" + id +"' for update;"
		done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
		if (done) {
			
			sql = "select * from " + tableName + " where solucion = '" + solucion + "' and formulario = '" + formulario + "' and identificador = '" + id +"'";
			var vDataset = databaseManager.getDataSetByQuery(serverName, sql, null, 1);
			
			if (vDataset.getMaxRowIndex()>0){
				
				if(vDataset.getValue(1,5)){
					
					bloqueado = true;
					plugins.rawSQL.executeSQL(serverName, tableName, "end;")
					globals.DIALOGS.showWarningDialog(tituloError, "Bloqueado por: \n" + msgEn + "\nLegajo : " + legajo, "Aceptar");
				}
				else{
					
					bloqueado = false;
					sql = "update " + tableName + " set"
						+ " legajo = '" + legajo
					    + "',bloqueado = " + true
					    + ",usuario = '" + userName
					    + "',equipo = '" + hostName
					    + "',ip = '" + ipAddress
						+ "',fecha = '" + fechaServer 
						+ "' where solucion = '" + solucion 
						+ "' and formulario = '" + formulario 
						+ "' and identificador = '" + id 
						+ "'; commit;";
					done = plugins.rawSQL.executeSQL(serverName, tableName, sql);
					if(!done){
						
						plugins.rawSQL.executeSQL(serverName, tableName, "end;")
						globals.DIALOGS.showWarningDialog(tituloError, "No ha sido posible bloquear : \n" + msgEn, "Aceptar");
					}
				}
			}
			else{
				
				bloqueado = true;
				sql = "insert into " + tableName +" values " 
					       + "('" + solucion
						   + "','" + formulario
						   + "','" + id
						   + "','" + legajo
						   + "','" + bloqueado
						   + "','" + userName
						   + "','" + hostName
						   + "','" + ipAddress
						   + "','" + fechaServer
						   + "');"
					       + " commit;"
				
				done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
				if (!done) {
					
					plugins.rawSQL.executeSQL(serverName, tableName, "end;")
					msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
					globals.DIALOGS.showWarningDialog(tituloError, "Error al bloquear :\n" + msgEn + '\nSQL exception: ' + msg, 'Aceptar')
				}
				else{
					bloqueado = false;
				}
			}
		}
		else{
			
			plugins.rawSQL.executeSQL(serverName, tableName, "end;")
			globals.DIALOGS.showWarningDialog(tituloError, "Error al consultar registro bloqueado :\n" + msgEn + "Error en Select for update" , 'Aceptar')
		}
	}
	else{
		
		msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		globals.DIALOGS.showWarningDialog(tituloError, "Error al consultar registro bloqueado :\n" + msgEn + "\nSQL exception:" + msg, 'Aceptar')
	}
  
	return bloqueado;
}

/**
 * Desbloquea registros de una tabla
 * solucion : nombre de la solucion
 * formulario : nombre del formulario
 * id : identificador generico, historia clinica, protocolo ..
 * legajo : legajo del usuario bloqueante
 * titulo Error : Hisotiria clinica, protocolo ... 
 * 
 * @param {String} solucion
 * @param {String} formulario
 * @param {String} id
 * @param {String} legajo
 * @param {String} tituloError
 *
 * @return {Boolean}
 * @properties={typeid:24,uuid:"A0F3DE4F-B4FF-4266-A326-60C4686B8F16"}
 */
function AsistFunciones_unLockRegisterTable (solucion,formulario,id,legajo,tituloError) {
	
	var result = false;
	
	var serverName = "desal";
	var tableName = "asi_bloqueos";
	var userName = '';
	var largo_url = application.getServerURL().length;
	if (largo_url < 24)
		userName = "developer";
	else
		userName = plugins.UserManager.Client().userName;
	
	var hostName = application.getHostName();
	var ipAddress = application.getIPAddress();
	var fechaServer = application.getServerTimeStamp();
	
	var msg = '';
	var msgEn = "Solucion : " + solucion + "\nFormulario : " + formulario + "\n" + tituloError + " : " + id;
	
	var sql = "begin; lock table " + tableName + " in row exclusive mode;";
    var done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
	if (done) {
		
		// Lock de registros
		sql = "select * from " + tableName + " where solucion = '" + solucion + "' and formulario = '" + formulario + "' and identificador = '" + id +"' for update;"
		done = plugins.rawSQL.executeSQL(serverName,tableName,sql);
		if (done) {
			
			//sql = "update " + tableName + " set bloqueado = false,fecha = '" + application.getServerTimeStamp() + "' where solucion = '" + solucion + "' and formulario = '" + formulario + "' and identificador = '" + id + "'; commit;";
			sql = "update " + tableName + " set"
			+ " legajo = '" + legajo
		    + "',bloqueado = " + false
		    + ",usuario = '" + userName
		    + "',equipo = '" + hostName
		    + "',ip = '" + ipAddress
			+ "',fecha = '" + fechaServer 
			+ "' where solucion = '" + solucion 
			+ "' and formulario = '" + formulario 
			+ "' and identificador = '" + id 
			+ "'; commit;";
			done = plugins.rawSQL.executeSQL(serverName, tableName, sql);
			if(!done){
				
				plugins.rawSQL.executeSQL(serverName, tableName, "end;")
				globals.DIALOGS.showWarningDialog(tituloError,"Error al desbloquear :\n"+ msgEn, "Aceptar");
			}
		}
		else{
			
			plugins.rawSQL.executeSQL(serverName, tableName, "end;")
			globals.DIALOGS.showWarningDialog(tituloError, "Error al desbloquear :\n" + msgEn + '\nError en Select for update' , 'Ok')
		}
	}
	else{
		
		msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
		globals.DIALOGS.showWarningDialog(tituloError, "Error al desbloquear :\n" + msgEn + '\nSQL exception: ' + msg, 'Ok');
	}
	
	return result;
}