/**
 * @properties={typeid:35,uuid:"09A2F42D-A1B8-4F7B-8684-C0004A5F42F0",variableType:-4}
 */
var $_dsAnatpaOb = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"81DE201D-8C8F-4D64-A42D-697644E6025B",variableType:4}
 */
var $fechaPedido = 0;

/**
 * @properties={typeid:35,uuid:"8A87BC54-83B7-4101-8882-9618722FB9F5",variableType:-4}
 */
var $ds_prestGuar = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6191CBEC-4107-4623-8D44-EE53501A2545",variableType:4}
 */
var $servicio = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"66AD035D-386F-4F39-8981-23C8654E524E",variableType:4}
 */
var $parUltNumero_1 = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2F11A272-EF92-4FB2-BC96-F2E409082B32"}
 */
var $itv_descripcion = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2B6BFEE9-2245-44A2-928B-8DA9ADA1FCB5",variableType:4}
 */
var $horaIngreso = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F9D73208-9898-4767-B516-4E6EA152C224",variableType:4}
 */
var $fechaIngreso = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8FF5CBD4-E50B-4D9C-9836-779B598DA0DB"}
 */
var $nombreMedico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F7D86EA1-E858-4388-8F02-77ECBBD30F5B"}
 */
var $matriculaMedico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4CD91EFA-E6B2-44BF-A78A-A4F05210803A"}
 */
var $nroDocu = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"66BD0A5F-7749-48C4-8F54-C5DB9742F33C",variableType:4}
 */
var $tipoDocu = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B95ADB09-5B33-49D2-BEC8-E978EB7DECD6"}
 */
var $nroInternado = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"FC400D9D-B8A7-427D-A4C2-D83EBE7CCE45",variableType:4}
 */
var f_fecNac = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"81C9180B-0C7A-49FC-A523-298AE02CDACE",variableType:4}
 */
var f_ciriIeCiru = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"99A167DE-AA27-448E-A401-CF1D3C3E328E",variableType:4}
 */
var f_ciriLegCiru = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"98B82FB1-30E0-485C-8AA0-2338C8259C1B",variableType:4}
 */
var f_ciriInterven = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"656D3621-53C4-4415-A38A-80325628401E",variableType:4}
 */
var f_obrSoc = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"922549BB-F5E8-472B-A06D-BC8C7EAAF021"}
 */
var f_planObr = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"51F68322-3DEC-4ABA-9134-65DF17169967"}
 */
var f_fechaHasta = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"59691FA6-BF35-4995-ABC4-66C14837F809"}
 */
var f_fechaDesde = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"89DC9BAF-9A34-4FD5-A521-DBF78FB0CC27"}
 */
var $messageErrorAmbu = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"18BBA776-E8A0-4316-A5B7-90722AB61B65",variableType:4}
 */
var f_ploEstado = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"459F56F1-5EBF-48D9-9086-21FEA5C0AEC5"}
 */
var $messageErrorInter = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"56247640-B603-4F58-AC4D-06E45BC6230F"}
 */
var f_obrMotSusp = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B6205F18-AEAE-46CF-BEBF-AAC3DB595F33",variableType:4}
 */
var f_obrEstado = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"88170F47-08D6-4CB6-B1E0-6ACE98178E21",variableType:4}
 */
var f_obrEsPami = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"0038DC7F-5427-445D-95F8-07C4D9FEA5F6",variableType:93}
 */
var f_fecEpic = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"43278420-E018-42F1-8D6B-632B466F4396",variableType:93}
 */
var f_fecaltaefec = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"33892826-4A56-4059-9BAD-EE797DB2224E"}
 */
var f_observaPractica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A26F3118-7B9A-44F0-BA1E-B4F5A87C6A23"}
 */
var f_obserGeneral = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"17FEDBB0-3333-42EC-859F-D0689EC15DAE"}
 */
var f_nroInternado = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3BD12093-77AB-4255-BBA0-7E857E7A0A7F"}
 */
var f_nombre = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"5E63BD5A-A749-4334-B582-9434BE8DDD75",variableType:4}
 */
var f_nroPedido = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3F6366A9-8860-4EF3-A999-2C92CE84B2C1"}
 */
var f_nroAfiliado = null;

/**
 * @properties={typeid:35,uuid:"A7CB5EA5-5012-4AD1-A5C3-A66824EC66A8",variableType:-4}
 */
var f_cerrarForm = false;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"30599CC1-ECB5-49ED-98F6-A43960DA57B9",variableType:4}
 */
var f_nroSolicitud = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"2A2B7522-DAF3-4371-B55A-3EDCAD00957C",variableType:93}
 */
var f_fechaSolicitud = null;

/**
 * @properties={typeid:35,uuid:"07A91F67-9F9F-411B-B5B6-B6CF53C14564",variableType:-4}
 */
var $isDirty = false;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0458A37A-5E18-4AE6-84B5-33B6643BD8DD"}
 */
var f_id = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"950ED0B9-F64C-4815-A7F8-8F07A11B4E24"}
 */
var f_plan = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3B50CEF4-19F6-43F9-A5F1-116AE950A3DA"}
 */
var f_histClinUnica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D6F41EA4-71E8-45F2-A0C0-16B10CDCFA66"}
 */
var f_cobertura = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BE8214F1-3015-45DE-931B-9E29E6F54F5E"}
 */
var f_paciente = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"08B22C09-39F5-471C-80E8-EBC57F932319",variableType:4}
 */
var f_servicio = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D1F119AF-A7BC-4202-8305-A8F4B5A4AA0C",variableType:4}
 */
var f_tipoPaciente = null;

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"81FF7113-DB5E-4CB0-B8DF-D85DCECD0C42"}
 */
function onShow_inicializarForm(firstShow, event) {
	
	var dataset = databaseManager.getDataSetByQuery("desal","select anat_servi_descri display_values,anat_servi_codigo optional_real_values from anat_servicios where anat_servi_codigo != 21 and anat_servi_codigo != 23",null,-1);
	elements.cbo_servicio.setValueListItems(dataset);
	
	setVisibleElementsAux(false);
	obtenerParUltNumero_1();
	
	var dsProtesis = databaseManager.createEmptyDataSet();
	dsProtesis.addColumn('id');
	dsProtesis.addColumn('apde_codnom');
	dsProtesis.addColumn('descripcion');
	dsProtesis.addColumn('apde_cantidad');
	dsProtesis.addColumn('apde_observa');
	dsProtesis.addColumn('observacion');
	dsProtesis.addColumn('apde_tipnom');
	
	var $frm = solutionModel.getForm('Anatpa_tbl_anatpade');
	var $tipos = [JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT];
	$frm.dataSource = dsProtesis.createDataSource('Anatpa_tbl_anatpade', $tipos);
	forms.Anatpa_tbl_anatpade.controller.recreateUI();

	if(f_id == null){
		f_fechaSolicitud = utils.timestampToDate(application.getServerTimeStamp());
		setVisibleElements(false);
		elements.btn_nuevo.requestFocus();
	}
	
	// control del elemento por perfil	    		
	var $form = controller.getName();
	//globals.prote_controlarElementos($form);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"C5B14333-56F6-4E89-991C-FCB6E71242E0"}
 */
function onAction_agregarItem(event) {
	
	forms.Anatpa_dlg_agregarItem.$item = null;
	
	var win = application.createWindow("agregar_practica",JSWindow.MODAL_DIALOG);	
    win.title= 'Agregar Prácticas';
    win.resizable = false;
    win.show(forms.Anatpa_dlg_agregarItem);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"B2E3370A-2AAE-44BE-A8C9-E5F9116A3476"}
 * @AllowToRunInFind
 */
function onAction_btnGuardar(event) {
	
	var res = globals.DIALOGS.showQuestionDialog('¡Atención!','¿ Esta seguro que desea guardar la Solicitud de Anatomía Patológica ?', 'Si', 'No');
	if( res == 'Si'){
		
	if($isDirty && f_id == null){
		
		if(isValidDataForm()){
			
			if(isValidData()) {
				
				var nroSolicitud = null;
				
				var done0 = plugins.rawSQL.executeSQL("parametros", "param", "begin; lock table param in row exclusive mode;")
				if (!done0) {
					var msg0 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
					plugins.dialogs.showErrorDialog('Error', 'SQL exception: ' + msg0, 'Ok');
				}
				var done = plugins.rawSQL.executeSQL("parametros", "param", "select * from param where key_param = 1 for update;");
				if (!done) {
					var msg = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
					plugins.dialogs.showErrorDialog('Error', 'SQL exception: ' + msg, 'Ok');
				}

				var vQuery = " SELECT prm_31 FROM param WHERE key_param = 1";
				var vDataset = databaseManager.getDataSetByQuery("parametros", vQuery, null, 1);
				
				var done1 = plugins.rawSQL.executeSQL("parametros", "param", "update param set prm_31 = prm_31 + 1 where key_param = 1; commit;")
				if (done1) {
					
					nroSolicitud = vDataset.getValue(1,1) + 1;
				}
				else{
					var msg1 = plugins.rawSQL.getException().getMessage(); //see exception node for more info about the exception obj
					plugins.dialogs.showErrorDialog('Error', 'SQL exception: ' + msg1, 'Ok')
				}
				
				if (nroSolicitud != null) {
					
					var fs_anatPaca = databaseManager.getFoundSet("asistencial","tbc_anatpaca");
					if(f_id == null || f_id == 'null'){
						
						if(f_nroPedido == null)
							f_nroPedido = 0;
						else{
							if(f_servicio == 21 || f_servicio == 22 || f_servicio == 23)
								f_nroPedido = nroSolicitud;
						}
						
						fs_anatPaca.newRecord();
						fs_anatPaca['apca_nrosolic'] = nroSolicitud; // pk not nuyll INTEGER
						fs_anatPaca['apca_servicio'] = f_servicio == null ? 0 : f_servicio;	// not null INTEGER
						fs_anatPaca['apca_protocolo'] = f_nroPedido;// not null INTEGER
						fs_anatPaca['apca_tipadmi'] = f_tipoPaciente == 0 ? 0 : 1;	// not null INTEGER
						fs_anatPaca['apca_histclin'] = f_tipoPaciente == 0 ? f_nroInternado : f_histClinUnica;	// not null DECIMAL
						//fs_anatPaca['apca_fecingr'] = globals.FormatearFecha(utils.timestampToDate( application.getServerTimeStamp()),'AAAAMMDD');	// not null INTEGER
						//fs_anatPaca['apca_horingr'] = globals.FormatearFecha(application.getServerTimeStamp(),'HHMM');	// not null INTEGER
						fs_anatPaca['apca_fecingr'] = $fechaIngreso == null ? 0: $fechaIngreso; // not null INTEGER ok
						fs_anatPaca['apca_horingr'] = $horaIngreso == null ? 0: $horaIngreso; // not null INTEGER ok
						fs_anatPaca['apca_fecsolic_3'] = globals.FormatearFecha(utils.timestampToDate( application.getServerTimeStamp()),'AAAAMMDD');	// not null INTEGER
						fs_anatPaca['apca_nrosolic_3'] = nroSolicitud;	// not null INTEGER
						fs_anatPaca['apca_obsgral'] = utils.stringTrim(f_obserGeneral).length > 0 ? 1 : 0; // INTEGER
						fs_anatPaca['apca_lineas'] = fs_anatPaca['apca_obsgral'] == 1 ? observaLineas(f_obserGeneral) : 0;	// INTEGER
						fs_anatPaca['apca_histnom'] = utils.stringTrim(f_nombre); // not null CHAR 30
						fs_anatPaca['apca_fecreci'] = 0; // INTEGER ok
						fs_anatPaca['apca_fecentre'] = 0; // INTEGER ok
						fs_anatPaca['apca_estado'] = 0;	// INTEGER ok
						fs_anatPaca['apca_tipmed'] = f_ciriIeCiru == null ? 0: f_ciriIeCiru;	// INTEGER
						fs_anatPaca['apca_codmed'] = f_ciriLegCiru == null ? 0 : f_ciriLegCiru;	// INTEGER
						
						// Sobre el informe primero
						fs_anatPaca['apca_feccargares'] = 0; // INTEGER ok
						fs_anatPaca['apca_profinfor'] = ' ';	// not null CHAR 20 ok
						fs_anatPaca['apca_matprofinfor'] = 0;	// DECIMAL ok
						
						// Sobre el informe complementario
						fs_anatPaca['apca_feccargacompl'] = 0;	// INTEGER ok
						fs_anatPaca['apca_profinforcompl'] = ' ';	// not null CHAR 20 ok
						fs_anatPaca['apca_matprofinforcompl'] = 0;	// DECIMAL ok
						
						fs_anatPaca['apca_obrsoc'] = f_obrSoc;	// INTEGER ok
						
						if(f_tipoPaciente == 3){
							fs_anatPaca['apca_servicio'] = 23;	// not null INTEGER
							fs_anatPaca['apca_protocolo'] = fs_anatPaca['apca_nrosolic'];	// not null INTEGER
							fs_anatPaca['apca_tipmed'] = 1;	// INTEGER
							fs_anatPaca['apca_codmed'] = 9999;	// INTEGER
							
						}
						
						if(f_servicio == 22 && f_tipoPaciente == 0){
							fs_anatPaca['apca_protocolo'] = fs_anatPaca['apca_nrosolic'];	// not null INTEGER	
						}
					}
					
 					var fs_anatPade = databaseManager.getFoundSet("asistencial","tbc_anatpade");
					var k;
					var id;
					var fs_prestGuar = databaseManager.getFoundSet("asistencial","tbc_prest_guar");
					var fs_prestCons = databaseManager.getFoundSet("asistencial","tbc_prest_cons");
					
					for(k= 1;k <= forms.Anatpa_tbl_anatpade.foundset.getSize(); k++){
							
						forms.Anatpa_tbl_anatpade.foundset.setSelectedIndex(k);
						id = forms.Anatpa_tbl_anatpade.foundset['id'];
							
						if(id == null || id == 'null'){
								
							fs_anatPade.newRecord();
							
							fs_anatPade['apde_nrosolic'] = fs_anatPaca['apca_nrosolic']; // pk not null INTEGER
							fs_anatPade['apde_tipnom'] = forms.Anatpa_tbl_anatpade.foundset['apde_tipnom'];	// pk not null INTEGER
							fs_anatPade['apde_codnom'] = forms.Anatpa_tbl_anatpade.foundset['apde_codnom'];	// pk not null INTEGER
							fs_anatPade['apde_servicio'] = fs_anatPaca['apca_servicio'];	// not null INTEGER
							fs_anatPade['apde_protocolo'] = fs_anatPaca['apca_protocolo'];	// not null INTEGER
							fs_anatPade['apde_tipadmi'] = fs_anatPaca['apca_tipadmi']; // not null INTEGER
							fs_anatPade['apde_histclin'] = fs_anatPaca['apca_histclin']; // not null DECIMAL
							fs_anatPade['apde_fecingr'] = fs_anatPaca['apca_fecingr']; // not null INTEGER
							fs_anatPade['apde_horingr'] = fs_anatPaca['apca_horingr']; // not null INTEGER
							fs_anatPade['apde_fecsolic'] = fs_anatPaca['apca_fecsolic_3']; // not null INTEGER
							fs_anatPade['apde_nrosolic_3'] = fs_anatPaca['apca_nrosolic'];	// not null INTEGER
							fs_anatPade['apde_tipnom_3'] = forms.Anatpa_tbl_anatpade.foundset['apde_tipnom']; // not null INTEGER
							fs_anatPade['apde_codnom_3'] = forms.Anatpa_tbl_anatpade.foundset['apde_codnom']; // not null INTEGER
							fs_anatPade['apde_cantidad'] = forms.Anatpa_tbl_anatpade.foundset['apde_cantidad']; //INTEGER
							fs_anatPade['apde_observa'] = forms.Anatpa_tbl_anatpade.foundset['apde_observa']; //INTEGER
							fs_anatPade['apde_lineas'] = (fs_anatPade['apde_observa'] == 1 ? observaLineas(forms.Anatpa_tbl_anatpade.foundset['observacion']) : 0);	//INTEGER
							
							if(f_tipoPaciente == 1){
								
								// GRAB-PRESTGU
								fs_prestGuar.newRecord();
								
								fs_prestGuar['pregcodnome'] = forms.Anatpa_tbl_anatpade.foundset['apde_codnom'];
								fs_prestGuar['pregfechaingreso'] = fs_anatPaca['apca_fecingr'];
								fs_prestGuar['preghistclinica'] = fs_anatPaca['apca_histclin'];
								fs_prestGuar['preghoraingreso'] = fs_anatPaca['apca_horingr'];
								fs_prestGuar['pregsecuencia'] = 1;
								fs_prestGuar['pregtiponome'] = forms.Anatpa_tbl_anatpade.foundset['apde_tipnom'];
								fs_prestGuar['pregcantidad'] = forms.Anatpa_tbl_anatpade.foundset['apde_cantidad'];
								fs_prestGuar['pregestado'] = 0;
								fs_prestGuar['preghorapedido'] = $ds_prestGuar.getValue(1,3);// PregHoraPedido
								fs_prestGuar['pregletrafc'] = ' ';
								fs_prestGuar['pregmedico'] = $ds_prestGuar.getValue(1,4);// PregMedico
								fs_prestGuar['pregnumefc'] = '000000';
								fs_prestGuar['pregpasehistpac'] = $ds_prestGuar.getValue(1,5);// PregPasehistpac
								fs_prestGuar['pregpedido'] = getPregPedido();
								fs_prestGuar['pregpedido2'] = getPregPedido();
								fs_prestGuar['pregservicio2'] = $ds_prestGuar.getValue(1,6);// PregServicio2
								fs_prestGuar['pregtipoestu2'] = $ds_prestGuar.getValue(1,7);// pregtipoestu2
								fs_prestGuar['pregtipomed'] = $ds_prestGuar.getValue(1,8);// pregtipomed
								fs_prestGuar['pregtipoprest'] = $ds_prestGuar.getValue(1,9);// pregtipoprest
		
							}
							else{
								if(f_tipoPaciente == 2){
									
									// GRAB-PRESCON
									fs_prestCons.newRecord();
									
									fs_prestCons['preccodnome'] = forms.Anatpa_tbl_anatpade.foundset['apde_codnom'];
									fs_prestCons['precfecha'] = anatpa_rel_buscar_reservas.reservasfech;
									fs_prestCons['prechistclinica'] = fs_anatPaca['apca_histclin'];
									fs_prestCons['prechora'] = getHoraHHMM_deHHMMssmm(anatpa_rel_buscar_reservas.reservashora);
									fs_prestCons['precsecuencia'] = 1;//ok
									fs_prestCons['prectiponome'] = forms.Anatpa_tbl_anatpade.foundset['apde_tipnom'];
									fs_prestCons['preccantidad'] = forms.Anatpa_tbl_anatpade.foundset['apde_cantidad'];
									fs_prestCons['precesp'] = anatpa_rel_buscar_reservas.reservasesp;
									fs_prestCons['precestado'] = 0;// ok
									fs_prestCons['precfecha2'] = anatpa_rel_buscar_reservas.reservasfech;
									fs_prestCons['prechora2'] = anatpa_rel_buscar_reservas.reservashora;
									fs_prestCons['prechorapedido'] = globals.CapturaHoraSistema("HHMM");
									fs_prestCons['precletrafc'] = ' ';//ok
									fs_prestCons['precmed'] = anatpa_rel_buscar_reservas.reservasmed;
									fs_prestCons['precnumerofc'] = 0;//ok
									fs_prestCons['precpasehistpac'] = 0;//ok
									fs_prestCons['precpedido'] = fs_anatPaca['apca_protocolo'];
									fs_prestCons['prectipoprest'] = 7;//ok
									fs_prestCons['prectipomed'] = 0;// Se completa al guardar
								}
							}	
						}
					}
					
					// Actualizando base de datos
					//databaseManager.startTransaction();
					var resultSaveMessage = '';
					var resultSaveAux = true;
					
					var resultSave = databaseManager.saveData(fs_anatPaca.getRecord(1));
					if(!resultSave)
						resultSaveMessage += "\nNo ha sido posible grabar en asistencial-tbc_anatpaca.";
					
					if(resultSave){
						
						resultSaveAux = databaseManager.saveData(fs_anatPade);
						if(!resultSaveAux){
							resultSaveMessage += "\nNo ha sido posible grabar en asistencial-tbc_anatpade.";
							resultSave = resultSaveAux;
						}
						
						//Actualizar cirugin
						if(f_servicio == 11 && f_tipoPaciente == 0){
							
							var fs_cirugint = databaseManager.getFoundSet("asistencial","tbc_cirugint");
							fs_cirugint.find();
							fs_cirugint['cirihistcl']= f_nroInternado;
							fs_cirugint['ciriprotocolo']= f_nroPedido;
							fs_cirugint['ciricodnome']= 0;
							fs_cirugint['ciricodnome']= 0;
							fs_cirugint['ciripatologia']= 0;
							fs_cirugint.search();
							
							if(fs_cirugint.getSize()>0){
								
								fs_cirugint['ciripatologia'] = 1;
								resultSaveAux = databaseManager.saveData(fs_cirugint);
								if(!resultSaveAux){
									resultSaveMessage += "No ha sido posible grabar en asistencial-tbc_cirugint.";
									resultSave = resultSaveAux;
								}
							}
						}
						
						// guardando observacion general
						if(utils.stringTrim(f_obserGeneral).length > 0)
							observaciones(nroSolicitud,f_obserGeneral,0,0,true);
						
						// Guardando observacion de practicas
						for(k= 1;k <= forms.Anatpa_tbl_anatpade.foundset.getSize(); k++){
								
							forms.Anatpa_tbl_anatpade.foundset.setSelectedIndex(k);
							if(utils.stringTrim(forms.Anatpa_tbl_anatpade.foundset['observacion']).length > 0)
								observaciones(nroSolicitud,forms.Anatpa_tbl_anatpade.foundset['observacion'],forms.Anatpa_tbl_anatpade.foundset['apde_codnom'],forms.Anatpa_tbl_anatpade.foundset['apde_tipnom'],true);
						}
						forms.Anatpa_tbl_anatpade.controller.recreateUI();
						
						var count = 0;
						// GRAB-PRESTGU
						if(fs_prestGuar.getSize() > 0){
							
							count = 0;//cantidad de intentos de save por clave duplicado
							
							for(var g=1; g<=fs_prestGuar.getSize(); g++){
								
								fs_prestGuar.setSelectedIndex(g);
								resultSaveAux = databaseManager.saveData(fs_prestGuar.getRecord(g));
								
								if(resultSaveAux == false){
									
									var array1 = databaseManager.getFailedRecords();
									if(array1.length > 0){
										
										var record1 = array1[0];
										if (record1.exception.getMessage().search(/duplicate key/i)){
											
											count++;
											fs_prestGuar['pregsecuencia'] = Number(fs_prestGuar['pregsecuencia']) + 1;//ok
											g--;
										}
										else
											break;	
									}
									else
										break;									
								}
								else{
									count = 0;
								}
								
								//Si la cantidad de intentos de save por clave duplicada es igual a 20 salir. esto es por cada item
								if(count == 20)
									break;
							}
							
							if(!resultSaveAux){
								resultSaveMessage += "\nNo ha sido posible grabar en asistencial-tbc_tbc_prest_guar.";
								resultSave = resultSaveAux;
							}
						}
							
						// GRAB-PRESCON
						if(fs_prestCons.getSize() > 0){
							
							var tipoMed = 0;
							var legajo = anatpa_rel_buscar_reservas.reservasmed;
							
							if(legajo > 1)
								legajo = String(legajo).substr(0,String(legajo).length - 1);
							
							var fs_Personal = databaseManager.getFoundSet("maestros","tbc_personal");
							fs_Personal.find();
							fs_Personal['per_legajo'] = legajo;
							fs_Personal.search();
							
							if(fs_Personal.getSize() == 0)
								tipoMed = 1;
							
							count = 0;//cantidad de intentos de save por clave duplicado
							
							for(var p=1; p<=fs_prestCons.getSize(); p++){
								
								fs_prestCons.setSelectedIndex(p);
								fs_prestCons['prectipomed'] = tipoMed;
								
								resultSaveAux = databaseManager.saveData(fs_prestCons.getRecord(p));
								
								if(resultSaveAux == false){
									
									var array2 = databaseManager.getFailedRecords();
									if(array2.length > 0){
										
										var record2 = array2[0];
										if (record2.exception.getMessage().search(/duplicate key/i)){
											
											count++;
											fs_prestCons['precsecuencia'] = Number(fs_prestCons['precsecuencia']) + 1;//ok
											p--;
										}
										else
											break;	
									}
									else
										break;									
								}
								else{
									count = 0;
								}
								
								//Si la cantidad de intentos de save por clave duplicada es igual a 20 salir. esto es por cada item
								if(count == 20)
									break;
							}
							
							if(!resultSaveAux){
								resultSaveMessage += "No ha sido posible grabar en asistencial-tbc_tbc_prest_cons";
								resultSave = resultSaveAux;
							}
						}
					}
					
					if(resultSave){
						
						//databaseManager.commitTransaction();
						
						f_nroSolicitud = nroSolicitud;
						f_id = nroSolicitud;
						f_fechaSolicitud = globals.IntegerToDate(Number(fs_anatPaca['apca_fecsolic_3']));
						globals.anatpa_interface_nroSolicitud = nroSolicitud;
						
						for(k = 1; k <= forms.Anatpa_tbl_anatpade.foundset.getSize(); k++){
							forms.Anatpa_tbl_anatpade.foundset.setSelectedIndex(k);
							forms.Anatpa_tbl_anatpade.foundset['id'] = nroSolicitud;
						}
						
						if(f_servicio == 11){
							
							var fs_interven = databaseManager.getFoundSet("maestros","tbc_interven");
							fs_interven.find();
							fs_interven['itv_codi']= f_ciriInterven;
							fs_interven.search();
							
							if(fs_interven.getSize()>0){
								$itv_descripcion = utils.stringTrim(fs_interven['itv_descripcion']);
								globals.DIALOGS.showInfoDialog("Información","Intervencion: ." + $itv_descripcion,"Aceptar");
							}
						}
							
						imprimir();
						globals.DIALOGS.showInfoDialog("Resultado","La solicitud de Anatomía Patológica se Guardo e Imprimió correctamente.\n","Aceptar");
						
						/*
						var print = globals.DIALOGS.showQuestionDialog('¡Atención!','¿Desea imprimir el comprobante de la solicitud?', 'Si', 'No');
						if( print == 'Si'){
							imprimir();
							//globals.DIALOGS.showInfoDialog("Informacion","Imprimiendo comprobante de solicitud...","Aceptar");
						}
						*/
						setVisibleElements(true);
						setEditableElements(false);
						
						$isDirty = false;
					}
					else{
						
						f_nroPedido = 0;
						
						var error1 = ''
						var error2 = ''
						var array = databaseManager.getFailedRecords()
						for (var i = 0; i < array.length; i++) {
							var record = array[i];
							var jstable = databaseManager.getTable(record);
							var tableSQLName = jstable.getSQLName();
							error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
							error2='Error en grabación '+record.exception;
							if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
								// exception thrown in pre-insert/update/delete event method
								var thrown = record.exception.getMessage()
								//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
							}
						}
						
						//databaseManager.rollbackTransaction();
						
						if(error1!=''){
							globals.DIALOGS.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
							globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error1,"Aceptar")
							globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error2,"Aceptar")
						}
						globals.DIALOGS.showErrorDialog("Error en grabación","Se ha producido un error de grabación. "+'\n'+"Avise a Sistemas, por favor." + resultSaveMessage, "Aceptar")
					}
					
				}
				else{
					
					globals.DIALOGS.showWarningDialog("Atención!","No ha sido posible guardar la solicitud. Vuelva a intentar.\nSi el problema persiste contacte al administrador del sistema.","Aceptar")
				}
			}	
		}
	}
	else{
		
		if(f_id != null)
			globals.DIALOGS.showWarningDialog("Atención!","Para generar una nueva solicitud, presione el boton Nuevo.","Aceptar")
		else{
			if($isDirty == false)
				globals.DIALOGS.showWarningDialog("Atención!","No hay datos para guardar.","Aceptar")
		}
	}
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"47CD2E08-87A6-4D32-A339-3A958E288406"}
 */
function onAction_btnBuscarPaciente(event) {
	
	globals.Anatpa_eventSourceButton = 1;
	openSearch();
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"6DA98D6C-FC1C-4E9A-9DCE-984B0174288E"}
 */
function openSearch() {
	
	if(f_tipoPaciente != null){
		
		// Ambulatorio
		if(f_tipoPaciente > 0){
			var win = application.createWindow("seleccion_ambulatorio",JSWindow.MODAL_DIALOG);	
		    win.title= 'Búsqueda de Pacientes Ambulatorios';
		    win.resizable = false;
		    win.show(forms.Anatpa_dg_buscarAmbulatorio);
		}
		
		// Internado
		if(f_tipoPaciente == 0){
			var win2 = application.createWindow("seleccion_internado",JSWindow.MODAL_DIALOG);	
		    win2.title= 'Búsqueda de Pacientes Internados';
		    win2.resizable = false;
		    win2.show(forms.Anatpa_dg_buscarInternado);
		}
		
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención",'Debe seleccionar tipo de ingreso.',"Aceptar");
		elements.cbo_tipoPaciente.requestFocus();
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"0B54E5FC-8A29-4FE9-83E3-DAD953472867"}
 */
function onAction_txtBusquedaRapida(event) {
	
	globals.Anatpa_hisclistrynro = f_paciente;
	if(globals.Anatpa_hisclistrynro != '' && globals.Anatpa_hisclistrynro != null){
		globals.Anatpa_eventSourceButton = 0;
		openSearch();
		//$isDirty = true;
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención",'Debe ingresar Nro. de paciente o apellido.',"Aceptar")
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"4212B958-D4EF-4B76-9116-565A291F3715"}
 */
function onAction_cboTipoPaciente(event) {
	
	f_paciente = null;
	f_histClinUnica = null;
	f_nroAfiliado = null;
	f_cobertura = null;
	f_plan = null;
	f_nombre = null;
	f_nroInternado = null;
	f_servicio = null;
	f_nroPedido = null;
	f_fecNac = null;
	$nroDocu = null;
	$tipoDocu = null;
	$nroInternado = null;
	
	$servicio = null;
	f_ciriIeCiru = null;
	f_ciriInterven = null;
	f_ciriLegCiru = null
	$matriculaMedico = null;
	$nombreMedico = null;
	$itv_descripcion = null;
	$fechaIngreso = null;
	$horaIngreso = null;
	$fechaPedido = 0;
	
	editablePaciente(true);
	set_lbl_tipoPaciente();
	
	elements.cbo_servicio.readOnly = false;
	elements.txt_nroPedido.enabled = true;
	elements.btn_buscarPedido.enabled = true;
	
	if(f_tipoPaciente == 3){
		
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!','Ha seleccionado tipo de paciente Externo. ¿Está seguro que desea continuar?', 'Si', 'No');
		if( respuesta == 'Si'){
			
			f_servicio = 23;
			f_nroPedido = 0;
			f_ciriIeCiru = 1;
			f_ciriLegCiru = 9999;
			
			elements.cbo_servicio.readOnly = true;
			elements.txt_nroPedido.enabled = false;
			elements.btn_buscarPedido.enabled = false;
			
			elements.txt_paciente.requestFocus();
		}
		else{
			f_tipoPaciente = null;
			elements.cbo_tipoPaciente.requestFocus();
		}
	}
	
	$isDirty = true;
}

/**
 * @properties={typeid:24,uuid:"A858F8E0-6F67-4F46-8E2A-0728FE0E491F"}
 */
function set_lbl_tipoPaciente (){
	
	// Internado
	if(f_tipoPaciente == 0){
		elements.lbl_paciente.text = 'Nro. Internación-Pac.';
		elements.btn_buscarPaciente.visible = true;
		elements.txt_paciente.requestFocus();		
	}
	
	// Ambulatorio
	if(f_tipoPaciente > 0){
		elements.lbl_paciente.text = 'H. Clinica U. - Pac.';
		elements.btn_buscarPaciente.visible = true;
		elements.txt_paciente.requestFocus();
	}
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"591D9336-3A50-44FA-A956-4DF94DE59887"}
 */
function isValidDataForm() {
	
	var isValid = true;	
	var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
	var borderError = 'LineBorder,1,#ff0000';
	setDefaultBorderElements();
		
	if(f_tipoPaciente == null){
		elements.cbo_tipoPaciente.border = borderError;
		messageError += "\nDebe seleccionar tipo de ingreso.";        
        isValid = false;
	}
	
	if(f_histClinUnica == null){
		elements.txt_paciente.border = borderError;
		messageError += "\nDebe ingresar paciente.";
		isValid = false;
	}
	
	if(f_tipoPaciente != 3){
		
		if(f_servicio == null){
			elements.cbo_servicio.border = borderError;
			messageError += "\nDebe seleccionar un servicio.";        
	        isValid = false;
		}
		else{
			
			if(f_servicio == 22 && f_tipoPaciente == 0){
				
			}
			else{
				
				if(f_nroPedido == null){
					elements.txt_nroPedido.border = borderError;
					messageError += "\nDebe ingresar número de pedido o protocolo.";        
			        isValid = false;
				}
			}
		}
	}
	
	if (forms.Anatpa_tbl_anatpade.foundset.getSize() == 0){
		elements.lbl_itemRecibido.border = borderError;	
		messageError += "\nDebe ingresar al menos un item de práctica.";        
        isValid = false;
	}
	
	if(!isValid){
		globals.DIALOGS.showWarningDialog("¡Atención!",messageError,"Aceptar")
	}
	
	return isValid;
}

/**
 * @properties={typeid:24,uuid:"D34D23A6-19DA-4C26-B38A-45A2701EF0D7"}
 */
function isValidData () {
	
	var isValid = true;	
	var messageError = "No ha sido posible guardar la solicitud. Corrija los siguientes errores y vuelva a intentar."
	var borderError = 'LineBorder,1,#ff0000';
	setDefaultBorderElements();
		
	// Valida paciente Internado
	if(f_tipoPaciente == 0){
		
		completarDatosAuxPacienteInter();
		isValid = isValidDatosPacienteInter();
		messageError += $messageErrorInter;
		//elements.cbo_tipoPaciente.border = borderError;
	}
	
	// Valida paciente ambulatorio
	if(f_tipoPaciente > 0){
		
		completarDatosAuxPacienteAmbu();
		isValid = isValidDatosPacienteAmbu();
		messageError += $messageErrorAmbu;
		
		/*
		if($servicio == 1){
			if($fechaIngreso == null || $horaIngreso == null){
				messageError += "\nNo hay Prestaciones cargadas en Guardia.";
				isValid = false;
			}
		}
		*/
		
		//elements.cbo_tipoPaciente.border = borderError;
		if(f_tipoPaciente == 1){
			
			cargarFechaPrestacion();
			if($fechaIngreso == null || $horaIngreso == null){
				messageError += "\nNo hay Prestaciones cargadas en Guardia.";
				isValid = false;
			}
		}
		else{
			
			if(f_tipoPaciente == 2){
				
				// VER-RESERVE
				consultarReservas();
				if(anatpa_rel_buscar_reservas.getSize() == 0){
					messageError += "\nNo existe Reserva en Cons.Ext. cargada.";
					isValid = false;
				}
			}
		}
	}
	
	if(f_ciriLegCiru == null){
		messageError += "\nDatos del médico solicitante incompletos. Debe confirmar el Nro. Pedido o Protocolo.";
		isValid = false;
	}
	
	if(isValid == true && f_tipoPaciente != 3){
		
		
		if(f_servicio == 22 && f_tipoPaciente == 0){
			
		}
		else{
			
			var fechaHasta = globals.FormatearFecha(utils.timestampToDate( application.getServerTimeStamp()),'AAAAMMDD');
			//var fechaHasta = globals.FormatearFecha(f_fechaSolicitud,'AAAAMMDD');
			var fechaDesde = obtenerFechaDesde(fechaHasta);
			f_fechaDesde = fechaDesde;
			f_fechaHasta = fechaHasta;
			
			var sql = null;
			var ds;
			var serviProceso = obtenerServiProceso();
			
			switch(serviProceso){
				
				case 1:{
					
						sql = forms.Anatpa_dlg_buscarImapedi.getQueryImapedi(f_nroPedido);
				}
				break;
				case 4:{
					
						
					if(f_tipoPaciente > 0){
						
						sql = forms.Anatpa_dlg_buscarCiruAmbu.getQueryCiruAmbu(f_nroPedido);
					}
					else{
						
						sql = forms.Anatpa_dlg_buscarCiruInter.getQueryCiruInter(f_nroPedido);
					}
						
				}
				break;
				default:
				break;
			}
			
			if(sql != null){
				
				ds = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
				if(ds.getMaxRowIndex() == 0){
					messageError += "\nEl número de pedido o protocolo no es válido.";
					isValid = false;
					elements.txt_nroPedido.border = borderError;
				}
				else{
					
					// validar si existe la solicitud
					var tipoAdmis = (f_tipoPaciente == 0 ? 0 : 1);
					var sqlSolicitud = "select apca_nrosolic from tbc_ANATPACA where Apca_Protocolo = " + f_nroPedido + " and Apca_Servicio = " + f_servicio + " and Apca_TipAdmi = " + tipoAdmis;
					var dsExisteSolicitud =  databaseManager.getDataSetByQuery('asistencial',sqlSolicitud,null,-1)
					
					if(dsExisteSolicitud.getMaxRowIndex() > 0){
						
						isValid = false;
						messageError += "\nPedido " +  f_nroPedido + " ya tiene una solicitud de anat. pat. : " + dsExisteSolicitud.getValue(1,1);
						
						//elements.cbo_tipoPaciente.border = borderError;
					}
					
				}
			}
		}
	}
	
	// ALATABLA
	if(f_tipoPaciente == 1){
		//VER-PRESTGU
		
	}
	else{
		if(f_tipoPaciente == 2){
			//VER-RESERVE
			
		}
		else{
			if(f_tipoPaciente == 3){
				//PEDIR-OPERD
			}
		}
	}
		
	if(!isValid){

		globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
		elements.cbo_tipoPaciente.requestFocus();
	}
	
	return isValid;
}

/**
 * @properties={typeid:24,uuid:"90B180F0-8FFE-4450-8F52-BC49133F2E2B"}
 */
function setDefaultBorderElements() {
	
	var border = 'LineBorder,1,null';
	elements.cbo_tipoPaciente.border = 'LineBorder,1,#abadb3';
	elements.txt_paciente.border = border;
	elements.txt_nroPedido.border = border;
	elements.cbo_servicio.border = 'LineBorder,1,#abadb3';
	elements.lbl_itemRecibido.border = null;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param editable
 *
 * @properties={typeid:24,uuid:"06F7F5E9-C0E1-4110-88E8-AFCE943AFD3C"}
 */
function setEditableElements(editable) {
	
	elements.btn_agregarItem.enabled = editable,
	elements.btn_buscarPaciente.enabled = editable;
	elements.btn_buscarPedido.enabled = editable;
	
	elements.cbo_tipoPaciente.enabled = editable;
	elements.cbo_servicio.enabled = editable;

	elements.txt_paciente.enabled= editable;
	elements.txt_nroPedido.enabled = editable;
	elements.txt_obserGeneral.readOnly = !editable;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"26D6BE22-B2B6-4DB7-8B58-495F9F63AAA5"}
 * @AllowToRunInFind
 */
function onAction_btnNuevo(event) {
	
	var limpiar = false;
	if($isDirty){
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!','Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No');
		if( respuesta == 'Si')
			limpiar = true;
	}
	else{
		limpiar = true;
	}
		
	if(limpiar){
		inicializarForm();
		setDefaultBorderElements();
		setVisibleElements(false);
		setEditableElements(true);
		elements.txt_nroPedido.enabled = true;
		elements.cbo_tipoPaciente.requestFocus();
		$isDirty = false;
	}

}

/**
 * @properties={typeid:24,uuid:"8CFC4F39-5419-4797-BE5A-D72C29675471"}
 */
function inicializarForm() {
	
	f_tipoPaciente = null;
	f_histClinUnica = null;
	f_nroAfiliado = null;
	f_nroSolicitud = null;
	f_paciente = null;
	f_cobertura = null;
	f_servicio = null;
	$servicio = null;
	f_nroPedido = null;
	f_fechaSolicitud = utils.timestampToDate(application.getServerTimeStamp());
	f_plan = null;
	
	f_obserGeneral = null;
	f_observaPractica = null;
	
	f_id = null;
	f_nombre = null;
	f_nroInternado = null;
	f_fecaltaefec = null;
	f_fecEpic = null;
	f_obrEsPami = null;
	f_obrEstado = null;
	f_obrMotSusp = null;
	f_obrSoc = null;
	f_fechaDesde = null;
	f_fechaHasta = null;
	f_ploEstado = null;
	f_planObr = null;
	f_ciriIeCiru = null;
	f_ciriInterven = null;
	f_ciriLegCiru = null;
	f_fecNac = null;
	$nroDocu = null;
	$tipoDocu = null;
	$nroInternado = null;
	$matriculaMedico = null;
	$nombreMedico = null;
	$itv_descripcion = null;
	$fechaIngreso = null;
	$horaIngreso = null;
	$ds_prestGuar = null;
	$fechaPedido = 0;
	
	globals.Anatpa_reservasHisCli = 0;
	globals.Anatpa_reservasFech5 = 0;
	globals.Anatpa_reservasEsta = 0;
	globals.Anatpa_reservasIPedido = 0;
	
	if(forms.Anatpa_tbl_anatpade.foundset.getSize() > 0){
		forms.Anatpa_tbl_anatpade.foundset.clear();
		forms.Anatpa_tbl_anatpade.foundset.deleteAllRecords();
	}
		
	actualizarObservaPractica();
	elements.lbl_paciente.text = 'Paciente';
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"8E189DDE-990B-46F9-84DB-B5EE3BD66A52"}
 */
function setVisibleElements(visible) {
	

}

/**
 * TODO generated, please specify type and doc for the params
 * @param visible
 *
 * @properties={typeid:24,uuid:"D90B9F1A-35E9-4F33-9255-D206BF5DB77C"}
 */
function setVisibleElementsAux(visible) {
	
	elements.lbl_fecepic.visible = visible;
	elements.lbl_fecha.visible = visible;
	elements.lbl_fechaAltaEfectiva.visible = visible;
	elements.lbl_id.visible = visible;
	elements.lbl_nombre.visible = visible;
	elements.lbl_nroInternado.visible = visible;
	elements.lbl_obr_esPami.visible = visible;
	elements.lbl_obrEstado.visible = visible;
	elements.lbl_obrMotSusp.visible = visible;
	elements.lbl_obrSoc.visible = visible;
	elements.lbl_ploEstado.visible = visible;
	elements.lbl_obrSoc.visible = visible;
	elements.lbl_planObr.visible = visible;
	elements.lbl_fecNac.visible = visible;
	elements.lbl_ciriIeCiru.visible = visible;
	elements.lbl_ciriInterven.visible = visible;
	elements.lbl_ciriLegCiru.visible = visible;
	
	elements.cld_fecEpic.visible = visible;
	elements.cld_fecaltaefec.visible = visible;
	elements.txt_id.visible = visible;
	elements.txt_nombre.visible = visible;
	elements.txt_nroInternado.visible = visible;
	elements.txt_obr_esPami.visible = visible;
	elements.txt_obrEstado.visible = visible;
	elements.txt_obrMotSusp.visible = visible;
	elements.txt_obrSoc.visible = visible;
	elements.txt_ploEstado.visible = visible;
	elements.txt_obrSoc.visible = visible;
	elements.txt_planObr.visible = visible;
	elements.txt_fechaDesde.visible = visible;
	elements.txt_fechaHasta.visible = visible;
	elements.txt_fecNac.visible = visible;
	elements.txt_ciriIeCiru.visible = visible;
	elements.txt_ciriInterven.visible = visible;
	elements.txt_ciriLegCiru.visible = visible;
	
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"37B1A342-6B32-4719-8132-AA9D3804C8B8"}
 */
function onHide_recepcionProtesis(event) {
	
	return f_cerrarForm;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"F4BCB394-8349-4400-8104-7E0E273CE160"}
 */
function onAction_btnCerrar(event) {
	
	if($isDirty){
		if(globals.DIALOGS.showQuestionDialog('¡Atención!','Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			f_cerrarForm = true;
	}
	else{
		f_cerrarForm = true;
	}
	
	if(f_cerrarForm){
		var $win = application.getWindow(application.getActiveWindow().getName());
		if($win != null){
			$win.hide();
			$win.destroy();
		}
	}
}

/**
 * @properties={typeid:24,uuid:"EB8DDA1B-9728-4A89-8B58-494F56317D1F"}
 */
function editablePaciente (value){
	elements.txt_paciente.enabled = value;
	//elements.btn_buscarPaciente.enabled = value;
}

/**
 * @properties={typeid:24,uuid:"C0BC7E9E-01EF-4AEA-B3F7-485DE30DE518"}
 */
function actualizarObservaPractica () {
	
	f_observaPractica = forms.Anatpa_tbl_anatpade.foundset['observacion'];
	if(forms.Anatpa_tbl_anatpade.foundset.getSize() > 0){
		elements.lbl_observaPractica.text = 'Observacion de práctica' + ' - Código ' + forms.Anatpa_tbl_anatpade.foundset['apde_codnom'];
	}
	else
		elements.lbl_observaPractica.text = 'Observacion de práctica';
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"19BBD072-E59A-46FA-8C31-E08B388DD6E4"}
 */
function onAction_cboServicio(event) {
		
	if(f_histClinUnica == null){
		
		f_servicio = null;
		$servicio = null;
		globals.DIALOGS.showWarningDialog("¡Atención!","Debe ingresar paciente.","Aceptar");
	    elements.txt_paciente.requestFocus();
	}
	else{
		
		f_nroPedido = null;
		$fechaPedido = 0;
		elements.txt_nroPedido.enabled = true;
		elements.btn_buscarPedido.enabled = true;
		f_ciriInterven = null;
		f_ciriIeCiru = null;
		f_ciriLegCiru = null;
		$matriculaMedico = null;
		$nombreMedico = null;
		$itv_descripcion = null;
		$fechaIngreso = null;
		$horaIngreso = null;
		
		if(f_servicio == 22 && f_tipoPaciente > 0){
			//Paciente ambulatorio
			globals.DIALOGS.showInfoDialog("Información","El servicio no se puede aplicar a paciente ambulatorio.","Aceptar");
			f_servicio = null;
			$servicio = null;
		}
		else
			elements.txt_nroPedido.requestFocus();
		
		if(f_servicio == 22 && f_tipoPaciente == 0){
			// Paciente internado
			
			agregarMedico();
			if(f_ciriLegCiru == null){
				f_servicio = null;
				$servicio = null;
				elements.cbo_servicio.requestFocus();
			}
			else{
				elements.txt_nroPedido.enabled = false;
				elements.btn_buscarPedido.enabled = false;
				elements.txt_obserGeneral.requestFocus();
			}
		}
	}
		
}

/**
 * @properties={typeid:24,uuid:"F0D8B322-75AC-4515-A947-4CD48F217CF0"}
 */
function agregarMedico() {
	
	var win = application.createWindow("buscar_medico",JSWindow.MODAL_DIALOG);
	win.title = "Búsqueda de médico";
	win.resizable = false;
	win.show(forms.Anatpa_dlg_agregarMedico);
}

/**
 * @properties={typeid:24,uuid:"A6EA58E8-75A8-489F-8596-D0BE5E263F09"}
 */
function completarDatosAuxPacienteInter(){
	
	var completo = true;
	
	var sql = "select a.Adm_FecAltaEfec,a.Adm_FecEpic,a.Adm_ObrSoc,a.Adm_PlanObr\
			,obr.Obr_Estado,obr.Obr_EsPami,obr.Obr_MotSuspen,po.Plo_Estado\
			from tbc_admision_scroll a\
			left join maestros.tbc_obras obr on obr.Obr_Codigo = a.Adm_ObrSoc\
			left join maestros.tbc_plan_obra po on po.Plo_Obra = a.Adm_ObrSoc and po.Plo_PlanX = a.Adm_PlanObr\
			where a.Adm_HistClin = " + f_nroInternado;
			
	var dsInter = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
	
	if(dsInter.getMaxRowIndex() > 0){
		
		forms.Anatpa_frm_anatpaca.f_fecaltaefec = globals.IntegerToDate(dsInter.getValue(1,1));
		forms.Anatpa_frm_anatpaca.f_fecEpic = globals.IntegerToDate(dsInter.getValue(1,2));
	
		forms.Anatpa_frm_anatpaca.f_obrEstado = dsInter.getValue(1,5);
		forms.Anatpa_frm_anatpaca.f_obrEsPami = dsInter.getValue(1,6);
		forms.Anatpa_frm_anatpaca.f_obrMotSusp = utils.stringTrim(dsInter.getValue(1,7));
		
		forms.Anatpa_frm_anatpaca.f_ploEstado = dsInter.getValue(1,8);
	}
	else{
		completo = false;
	}

	return completo;
}

/**
 * @properties={typeid:24,uuid:"298CF9B6-BC68-43E6-BCDC-5886A97D1F89"}
 */
function isValidDatosPacienteInter (){
	
	var isValid = true;	
	$messageErrorInter = '';
	
	if(f_fecaltaefec != null){
		$messageErrorInter += "\nPaciente, egresado del sanatorio.";        
        isValid = false;
	}
	else{
		if(f_fecEpic != null && f_obrEsPami != 2){
		
			$messageErrorInter += "\nPaciente con alta medica.";        
	        isValid = false;
		}
		else{
			if(f_obrEstado == 7 ){
				$messageErrorInter += "\nLa Cobertura es Incorrecta.";        
		        isValid = false;
			}
			else{
				if(f_obrEstado == 1 || f_obrEstado == 5 ){
					isValid = false;
					var motivo = utils.stringTrim(f_obrMotSusp).length > 0 ? '\nMotivo: ' + utils.stringTrim(f_obrMotSusp): '';
					if(f_obrEstado == 1 ){
						$messageErrorInter += "\nObra Social suspendida." + motivo;        
				        
					}
					else{
						$messageErrorInter += "\nObra Social suspendida para internados." + motivo;        
				        
					}
				}
				else{
					// rutina control del planes
					if(f_obrEstado == 2 ){
						$messageErrorInter += "\nLa Cobertura no esta vigente.";        
				        isValid = false;
					}
					
				}
				
			}
			
		}
	}
	
	// Rutina control de planes
	if(isValid){
		
		if(utils.stringTrim(f_planObr).length > 0){
			
			if(f_ploEstado == 1 || f_ploEstado == 3 ){
				
				var message = '';
				if(f_ploEstado == 1 )
					message += "\nPLAN suspendido.";
				else
					message += "\nPLAN sin disponibilidad.";
				
				var continuar = globals.DIALOGS.showQuestionDialog('¡Atención!',message + '\n¿desea continuar?', 'Si', 'No');
				if(continuar == 'Si'){
					globals.DIALOGS.showInfoDialog("Información","Asegurese tener la Autorizacion correspondiente.","Aceptar");
				}
				else{
					$messageErrorInter = message;
					isValid = false;
				}
					
			}
			
			if(f_ploEstado == 2 ){
				$messageErrorInter = "La Cobertura del PLAN no esta vigente.";        
		        isValid = false;
			}
		}
		else
			forms.Anatpa_frm_anatpaca.f_plan = null;
	}
	
	
	return isValid;
}

/**
 * @properties={typeid:24,uuid:"33AED7FC-15A8-40D8-9E0D-D0063DFE861E"}
 */
function completarDatosAuxPacienteAmbu(){
	
	var completo = true;
	
	var sql = "select hc.histcabobra,hc.histcabplanx\
			,obr.Obr_Estado,obr.Obr_MotSuspen,po.Plo_Estado\
			from tbc_hist_cab_new hc\
			left join maestros.tbc_obras obr on obr.Obr_Codigo = hc.histcabobra\
			left join maestros.tbc_plan_obra po on po.Plo_Obra = hc.histcabobra and po.Plo_PlanX = hc.histcabplanx\
			where hc.HistCabNroUnico = " + f_histClinUnica;
			
	var dsInter = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
	
	if(dsInter.getMaxRowIndex() > 0){
		
		forms.Anatpa_frm_anatpaca.f_obrEstado = dsInter.getValue(1,3);
		forms.Anatpa_frm_anatpaca.f_obrMotSusp = utils.stringTrim(dsInter.getValue(1,4));
		
		forms.Anatpa_frm_anatpaca.f_ploEstado = dsInter.getValue(1,5);
	}
	else{
		completo = false;
	}

	return completo;
}

/**
 * @properties={typeid:24,uuid:"644222BC-109A-4530-8810-0C887FAE7471"}
 */
function isValidDatosPacienteAmbu (){
	
	var isValid = true;	
	$messageErrorAmbu = '';
	
	if(f_obrEstado == 7 ){
		$messageErrorAmbu += "\nLa Cobertura es Incorrecta.";        
		isValid = false;
	}
	else{
		if(f_obrEstado == 1 || f_obrEstado == 6 ){
			isValid = false;
			var motivo = utils.stringTrim(f_obrMotSusp).length > 0 ? '\nMotivo: ' + utils.stringTrim(f_obrMotSusp): '';
			if(f_obrEstado == 1 ){
				$messageErrorAmbu += "\nObra Social suspendida." + motivo;        
				        
			}
			else{
				$messageErrorAmbu += "\nObra Social suspendida para ambulatorio." + motivo;
			}
		}
		else{
			if(f_obrEstado == 2 ){
				$messageErrorAmbu += "\nLa Cobertura no esta vigente.";        
		        isValid = false;
			}	
		}	
	}
	
	// Rutina control de planes
	if(isValid){
		
		if (utils.stringTrim(f_planObr).length > 0){
			
			if(f_ploEstado == 1 || f_ploEstado == 3 ){
				
				var message = '';
				if(f_ploEstado == 1 )
					message += "\nPLAN suspendido.";
				else
					message += "\nPLAN sin disponibilidad.";
				
				var continuar = globals.DIALOGS.showQuestionDialog('¡Atención!',message + '\n¿desea continuar?', 'Si', 'No');
				if(continuar == 'Si'){
					globals.DIALOGS.showInfoDialog("Información","Asegurese tener la Autorizacion correspondiente.","Aceptar");
				}
				else{
					$messageErrorAmbu = message;
					isValid = false;
				}
					
			}
			
			if(f_ploEstado == 2 ){
				$messageErrorAmbu =  "La Cobertura del PLAN no esta vigente.";        
		        isValid = false;
			}
		}
		else
			forms.Anatpa_frm_anatpaca.f_plan = null;
	}
	
	return isValid;
}

/**
 * @properties={typeid:24,uuid:"9B80017B-72E7-4C83-BC25-368494E79E03"}
 */
function clearDatosPaciente () {
	f_paciente = null;
	f_histClinUnica = null;
	f_nroAfiliado = null;
	f_nroSolicitud = null;
	f_cobertura = null;
	
	f_nombre = null;
	f_fecaltaefec = null;
	f_fecEpic = null;
	f_nroInternado = null;
	f_obrEsPami = null;
	f_obrEstado = null;
	f_obrMotSusp = null;
	f_plan = null;
	f_ploEstado  = null;
	f_fecNac = null;
	$nroDocu = null;
	$tipoDocu = null;
	$nroInternado = null;
}

/**
 * @properties={typeid:24,uuid:"10B01798-0417-4C5F-82FA-453FCC06A54F"}
 * @AllowToRunInFind
 */
function buscarPedido(){
	
	var fechaHasta = globals.FormatearFecha(utils.timestampToDate( application.getServerTimeStamp()),'AAAAMMDD');
	//var fechaHasta = globals.FormatearFecha(f_fechaSolicitud,'AAAAMMDD');
	var fechaDesde = obtenerFechaDesde(fechaHasta);
	f_fechaDesde = fechaDesde;
	f_fechaHasta = fechaHasta;
	
	var serviProceso = obtenerServiProceso();
	f_ciriLegCiru = null;
	f_ciriIeCiru = null;
	$matriculaMedico = null;
	$nombreMedico = null;
	
	switch(serviProceso){
		
		case 1:{
				
				f_ciriInterven = 0;
				$itv_descripcion = null;
				openSearchImapedi();
		}
		break;
		case 4:{
			
				if(f_histClinUnica != null){
					
					f_ciriInterven = null;
					$itv_descripcion = null;
					if(f_tipoPaciente > 0){
						openSearchCiruAmbu();
					}
					else{
						openSearchCiruInter();
					}
				}
				else{
					globals.DIALOGS.showWarningDialog("¡Atención!","Debe ingresar un paciente.","Aceptar");
				}
		}
		break;
		default:
		break;
	}
}

/**
 * @properties={typeid:24,uuid:"1F2BB2F7-2FEA-4EF7-BD8A-25A30BBEAAFD"}
 */
function isValidBuscarPedido() {
	
	var isValid = true;	
	var messageError = ""
	
	if(f_histClinUnica == null){
		
		messageError += "Debe ingresar paciente.";        
        isValid = false;
        elements.txt_paciente.requestFocus();
	}
	else{
		if(f_servicio == null){
			
			messageError += "Debe seleccionar un servicio.";        
	        isValid = false;
	        elements.cbo_servicio.requestFocus();
		}
	}

	if(!isValid){
		globals.DIALOGS.showWarningDialog("¡Atención!",messageError,"Aceptar")
	}
	
	return isValid;
}

/**
 * @properties={typeid:24,uuid:"43387EEC-ADF2-4383-ADD5-414915203781"}
 */
function clearDatosServicio (){
	f_servicio = null;
	$servicio = null;
	f_nroPedido = null;
	$fechaPedido = 0;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"5AEE152E-860B-416B-AB81-35ECDBDA03B8"}
 */
function onAction_buscarImapedi(event) {
	
	if(isValidBuscarPedido()){
		globals.Anatpa_eventSourceButton = 1;
		buscarPedido();
	}	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"0AE3E4DD-CCBC-4555-BFA0-03C10CEDA01E"}
 */
function onAction_imapediBusquedaRapida(event) {
	
	if(isValidBuscarPedido()){
		
		if(f_nroPedido != null){
			
			globals.Anatpa_cajaAlfa = f_nroPedido;
			globals.Anatpa_eventSourceButton = 0;
			buscarPedido();
		}
		else{
			globals.DIALOGS.showWarningDialog("¡Atención!",'Debe ingresar número de pedido o protocolo',"Aceptar")
		}
	}
	else{
		
		f_nroPedido = null;
		$fechaPedido = 0;
	}
		
}

/**
 * @properties={typeid:24,uuid:"C9999FF3-0D8A-49DD-A90B-B2D7B8740AE9"}
 */
function openSearchImapedi(){
	
	var win = application.createWindow("buscar_imapedi",JSWindow.MODAL_DIALOG);
	win.title = "Lista de pedidos";
	win.resizable = false;
	win.show(forms.Anatpa_dlg_buscarImapedi);
}

/**
 * @properties={typeid:24,uuid:"B2E348AB-F06E-4091-B0DC-CB0AFB4F6CC4"}
 */
function openSearchCiruInter(){
	
	var win = application.createWindow("buscar_ciru_inter",JSWindow.MODAL_DIALOG);
	win.title = "Lista de Protocolos";
	win.resizable = false;
	win.show(forms.Anatpa_dlg_buscarCiruInter);
}

/**
 * @properties={typeid:24,uuid:"3B4B2F37-E275-4EFC-9684-D4CF4FD113F5"}
 */
function openSearchCiruAmbu(){
	
	var win = application.createWindow("buscar_ciru_ambu",JSWindow.MODAL_DIALOG);
	win.title = "Lista de Protocolos";
	win.resizable = false;
	win.show(forms.Anatpa_dlg_buscarCiruAmbu);
}

/**
 * @properties={typeid:24,uuid:"41F91988-2393-43F5-95C7-3E6E945FB795"}
 */
function obtenerFechaDesde (fechaHasta) {
	
	var dateAux = globals.IntegerToDate(utils.stringToNumber(fechaHasta));
	dateAux.setTime(dateAux.getTime()-(1000*60*60*24));
	var fechaDesde = globals.FormatearFecha(dateAux, 'AAAAMMDD');
	 
	return fechaDesde;
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"81D85BD7-1D3F-4E1E-AA41-E04B50F3E967"}
 */
function obtenerServiProceso(){
	
	var fs_servicios = databaseManager.getFoundSet('desal','anat_servicios')
	fs_servicios.find();
	fs_servicios['anat_servi_codigo'] = f_servicio;
	fs_servicios.search();
	
	var servicio = 0;
	if(fs_servicios.getSize() > 0){
		servicio = fs_servicios['anat_servi_proceso'];
		$servicio = fs_servicios['anat_servi_servici'];
	}
	
	return servicio;
}

/**
 * @properties={typeid:24,uuid:"EE6C7064-0A63-458A-911B-A60384173E28"}
 * @AllowToRunInFind
 */
function imprimir (){
	
	// Buscando nombre de medico para impresion
	if(f_servicio == 22 && f_tipoPaciente == 0){
	}
	else{
		
		if(f_ciriIeCiru != null){
			if(f_ciriIeCiru == 0){
				// Buscar en personal
				var fs_personal = databaseManager.getFoundSet('maestros','tbc_personal');
				fs_personal.find();
				fs_personal['per_legajo'] = f_ciriLegCiru;
				fs_personal.search();
				
				if(fs_personal.getSize() > 0){
					$nombreMedico = utils.stringTrim(fs_personal['per_apelnom']);
					$matriculaMedico = fs_personal['per_codmatri'];
				}
			}
			else{
				// Buscar en medicos
				var fs_medicos = databaseManager.getFoundSet('maestros','tbc_medicos');
				fs_medicos.find();
				fs_medicos['med_codigo'] = f_ciriLegCiru;
				fs_medicos.search();
				
				if(fs_medicos.getSize() > 0){
					$nombreMedico = utils.stringTrim(fs_medicos['med_apenom']);
					$matriculaMedico = utils.stringTrim(fs_medicos['med_matricula']);
				}
			}
		}
	}
	
	//Limpiando form de impresion
	forms.Anatpa_print_internado.limpiarForm();
	cargarSolicitudImpresion();
	imprimirSolicitud();
	
	// Actualizar estado de anatpaca
	var fs_anatPaca = databaseManager.getFoundSet("asistencial","tbc_anatpaca");
	fs_anatPaca.find();
	fs_anatPaca['apca_nrosolic']= f_nroSolicitud;
	fs_anatPaca.search();
	
	if(fs_anatPaca.getSize() == 1){
		
		if(fs_anatPaca['apca_estado'] == 0){
		
			fs_anatPaca['apca_estado'] = 1;
			databaseManager.saveData(fs_anatPaca);
		}
	}
	
	// Si el servicio es cirujia
	if(f_servicio == 11){
		
		imprimirSolicitud();// imprime una copia
		forms.Anatpa_print_servicio.limpiarForm();
		cargarCabeceraImpresionServicio();
		
		// si es ambulatorio
		if(f_tipoPaciente > 0){
			cargarTalonServicioAmbu();
		}
		else{
			// Si es internado
			cargarTalonServicioInter();
		}
		
		imprimirTalonServicio();
	}
	
	// Si es ambulatorio
	if(f_tipoPaciente > 0){
		
		// limpiar form de impresion
		forms.Anatpa_print_paciente.limpiarForm();
		imprimirTalonPaciente();
	}
	
}

/**
 * @properties={typeid:24,uuid:"86AAD901-9F51-4E19-8311-FB34F3455F24"}
 */
function cargarCabeceraImpresionServicio() {
	
	var servicio = utils.stringTrim(application.getValueListDisplayValue('Anatpa_vl_servicios',f_servicio));
	if(f_servicio == 21){
		if(f_tipoPaciente == 1)
			servicio = "Guardia";
		else
			servicio = "Externo"; 	
	}
	
	forms.Anatpa_print_servicio.f_fechaImpresion = application.getServerTimeStamp();
	forms.Anatpa_print_servicio.f_apelnom = f_tipoPaciente == 0 ? $nroInternado + ' ' + f_nombre + '  (Internado)': f_histClinUnica + ' ' + f_nombre + '  (Ambulatorio)';
	forms.Anatpa_print_servicio.f_cobertura = f_cobertura;
	forms.Anatpa_print_servicio.f_edad = globals.CalculoEdad(f_fecNac) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_servicio.f_histclin = f_tipoPaciente == 0 ? f_histClinUnica : '';
	forms.Anatpa_print_servicio.f_intervencion = $itv_descripcion;
	forms.Anatpa_print_servicio.f_nroAfiliado = f_nroAfiliado;
	forms.Anatpa_print_servicio.f_nroDocumento = application.getValueListDisplayValue('Anatpa_vl_tipoDocu',$tipoDocu) + ' ' + $nroDocu;
	forms.Anatpa_print_servicio.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_servicio.f_plan = f_plan;
	forms.Anatpa_print_servicio.f_protocolo = f_nroPedido;
	forms.Anatpa_print_servicio.f_servicio = servicio;
	
}

/**
 * @properties={typeid:24,uuid:"021E239D-7028-468C-BD49-1A0E3679C7D4"}
 */
function cargarSolicitudImpresion () {
	
	var servicio = utils.stringTrim(application.getValueListDisplayValue('Anatpa_vl_servicios',f_servicio));
	if(f_servicio == 21){
		if(f_tipoPaciente == 1)
			servicio = "Guardia";
		else
			servicio = "Externo"; 	
	}
	
	forms.Anatpa_print_internado.f_fechaImpresion = application.getServerTimeStamp();
	forms.Anatpa_print_internado.f_apelnom = f_tipoPaciente == 0 ? $nroInternado + ' ' + f_nombre + '  (Internado)': f_histClinUnica + ' ' + f_nombre + '  (Ambulatorio)';
	forms.Anatpa_print_internado.f_cobertura = f_cobertura;
	forms.Anatpa_print_internado.f_edad = globals.CalculoEdad(f_fecNac) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_internado.f_histclin = f_tipoPaciente == 0 ? f_histClinUnica : '';
	forms.Anatpa_print_internado.f_intervencion = $itv_descripcion;
	forms.Anatpa_print_internado.f_nroAfiliado = f_nroAfiliado;
	forms.Anatpa_print_internado.f_nroDocumento = application.getValueListDisplayValue('Anatpa_vl_tipoDocu',$tipoDocu) + ' ' + $nroDocu;
	forms.Anatpa_print_internado.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_internado.f_plan = f_plan;
	forms.Anatpa_print_internado.f_protocolo = f_nroPedido;
	forms.Anatpa_print_internado.f_servicio = servicio;
	
	forms.Anatpa_print_internado.f_nombreMedico = 'Dr.'+ ' ' + $nombreMedico;
	forms.Anatpa_print_internado.f_matriculaMedico = 'M.N.' + ' ' + $matriculaMedico;
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	var html = "";
	var obserGeneral = '';
	
	// Obteniendo datos de observacion
	var sqlObserva = "select ob.ApobCodNome,ob.ApobSecuencia,ob.ApobLinea,ob.ApobTipoNome,ob.ApobSecuencia from tbc_ANATPAOB ob"
		+ " where ob.ApobNroSolic = " + f_nroSolicitud
		+ " order by ob.ApobTipoNome,ob.ApobCodNome,ob.ApobSecuencia";
	$_dsAnatpaOb = databaseManager.getDataSetByQuery('asistencial',sqlObserva,null,-1);
	
	var k;
	for(k=1 ; k <= $_dsAnatpaOb.getMaxRowIndex() ; k++){
		if($_dsAnatpaOb.getValue(k,1) == 0){
			if($_dsAnatpaOb.getValue(k,5) == 1)
				obserGeneral += '&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
			else
				obserGeneral += '<BR>&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
		}
		else
			break;
	}	
	
	var fs_anatpade = forms.Anatpa_tbl_anatpade.foundset.duplicateFoundSet();
	fs_anatpade.sort('apde_tipnom asc,apde_codnom asc');
	
	for(var i = 1 ; i <= fs_anatpade.getSize() ; i++ ){
		fs_anatpade.setSelectedIndex(i);
		
		html = "";
		html += '<html><body>'
			
		html += '<table width=100% border="none" cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=7%>' +  formatearCodNomencla(fs_anatpade['apde_codnom']) +'</td>'
		html += '<td width=63%>' + fs_anatpade['descripcion'] +'</td>'
		html += '<td width=30%>' + fs_anatpade['apde_cantidad'] +'</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'Observaciones: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + obtenerObservaPractica(fs_anatpade['apde_codnom'],fs_anatpade['apde_tipnom']) + '</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}
	
	if(utils.stringTrim(obserGeneral).length > 0){
		
		html = ''
		html += '<html><body>'
	    html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'Observaciones generales: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + obserGeneral + '</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}

	var $frm = solutionModel.getForm('Anatpa_print_internado');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_internado', $tipos);
	forms.Anatpa_print_internado.controller.recreateUI();
	/*
	var win = application.createWindow("impri_internado",JSWindow.MODAL_DIALOG);
	win.title = "Impresion Internado";
	win.resizable = false;
	win.show(forms.Anatpa_print_internado);
	*/
}

/**
 * @properties={typeid:24,uuid:"F1B621BF-CF4F-4F62-9FF1-68F424BA8E27"}
 */
function imprimirSolicitud () {
	forms.Anatpa_print_internado.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_internado.controller.print(false,false);
}

/**
 * TODO generated, please specify type and doc for the params
 * @param codigo
 *
 * @properties={typeid:24,uuid:"45AFA63C-C3E5-4BF2-927D-450C740A2D6A"}
 */
function formatearCodNomencla(codigo){
	
	var texto = String(codigo).substr(0,2)+"."+String(codigo).substr(2,2)+"."+String(codigo).substr(4,2);
	
	return texto;
}

/**
 * @properties={typeid:24,uuid:"6D600A63-7018-41B2-9BF1-A0F7AD7AAB76"}
 * @AllowToRunInFind
 */
function imprimirTalonPaciente () {
	
	forms.Anatpa_print_paciente.f_fechaImpresion = application.getServerTimeStamp();
	forms.Anatpa_print_paciente.f_apelnom = f_tipoPaciente == 0 ? $nroInternado + ' ' + f_nombre : f_histClinUnica + ' ' + f_nombre;
	forms.Anatpa_print_paciente.f_cobertura = f_cobertura;
	forms.Anatpa_print_paciente.f_edad = globals.CalculoEdad(f_fecNac) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_paciente.f_histclin = f_tipoPaciente == 0 ? f_histClinUnica : '';
	forms.Anatpa_print_paciente.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_paciente.f_plan = f_plan;
	forms.Anatpa_print_paciente.f_medicoSolicitante = $nombreMedico;

	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
	var html = "";
	var i;
	var wPap = true;  
	if(true){
		
		for(i = 1 ; i <= forms.Anatpa_tbl_anatpade.foundset.getSize() ; i++ ){
			forms.Anatpa_tbl_anatpade.foundset.setSelectedIndex(i);
			
			if(forms.Anatpa_tbl_anatpade.foundset['apde_codnom'] != 150106 && forms.Anatpa_tbl_anatpade.foundset['apde_codnom'] != 150107){
				wPap = false;
			}
			
			html = "";
			html += '<html><body>'
				
			html += '<table width=100% border="none" cellpadding=1 cellspacing=0>'
			html += '<tr>'
			html += '<td width=70%>' + forms.Anatpa_tbl_anatpade.foundset['descripcion'] +'</td>'
			html += '<td width=30%>' + forms.Anatpa_tbl_anatpade.foundset['apde_cantidad'] +'</td>'
			html += '</tr>'
			html += '</table>'
			
			html += '</body></html>'
			dsAux.addRow([html]);
		}
		
		html = ''
		html += '<html><body>'
	    html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%>' + obtenerTextoTalonPaciente(f_obrSoc,f_obrEsPami,f_fechaSolicitud,f_servicio,f_tipoPaciente,wPap) + '</td>'
		//html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
				
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL PACIENTE ***' +'</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}
	
	var $frm = solutionModel.getForm('Anatpa_print_paciente');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_paciente', $tipos);
	forms.Anatpa_print_paciente.controller.recreateUI();
	/*
	var win = application.createWindow("impri_paciente",JSWindow.MODAL_DIALOG);
	win.title = "Impresion catálogo paciente";
	win.resizable = false;
	win.show(forms.Anatpa_print_paciente);
	*/
	forms.Anatpa_print_paciente.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_paciente.controller.print(false,false);
}

/**
 * TODO generated, please specify type and doc for the params
 * @param obrCod
 * @param esPami
 * @param fechaSolicitud
 * @param servicio
 * @param tipoAdmision
 * @param wPap
 *
 * @properties={typeid:24,uuid:"234B0C87-E20E-482E-956D-3D3FD9502E79"}
 */
function obtenerTextoTalonPaciente(obrCod,esPami,fechaSolicitud,servicio,tipoAdmision,wPap){
	
	var texto = '';
	var addCountDay = 20;
	var fechaDesde;
	var ds_feriados;
	var date;
	var fechaAux;
	var fechaPrint;
	
	if(obrCod == 1132){
		texto = 'Retirar en Humberto Primo 434 C.A.B.A. Servicio de Anatomía Patológica - 4o Piso de Lunes a Viernes de 10:00 a 17:00 Hs. Tel.: 5-168-2679.';
		return texto;
	}
	
	if(obrCod == 352 || obrCod == 1127 || obrCod == 1128){
		
		fechaDesde = globals.FormatearFecha(fechaSolicitud,'AAAAMMDD');
		ds_feriados = databaseManager.getDataSetByQuery('maestros','select FerNacional from tbc_feriados_row where FerNacional > ' + fechaDesde,null,-1);
		date = globals.calcularFechaResultado(fechaSolicitud,addCountDay,ds_feriados,true,true);
		fechaAux = globals.FormatearFecha(date,'AAAAMMDD');
		fechaPrint = fechaAux.substr(6,2) + '/' + fechaAux.substr(4,2) + '/' + fechaAux.substr(0,4);
		
		texto = 'Retirar por F.Lacroze 3225 1er. Subsuelo, a partir del ' + fechaPrint + ' de Lunes a Viernes de 9:00 a 18:00 Hs.';
		return texto;
	}
	
	if(esPami == 2){
		texto = 'Consulte con su Obra Social para el retiro del informe.';
		return texto;
	}
	
	if(esPami != 1){
		
		fechaDesde = globals.FormatearFecha(fechaSolicitud,'AAAAMMDD');
		ds_feriados = databaseManager.getDataSetByQuery('maestros','select FerNacional from tbc_feriados_row where FerNacional > ' + fechaDesde,null,-1);
		date = globals.calcularFechaResultado(fechaSolicitud,addCountDay,ds_feriados,true,true);
		fechaAux = globals.FormatearFecha(date,'AAAAMMDD');
		fechaPrint = fechaAux.substr(6,2) + '/' + fechaAux.substr(4,2) + '/' + fechaAux.substr(0,4);
		
		if((servicio == 21 && tipoAdmision == 2 && wPap == true) || (servicio == 23 && wPap == true) ){
			texto = 'Retirar por Conde 849 Primer Subsuelo, apartir del ' + fechaPrint + ' de Lunes a Viernes de 8:30 a 19:30 Hs.';
		}
		else{
			texto = 'Retirar por Conde 849 Primer Subsuelo, a partir del ' + fechaPrint + ' de Lunes a Viernes de 8:00 a 17:00 Hs.';
		}
	}
	
	return texto;
}

/**
 * @properties={typeid:24,uuid:"E0F5B200-2E7D-4150-8C85-57D27F000730"}
 * @AllowToRunInFind
 */
function cargarTalonServicioAmbu () {
	
	var diagnostico = '';
	
	var sqlDesal = 'select texto from tbl_proamb_t\
		where grupo = 1'
		+ ' and hiscli = ' + f_histClinUnica
		+ ' and fecing = ' + $fechaIngreso
		+ ' and horing = ' + $horaIngreso;
	var ds_proAmbDesal = databaseManager.getDataSetByQuery('desal',sqlDesal,null,-1)
	
	if(ds_proAmbDesal.getMaxRowIndex() > 0){
		diagnostico = utils.stringTrim(ds_proAmbDesal.getValue(1,1));
	}
	else{
		
		var sql = 'select proalinea from tbc_proamb_t\
			where proagrupo = 1 and proasecuencia > 0'
			+ ' and proahistclinica = ' + f_histClinUnica
			+ ' and proafechaingreso = ' + $fechaIngreso
			+ ' and proahoraingreso = ' + $horaIngreso;
		var ds_proAmb = databaseManager.getDataSetByQuery('asistencial',sql,null,-1)

		var i;
		for(i=1 ; i <= ds_proAmb.getMaxRowIndex() ; i++){
	
			diagnostico += ds_proAmb.getValue(i,1);
		}
	}
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
		var html = ''
		html += '<html><body>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'DIAGNOSTICO Y DESCRIPCION OPERATORIA: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + diagnostico + '</p></td>'
		html += '</tr>'
		html += '</table>'
				
		html += '</body></html>'
		dsAux.addRow([html]);
		
		html = ''
		html += '<html><body>'
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL SERVICIO ***' +'</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	
	var $frm = solutionModel.getForm('Anatpa_print_servicio');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_servicio', $tipos);
	forms.Anatpa_print_servicio.controller.recreateUI();
	/*
	var win = application.createWindow("impri_servicio",JSWindow.MODAL_DIALOG);
	win.title = "Impresion talon servicio";
	win.resizable = false;
	win.show(forms.Anatpa_print_servicio);
	*/
}

/**
 * @properties={typeid:24,uuid:"8CC34A60-6B2C-44D7-AD8D-E24A070C9963"}
 */
function cargarTalonServicioInter () {
	
	if(Number(f_nroPedido) <= $parUltNumero_1){
		globals.vNroProtocolo = f_nroPedido;
		
		globals.vNroProtocolo = f_nroPedido;
		globals.MuestroTextoProtocTxt(1,'proto1');
		globals.MuestroTextoProtocTxt(2,'proto2');
		globals.MuestroTextoProtocTxt(3,'proto3');		
	}
	else{
		globals.Anatpa_protocolo = f_nroPedido;
		
		globals.Anatpa_grupo=1;
		globals.proto1=anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
		globals.Anatpa_grupo=2
		globals.proto2 = anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
		globals.Anatpa_grupo=3
		globals.proto3=anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
	}
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
	var html = '';
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'DIAGNOSTICO PRE-OPERATORIO: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto1) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'DIAGNOSTICO POST-OPERATORIO: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto2) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'OPERACION EFECTUADA Y DESCRIPCION: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto3) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);

	html = ''
	html += '<html><body>'
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL SERVICIO ***' +'</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	var $frm = solutionModel.getForm('Anatpa_print_servicio');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_servicio', $tipos);
	forms.Anatpa_print_servicio.controller.recreateUI();
	/*
	var win = application.createWindow("impri_servicio",JSWindow.MODAL_DIALOG);
	win.title = "Impresion Talon para el Servicio";
	win.resizable = false;
	win.show(forms.Anatpa_print_servicio);
	*/	
}

/**
 * @properties={typeid:24,uuid:"16417552-1107-4D78-AA6E-15C7BD52F336"}
 */
function imprimirTalonServicio () {
	
	forms.Anatpa_print_servicio.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_servicio.controller.print(false,false);
}

/**
 * 
 * @param {Number} solicitud
 * @param {String} $campo1
 * @param {Number} codigo_nome
 * @param {Number} tipo_nome
 * @param {Boolean} grabar
 *
 * @return {Number}
 * @properties={typeid:24,uuid:"40784F99-FEC6-46DC-9C8E-FE912A46D0D7"}
 */
function observaciones(solicitud,$campo1,codigo_nome,tipo_nome,grabar) {
	
	// Primero : reemplazar caracteres especiales del campo text_area
	var fs1 = databaseManager.getFoundSet("asistencial", "tbc_anatpaob")
	var $campo2 = globals.Anatpa_conversion_caract_espec(utils.stringTrim($campo1))
	
	// Segundo : se quitan los 'enters' y se crea nueva linea	x c/u
	var $campo = new Array();
	$campo = $campo2.split('\n', 7800);
	var $cuantas_partes = 0
	$cuantas_partes = $campo.length 
	var ii = 0
	var lineascab = 0;
	for (var i = 1; i < $cuantas_partes + 1; i++)
	{
	var longitudTexto = 0
	var lineas = 0
	ii = i - 1
	longitudTexto = $campo[ii].length
	var posicionInicial = 0
	if (longitudTexto > 78)
	{	//lineas = Math.round(longitudTexto / 78)  //original
		lineas = Math.floor(longitudTexto / 78)
		var resto = longitudTexto % 78
		if (resto > 0)
			{++lineas}
	}
	else {lineas = 1}
	
	var $aux_tex = ''
	var $aux_texto_79 = ''
	var $aux_pos = 77
	var $txt4 = ''

	// n lineas/reg de texto
	for (var j = 1; j < lineas + 1; j++) {
		
		var aux_largo_final = posicionInicial + 78
		if (aux_largo_final < longitudTexto)
		{
			var vlarguito = $campo[ii].substr(posicionInicial, 78)
			if (vlarguito != '') 
			{
				++lineascab
				
				fs1.newRecord();
				fs1['apobnrosolic'] = solicitud;
				fs1['apobtiponome'] = tipo_nome;
				fs1['apobcodnome'] = codigo_nome;
				fs1['apobsecuencia'] = lineascab;
				fs1['apoblinea'] = $campo[ii].substr(posicionInicial, 78)
				
				$txt4  = $campo[ii].substr(posicionInicial, 78)  		
				$aux_tex = $txt4.substr (77,1) 
				if ($aux_tex != ' ')
				{
					$aux_texto_79 = $campo[ii].substr(posicionInicial + 78, 1)  // caracter 79
					$aux_tex = $txt4.substr (77,1)        // caracter 78
					if ($aux_texto_79 == ' ')  //  asi estaría ok, porque la palabra termina justo en la 78
						{posicionInicial = posicionInicial + 79}   // 78 para que no ponga un blanco al iniciar
					else  // queda cortada la palabra, va hacia atras hasta encontrar un espacio
						{$aux_pos =  posicionInicial + 77   
						for (var k = 77; k > 1; k--)
						{
							$aux_tex = $txt4.substr(k,1)
							if ($aux_tex != ' ')
								{$aux_pos = $aux_pos - 1}
							else     // rellena a derecha con espacios los caracteres de la palabra que estaba cortada hasta completar 78
							{	var $nn = $aux_pos - posicionInicial
								$aux_tex = $txt4.substr(0,$nn)
								for (var l = $nn ; l < 78 ; l++) 
								{$aux_tex = $aux_tex + ' '}
								var longitudTexto1 = longitudTexto + 78 - $nn
								if (longitudTexto1 > 78)
								{
								var lineas1 = Math.floor(longitudTexto1 / 78)
								resto = longitudTexto1 % 78
								if (resto > 0)
									{++lineas1} 
								}
								else{lineas1 = 1} 
								lineas = lineas1
								break
							}
						}
						posicionInicial = $aux_pos + 1
						fs1['apoblinea'] =  $aux_tex
						}
				}
				else {
					
					posicionInicial = posicionInicial + 78
				}
			} 
		}
		else  
		{  	
			
			++lineascab
			
			fs1.newRecord();
			fs1['apobnrosolic'] = solicitud;
			fs1['apobtiponome'] = tipo_nome;
			fs1['apobcodnome'] = codigo_nome;
			fs1['apobsecuencia'] = lineascab;
			//fs1['apoblinea'] = ($campo[ii].substr(posicionInicial, 78).length == 0 ? ' ' : $campo[ii].substr(posicionInicial, 78))
			 
			if (lineas == 1)
				{if (longitudTexto == 0)
					{fs1['apoblinea'] = '                                                                              '}
				else
					{fs1['apoblinea'] = $campo[ii].substr(0, longitudTexto)}}
			else {
				 
				var dife = longitudTexto - posicionInicial
				fs1['apoblinea'] = $campo[ii].substr(posicionInicial, dife)
			}
		}
		
		// control logintud para no tener problema al grabar en arch. cobol
		if (fs1['apoblinea'].length > 78){
			fs1['apoblinea'] = fs1['apoblinea'].substr(0, 77)
		}
		
		if (fs1['apoblinea'].length < 78){
			
			$nn = fs1['apoblinea'].length
			for (var m = $nn + 1 ; m < 79 ; m++) {
				
				fs1['apoblinea'] = fs1['apoblinea'] + ' '
			}
		}
		
		try{
			if(grabar)
				databaseManager.saveData(fs1.getRecord(1))
			//application.output(fs1['apoblinea']);
			
		}catch (msg){
			//	application.output(msg.rhinoException.getMessage())
		}
		
		}
	}
	
	fs1.clear();
	//fs1.deleteAllRecords();
	
	return lineascab;
}

/**
 * 
 * @param {String} $campo1
 *
 * @return {Number}
 * @properties={typeid:24,uuid:"D235AD71-BA9A-427D-84BC-6D2371AE590C"}
 */
function observaLineas($campo1) {
	
	// Primero : reemplazar caracteres especiales del campo text_area
	var $campo2 = globals.Anatpa_conversion_caract_espec(utils.stringTrim($campo1))
	var texto = '';
	
	// Segundo : se quitan los 'enters' y se crea nueva linea	x c/u
	var $campo = new Array();
	$campo = $campo2.split('\n', 7800);
	var $cuantas_partes = 0
	$cuantas_partes = $campo.length 
	var ii = 0
	var lineascab = 0;
	for (var i = 1; i < $cuantas_partes + 1; i++)
	{
	var longitudTexto = 0
	var lineas = 0
	ii = i - 1
	longitudTexto = $campo[ii].length
	var posicionInicial = 0
	if (longitudTexto > 78)
	{	//lineas = Math.round(longitudTexto / 78)  //original
		lineas = Math.floor(longitudTexto / 78)
		var resto = longitudTexto % 78
		if (resto > 0)
			{++lineas}
	}
	else {lineas = 1}
	
	var $aux_tex = ''
	var $aux_texto_79 = ''
	var $aux_pos = 77
	var $txt4 = ''

	// n lineas/reg de texto
	for (var j = 1; j < lineas + 1; j++) {
		
		var aux_largo_final = posicionInicial + 78
		if (aux_largo_final < longitudTexto)
		{
			var vlarguito = $campo[ii].substr(posicionInicial, 78)
			if (vlarguito != '') 
			{
				++lineascab
			
				texto = $campo[ii].substr(posicionInicial, 78)
				
				$txt4  = $campo[ii].substr(posicionInicial, 78)  		
				$aux_tex = $txt4.substr (77,1) 
				if ($aux_tex != ' ')
				{
					$aux_texto_79 = $campo[ii].substr(posicionInicial + 78, 1)  // caracter 79
					$aux_tex = $txt4.substr (77,1)        // caracter 78
					if ($aux_texto_79 == ' ')  //  asi estaría ok, porque la palabra termina justo en la 78
						{posicionInicial = posicionInicial + 79}   // 78 para que no ponga un blanco al iniciar
					else  // queda cortada la palabra, va hacia atras hasta encontrar un espacio
						{$aux_pos =  posicionInicial + 77   
						for (var k = 77; k > 1; k--)
						{
							$aux_tex = $txt4.substr(k,1)
							if ($aux_tex != ' ')
								{$aux_pos = $aux_pos - 1}
							else     // rellena a derecha con espacios los caracteres de la palabra que estaba cortada hasta completar 78
							{	var $nn = $aux_pos - posicionInicial
								$aux_tex = $txt4.substr(0,$nn)
								for (var l = $nn ; l < 78 ; l++) 
								{$aux_tex = $aux_tex + ' '}
								var longitudTexto1 = longitudTexto + 78 - $nn
								if (longitudTexto1 > 78)
								{
								var lineas1 = Math.floor(longitudTexto1 / 78)
								resto = longitudTexto1 % 78
								if (resto > 0)
									{++lineas1} 
								}
								else{lineas1 = 1} 
								lineas = lineas1
								break
							}
						}
						posicionInicial = $aux_pos + 1
						texto = $aux_tex;
						}
				}
				else {
					
					posicionInicial = posicionInicial + 78
				}
			} 
		}
		else  
		{  	
			
			++lineascab
			 
			if (lineas == 1)
				{if (longitudTexto == 0)
					{texto = '                                                                              '}
				else
					{texto = $campo[ii].substr(0, longitudTexto)}}
			else {
				 
				var dife = longitudTexto - posicionInicial
				texto = $campo[ii].substr(posicionInicial, dife)
			}
		}
		
		// control logintud para no tener problema al grabar en arch. cobol
		if (texto.length > 78){
			texto = texto.substr(0, 77)
		}
		
		if (texto.length < 78){
			
			$nn = texto.length
			for (var m = $nn + 1 ; m < 79 ; m++) {
				
				texto = texto + ' '
			}
		}
		}
	}
	
	return lineascab;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"AFF4B875-EC1A-4B48-BEFD-E1BF1D59288E"}
 * @AllowToRunInFind
 */
function onAction_imprimir(event) {
	
	if(f_nroSolicitud != null && f_nroSolicitud != 'null'){
		
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!','¿Esta seguro que desea imprimir el comprobante de la solicitud?', 'Si', 'No');
		if( respuesta == 'Si'){
			imprimir();
		}
		
	}
	else
		globals.DIALOGS.showWarningDialog("Atención!","No existe una solicitud para imprimir.","Aceptar")
}

/**
 * @properties={typeid:24,uuid:"3945E5A3-A6AD-431B-890D-C2E17F5C12E5"}
 */
function obtenerParUltNumero_1 () {
	
	var sql1 = 'SELECT parultnumero_1'
	+ ' FROM tbc_param_his'		
	+ ' WHERE ParArchivo = 6';
	var ds = databaseManager.getDataSetByQuery('asistencial',sql1,null,-1);
	
	if(ds.getMaxRowIndex() > 0){
		$parUltNumero_1 = Number(ds.getValue(1,1));					
	}
}

/**
 * @properties={typeid:24,uuid:"E7FB80B5-47BC-4F67-B80F-F1BB83BA6189"}
 */
function cargarFechaPrestacion() {
	
	if(f_tipoPaciente == 1){
		
		// VER-PRESTGU
		obtenerServiProceso();
		
		var pregTipoEstu2 = '00';
		var nroPedido = getPregPedido();
		var nroServicio = '';
		var longitud = $servicio.toString().length;
		if(longitud == 1)
			nroServicio = '0' + $servicio;
		else
			nroServicio = $servicio;
		
		var buscarEnPrest = true;
		if($servicio > 0)
			pregTipoEstu2 = '03';
		else{
			
			if($fechaIngreso > 0)
				buscarEnPrest = false;
			else{
			
				if(f_servicio == 9)
					pregTipoEstu2 = '02';
				else{
					
					if(f_servicio == 10)
						pregTipoEstu2 = '06';
					else{
						
						if(f_servicio == 11)
							pregTipoEstu2 = '05';
						else{
							
							if(f_servicio == 14)
								pregTipoEstu2 = '07';
						}
					}
				}
			}
		}
		
		var sql = '';
		if(buscarEnPrest){
			
			// VER-PREST
			sql = "select pg.PregFechaIngreso,pg.PregHoraIngreso,PregHoraPedido,PregMedico,PregPasehistpac,PregServicio2,pregtipoestu2,pregtipomed,pregtipoprest\
				from tbc_prest_guar pg\
				where pg.PregEstado < 9"
				+ " and pg.PregTipoestu2 = '" + pregTipoEstu2 + "'"
				+ " and pg.PregServicio2 = '" + nroServicio + "'" 
				+ " and pg.PregPedido2 = '" + nroPedido + "'"
				+ " and PregHistClinica = " + f_histClinUnica;
			
			$ds_prestGuar = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
			if($ds_prestGuar.getMaxRowIndex() > 0){
				$fechaIngreso = $ds_prestGuar.getValue(1,1);
				$horaIngreso = $ds_prestGuar.getValue(1,2);
			}
			else{
				$fechaIngreso = null;
				$horaIngreso = null;
				globals.DIALOGS.showWarningDialog("Atención!","No hay Prestaciones cargadas en Guardia.","Aceptar")
			}
		}
		else{
			
			// VER-PREST1
			sql = "select pg.PregFechaIngreso,pg.PregHoraIngreso,PregHoraPedido,PregMedico,PregPasehistpac,PregServicio2,pregtipoestu2,pregtipomed,pregtipoprest\
				from tbc_prest_guar pg\
				where pg.PregEstado < 9 and pg.PregTipoPrest <= 97"
				+ " and PregHistClinica = " + f_histClinUnica
				+ " and pg.PregFechaIngreso = " + $fechaIngreso
				+ " and pg.PregHoraIngreso = " + $horaIngreso; 
				
			$ds_prestGuar = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
			if($ds_prestGuar.getMaxRowIndex() == 0){
				$fechaIngreso = null;
				$horaIngreso = null;
				globals.DIALOGS.showWarningDialog("Atención!","No hay Prestaciones cargadas.","Aceptar")
			}
		}	
	}
}

/**
 * @properties={typeid:24,uuid:"604924FF-0C0C-497D-98E9-352E0520DB03"}
 */
function getPregPedido(){
	
	var nroPedido = '';
	var longitud = 0;
	
	if(f_nroPedido != null){
		longitud = f_nroPedido.toString().length;
	}
	
	switch(longitud){
			
		case 1:{
			nroPedido = '00000' + f_nroPedido;
				
		}
		break;
		case 2: {
			nroPedido = '0000' + f_nroPedido;
		}
		break;
		case 3: {
			nroPedido = '000' + f_nroPedido;
		}
		break;
		case 4: {
			nroPedido = '00' + f_nroPedido;
		}
		break;
		case 5: {
			nroPedido = '0' + f_nroPedido;
		}
		break;
		case 6: {
			nroPedido = f_nroPedido;
		}
		break;
		default:
			nroPedido = '0';
		break;
	}
	
	return nroPedido;
}

/**
 * @properties={typeid:24,uuid:"FEEAC47F-E7C6-43CE-A967-C8C2AB72B94D"}
 */
function consultarReservas(){
	
	globals.Anatpa_reservasHisCli = f_histClinUnica;
	globals.Anatpa_reservasFech5 = $fechaPedido;
	globals.Anatpa_reservasEsta = 9;
	globals.Anatpa_reservasIPedido = f_nroPedido;
}

/**
 * 
 * @param {Number} value
 *
 * @return {String}
 * @properties={typeid:24,uuid:"B09A503E-EA2C-4B71-AF6F-F8F3EFBC18AB"}
 */
function getHoraHHMM_deHHMMssmm(value) {
	
	var hora = String(value);
	var result = '0';
	
	if(value > 0){
		
		if(hora.length > 4)
			result = hora.substr(0,hora.length - 4);
	}
	
	return result;
}

/**
 * 
 * @param {Number} codNomencla
 * @param {Number} tipoNome
 *
 * @return {String}
 * @properties={typeid:24,uuid:"3B02CAE7-3281-473E-81CF-8EED1DC60E15"}
 */
function obtenerObservaPractica (codNomencla,tipoNome) {
	var k;
	var texto = '';
	
	for(k=1 ; k <= $_dsAnatpaOb.getMaxRowIndex() ; k++){
		
		if($_dsAnatpaOb.getValue(k,1) == codNomencla && $_dsAnatpaOb.getValue(k,4) == tipoNome){
			
			if($_dsAnatpaOb.getValue(k,5) == 1)
				texto += '&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
			else
				texto += '<BR>&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
		}
	}
	
	return texto;
}
