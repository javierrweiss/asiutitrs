/**
 * @properties={typeid:35,uuid:"A8A96A1C-4B60-4461-A814-86D3B8C2FFAD",variableType:-4}
 */
var $_dsAnatpaOb = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2872A683-97DE-4463-A21A-9F7828E3371C",variableType:4}
 */
var $_mat_prof_infor = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B0F86C6D-BFE4-4B54-A808-A3EBDBA9F2A1"}
 */
var $_prof_infor = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"1EC0818A-B21C-45F4-8E82-95C8373030CB",variableType:93}
 */
var $_fechaRecibido = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"BEFEAE39-363B-4767-83CC-5A8B6B141366",variableType:4}
 */
var f_tipoReimpresion = null;

/**
 * @properties={typeid:35,uuid:"9211AA5F-E1C8-4D1E-A1C2-193707C1BB0B",variableType:-4}
 */
var $_dsAnatpade = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5BCDF06F-F8A8-413E-B635-486C56D692B4"}
 */
var f_nroPedido = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6B8B18DC-53D7-4149-8452-DD5EA354A92F",variableType:4}
 */
var f_servicio = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"EF54ACCA-5414-460A-AD69-1A8BC0D66DBC"}
 */
var f_plan = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8BE2EA12-156A-4171-8FCD-6520FEE78A3D"}
 */
var f_cobertura = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CBCF4D39-3DA5-4BEF-845F-62C128448B3E",variableType:4}
 */
var $_parUltNumero_1 = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D346A973-7969-48EE-84B9-388D6AE5E1AE",variableType:4}
 */
var $_horaIngreso = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"57E20D39-91E3-4CC6-BA9D-8721BEC16CC0",variableType:4}
 */
var $_fechaIngreso = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"15C2F69D-9017-46B5-8A0E-B40BDF476E5D"}
 */
var $_obserGeneral = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BB154894-7308-4434-9B46-A7028E264111"}
 */
var $_nroDocu = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A769847C-0561-4AD9-B144-AFA52761D952",variableType:4}
 */
var $_tipoDocu = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"251912AC-888E-426A-BE8E-735EDA5F5564"}
 */
var $_itvDescripcion = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"73C339C0-2DC9-41CC-8A37-9F42AF318C64",variableType:4}
 */
var $_fecNac = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6A63B684-2D30-427F-A6F5-6429E83CD0EF"}
 */
var $_histClinUnica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1C61D05E-1434-4638-B6DF-40A4789527A8"}
 */
var $_nombre = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E1363C00-D0F3-4DFC-8F7D-0DCB77C6A97A"}
 */
var $_nroInternado = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5BEA65CB-FADE-4BC8-B721-7796DA052580"}
 */
var $_matriculaMedico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B1156EC2-C88A-4116-98C4-9DC1AA6862E0"}
 */
var $_nombreMedico = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D6EEF7AC-AC1C-46A6-A17A-23A94DE4DED5",variableType:4}
 */
var $_legajoMedico = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"91292DA0-C681-49C1-A1BE-8C750E3C5753",variableType:4}
 */
var $_tipoMedico = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"207D305D-856E-4443-A2B6-5ABB2D20C728",variableType:4}
 */
var $_tipoPaciente = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4ECE4C00-282C-4E6A-9E7E-14FE7F08D926"}
 */
var f_nroSolicitud = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D619718F-3A7A-4998-BECC-C90A59CB5366",variableType:4}
 */
var $countFilter = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"50E372EF-B7B9-49C5-A698-5948AD72762C"}
 */
var f_paciente = null;

/**
 * @properties={typeid:35,uuid:"5E1929FA-018A-466D-A6C7-C0E59B8184B7",variableType:-4}
 */
var f_cerrarForm = false;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D64469B5-8F37-4F4A-80B2-9CDF66D7ADD8"}
 */
var f_nroAfiliado = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"89419916-73FB-4B37-BBF5-E775E307ED5E",variableType:93}
 */
var f_fechaSolicitud = null;

/**
 * TODO generated, please specify type and doc for the params
 * @param nroSolicitud
 *
 * @properties={typeid:24,uuid:"5F146792-B5F3-43C6-9581-8E973469DB01"}
 */
function buscarPedido(nroSolicitud) {
	
	if(validDataForm(nroSolicitud)){
		
		$countFilter = 0;
		/*
		var fechaDesde;
		var fechaHasta;
		if(f_fechaDesde != null && f_fechaHasta != null){
			fechaDesde = globals.FormatearFecha(f_fechaDesde,"AAAAMMDD");
			fechaHasta = globals.FormatearFecha(f_fechaHasta,"AAAAMMDD");
		}
		*/
		var $ds;
		var paciente = utils.stringTrim(nroSolicitud).toLocaleUpperCase();
		var ds_ambu = databaseManager.getDataSetByQuery('asistencial',"select amb.histcabnrounico from tbc_hist_cab_new amb where amb.histcabapellnom like '" + paciente + "%'",null,-1);
		var ds_inter = databaseManager.getDataSetByQuery('asistencial',"select Adm_HistClin from tbc_ADMISION where Adm_ApelNom like '" + paciente + "%'",null,-1);
		
		var $sql1 = "SELECT ca.Apca_NroSolic nro_solicitud ,ca.Apca_FecSolic_3 fecha_solicitud,ca.Apca_HistClin hist_clinica,ca.Apca_HistNom paciente,ca.Apca_ObrSoc cobertura\
			,ca.Apca_Servicio servicio,ca.Apca_Protocolo pedido,ca.Apca_TipAdmi tipo_admi,ca.Apca_FecIngr fecha_ingreso,ca.Apca_HorIngr hora_ingreso\
			,ca.apca_tipmed tipo_med,ca.apca_codmed cod_med,ca.Apca_FecReci fecha_recibido,ca.Apca_ProfInfor prof_infor,ca.Apca_MatProfInfor mat_prof_infor\
			FROM tbc_ANATPACA ca\
			WHERE ";
		
		if(isNaN(nroSolicitud)){
					
			$ds = databaseManager.createEmptyDataSet();
			$ds.addColumn('nro_solicitud');
			$ds.addColumn('fecha_solicitud');
			$ds.addColumn('hist_clinica');
			$ds.addColumn('paciente');
			$ds.addColumn('cobertura');
			$ds.addColumn('servicio');
			$ds.addColumn('pedido');
			$ds.addColumn('tipo_admi');
			$ds.addColumn('fecha_ingreso');
			$ds.addColumn('hora_ingreso');
			$ds.addColumn('tipo_med');
			$ds.addColumn('cod_med');
			$ds.addColumn('fecha_recibido');
			$ds.addColumn('prof_infor');
			$ds.addColumn('mat_prof_infor');
			
			var count = 0;
			var $ds1
			var i;
			var k;
			var sql2 ="";
			
			// buscqueda de solicitudes segun pacientes ambulatorios
			for(i=1 ; i<= ds_ambu.getMaxRowIndex() ; i++){
				count++;
				if(count==1)
					sql2 = $sql1 + " (ca.Apca_TipAdmi = 1 and ca.Apca_HistClin = " + ds_ambu.getValue(i,1) + ")";
				else
					sql2 += " or (ca.Apca_TipAdmi = 1 and ca.Apca_HistClin = " + ds_ambu.getValue(i,1) + ")";
				
				if(count == 20){
					$ds1 = databaseManager.getDataSetByQuery('asistencial',sql2,null,-1);
					for(k = 1; k<= $ds1.getMaxRowIndex() ; k++){
						$ds.addRow($ds1.getRowAsArray(k))
					}
					count = 0;
				}
			}
			
			if(count > 0){
				$ds1 = databaseManager.getDataSetByQuery('asistencial',sql2,null,-1);
				for(k = 1; k<= $ds1.getMaxRowIndex() ; k++){
					$ds.addRow($ds1.getRowAsArray(k))
				}
			}
			
			// busqueda de solicitudes segun pacientes internados
			count = 0;
			sql2 = "";
			for(i=1 ; i<= ds_inter.getMaxRowIndex() ; i++){
				count++;
				if(count==1)
					sql2 = $sql1 + " (ca.Apca_TipAdmi = 0 and ca.Apca_HistClin = " + ds_inter.getValue(i,1) + ")";
				else
					sql2 += " or (ca.Apca_TipAdmi = 0 and ca.Apca_HistClin = " + ds_inter.getValue(i,1) + ")";
				
				if(count == 20){
					$ds1 = databaseManager.getDataSetByQuery('asistencial',sql2,null,-1);
					for(k = 1; k<= $ds1.getMaxRowIndex() ; k++){
						$ds.addRow($ds1.getRowAsArray(k))
					}
					count = 0;
				}
			}
			
			if(count > 0){
				$ds1 = databaseManager.getDataSetByQuery('asistencial',sql2,null,-1);
				for(k = 1; k<= $ds1.getMaxRowIndex() ; k++){
					$ds.addRow($ds1.getRowAsArray(k))
				}
			}
			
			$countFilter += 1;
		}
		else{
					
			$sql1 += " ca.Apca_NroSolic = " + nroSolicitud;
			$ds = databaseManager.getDataSetByQuery('asistencial',$sql1,null,-1);
			
			$countFilter +=1;
		}
				 
		if($countFilter >0){
			
			
			if($ds.getMaxRowIndex() > 0){
				
				if(isNaN(nroSolicitud)){
					//$ds.sort(1,true);
					
					var $frm = solutionModel.getForm('Anatpa_tbl_reimpresion_solicitud');
					var $tipos = [JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT];
					$frm.dataSource = $ds.createDataSource('Anatpa_tbl_reimpresion_solicitud', $tipos);
					forms.Anatpa_tbl_reimpresion_solicitud.foundset.sort('paciente asc,nro_solicitud asc');
					forms.Anatpa_tbl_reimpresion_solicitud.controller.recreateUI();
					
					openListViewReimpresion();
				}
				else{
					
					var obj = new Object();
					obj['nro_solicitud'] = $ds.getValue(1,1);
					obj['fecha_solicitud'] = $ds.getValue(1,2);
					obj['hist_clinica'] = $ds.getValue(1,3);
					obj['paciente'] = $ds.getValue(1,4);
					obj['cobertura'] = $ds.getValue(1,5);
					obj['servicio'] = $ds.getValue(1,6);
					obj['pedido'] = $ds.getValue(1,7);
					obj['tipo_admi'] = $ds.getValue(1,8);
					obj['fecha_ingreso'] = $ds.getValue(1,9);
					obj['hora_ingreso'] = $ds.getValue(1,10);
					obj['tipo_med'] = $ds.getValue(1,11);
					obj['cod_med'] = $ds.getValue(1,12);
					obj['fecha_recibido'] = $ds.getValue(1,13);
					obj['prof_infor'] = $ds.getValue(1,14);
					obj['mat_prof_infor'] = $ds.getValue(1,15);
					
					loadDataForm(obj);
					elements.txt_nroSolicitud.enabled = false;
					elements.btn_imprimir.requestFocus();
				}
			}
			else{
				globals.DIALOGS.showWarningDialog("Atención","Nro. de Solicitud inexistente.","Aceptar");
			}
			
			$countFilter = 0;
		}
		else{
			globals.DIALOGS.showWarningDialog("Atención","Debe ingresar al menos un criterio de filtro.","Aceptar");
			elements.txt_nroSolicitud.requestFocus();
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param data
 *
 * @properties={typeid:24,uuid:"FA961FB3-64A9-4CC5-BF0D-52BC5E1806D7"}
 * @AllowToRunInFind
 */
function loadDataForm (data) {
	
	if(data['fecha_solicitud'] == 0 || data['fecha_solicitud'] == "0"){
		
		globals.DIALOGS.showInfoDialog("Información","Este examen no fue enviado al Laboratorio.","Aceptar");
		limpiarForm();
		elements.txt_nroSolicitud.requestFocus();
	}
	else{
		
		f_nroSolicitud = data['nro_solicitud'];
		f_fechaSolicitud = globals.IntegerToDate(data['fecha_solicitud']) ;
		$_fechaRecibido = globals.IntegerToDate(data['fecha_recibido']) ;
		f_nroPedido = data['pedido'];
		f_servicio = data['servicio'];
		globals.Anatpa_codObraSocial = data['cobertura'];
		f_cobertura =  globals.anatpa_buscar_obrasocial.obr_razonsoc;
		
		$_nombre = data['paciente'];
		$_tipoPaciente = data['tipo_admi'];
		$_tipoMedico = data['tipo_med'];
		$_legajoMedico = data['cod_med'];
		$_prof_infor = data['prof_infor'];
		$_mat_prof_infor = data['mat_prof_infor']

		if(f_servicio == 11){
			
			var sql = "";
			// paciente internado
			if($_tipoPaciente == 0){
				
				sql = "select it.Itv_Descripcion interven from tbc_cirugint ci\
						left join maestros.tbc_interven it on it.Itv_Codi = ci.CiriInterven\
						where ci.CiriTipoNome = 0 and ci.CiriCodNome = 0" 
						+ " and ci.CiriHistCl = " + data['hist_clinica']
						+ " and ci.ciriprotocolo = " + data['pedido'];
			}
			else{
				//paciente ambulatorio
				sql = "select it.Itv_Descripcion interven from tbc_ciruguar cg\
					left join maestros.tbc_interven it on it.Itv_Codi = cg.CirgInterven"
					+ " where cg.CirgHistClinica = " + data['hist_clinica']
					+ " and cg.CirgFechaIngreso = " + data['fecha_ingreso']
					+ " and cg.CirgHoraIngreso = " + data['hora_ingreso'];
			}
			
			var ds = databaseManager.getDataSetByQuery('asistencial',sql,null,-1);
			if(ds.getMaxRowIndex() > 0){
				$_itvDescripcion = utils.stringTrim(ds.getValue(1,1));
			}
		}
		
		globals.Anatpa_hiscli = data['hist_clinica'];
		
		if($_tipoPaciente == 0){

			f_paciente = globals.anatpa_numero_to_tbc_admision.hiscli2_anatpa + ' ' + data['paciente'];
			f_plan = globals.anatpa_numero_to_tbc_admision.adm_planobr;
			f_nroAfiliado = utils.stringTrim(globals.anatpa_numero_to_tbc_admision.adm_nrobenef);
			$_fecNac = globals.anatpa_numero_to_tbc_admision.adm_fecnac;
			$_histClinUnica = globals.anatpa_numero_to_tbc_admision.adm_histclinuni;
			$_tipoDocu = globals.anatpa_numero_to_tbc_admision.adm_tipdocu;
			$_nroDocu = globals.anatpa_numero_to_tbc_admision.adm_nrodocu;
			$_nroInternado = globals.anatpa_numero_to_tbc_admision.hiscli2_anatpa;
			
			var msg = '';
			if(anatpa_numero_to_tbc_admision.adm_fecaltaefec > 0)
				msg = 'Paciente, egresado del sanatorio.';
			
			if(anatpa_buscar_obrasocial.obr_estado == 2){
				
				if(msg != '')
					msg += '\n';
				
				msg += 'La Cobertura no esta vigente.';
			}
				
			if(msg != '')
				globals.DIALOGS.showInfoDialog("Atención",msg,"Aceptar")
		}
		else{
			
			var plan = "";
			var sqlHistCabObras = "select HistCabObrasPlanX from tbc_hist_cab_obras where HistCabObrasNroUnico = " + data['hist_clinica'] + " and HistCabObrasObra = " + data['cobertura'];
 			var ds_histCabObras = databaseManager.getDataSetByQuery('asistencial',sqlHistCabObras,null,-1);
 			if(ds_histCabObras.getMaxRowIndex() > 0)
 				plan = ds_histCabObras.getValue(1,1)
			else
				plan = globals.anatpa_ambulatorio_buscar_numero.histcabplanx;
 			
			f_paciente = data['hist_clinica'] + ' ' + data['paciente'];
			f_plan = plan;
			f_nroAfiliado = utils.stringTrim(globals.anatpa_ambulatorio_buscar_numero.histcabnrobenef);
			$_fecNac = globals.anatpa_ambulatorio_buscar_numero.histcabfechanac;
			$_tipoDocu = globals.anatpa_ambulatorio_buscar_numero.histcabtipodoc;
			$_nroDocu = globals.anatpa_ambulatorio_buscar_numero.histcabnrodoc;
			$_histClinUnica = data['hist_clinica'];
			
			$_fechaIngreso = data['fecha_ingreso'];
			$_horaIngreso = data['hora_ingreso'];
		}
		
		// Obteniendo datos del detalle de la anatomia
		var sqlDetalle = "select de.Apde_CodNom,nom.Nome_Descr,de.Apde_Cantidad,de.Apde_TipNom from tbc_ANATPADE de\
							left join maestros.tbc_nomencla nom on nom.Nome_Codigo = de.Apde_CodNom"
							+ " where de.Apde_NroSolic = " + data['nro_solicitud'];
							+ " order by de.Apde_TipNom,de.Apde_CodNom";
		$_dsAnatpade = databaseManager.getDataSetByQuery('asistencial',sqlDetalle,null,-1);
		
		// Obteniendo datos de observacion
		var sqlObserva = "select ob.ApobCodNome,ob.ApobSecuencia,ob.ApobLinea,ob.ApobTipoNome,ob.ApobSecuencia from tbc_ANATPAOB ob"
			+ " where ob.ApobNroSolic = " + data['nro_solicitud']
			+ " order by ob.ApobTipoNome,ob.ApobCodNome,ob.ApobSecuencia";
			$_dsAnatpaOb = databaseManager.getDataSetByQuery('asistencial',sqlObserva,null,-1);
		
		var k;
		for(k=1 ; k <= $_dsAnatpaOb.getMaxRowIndex() ; k++){
			if($_dsAnatpaOb.getValue(k,1) == 0){
				if($_dsAnatpaOb.getValue(k,5) == 1)
					$_obserGeneral += '&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
				else
					$_obserGeneral += '<BR>&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
			}
			else
				break;
		}	
	}
}

/**
 * @properties={typeid:24,uuid:"EEF49BA5-08F6-45C5-B1AA-3462D716B1E1"}
 */
function validDataForm(nroSolicitud) {
	
	var isValid = true;	
	var messageError = "No ha sido posible realizar la consulta. Corrija los siguientes errores y vuelva a intentar."
	
	if(nroSolicitud ==  null){
		messageError += "\nDebe ingresar el nro. de solicitud o al menos las 3 primeras letras del apellido del paciente.";        
        isValid = false;
	}
	else{
		var texto = utils.stringTrim(nroSolicitud) 
		if(isNaN(texto) && texto.length < 3){
			messageError += "\Debe ingresar el nro. de solicitud o al menos las 3 primeras letras del apellido del paciente.";
			isValid = false;
		}
	}
	
	/*
	if (f_fechaDesde != null && f_fechaHasta == null){
		messageError += "\nDebe ingresar fecha hasta.";        
	    isValid = false;
	}
	
	if (f_fechaHasta != null && f_fechaDesde == null){
		messageError += "\nDebe ingresar fecha desde.";        
        isValid = false;
	}
	
	if(f_fechaDesde != null && f_fechaHasta != null){
		if (f_fechaHasta < f_fechaDesde){
			messageError += "\nLa fecha hasta debe ser mayor o igual a la fecha desde.";        
	        isValid = false;
		}
	}
	
	if(utils.stringTrim(f_paciente).length > 0){
		
		if (f_fechaHasta == null || f_fechaDesde == null){
			messageError += "\nDebe ingresar fecha desde y hasta.";        
	        isValid = false;
		}
	}
	*/
	if(!isValid){
		globals.DIALOGS.showWarningDialog("Atención",messageError,"Aceptar")
		elements.txt_nroSolicitud.requestFocus();
	}
	
	return isValid;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"3AA6265F-44FB-4420-9120-648058AAD418"}
 */
function onAction_limpiarForm(event) {
	
	limpiarForm();
	elements.txt_nroSolicitud.requestFocus();
}

/**
 * @properties={typeid:24,uuid:"45E348D7-34FD-475D-92C0-5F04A4AAA697"}
 */
function limpiarForm () {
	
	f_nroSolicitud = null;
	f_cobertura = null;
	f_fechaSolicitud = null;
	f_nroAfiliado = null;
	f_nroPedido = null;
	f_paciente = null;
	f_plan =  null;
	f_servicio = null;
	$countFilter = 0;
	$_dsAnatpade = null;
	$_dsAnatpaOb = null;
	
	$_fechaRecibido = null;
	$_fechaIngreso = null;
	$_fecNac = null;
	$_histClinUnica = null;
	$_horaIngreso = null;
	$_itvDescripcion = null;
	$_legajoMedico = null;
	$_matriculaMedico = null;
	$_nombre = null;
	$_nombreMedico = null;
	$_nroDocu = null;
	$_nroInternado = null;
	$_obserGeneral = null;
	$_parUltNumero_1 = null;
	$_tipoDocu = null;
	$_tipoMedico = null;
	$_tipoPaciente = null;
	
	$_prof_infor = null;
	$_mat_prof_infor = null;
	//f_tipoReimpresion = 1;
	
	elements.txt_nroSolicitud.enabled = true;
		
	if(forms.Anatpa_tbl_reimpresion_solicitud.foundset.getSize() > 0){
		forms.Anatpa_tbl_reimpresion_solicitud.foundset.clear();		
	}
}

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"424F90B2-1931-41DA-B414-08FF5FD4BCF7"}
 */
function onShow_inicializarForm(firstShow, event) {
	
	f_cerrarForm = false;
	limpiarForm();
	obtenerParUltNumero_1();

	var ds_anatpaca = databaseManager.createEmptyDataSet();
	ds_anatpaca.addColumn('nro_solicitud');
	ds_anatpaca.addColumn('fecha_solicitud');
	ds_anatpaca.addColumn('hist_clinica');
	ds_anatpaca.addColumn('paciente');
	ds_anatpaca.addColumn('cobertura');
	ds_anatpaca.addColumn('servicio');
	ds_anatpaca.addColumn('pedido');
	ds_anatpaca.addColumn('tipo_admi');
	ds_anatpaca.addColumn('fecha_ingreso');
	ds_anatpaca.addColumn('hora_ingreso');
	ds_anatpaca.addColumn('tipo_med');
	ds_anatpaca.addColumn('cod_med');
	ds_anatpaca.addColumn('fecha_recibido');
	ds_anatpaca.addColumn('prof_infor');
	ds_anatpaca.addColumn('mat_prof_infor');
	
	var $frm = solutionModel.getForm('Anatpa_tbl_reimpresion_solicitud');
	var $tipos = [JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.INTEGER,JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT];
	$frm.dataSource = ds_anatpaca.createDataSource('Anatpa_tbl_reimpresion_solicitud', $tipos);
	forms.Anatpa_tbl_reimpresion_solicitud.controller.recreateUI();
	
	elements.txt_nroSolicitud.requestFocus();
	
	// control del elemento por perfil	    		
	var $form = controller.getName();
	//globals.consulta_288_controlarElementos($form);
	var cargarOpciones = false;
	var $tope_form = globals.Anatpa_permisos.getMaxRowIndex()
	
	for (var i = 1; i <= $tope_form; i++){	
		
		if ($form == globals.Anatpa_permisos.getValue(i,3)){
			
			if('imprimir_informe' == globals.Anatpa_permisos.getValue(i,4)){
					
				if(globals.Anatpa_permisos.getValue(i,6)==true){
						
					cargarOpciones = true;
					break;
				}
			}
			
		}
	}
	
	var dataset;
	if(cargarOpciones){
		
		dataset = databaseManager.createEmptyDataSet(0,new Array('display_values','optional_real_values'));
		dataset.addRow(['Pedido',1]);
		dataset.addRow(['Informe',2]);
		dataset.addRow(['Ambos',3]);
		elements.cbo_tipoReimpresion.setValueListItems(dataset);
		
	}
	else{
		
		dataset = databaseManager.createEmptyDataSet(0,new Array('display_values','optional_real_values'));
		dataset.addRow(['Pedido',1]);
		elements.cbo_tipoReimpresion.setValueListItems(dataset);
		f_tipoReimpresion = 1;
	}
}

/**
 * @properties={typeid:24,uuid:"DC72A610-C946-4EE7-9818-FFF4AE26F5A0"}
 */
function obtenerParUltNumero_1 () {
	
	var sql1 = 'SELECT parultnumero_1'
	+ ' FROM tbc_param_his'		
	+ ' WHERE ParArchivo = 6';
	var ds = databaseManager.getDataSetByQuery('asistencial',sql1,null,-1);
	
	if(ds.getMaxRowIndex() > 0){
		$_parUltNumero_1 = Number(ds.getValue(1,1));					
	}
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"EC2B7D5B-C196-4937-B5A0-13B42544950E"}
 */
function onHide_consultaProtocolo(event) {
	if(f_cerrarForm){
		var $win = application.getWindow(application.getActiveWindow().getName());
		if($win != null){
			$win.hide();
			$win.destroy();
		}
	}
	return f_cerrarForm;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"89E9F14E-2943-4C9E-90F4-A29F2190271E"}
 */
function onAction_cerrar(event) {
	f_cerrarForm = true;
	onHide_consultaProtocolo(event);
}

/**
 * @AllowToRunInFind
 * @param {Boolean} esReimpresion
 * @properties={typeid:24,uuid:"CADAEB0C-DAC1-4838-AF59-7ADCC60110EC"}
 */
function imprimir (esReimpresion){
	
	// Buscando nombre de medico para impresion
	if(f_servicio == 22 && $_tipoPaciente == 0){
	}
	else{
		
		if($_tipoMedico != null){
			if($_tipoMedico == 0){
				// Buscar en personal
				var fs_personal = databaseManager.getFoundSet('maestros','tbc_personal');
				fs_personal.find();
				fs_personal['per_legajo'] = $_legajoMedico;
				fs_personal.search();
				
				if(fs_personal.getSize() > 0){
					$_nombreMedico = utils.stringTrim(fs_personal['per_apelnom']);
					$_matriculaMedico = fs_personal['per_codmatri'];
				}
			}
			else{
				// Buscar en medicos
				var fs_medicos = databaseManager.getFoundSet('maestros','tbc_medicos');
				fs_medicos.find();
				fs_medicos['med_codigo'] = $_legajoMedico;
				fs_medicos.search();
				
				if(fs_medicos.getSize() > 0){
					$_nombreMedico = utils.stringTrim(fs_medicos['med_apenom']);
					$_matriculaMedico = utils.stringTrim(fs_medicos['med_matricula']);
				}
			}
		}
	}
	
	//Limpiando form de impresion
	forms.Anatpa_print_internado.limpiarForm();
	cargarSolicitudImpresion();
	imprimirSolicitud();
	
	// Actualizar estado de anatpaca
	var fs_anatPaca = databaseManager.getFoundSet("asistencial","tbc_anatpaca");
	fs_anatPaca.find();
	fs_anatPaca['apca_nrosolic']= f_nroSolicitud;
	fs_anatPaca.search();
	
	if(fs_anatPaca.getSize() == 1){
		
		if(fs_anatPaca['apca_estado'] == 0){
		
			fs_anatPaca['apca_estado'] = 1;
			databaseManager.saveData(fs_anatPaca);
		}
	}
	
	// Si es reimpresion solo imprimir una copia de la solicitud
	if(!esReimpresion){
		
		// Si el servicio es cirujia
		if(f_servicio == 11){
			
			imprimirSolicitud();// imprime una copia
			forms.Anatpa_print_servicio.limpiarForm();
			cargarCabeceraImpresionServicio();
			
			// si es ambulatorio
			if($_tipoPaciente > 0){
				cargarTalonServicioAmbu();
			}
			else{
				// Si es internado
				cargarTalonServicioInter();
			}
			
			imprimirTalonServicio();
		}
		
		// Si es ambulatorio
		if($_tipoPaciente > 0){
			
			// limpiar form de impresion
			forms.Anatpa_print_paciente.limpiarForm();
			imprimirTalonPaciente();
		}
	}
	
}

/**
 * @properties={typeid:24,uuid:"18912A21-AA08-4D78-8F7B-44A40724AA95"}
 */
function cargarCabeceraImpresionServicio() {
	
	var servicio = utils.stringTrim(application.getValueListDisplayValue('Anatpa_vl_servicios',f_servicio));
	/*
	if(f_servicio == 21){
		if($_tipoPaciente == 1)
			servicio = "Guardia";
		else
			servicio = "Consultorios Externos"; 	
	}
	*/
	forms.Anatpa_print_servicio.f_fechaImpresion = f_fechaSolicitud;
	forms.Anatpa_print_servicio.f_apelnom = $_tipoPaciente == 0 ? $_nroInternado + ' ' + $_nombre + '  (Internado)': $_histClinUnica + ' ' + $_nombre + '  (Ambulatorio)';
	forms.Anatpa_print_servicio.f_cobertura = f_cobertura;
	forms.Anatpa_print_servicio.f_edad = globals.CalculoEdad($_fecNac) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_servicio.f_histclin = $_tipoPaciente == 0 ? $_histClinUnica : '';
	forms.Anatpa_print_servicio.f_intervencion = $_itvDescripcion;
	forms.Anatpa_print_servicio.f_nroAfiliado = f_nroAfiliado;
	forms.Anatpa_print_servicio.f_nroDocumento = application.getValueListDisplayValue('Anatpa_vl_tipoDocu',$_tipoDocu) + ' ' + $_nroDocu;
	forms.Anatpa_print_servicio.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_servicio.f_plan = f_plan;
	forms.Anatpa_print_servicio.f_protocolo = f_nroPedido;
	forms.Anatpa_print_servicio.f_servicio = servicio;
	
}

/**
 * @properties={typeid:24,uuid:"EEA31729-05EF-4FF8-B879-9995C72B48E7"}
 */
function cargarSolicitudImpresion () {
	
	var fechaDesde = String($_fecNac);
	var fechaHasta = globals.FormatearFecha(f_fechaSolicitud,'AAAAMMDD');
	
	var servicio = utils.stringTrim(application.getValueListDisplayValue('Anatpa_vl_servicios',f_servicio));
	/*
	if(f_servicio == 21){
		if($_tipoPaciente == 1)
			servicio = "Guardia";
		else
			servicio = "Consultorios Externos"; 	
	}
	*/
	var protocolo = f_nroPedido;
	if(f_servicio == 21 ||f_servicio == 22 || f_servicio == 23){
		protocolo = "";
	}
	
	forms.Anatpa_print_internado.f_fechaImpresion = f_fechaSolicitud;
	forms.Anatpa_print_internado.f_apelnom = $_tipoPaciente == 0 ? $_nroInternado + ' ' + $_nombre + '  (Internado)': $_histClinUnica + ' ' + $_nombre + '  (Ambulatorio)';
	forms.Anatpa_print_internado.f_cobertura = f_cobertura;
	forms.Anatpa_print_internado.f_edad = globals.Anatpa_calcularEdad(fechaDesde,fechaHasta) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_internado.f_histclin = $_tipoPaciente == 0 ? $_histClinUnica : '';
	forms.Anatpa_print_internado.f_intervencion = $_itvDescripcion;
	forms.Anatpa_print_internado.f_nroAfiliado = f_nroAfiliado;
	forms.Anatpa_print_internado.f_nroDocumento = application.getValueListDisplayValue('Anatpa_vl_tipoDocu',$_tipoDocu) + ' ' + $_nroDocu;
	forms.Anatpa_print_internado.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_internado.f_plan = f_plan;
	forms.Anatpa_print_internado.f_protocolo = protocolo;
	forms.Anatpa_print_internado.f_servicio = servicio;
	
	forms.Anatpa_print_internado.f_nombreMedico = 'Dr.'+ ' ' + $_nombreMedico;
	forms.Anatpa_print_internado.f_matriculaMedico = 'M.N.' + ' ' + $_matriculaMedico;
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
	var html = "";
	
	for(var i = 1 ; i <= $_dsAnatpade.getMaxRowIndex() ; i++ ){
		
		html = "";
		html += '<html><body>'
			
		html += '<table width=100% border="none" cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=7%>' + formatearCodNomencla($_dsAnatpade.getValue(i,1)) +'</td>'
		html += '<td width=63%>' + $_dsAnatpade.getValue(i,2) +'</td>'
		html += '<td width=30%>' + $_dsAnatpade.getValue(i,3) +'</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'Observaciones: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + obtenerObservaPractica($_dsAnatpade.getValue(i,1),$_dsAnatpade.getValue(i,4)) + '</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}
	
	if(utils.stringTrim($_obserGeneral).length > 0){
		
		html = ''
		html += '<html><body>'
	    html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'Observaciones generales: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + utils.stringTrim($_obserGeneral) + '</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}
		
	var $frm = solutionModel.getForm('Anatpa_print_internado');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_internado', $tipos);
	forms.Anatpa_print_internado.controller.recreateUI();
	/*
	var win = application.createWindow("impri_internado",JSWindow.MODAL_DIALOG);
	win.title = "Impresion Internado";
	win.resizable = false;
	win.show(forms.Anatpa_print_internado);
	*/
}

/**
 * @properties={typeid:24,uuid:"24F9370C-AE3D-433A-A4F1-035A85B696D0"}
 */
function imprimirSolicitud () {
	forms.Anatpa_print_internado.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_internado.controller.print(false,false);
}

/**
 * @properties={typeid:24,uuid:"4AB66A35-2668-47A0-975B-9173EBAC48D8"}
 */
function imprimirTalonPaciente () {
	
	forms.Anatpa_print_paciente.f_fechaImpresion = f_fechaSolicitud;
	forms.Anatpa_print_paciente.f_apelnom = $_tipoPaciente == 0 ? $_nroInternado + ' ' + $_nombre : $_histClinUnica + ' ' + $_nombre;
	forms.Anatpa_print_paciente.f_cobertura = f_cobertura;
	forms.Anatpa_print_paciente.f_edad = globals.CalculoEdad($_fecNac) + ' ' +  globals.vTipoEdad;
	forms.Anatpa_print_paciente.f_histclin = $_tipoPaciente == 0 ? $_histClinUnica : '';
	forms.Anatpa_print_paciente.f_nroSolicitud = f_nroSolicitud;
	forms.Anatpa_print_paciente.f_plan = f_plan;
	forms.Anatpa_print_paciente.f_medicoSolicitante = $_nombreMedico;

	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
	var html = "";
	var i;
	for(i = 1 ; i <= $_dsAnatpade.getMaxRowIndex() ; i++ ){
		
		html = "";
		html += '<html><body>'
			
		html += '<table width=100% border="none" cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=70%>' + $_dsAnatpade.getValue(i,2) +'</td>'
		html += '<td width=30%>' + $_dsAnatpade.getValue(i,3) +'</td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	}
		
		html = ''
		html += '<html><body>'
	    html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'Consulte con su Obra Social para el retiro del informe. ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
				
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL PACIENTE ***' +'</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	
	
	var $frm = solutionModel.getForm('Anatpa_print_paciente');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_paciente', $tipos);
	forms.Anatpa_print_paciente.controller.recreateUI();
	
	/*var win = application.createWindow("impri_paciente",JSWindow.MODAL_DIALOG);
	win.title = "Impresion catálogo paciente";
	win.resizable = false;
	win.show(forms.Anatpa_print_paciente);*/
	
	forms.Anatpa_print_paciente.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_paciente.controller.print(false,false);
}

/**
 * @properties={typeid:24,uuid:"E37A0D47-51CE-4804-85D7-459E0D9A88AC"}
 */
function cargarTalonServicioAmbu () {
	
	var diagnostico = '';
	
	var sqlDesal = 'select texto from tbl_proamb_t\
		where grupo = 1'
		+ ' and hiscli = ' + $_histClinUnica
		+ ' and fecing = ' + $_fechaIngreso
		+ ' and horing = ' + $_horaIngreso;
	var ds_proAmbDesal = databaseManager.getDataSetByQuery('desal',sqlDesal,null,-1)
	
	if(ds_proAmbDesal.getMaxRowIndex() > 0){
		diagnostico = utils.stringTrim(ds_proAmbDesal.getValue(1,1));
	}
	else{
		
		var sql = 'select proalinea from tbc_proamb_t\
			where proagrupo = 1 and proasecuencia > 0'
			+ ' and proahistclinica = ' + $_histClinUnica
			+ ' and proafechaingreso = ' + $_fechaIngreso
			+ ' and proahoraingreso = ' + $_horaIngreso;
		var ds_proAmb = databaseManager.getDataSetByQuery('asistencial',sql,null,-1)

		var i;
		for(i=1 ; i <= ds_proAmb.getMaxRowIndex() ; i++){
	
			diagnostico += ds_proAmb.getValue(i,1);
		}
	}
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
		var html = ''
		html += '<html><body>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=50%>' + 'DIAGNOSTICO Y DESCRIPCION OPERATORIA: ' + '</td>'
		html += '<td width=50%>' + '                   ' + '</td>'
		html += '</tr>'
		html += '</table>'
			
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><p>' + diagnostico + '</p></td>'
		html += '</tr>'
		html += '</table>'
				
		html += '</body></html>'
		dsAux.addRow([html]);
		
		html = ''
		html += '<html><body>'
		html += '<table width=100% cellpadding=1 cellspacing=0>'
		html += '<tr>'
		html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL SERVICIO ***' +'</p></td>'
		html += '</tr>'
		html += '</table>'
		
		html += '</body></html>'
		dsAux.addRow([html]);
	
	var $frm = solutionModel.getForm('Anatpa_print_servicio');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_servicio', $tipos);
	forms.Anatpa_print_servicio.controller.recreateUI();
	/*
	var win = application.createWindow("impri_servicio",JSWindow.MODAL_DIALOG);
	win.title = "Impresion talon servicio";
	win.resizable = false;
	win.show(forms.Anatpa_print_servicio);
	*/
}

/**
 * @properties={typeid:24,uuid:"424D2CD0-2F3C-4ED4-A7F3-02655E0A52D5"}
 */
function cargarTalonServicioInter () {
	
	if(Number(f_nroPedido) <= $_parUltNumero_1){
		globals.vNroProtocolo = f_nroPedido;
		
		globals.vNroProtocolo = f_nroPedido;
		globals.MuestroTextoProtocTxt(1,'proto1');
		globals.MuestroTextoProtocTxt(2,'proto2');
		globals.MuestroTextoProtocTxt(3,'proto3');		
	}
	else{
		globals.Anatpa_protocolo = f_nroPedido;
		
		globals.Anatpa_grupo=1;
		globals.proto1=anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
		globals.Anatpa_grupo=2
		globals.proto2 = anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
		globals.Anatpa_grupo=3
		globals.proto3=anatpa_tbl_protoc_txt_to_tbl_protoc_txt.texto
	}
	
	var dsAux = databaseManager.createEmptyDataSet();
	dsAux.addColumn('html_internado');
	
	var html = '';
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'DIAGNOSTICO PRE-OPERATORIO: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto1) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'DIAGNOSTICO POST-OPERATORIO: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto2) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	html = ''
	html += '<html><body>'
    html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=50%>' + 'OPERACION EFECTUADA Y DESCRIPCION: ' + '</td>'
	html += '<td width=50%>' + '                   ' + '</td>'
	html += '</tr>'
	html += '</table>'
		
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><p>' + utils.stringTrim(globals.proto3) + '</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);

	html = ''
	html += '<html><body>'
	html += '<table width=100% cellpadding=1 cellspacing=0>'
	html += '<tr>'
	html += '<td width=100%><hr style="height:6px"><p ALIGN=center>' + '*** TALON PARA EL SERVICIO ***' +'</p></td>'
	html += '</tr>'
	html += '</table>'
	
	html += '</body></html>'
	dsAux.addRow([html]);
	
	var $frm = solutionModel.getForm('Anatpa_print_servicio');
	var $tipos = [JSColumn.TEXT];
	$frm.dataSource = dsAux.createDataSource('Anatpa_print_servicio', $tipos);
	forms.Anatpa_print_servicio.controller.recreateUI();
	/*
	var win = application.createWindow("impri_servicio",JSWindow.MODAL_DIALOG);
	win.title = "Impresion Talon para el Servicio";
	win.resizable = false;
	win.show(forms.Anatpa_print_servicio);
	*/
}

/**
 * @properties={typeid:24,uuid:"1457D78A-406F-4108-A68E-D0E7C8E0F469"}
 */
function imprimirTalonServicio () {
	
	forms.Anatpa_print_servicio.controller.setPageFormat(210,297,10,10,10,10,1,0);
	forms.Anatpa_print_servicio.controller.print(false,false);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"523D2226-BAB2-4615-AEBC-DBEDE318BC34"}
 */
function onAction_nroSolicitud(event) {
	
	buscarPedido(f_nroSolicitud);
}

/**
 * @properties={typeid:24,uuid:"75D89886-1809-4BF3-AE57-25F4A3ADF159"}
 */
function openListViewReimpresion() {
	
	var win = application.createWindow("Anatpa_tbl_reimpresion",JSWindow.MODAL_DIALOG);
	win.title = "Búsqueda de prácticas";
	win.resizable = false;
	win.show(forms.Anatpa_tbl_reimpresion_solicitud);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"1B02016E-029D-4EB9-8B51-309B01046C53"}
 */
function onAction_btnImprimir(event) {
	
	if(f_nroPedido != null){
		
		var res = globals.DIALOGS.showQuestionDialog('¡Atención!','¿Confirma reimpresión?', 'Si', 'No');
		if( res == 'Si'){
			if(f_tipoReimpresion != null){
				
				if(f_tipoReimpresion == 1 || f_tipoReimpresion == 3){
					imprimir(true);
				}
				
				if(f_tipoReimpresion == 2 || f_tipoReimpresion == 3){
					imprimirInforme();
				}
			}
			else{
				globals.DIALOGS.showWarningDialog("Atención","Debe seleccionar tipo de reimpresión.","Aceptar");
				elements.cbo_tipoReimpresion.requestFocus();
			}
		}
		
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención","No hay datos para imprimir.","Aceptar");
		elements.txt_nroSolicitud.requestFocus();
	}
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param codNomencla
 * @param tipoNome
 *
 * @properties={typeid:24,uuid:"05ED22C9-D9D8-4272-AAE6-82B1942C863C"}
 */
function obtenerObservaPractica (codNomencla,tipoNome) {
	var k;
	var texto = '';
	
	for(k=1 ; k <= $_dsAnatpaOb.getMaxRowIndex() ; k++){
		
		if($_dsAnatpaOb.getValue(k,1) == codNomencla && $_dsAnatpaOb.getValue(k,4) == tipoNome){
			
			if($_dsAnatpaOb.getValue(k,5) == 1)
				texto += '&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
			else
				texto += '<BR>&nbsp;&nbsp;&nbsp;&nbsp;' + $_dsAnatpaOb.getValue(k,3);
		}
	}
	
	return texto;
}

/**
 * @properties={typeid:24,uuid:"0B945373-9E35-4715-95A5-04B95C62FF3A"}
 * @AllowToRunInFind
 */
function imprimirInforme () {
	
	var ds_anatInf = databaseManager.getDataSetByQuery('asistencial',"select AnatinfDescr from tbc_ANATINF where AnatinfNroSolic = " + utils.stringTrim(f_nroSolicitud),null,-1);
	
	if(ds_anatInf.getMaxRowIndex() > 0){
		
		var fechaDesde = String($_fecNac);
		var fechaHasta = globals.FormatearFecha($_fechaRecibido,'AAAAMMDD');
		
		var servicio = utils.stringTrim(application.getValueListDisplayValue('Anatpa_vl_servicios',f_servicio));
		/*
		if(f_servicio == 21){
			if($_tipoPaciente == 1)
				servicio = "Guardia";
			else
				servicio = "Consultorios Externos"; 	
		}
		*/
		var protocolo = f_nroPedido;
		if(f_servicio == 21 ||f_servicio == 22 || f_servicio == 23){
			protocolo = "";
		}
		
		var histClinUnica = $_histClinUnica;
		if($_histClinUnica == 0 || $_histClinUnica == '0')
			histClinUnica = '';
		
		forms.Anatpa_print_informe.f_fechaImpresion = $_fechaRecibido;
		forms.Anatpa_print_informe.f_apelnom = $_tipoPaciente == 0 ? $_nroInternado + ' ' + $_nombre : $_histClinUnica + ' ' + $_nombre;
		forms.Anatpa_print_informe.f_cobertura = f_cobertura;
		forms.Anatpa_print_informe.f_edad = globals.Anatpa_calcularEdad(fechaDesde,fechaHasta) + ' ' +  globals.vTipoEdad;
		forms.Anatpa_print_informe.f_histclin = $_tipoPaciente == 0 ? histClinUnica : '';
		forms.Anatpa_print_informe.f_intervencion = $_itvDescripcion;
		forms.Anatpa_print_informe.f_nroAfiliado = f_nroAfiliado;
		forms.Anatpa_print_informe.f_nroDocumento = application.getValueListDisplayValue('Anatpa_vl_tipoDocu',$_tipoDocu) + ' ' + $_nroDocu;
		forms.Anatpa_print_informe.f_nroSolicitud = f_nroSolicitud;
		forms.Anatpa_print_informe.f_plan = "";
		forms.Anatpa_print_informe.f_protocolo = protocolo;
		forms.Anatpa_print_informe.f_servicio = servicio;
		
		forms.Anatpa_print_informe.f_nombreMedico = $_prof_infor;
		forms.Anatpa_print_informe.f_matriculaMedico = 'Matricula' + ' ' + $_mat_prof_infor;
		
		var dsAux = databaseManager.createEmptyDataSet();
		dsAux.addColumn('html_internado');
		
		var html = "";
		var i;
	
		
		for(i = 1 ; i <= ds_anatInf.getMaxRowIndex() ; i++ ){
			
			
			html = "";
			html += '<html><body>'
				
			html += '<table width=100% border="none" cellpadding=1 cellspacing=0>'
			html += '<tr>'
			html += '<td width=100%>' + ds_anatInf.getValue(i,1) +'</td>'
			html += '</tr>'
			html += '</table>'
				
			html += '</body></html>'
			dsAux.addRow([html]);
		}
		
		var $frm = solutionModel.getForm('Anatpa_print_informe');
		var $tipos = [JSColumn.TEXT];
		$frm.dataSource = dsAux.createDataSource('Anatpa_print_informe', $tipos);
		forms.Anatpa_print_informe.controller.recreateUI();
		/*
		var win = application.createWindow("impri_informe",JSWindow.MODAL_DIALOG);
		win.title = "Impresion Informe";
		win.resizable = false;
		win.show(forms.Anatpa_print_informe);
		*/
		forms.Anatpa_print_informe.controller.setPageFormat(210,297,10,10,10,10,1,0);
		forms.Anatpa_print_informe.controller.print(false,false);
		
	}
	else{
		
		globals.DIALOGS.showInfoDialog("Información","No hay informe para esta solicitud.","Aceptar");
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param codigo
 *
 * @properties={typeid:24,uuid:"CF1B3A1D-3690-446B-B1F5-564AFABB9C1C"}
 */
function formatearCodNomencla(codigo){
	
	var texto = String(codigo).substr(0,2)+"."+String(codigo).substr(2,2)+"."+String(codigo).substr(4,2);
	
	return texto;
}
