/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"02777131-A61D-4EBB-AC2D-5A56F21CE0D6",variableType:4}
 */
var $nroSolicitud = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9BCFDF38-A14B-483A-88D4-7EDF5634781C",variableType:4}
 */
var $medpertipoie = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"72D37DC7-3DF3-4733-A792-CDBAA23103F9"}
 */
var $to = null;

/**
 * @properties={typeid:35,uuid:"4569E86F-9534-4A6B-AC5C-088665BB402E",variableType:-4}
 */
var f_cerrarForm = false
;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DF855CF2-B11C-4359-B129-2DAC157DA90C",variableType:4}
 */
var $med_per_cod = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"196B3FBB-7817-42F4-975E-9612ADC142E1",variableType:4}
 */
var $cod_intervencion = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4DE5B5BE-8CD5-4FC9-A4CB-9E0646E74A4B"}
 */
var $intervencion = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"171615C3-E936-418F-97FE-13F6ADF493DF"}
 */
var f_intervencion = null;

/**
 * @properties={typeid:35,uuid:"3C2009DC-5E80-4092-BCE4-1891C7BC7063",variableType:-4}
 */
var $solicitudProtesis = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0A5BBE7E-6D86-497A-A72A-D72FD827597C"}
 */
var $emailItems = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E8CFA439-DA7F-4906-9AA2-1B5B6FCA7101"}
 */
var $medico = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"169F3EF9-CF26-4E1C-8FDA-41E921C00EF9"}
 */
var $nro_internacion = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A4131D51-C96B-4A1D-80D8-347EE3563405",variableType:4}
 */
var f_nroSolicitud = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"63CD5DD0-A63C-4A69-BE53-52DD792280C8"}
 */
var f_medico = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"74099C16-FA37-4714-9563-B9AAD6447A25",variableType:93}
 */
var f_fechaSolicitud = null;

/**
 * @properties={typeid:35,uuid:"75C346BE-CFA4-487F-9EDA-DAF026886B5A",variableType:-4}
 */
var $isDirty = false;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"5B19EE8B-538F-4B9A-87CE-F145D73F26EE",variableType:93}
 */
var $fechaSolicitud = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A159D1EF-7725-430B-A9AB-E6112D4B8FFF"}
 */
var $paciente = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F95583F6-899C-431C-A74D-F057B3EBB05A"}
 */
var $id = null;

/**
 * @properties={typeid:35,uuid:"A3575A0D-427E-469B-B0FA-04D521EF9AAF",variableType:-4}
 */
var $fs_protesis = databaseManager.getFoundSet("desal","prote_solicitud_protesis");

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E80616BE-20D1-423F-9EE5-9D8501DEDACA"}
 */
var f_messageErrorItem = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1BCAE24A-91ED-4EBB-BDF3-033FC0CAC433"}
 */
var f_plan = '';

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"823A5EF7-AAAA-452E-9424-FCF3FC957DC4",variableType:93}
 */
var f_fechaRecepcion = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"C35A4FE8-F4DB-42D5-87D1-9F2D26CF80D1",variableType:93}
 */
var f_fechaImplante = null;

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"558F24A1-156A-40A9-9616-4668491922BD",variableType:93}
 */
var f_horaImplante = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C5382277-C5DD-4770-8361-14281830F3BC"}
 */
var f_edad = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"FE77303A-9FC3-4DA3-857C-0F14565405E8"}
 */
var f_histClinUnica = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5DFDF4AB-2C67-499C-8CF1-72DB85486F85"}
 */
var f_cobertura = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"41BF338C-B879-4717-9A74-CDA1C60CD0FB",variableType:4}
 */
var f_lugarEntrega = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"A1D14395-B020-4FCB-906F-FB0A9AF679B8"}
 */
var f_paciente = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"90F28EAB-E9DD-4898-BE8D-33BA9543EBF3",variableType:4}
 */
var f_tipoPrioridad = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9F0024E4-7802-46D7-A8EA-096CFD258206",variableType:4}
 */
var f_tipoPaciente = null;

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EB650B96-2E3E-4001-85CA-407C14888F94"}
 */
function onShow_inicializarForm(firstShow, event) {
	
	var dsProtesis = databaseManager.createEmptyDataSet();
	dsProtesis.addColumn('id');
	dsProtesis.addColumn('cantidad');
	dsProtesis.addColumn('descripcion');
	dsProtesis.addColumn('laboratorio');
	dsProtesis.addColumn('observacion');
	dsProtesis.addColumn('esteril');
	dsProtesis.addColumn('esteril_value');
	dsProtesis.addColumn('fecha_recepcion');
	
	var $frm = solutionModel.getForm('prote_tbl_protesisSubItems');
	var $tipos = [JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.INTEGER,JSColumn.DATETIME];
	$frm.dataSource = dsProtesis.createDataSource('prote_tbl_protesisSubItems', $tipos);
	forms.prote_tbl_protesisSubItems.controller.recreateUI();
	
	//forms.prote_tbl_protesisNovedadItem.onShow_inicializarform(false,event);
	
	if($id == null){
		//f_fechaSolicitud = utils.timestampToDate(application.getServerTimeStamp());
		setVisibleElements(false);
		elements.btn_nuevo.requestFocus();
	}
	else{
		
		setDefaultBorderElements();
		setEditableElements(false);
		setVisibleElements(true);
		loadDataForm();
		forms.prote_tbl_protesisSubItems.elements.descripcion.requestFocus();
	}
	
	// control del elemento por perfil	    		
	var $form = controller.getName();
	globals.prote_controlarElementos($form);
	
	$isDirty = false;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"CD969F17-E7FB-4EDC-944F-904A4E92B0ED"}
 */
function onAction_agregarItem(event) {
	
	forms.prote_dlgModificarProtesisItems.$item = null;
	
	var win = application.createWindow("agregar_item_recibido",JSWindow.MODAL_DIALOG);	
    win.title= 'Agregar - Recepción de Prótesis e Implantes Quirúrgicos';
    win.resizable = false;
    win.show(forms.prote_dlgModificarProtesisItems);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"3616A2BC-1132-4104-9303-20A2F1F4CF3B"}
 * @AllowToRunInFind
 */
function onAction_btnGuardar(event) {
	
	if($isDirty){
		
		var idAux = $id;
		var fs_nroSolicitud = databaseManager.getFoundSet("parametros","numprot")
		
		if($id == null || $id == 'null'){
			
			fs_nroSolicitud.find()
			fs_nroSolicitud['nprot_1']=1
			fs_nroSolicitud.search()
			if(fs_nroSolicitud.getSize()>0){
				$nroSolicitud = fs_nroSolicitud['nprot_2'];
				$nroSolicitud +=1;
			}
		}
		
		if(isValidDataForm()){
			
			if($id == null || $id == 'null'){
				
				idAux = application.getUUID();
				//Verificando si existe clave primaria
				var sql = "SELECT EXISTS( SELECT id FROM prote_solicitud_protesis WHERE id='" + idAux + "')"
				var dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
				while(dsExists.getValue(1,1) == 1){
					idAux = application.getUUID();
					sql = "SELECT EXISTS( SELECT id FROM prote_solicitud_protesis WHERE id='" + idAux + "')"
					dsExists = databaseManager.getDataSetByQuery('desal',sql,null,-1);
				}
				
				f_fechaSolicitud = utils.timestampToDate(application.getServerTimeStamp());
				
				$fs_protesis.newRecord()
				$fs_protesis['id'] = idAux;
				$fs_protesis['tipo_paciente'] = f_tipoPaciente;
				$fs_protesis['tipo_prioridad'] = f_tipoPrioridad;
				
				if(utils.stringTrim(f_histClinUnica).length == 0)
					$fs_protesis['hist_clin_unica'] = null;
				else
					$fs_protesis['hist_clin_unica'] = f_histClinUnica;
				
				$fs_protesis['hist_clin'] = $nro_internacion;
				$fs_protesis['paciente'] = utils.stringTrim($paciente);
				$fs_protesis['medico'] = utils.stringTrim($medico);
				$fs_protesis['med_per_cod'] = $med_per_cod;
				$fs_protesis['medpertipoie'] = $medpertipoie;
				
				if(utils.stringTrim(f_intervencion).length > 0){
					$fs_protesis['intervencion'] = utils.stringTrim($intervencion);
					$fs_protesis['cod_intervencion'] = $cod_intervencion;
				}
				else{
					$fs_protesis['intervencion'] = null;
					$fs_protesis['cod_intervencion'] = null;
				}
				
				
				//$fs_protesis['fecha_solicitud'] = utils.timestampToDate(application.getServerTimeStamp());
				$fs_protesis['fecha_solicitud'] = f_fechaSolicitud;
				$fs_protesis['nro_solicitud'] = $nroSolicitud;
				$fs_protesis['leg_operador'] = globals.vLega;
				$fs_protesis['fecha_creacion'] = application.getServerTimeStamp();
				
				
				// Actualizando tabla parametros
				fs_nroSolicitud['nprot_2'] = $nroSolicitud;
			}
				
			var fs_protesisItems = databaseManager.getFoundSet("desal","prote_item_recibidos");
			var maxItems = forms.prote_tbl_protesisSubItems.foundset.getSize();
			var k;
			var item;
			var sqlItem;
			var idItem;
			for(k= 1;k <= maxItems; k++){
					
				forms.prote_tbl_protesisSubItems.foundset.setSelectedIndex(k);
				item = forms.prote_tbl_protesisSubItems.foundset.getSelectedRecord();
					
				if(item.id == null || item.id == 'null'){
						
					idItem = application.getUUID();
					// Verificando si existe clave primaria
					sqlItem = "SELECT EXISTS( SELECT id FROM prote_item_recibidos WHERE id='" + idItem + "')";
					var dsExistsItem = databaseManager.getDataSetByQuery('desal',sqlItem,null,-1);
					while(dsExistsItem.getValue(1,1) == 1){
						idItem = application.getUUID();
						sqlItem = "SELECT EXISTS( SELECT id FROM prote_item_recibidos WHERE id='" + idItem + "')";
						dsExistsItem = databaseManager.getDataSetByQuery('desal',sqlItem,null,-1);
					}
					
					fs_protesisItems.newRecord();
					fs_protesisItems['id'] = idItem;
					fs_protesisItems['solicitud_id'] = idAux;
					//fs_protesisItems['codigo'] = item.codigo;
					fs_protesisItems['descripcion'] = item.descripcion;
					fs_protesisItems['cantidad'] = item.cantidad;
					fs_protesisItems['laboratorio'] = item.laboratorio;
					fs_protesisItems['esteril'] = item.esteril_value;
					fs_protesisItems['fecha_recepcion'] = f_fechaSolicitud;
					fs_protesisItems['observacion'] = item.observacion;
					fs_protesisItems['leg_operador'] = globals.vLega;
					fs_protesisItems['fecha_creacion'] = application.getServerTimeStamp();
					
					//forms.prote_tbl_protesisSubItems.foundset['id'] = idItem;
					$emailItems += "  - " +item.descripcion + "  Laboratorio " + item.laboratorio + " \n"
				}
			}
			
			// Actualizando base de datos
			databaseManager.startTransaction()
			var result = databaseManager.saveData();
			if(result){
				databaseManager.commitTransaction();
				
				// Si es una insercion se debe actualizar el id de la solicitud de protesis
				if($id == null || $id == 'null'){
					$id = idAux;
					f_nroSolicitud = $nroSolicitud;
				}
					
				globals.DIALOGS.showInfoDialog("Resultado","La recepción de protesis se guardo correctamente.","Aceptar");
				loadItemRecibidos();
				setVisibleElements(true);
				setEditableElements(false);
				forms.prote_tbl_protesisSubItems.elements.btn_AgregarNovedad.enabled= true;
				
				enviarEmail();
				$emailItems = null;
				$isDirty = false;
			}
			else{
				var error1 = ''
				var error2 = ''
				var array = databaseManager.getFailedRecords()
				for (var i = 0; i < array.length; i++) {
					var record = array[i];
					var jstable = databaseManager.getTable(record);
					var tableSQLName = jstable.getSQLName();
					error1='Error de Grabación en Tabla:' + tableSQLName + ' en server:' + jstable.getServerName() + ' falló la grabación. Avise urgente a Sistemas, por favor!'
					error2='Error en grabación '+record.exception;
					if (record.exception.getErrorCode() == ServoyException.RECORD_VALIDATION_FAILED) {
						// exception thrown in pre-insert/update/delete event method
						var thrown = record.exception.getValue()
						//plugins.dialogs.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
					}
				}
				
				databaseManager.rollbackTransaction()
				if(error1!=''){
					globals.DIALOGS.showErrorDialog("Error de grabación","Record validation failed: " + thrown)
					globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error1,"Aceptar")
					globals.DIALOGS.showErrorDialog("Error en grabacion de Histórico",error2,"Aceptar")
				}
				globals.DIALOGS.showErrorDialog("Error en grabación","Se ha producido un error de grabación. "+'\n'+"Avise a Sistemas, por favor.", "Aceptar")
			}
		}	

	}
	else{
		if($id == null)
			globals.DIALOGS.showWarningDialog("Atención!","No hay datos para guardar.","Aceptar")
		else
			globals.DIALOGS.showWarningDialog("Atención!","No hay modificaciones para guardar.","Aceptar")
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"50F8260A-EA43-4EA6-AA40-C8F54FDC04CC"}
 */
function onAction_btnBuscarPaciente(event) {
	
	globals.gbl_eventSourceButton = 1;
	openSearch();
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"D5146DAA-1A11-42F9-A275-F2CD63F843E2"}
 */
function openSearch() {
	
	if(f_tipoPaciente != null){
		
		// Ambulatorio
		if(f_tipoPaciente == 2){
			var win = application.createWindow("seleccion_ambulatorio",JSWindow.MODAL_DIALOG);	
		    win.title= 'Búsqueda de Pacientes Ambulatorios';
		    win.resizable = false;
		    win.show(forms.frm_protesis_buscarAmbulatorio_dg);
		}
		
		// Internado
		if(f_tipoPaciente == 1){
			var win2 = application.createWindow("seleccion_internado",JSWindow.MODAL_DIALOG);	
		    win2.title= 'Búsqueda de Pacientes Internados';
		    win2.resizable = false;
		    win2.show(forms.frm_protesis_buscarInternado_dg);
		}
		
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención",'Debe seleccionar tipo de paciente.',"Aceptar");
		elements.cbo_tipoPaciente.requestFocus();
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"2E2608DE-475C-489E-8A07-FFEA5817A04B"}
 */
function onAction_txtBusquedaRapida(event) {
	
	globals.pHisclistrynro = f_paciente;
	if(globals.pHisclistrynro != '' && globals.pHisclistrynro != null){
		globals.gbl_eventSourceButton = 0;
		openSearch();
		//$isDirty = true;
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención",'Debe ingresar Nro. de paciente o apellido.',"Aceptar")
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"3DEB9441-6B6B-4230-A601-F65E0A2C9FFF"}
 */
function onAction_cboTipoPaciente(event) {
	
	f_paciente = '';
	f_histClinUnica = '';
	$paciente = '';
	$nro_internacion = null;
	
	set_lbl_tipoPaciente();
	
	$isDirty = true;
}

/**
 * @properties={typeid:24,uuid:"21BF85D9-1676-49DF-A3C9-5BB66708FDCE"}
 */
function set_lbl_tipoPaciente (){
	
	// Internado
	if(f_tipoPaciente == 1){
		elements.lbl_paciente.text = 'Nro. Internación-Pac.';
		elements.btn_buscarPaciente.visible = true;
		elements.txt_paciente.requestFocus();		
	}
	
	// Ambulatorio
	if(f_tipoPaciente == 2){
		elements.lbl_paciente.text = 'H. Clinica U. - Pac.';
		elements.btn_buscarPaciente.visible = true;
		elements.txt_paciente.requestFocus();
	}
	
	// Obra social
	if(f_tipoPaciente == 3){
		elements.lbl_paciente.text = 'Obra social';
		elements.btn_buscarPaciente.visible = false;
		f_tipoPrioridad = 2;
		elements.txt_paciente.requestFocus();
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"73046B34-57FD-4326-9F1C-0DAA8B50B7CC"}
 */
function onAction_btnBuscarMedico(event) {
	globals.gbl_eventSourceButton = 1;
	openMedicoSearch();
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"63145A0A-C154-4DF9-80C0-C5DFB1B32E4E"}
 */
function openMedicoSearch() {
	
	var win2 = application.createWindow("seleccion_medico",JSWindow.MODAL_DIALOG);	
    win2.title= 'Búsqueda de Médico';
    win2.resizable = false;
    win2.show(forms.prote_dlg_busquedaMedicos);
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"ED1E3634-2A23-4FCD-97E2-1EF8D0DF56BC"}
 */
function isValidDataForm() {
	
	var isValid = true;	
	var messageError = "No ha sido posible guardar la recepción de protesis. Corrija los siguientes errores y vuelva a intentar."
	var borderError = 'LineBorder,1,#ff0000';
	setDefaultBorderElements();
		
	if(f_tipoPaciente == null){
		elements.cbo_tipoPaciente.border = borderError;
		messageError += "\nDebe seleccionar tipo paciente.";        
        isValid = false;
	}
	
	if(f_paciente == null || f_paciente == ''){
		
		if(f_tipoPaciente != 3){
			messageError += "\nDebe ingresar paciente.";
		}
		else
			messageError += "\nDebe ingresar obra social.";
		
		elements.txt_paciente.border = borderError;
		isValid = false;
	}
	else
	{
		// Internado = 1
		if(f_tipoPaciente == 1){
			
			if(utils.stringTrim(f_histClinUnica).length > 0){
				
				var nro_internacionAux = null;
				var pacienteAux = null;
				
				var dataPacInter = f_paciente.split('-');
				if(dataPacInter.length > 1){
					nro_internacionAux = utils.stringToNumber(utils.stringTrim(dataPacInter[0])); 
					pacienteAux = utils.stringTrim(dataPacInter[1]) 
				}
				
				if( nro_internacionAux != utils.stringToNumber($nro_internacion) || utils.stringTrim($paciente) != pacienteAux){
					elements.txt_paciente.border = borderError;
					messageError += "\nDatos de paciente inconsistente, vuelva a seleccionar paciente o presione boton nuevo.";        
			        isValid = false;
				}
			}
			else{
				$paciente = f_paciente;
			}
			
		}
		
		// ambulatorio = 2
		if(f_tipoPaciente == 2){
			
			if(utils.stringTrim(f_histClinUnica).length > 0){
				
				var histClinUnicaAux = null;
				var pacienteAmbuAux = null;
				
				var dataPacAmbu = f_paciente.split('-');
				if(dataPacAmbu.length > 1){
					histClinUnicaAux = utils.stringToNumber(utils.stringTrim(dataPacAmbu[0])); 
					pacienteAmbuAux = utils.stringTrim(dataPacAmbu[1]) 
				}
				
				var hist = Number(f_histClinUnica);
				if( histClinUnicaAux !=  hist || utils.stringTrim($paciente) != pacienteAmbuAux){
					elements.txt_paciente.border = borderError;
					messageError += "\nDatos de paciente inconsistente, vuelva a seleccionar paciente o presione el boton nuevo.";        
			        isValid = false;
				}
			}
			else{
				$paciente = f_paciente;
			}
			
		}
		
		// A Banco
		if(f_tipoPaciente == 3){
			$paciente = f_paciente;
		}
		
	}
	
	if(f_tipoPrioridad == null){
		elements.cbo_tipoPrioridad.border = borderError;
		messageError += "\nDebe seleccionar tipo prioridad.";        
        isValid = false;
	}
	
	if(f_medico == null || f_medico == ''){
		elements.txt_medico.border = borderError;
		messageError += "\nDebe ingresar médico.";        
        isValid = false;
	}
	else{
		
		if($med_per_cod > 0){
			
			var med_per_codAux = null;
			var medicoAux = null;
			
			var dataMedico = f_medico.split('-');
			if(dataMedico.length > 1){
				med_per_codAux = utils.stringToNumber(utils.stringTrim(dataMedico[0])); 
				medicoAux = utils.stringTrim(dataMedico[1]) 
			}
			
			if( med_per_codAux != $med_per_cod || utils.stringTrim($medico) != medicoAux){
				elements.txt_paciente.border = borderError;
				messageError += "\nDatos de médico inconsistente, vuelva a seleccionar médico o  presione el boton nuevo.";        
		        isValid = false;
			}
		}
		else{
			
			elements.txt_medico.border = borderError;
			messageError += "\nEl médico ingresado, no esta registrado en el sistema.";        
	        isValid = false;
		}
	}
	
	if(f_intervencion != null && utils.stringTrim(f_intervencion).length > 0){
		
		var cod_intervencionAux = -1;
		var f_intervencionAux = f_intervencion;
		
		var dataInter = f_intervencion.split('-');
		if(dataInter.length > 1){
			cod_intervencionAux = utils.stringToNumber(utils.stringTrim(dataInter[0])); 
			f_intervencionAux = utils.stringTrim(dataInter[1]) 
		}
		
		var sqlInter = "SELECT itv_codi FROM tbc_INTERVEN WHERE itv_codi = " + cod_intervencionAux  
				+ " and itv_descripcion = '" + f_intervencionAux + "'";
		var dsExistsInter = databaseManager.getDataSetByQuery('maestros',sqlInter,null,-1);
	
		if(dsExistsInter.getMaxRowIndex() == 0){
			elements.txt_intervencion.border = borderError;
			messageError += "\nLa intervención ingresada, no esta registrada en el sistema.";        
	        isValid = false;
		}
		else{
			$intervencion = f_intervencionAux;
			$cod_intervencion = cod_intervencionAux;
		}
	}
	
	if (forms.prote_tbl_protesisSubItems.foundset.getSize() == 0){
		elements.lbl_itemRecibido.border = borderError;	
		messageError += "\nDebe ingresar al menos un item recibido.";        
        isValid = false;
	}
	
	// nueva solicitud 
	if($id == null || $id == 'null'){
	
		// Verificando si existe nro de solicitud
		var sqlNro = "SELECT EXISTS( SELECT id FROM prote_solicitud_protesis WHERE nro_solicitud=" + $nroSolicitud + ")"
		var dsExistsNro = databaseManager.getDataSetByQuery('desal',sqlNro,null,-1);
		if(dsExistsNro.getValue(1,1) == 1){
			messageError += "\nYa existe el número de solicitud " + $nroSolicitud + ".";        
	        isValid = false;
		}
	}
	else{
		// Solicitud existente
		var maxItems = forms.prote_tbl_protesisSubItems.foundset.getSize();
		var k;
		var item;
		var existeNuevoItem = false;
		for(k= 1;k <= maxItems; k++){
				
			forms.prote_tbl_protesisSubItems.foundset.setSelectedIndex(k);
			item = forms.prote_tbl_protesisSubItems.foundset.getSelectedRecord();
				
			if(item.id == null || item.id == 'null'){
				existeNuevoItem = true;
				break;
			}
		}
		
		if(!existeNuevoItem){
			messageError += "\nDebe ingresar al menos un nuevo item recibido.";        
	        isValid = false;
		}	
	}
	
	if(!isValid){
		globals.DIALOGS.showWarningDialog("Atención!",messageError,"Aceptar")
		elements.cbo_tipoPaciente.requestFocus();
	}
	
	return isValid;
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"067D711C-04B7-4A85-AA58-4E816A2D44B3"}
 */
function setDefaultBorderElements() {
	
	var border = 'LineBorder,1,null';
	elements.cbo_tipoPaciente.border = 'LineBorder,1,#abadb3';
	elements.txt_paciente.border = border;
	elements.txt_medico.border = border;
	elements.txt_intervencion.border = border;
	elements.cbo_tipoPrioridad.border = 'LineBorder,1,#abadb3';
	elements.lbl_itemRecibido.border = null;
	
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"AEF2EB3C-FAB6-461F-836B-33355100EEEB"}
 */
function setEditableElements(editable) {
	
	//elements.btn_agregarItem.enabled = editable,
	elements.btn_buscarPaciente.enabled = editable;
	elements.btn_buscarMedico.enabled = editable;
	elements.btn_buscarIntervención.enabled = editable;
	//elements.btn_grabar.enabled = editable;
	elements.cbo_tipoPaciente.enabled = editable;
	elements.cbo_tipoPrioridad.enabled = editable;
	//elements.cld_fechaSolicitud.enabled = editable;
	//elements.lbl_agregarItem.enabled = editable;
	//elements.tab_novedad.enabled = editable;
	elements.txt_paciente.enabled= editable;
	elements.txt_medico.enabled = editable;
	elements.txt_intervencion.enabled = editable;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"36E3FB83-FA3F-41A5-98C5-230DEC29D34F"}
 * @AllowToRunInFind
 */
function onAction_btnNuevo(event) {
	
	var limpiar = false;
	if($isDirty){
		var respuesta = globals.DIALOGS.showQuestionDialog('¡Atención!','Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No');
		if( respuesta == 'Si')
			limpiar = true;
	}
	else{
		limpiar = true;
	}
		
	if(limpiar){
		inicializarForm();
		setDefaultBorderElements();
		setVisibleElements(false);
		setEditableElements(true);
		elements.cbo_tipoPaciente.requestFocus();
		$isDirty = false;
	}
	
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"2523B43C-AEE2-4C9A-A345-1195241244F1"}
 */
function inicializarForm() {
	
	$id = null;
	f_nroSolicitud = null;
	$nroSolicitud = null;
	f_histClinUnica = "";
	$paciente = "";
	f_intervencion = null;
	$cod_intervencion = null;
	$intervencion = null;
	f_paciente = null;
	f_medico = null;
	$medico = null;
	$to = null;
	$med_per_cod = null;
	$medpertipoie = null
	f_tipoPaciente = null;
	f_tipoPrioridad = null;
	f_fechaSolicitud = null;
	forms.prote_tbl_protesisSubItems.elements.btn_AgregarNovedad.enabled = false;
	forms.prote_tbl_protesisSubItems.foundset.clear();
	if(forms.prote_tbl_protesisNovedadItem.foundset.getSize() > 0){
		forms.prote_tbl_protesisNovedadItem.foundset.clear();
	}
	elements.lbl_paciente.text = 'Paciente';
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"F0CBA322-B696-4742-A9FD-6E5D011AA9F0"}
 */
function setVisibleElements(visible) {
	
	elements.tab_novedad.visible = visible;
	elements.lbl_novedad.visible = visible;
	elements.shp_novedad.visible = visible;
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"67BE2541-EB6B-4794-B4F6-6226D64581C8"}
 * @AllowToRunInFind
 */
function enviarEmail() {
	
	var subJect = "Aviso, recepción de protesis/materiales paciente " + $paciente;
	
	var msgText = "Estimado Dr./Dra. " + $medico + "\n\n"
	+ "                En el día de la fecha se ha recepcionado el siguiente material para el paciente " + utils.stringTrim($paciente) + ":\n\n"
	+ $emailItems;
	if($intervencion != null && $intervencion != null){
		msgText+= "\nIntervención a realizar: " + $intervencion + "\n\n";
	}
	else{
		msgText+= "\n";
	}
	
	msgText+= "Atte.\n"; 
	msgText+= "Unidad Quirugica\n";
	msgText+= "Sanatorio Colegiales";
	
	// Enviando email
	//var userName = 'aviso@sanatoriocolegiales.com.ar';
	//var passWord = 'avi32avi';
	var userName = 'turnosquirurgicos@sanatoriocolegiales.com.ar';
	var passWord = 'casio8888';
	var properties = new Array();
	//properties[0] = 'mail.smtp.host=smtp.sanatoriocolegiales.com.ar';
	properties[0] = 'mail.smtp.host=200.80.43.104';
	properties[1] = 'mail.smtp.auth=true';
	properties[2] = 'mail.smtp.username=' + userName;
	properties[3] = 'mail.smtp.password=' + passWord;
	properties[4] = 'mail.smtp.port=25';

	//properties[5] = 'mail.smtp.starttls.enable=true';
	//var attachment1 = plugins.mail.createBinaryAttachment('LB-CIRUINTER-20140216-20140301.pdf',plugins.file.readFile('c:/temp/LB-CIRUINTER-20140216-20140301.pdf'));
	//var attachment2 = plugins.mail.createBinaryAttachment('proto61.pdf',plugins.file.readFile('c:/temp/proto61.pdf'));
	//var success = plugins.mail.sendMail('fhuertas@cirendsa.com.ar', 'aviso@sanatoriocolegiales.com.ar', 'Aviso recepcion de protesis', msgText,null,null,attachment1, properties);

	var cc = null;
	
	var url=''
	var largo_url=application.getServerURL().length
	if (largo_url<24){
		globals.DIALOGS.showInfoDialog("Resultado",msgText + '\nTo: ' + $to,"Aceptar");
		$to = 'fhuertas@cirendsa.com.ar';
	}else{
		url = application.getServerURL().substr(0,23)
		var puerto = url.split(':');
		
		if(puerto[2]!='8080'){
			// Ambiente de pruebas
			$to = globals.DIALOGS.showInputDialog(puerto[2],"Ingrese Dirección de correo electronico",'fhuertas@cirendsa.com.ar');
			cc = 'fmhuertas@yahoo.com.ar';
		}
		else{
			// Ambiente operativo
			cc = "clausmocovich@sanatoriocolegiales.com.ar,sgallo@cirendsa.com.ar,sret@cirendsa.com.ar,fflores@sanatoriocolegiales.com.ar,eperez@cirendsa.com.ar";
		}
	}
	
	if(plugins.mail.isValidEmailAddress(utils.stringTrim($to))){
		
		var success = plugins.mail.sendMail($to, 'turnosquirurgicos@sanatoriocolegiales.com.ar', subJect, msgText,cc,null,null, properties);
		if (!success){
			globals.DIALOGS.showWarningDialog("Alert","No ha sido posible enviar las notificaciones de E-mail. Contacte al administrador del sistema.","Aceptar");
		}
	}
	else
		globals.DIALOGS.showWarningDialog("Atención!","No ha sido posible enviar la notificiación. Direccion de correo electrónico no válido.\n E-mail: " + $to,"Aceptar");	
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"A7FD4268-C089-424B-A157-E039F42AC261"}
 */
function loadDataForm() {
	
	f_fechaSolicitud = forms.prote_tblSolicitudProtesis.foundset['fecha_solicitud'];
	f_nroSolicitud = forms.prote_tblSolicitudProtesis.foundset['nro_solicitud'];
	f_histClinUnica = forms.prote_tblSolicitudProtesis.foundset['hist_clin_unica'];
	f_tipoPaciente = forms.prote_tblSolicitudProtesis.foundset['tipo_paciente'];
	f_paciente = forms.prote_tblSolicitudProtesis.foundset['paciente'];
	$paciente = f_paciente;
	
	if(f_tipoPaciente == 1){
		
		f_paciente = forms.prote_tblSolicitudProtesis.foundset['hist_clin'] + " - " + forms.prote_tblSolicitudProtesis.foundset['paciente'];
		$nro_internacion = forms.prote_tblSolicitudProtesis.foundset['hist_clin'];
	}

	if(f_tipoPaciente == 2)
		f_paciente  = f_histClinUnica + " - " + forms.prote_tblSolicitudProtesis.foundset['paciente'];
		
	f_tipoPrioridad = forms.prote_tblSolicitudProtesis.foundset['prioridad'];
	f_medico = forms.prote_tblSolicitudProtesis.foundset['med_per_cod'] + " - " + forms.prote_tblSolicitudProtesis.foundset['medico'];
	$medico = forms.prote_tblSolicitudProtesis.foundset['medico']; 
	$med_per_cod = forms.prote_tblSolicitudProtesis.foundset['med_per_cod'];
	
	f_intervencion = null;
	$intervencion = null;
	var intervencion = utils.stringTrim(forms.prote_tblSolicitudProtesis.foundset['intervencion']);
	if(intervencion.length > 0){
	
		f_intervencion = forms.prote_tblSolicitudProtesis.foundset['cod_intervencion'] + " - " +  forms.prote_tblSolicitudProtesis.foundset['intervencion'];
		$intervencion = forms.prote_tblSolicitudProtesis.foundset['intervencion'];
	}
	
	$medpertipoie = forms.prote_tblSolicitudProtesis.foundset['medpertipoie'];
	
	set_lbl_tipoPaciente();
	
	// Cargando item recibidos
	loadItemRecibidos();
	// Cargando item novedades
	forms.prote_tbl_protesisSubItems.foundset.setSelectedIndex(1);
	var itemRecibidoId = forms.prote_tbl_protesisSubItems.foundset['id'];
	forms.prote_tbl_protesisNovedadItem.$itemRecibidoId = itemRecibidoId;
	forms.prote_tbl_protesisNovedadItem.loadDataForm();
	// Cargando Email del medico
	loadEmailTo();
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"7721C04B-D860-4276-84F0-4C46E6E73B9A"}
 */
function onAction_btnBuscar(event) {
	var buscar = false;
	
	if($isDirty){
		if(globals.DIALOGS.showQuestionDialog('¡Atención!','Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			buscar = true;
	}
	else{
		buscar = true;
	}
	
	if(buscar){

		var win = application.createWindow("busqueda_recepcion_protesis",JSWindow.MODAL_DIALOG);	
	    win.title= 'Búsqueda - Recepción de Protesis e Implantes Quirúrgicos';
	    win.resizable = false;
	    //globals.gbl_cerrarDetalleProtocolo = false;
	    win.show(forms.prote_frmSolicitudProtesisSearch);
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"263B865A-1DA5-444F-BF0C-179B176125E9"}
 */
function onAction_medicoBusquedaRapida(event) {
	
	globals.vProfeAlfa = f_medico;
	if(globals.vProfeAlfa != '' && globals.vProfeAlfa != null && isNaN(f_medico)){
		globals.gbl_eventSourceButton = 0;
		openMedicoSearch();
		//$isDirty = true;
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención!",'Debe ingresar apellido o nombre del médico solicitante.',"Aceptar")
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"2F65A4F4-85ED-44AB-986D-40C580BC250D"}
 */
function onAction_btnBuscarIntervencion(event) {
	
	globals.gbl_eventSourceButton = 1;
	openIntervencionSearch();
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"2BE95FC3-2DF3-4D6F-BE5B-543641A70A30"}
 */
function openIntervencionSearch() {
	
	var win2 = application.createWindow("seleccion_intervencion",JSWindow.MODAL_DIALOG);	
    win2.title= 'Búsqueda de Intervencion';
    win2.resizable = false;
    win2.show(forms.prote_dlg_busquedaIntervencion);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"76B71BD1-5FBB-4798-A56F-7822BB1102E1"}
 */
function onAction_intervencionBusquedaRapida(event) {
	
	globals.prote_intervenAlfa = f_intervencion;
	if(globals.prote_intervenAlfa != '' && globals.prote_intervenAlfa != null && isNaN(f_intervencion)){
		globals.gbl_eventSourceButton = 0;
		openIntervencionSearch();
		//$isDirty = true;
	}
	else{
		globals.DIALOGS.showWarningDialog("Atención!",'Debe ingresar la intervencion.',"Aceptar")
	}
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"A0F5E0F1-A056-49FA-A697-7B8E640660CD"}
 */
function onDataChange_setIsDirty(oldValue, newValue, event) {
	elements.txt_medico.requestFocus();
	$isDirty = true;
	return true
}

/**
 * Handle hide window.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"15764E6D-4E90-4272-A799-1251D11647A0"}
 */
function onHide_recepcionProtesis(event) {
	
	return f_cerrarForm;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"C8AC73F4-647D-4074-B865-F7FDC0BD0E4C"}
 */
function onAction_btnCerrar(event) {
	
	if($isDirty){
		if(globals.DIALOGS.showQuestionDialog('¡Atención!','Existen datos que no hay sido guardados. ¿Está seguro que desea continuar?', 'Si', 'No') == 'Si')
			f_cerrarForm = true;
	}
	else{
		f_cerrarForm = true;
	}
	
	if(f_cerrarForm){
		var $win = application.getWindow(application.getActiveWindow().getName());
		if($win != null){
			$win.hide();
			$win.destroy();
		}
	}
}

/**

 * @private
 *
 * @properties={typeid:24,uuid:"76A1024D-DB8B-4D06-A498-4CDC4097D15B"}
 */
function loadItemRecibidos() {
	
	var sqlsubItem = "SELECT sr.id,sr.cantidad,sr.descripcion,sr.laboratorio,sr.esteril,sr.fecha_recepcion,sr.observacion,sr.esteril esteril_value\
		FROM prote_item_recibidos sr\
		WHERE sr.solicitud_id = '" + $id + "'";
	
	var dsProtesis = databaseManager.getDataSetByQuery('desal',sqlsubItem,null,-1);
	
	var $frm = solutionModel.getForm('prote_tbl_protesisSubItems');
	var $tipos = [JSColumn.TEXT,JSColumn.TEXT,JSColumn.TEXT, JSColumn.TEXT,JSColumn.TEXT, JSColumn.DATETIME,JSColumn.TEXT,JSColumn.TEXT];
	$frm.dataSource = dsProtesis.createDataSource('prote_tbl_protesisSubItems', $tipos);
	forms.prote_tbl_protesisSubItems.controller.recreateUI();
	
	forms.prote_tbl_protesisSubItems.elements.btn_AgregarNovedad.enabled = true;
}

/**
 * @properties={typeid:24,uuid:"8CF45587-C0E2-4089-B50B-8B4F38F89A2C"}
 * @AllowToRunInFind
 */
function loadEmailTo() {
	
	$to = null;
	if($medpertipoie == 0){
		var fs_personal = databaseManager.getFoundSet("maestros","tbc_personal")
		fs_personal.find()
		fs_personal['per_legajo']= $med_per_cod
		fs_personal.search()
		if(fs_personal.getSize()>0){
			$to = fs_personal['per_mail'];
		}
	}
	
	if($medpertipoie == 1){
		var fs_medicos = databaseManager.getFoundSet("maestros","tbc_medicos")
		fs_medicos.find()
		fs_medicos['med_codigo']=$med_per_cod
		fs_medicos.search()
		if(fs_medicos.getSize()>0){
			$to = fs_medicos['med_email'];
		}
	}
	
	if($id == null || $id == 'null'){
		if(!plugins.mail.isValidEmailAddress(utils.stringTrim($to))){
			globals.DIALOGS.showWarningDialog("¡Atención!","La dirección de correo electrónico del médico no es válido.\n E-mail: " + $to,"Aceptar");
		}
	}
	
}
